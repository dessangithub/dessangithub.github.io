var oh=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill.b7f2da20.js";var s0=oh((a0,jt)=>{function ah(r){if(r.__esModule)return r;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(r).forEach(function(t){var i=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:function(){return r[t]}})}),e}var Za=/[\\\"\x00-\x1F]/g,Qt={};for(var Xr=0;Xr<32;++Xr)Qt[String.fromCharCode(Xr)]="\\U"+("0000"+Xr.toString(16)).slice(-4).toUpperCase();Qt["\b"]="\\b";Qt["	"]="\\t";Qt[`
`]="\\n";Qt["\f"]="\\f";Qt["\r"]="\\r";Qt['"']='\\"';Qt["\\"]="\\\\";function Ml(r){return Za.lastIndex=0,r.replace(Za,function(e){return Qt[e]})}function ca(r){switch(typeof r){case"string":return'"'+Ml(r)+'"';case"number":return isFinite(r)?r:"null";case"boolean":return r;case"object":return r===null?"null":Array.isArray(r)?ch(r):lh(r);default:throw new Error("Cannot stringify: "+typeof r)}}function ch(r){for(var e="[",t="",i=0;i<r.length;++i)t+=e,e=",",t+=ca(r[i]);return e!=","?"[]":t+"]"}function lh(r){var e="{",t="",i=Object.keys(r);i.sort();for(var s=0;s<i.length;++s){var n=i[s];t+=e+'"'+Ml(n)+'":',e=",",t+=ca(r[n])}return e!=","?"{}":t+"}"}var Lr={stringify:ca},dh={exports:{}},uh={},hh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:uh}),Qr=ah(hh);(function(r,e){// @license magnet:?xt=urn:btih:8e4f440f4c65981c5bf93c76d35135ba5064d8b7&dn=apache-2.0.txt Apache-2.0
var t=function(){var i={},s,n,o=(()=>{var l=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(l=l||__filename),function(d){d=d||{};var c;c||(c=typeof d<"u"?d:{});var h,p;c.ready=new Promise(function(u,m){h=u,p=m});var g;if(typeof window<"u")g=function(u){window.crypto.getRandomValues(u)};else if(r.exports){var y=Qr;g=function(u){var m=y.randomBytes(u.length);u.set(m)}}else throw Error("Cannot find global to attach library to");if(typeof OLM_OPTIONS<"u")for(var w in OLM_OPTIONS)OLM_OPTIONS.hasOwnProperty(w)&&(c[w]=OLM_OPTIONS[w]);c.onRuntimeInitialized=function(){Qe=c._olm_error(),i.PRIVATE_KEY_LENGTH=c._olm_pk_private_key_length(),s&&s()},c.onAbort=function(u){n&&n(u)};var x=Object.assign({},c),M=typeof window=="object",D=typeof importScripts=="function",O=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string",C="",U,B,G,wt,ss,Ws;O?(C=D?Qr.dirname(C)+"/":__dirname+"/",Ws=()=>{ss||(wt=Qr,ss=Qr)},U=function(u,m){return Ws(),u=ss.normalize(u),wt.readFileSync(u,m?void 0:"utf8")},G=u=>(u=U(u,!0),u.buffer||(u=new Uint8Array(u)),u),B=(u,m,_)=>{Ws(),u=ss.normalize(u),wt.readFile(u,function(v,S){v?_(v):m(S.buffer)})},1<process.argv.length&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(u){throw u}),process.on("unhandledRejection",function(u){throw u}),c.inspect=function(){return"[Emscripten Module object]"}):(M||D)&&(D?C=self.location.href:typeof document<"u"&&document.currentScript&&(C=document.currentScript.src),l&&(C=l),C.indexOf("blob:")!==0?C=C.substr(0,C.replace(/[?#].*/,"").lastIndexOf("/")+1):C="",U=u=>{var m=new XMLHttpRequest;return m.open("GET",u,!1),m.send(null),m.responseText},D&&(G=u=>{var m=new XMLHttpRequest;return m.open("GET",u,!1),m.responseType="arraybuffer",m.send(null),new Uint8Array(m.response)}),B=(u,m,_)=>{var v=new XMLHttpRequest;v.open("GET",u,!0),v.responseType="arraybuffer",v.onload=()=>{v.status==200||v.status==0&&v.response?m(v.response):_()},v.onerror=_,v.send(null)}),c.print||console.log.bind(console);var Ri=c.printErr||console.warn.bind(console);Object.assign(c,x),x=null;var ti;c.wasmBinary&&(ti=c.wasmBinary),c.noExitRuntime,typeof WebAssembly!="object"&&Nt("no native wasm support detected");var qe,rs=!1,ns=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function V(u,m){if(u){var _=ne,v=u+m;for(m=u;_[m]&&!(m>=v);)++m;if(16<m-u&&_.buffer&&ns)u=ns.decode(_.subarray(u,m));else{for(v="";u<m;){var S=_[u++];if(S&128){var N=_[u++]&63;if((S&224)==192)v+=String.fromCharCode((S&31)<<6|N);else{var E=_[u++]&63;S=(S&240)==224?(S&15)<<12|N<<6|E:(S&7)<<18|N<<12|E<<6|_[u++]&63,65536>S?v+=String.fromCharCode(S):(S-=65536,v+=String.fromCharCode(55296|S>>10,56320|S&1023))}}else v+=String.fromCharCode(S)}u=v}}else u="";return u}function Gr(u,m,_,v){if(!(0<v))return 0;var S=_;v=_+v-1;for(var N=0;N<u.length;++N){var E=u.charCodeAt(N);if(55296<=E&&57343>=E){var f=u.charCodeAt(++N);E=65536+((E&1023)<<10)|f&1023}if(127>=E){if(_>=v)break;m[_++]=E}else{if(2047>=E){if(_+1>=v)break;m[_++]=192|E>>6}else{if(65535>=E){if(_+2>=v)break;m[_++]=224|E>>12}else{if(_+3>=v)break;m[_++]=240|E>>18,m[_++]=128|E>>12&63}m[_++]=128|E>>6&63}m[_++]=128|E&63}}return m[_]=0,_-S}function ii(u,m,_){return Gr(u,ne,m,_)}function si(u){for(var m=0,_=0;_<u.length;++_){var v=u.charCodeAt(_);127>=v?m++:2047>=v?m+=2:55296<=v&&57343>=v?(m+=4,++_):m+=3}return m}var Ys,dt,ne,os,ie,as,se,At;function cs(){var u=qe.buffer;Ys=u,c.HEAP8=dt=new Int8Array(u),c.HEAP16=os=new Int16Array(u),c.HEAP32=ie=new Int32Array(u),c.HEAPU8=ne=new Uint8Array(u),c.HEAPU16=new Uint16Array(u),c.HEAPU32=as=new Uint32Array(u),c.HEAPF32=se=new Float32Array(u),c.HEAPF64=At=new Float64Array(u)}var Js=[],ls=[],Xs=[];function Hr(){var u=c.preRun.shift();Js.unshift(u)}var ze=0,Je=null;function Nt(u){throw c.onAbort&&c.onAbort(u),u="Aborted("+u+")",Ri(u),rs=!0,u=new WebAssembly.RuntimeError(u+". Build with -sASSERTIONS for more info."),p(u),u}function ds(){return ye.startsWith("data:application/octet-stream;base64,")}var ye;if(ye="olm.wasm",!ds()){var Ci=ye;ye=c.locateFile?c.locateFile(Ci,C):C+Ci}function Mi(){var u=ye;try{if(u==ye&&ti)return new Uint8Array(ti);if(G)return G(u);throw"both async and sync fetching of the wasm failed"}catch(m){Nt(m)}}function Wr(){if(!ti&&(M||D)){if(typeof fetch=="function"&&!ye.startsWith("file://"))return fetch(ye,{credentials:"same-origin"}).then(function(u){if(!u.ok)throw"failed to load wasm binary file at '"+ye+"'";return u.arrayBuffer()}).catch(function(){return Mi()});if(B)return new Promise(function(u,m){B(ye,function(_){u(new Uint8Array(_))},m)})}return Promise.resolve().then(function(){return Mi()})}var us;function Qs(u){for(;0<u.length;)u.shift()(c)}function ri(u,m="i8"){switch(m.endsWith("*")&&(m="*"),m){case"i1":return dt[u>>0];case"i8":return dt[u>>0];case"i16":return os[u>>1];case"i32":return ie[u>>2];case"i64":return ie[u>>2];case"float":return se[u>>2];case"double":return At[u>>3];case"*":return as[u>>2];default:Nt("invalid type for getValue: "+m)}return null}function Ge(u){var m="i8";switch(m.endsWith("*")&&(m="*"),m){case"i1":dt[u>>0]=0;break;case"i8":dt[u>>0]=0;break;case"i16":os[u>>1]=0;break;case"i32":ie[u>>2]=0;break;case"i64":us=[0,0],ie[u>>2]=us[0],ie[u+4>>2]=us[1];break;case"float":se[u>>2]=0;break;case"double":At[u>>3]=0;break;case"*":as[u>>2]=0;break;default:Nt("invalid type for setValue: "+m)}}function rt(u,m,_){for(var v=0;v<u.length;++v)dt[m++>>0]=u.charCodeAt(v);_||(dt[m>>0]=0)}function Dt(u,m,_){return _=Array(0<_?_:si(u)+1),u=Gr(u,_,0,_.length),m&&(_.length=u),_}var Yr={b:function(u,m,_){ne.copyWithin(u,m,m+_)},a:function(u){var m=ne.length;if(u>>>=0,2147483648<u)return!1;for(var _=1;4>=_;_*=2){var v=m*(1+.2/_);v=Math.min(v,u+100663296);var S=Math;v=Math.max(u,v),S=S.min.call(S,2147483648,v+(65536-v%65536)%65536);e:{try{qe.grow(S-Ys.byteLength+65535>>>16),cs();var N=1;break e}catch{}N=void 0}if(N)return!0}return!1}};(function(){function u(S){c.asm=S.exports,qe=c.asm.c,cs(),ls.unshift(c.asm.d),ze--,c.monitorRunDependencies&&c.monitorRunDependencies(ze),ze==0&&Je&&(S=Je,Je=null,S())}function m(S){u(S.instance)}function _(S){return Wr().then(function(N){return WebAssembly.instantiate(N,v)}).then(function(N){return N}).then(S,function(N){Ri("failed to asynchronously prepare wasm: "+N),Nt(N)})}var v={a:Yr};if(ze++,c.monitorRunDependencies&&c.monitorRunDependencies(ze),c.instantiateWasm)try{return c.instantiateWasm(v,u)}catch(S){return Ri("Module.instantiateWasm callback failed with error: "+S),!1}return function(){return ti||typeof WebAssembly.instantiateStreaming!="function"||ds()||ye.startsWith("file://")||O||typeof fetch!="function"?_(m):fetch(ye,{credentials:"same-origin"}).then(function(S){return WebAssembly.instantiateStreaming(S,v).then(m,function(N){return Ri("wasm streaming compile failed: "+N),Ri("falling back to ArrayBuffer instantiation"),_(m)})})}().catch(p),{}})(),c.___wasm_call_ctors=function(){return(c.___wasm_call_ctors=c.asm.d).apply(null,arguments)},c._olm_get_library_version=function(){return(c._olm_get_library_version=c.asm.f).apply(null,arguments)},c._olm_error=function(){return(c._olm_error=c.asm.g).apply(null,arguments)},c._olm_account_last_error=function(){return(c._olm_account_last_error=c.asm.h).apply(null,arguments)},c.__olm_error_to_string=function(){return(c.__olm_error_to_string=c.asm.i).apply(null,arguments)},c._olm_account_last_error_code=function(){return(c._olm_account_last_error_code=c.asm.j).apply(null,arguments)},c._olm_session_last_error=function(){return(c._olm_session_last_error=c.asm.k).apply(null,arguments)},c._olm_session_last_error_code=function(){return(c._olm_session_last_error_code=c.asm.l).apply(null,arguments)},c._olm_utility_last_error=function(){return(c._olm_utility_last_error=c.asm.m).apply(null,arguments)},c._olm_utility_last_error_code=function(){return(c._olm_utility_last_error_code=c.asm.n).apply(null,arguments)},c._olm_account_size=function(){return(c._olm_account_size=c.asm.o).apply(null,arguments)},c._olm_session_size=function(){return(c._olm_session_size=c.asm.p).apply(null,arguments)},c._olm_utility_size=function(){return(c._olm_utility_size=c.asm.q).apply(null,arguments)},c._olm_account=function(){return(c._olm_account=c.asm.r).apply(null,arguments)},c._olm_session=function(){return(c._olm_session=c.asm.s).apply(null,arguments)},c._olm_utility=function(){return(c._olm_utility=c.asm.t).apply(null,arguments)},c._olm_clear_account=function(){return(c._olm_clear_account=c.asm.u).apply(null,arguments)},c._olm_clear_session=function(){return(c._olm_clear_session=c.asm.v).apply(null,arguments)},c._olm_clear_utility=function(){return(c._olm_clear_utility=c.asm.w).apply(null,arguments)},c._olm_pickle_account_length=function(){return(c._olm_pickle_account_length=c.asm.x).apply(null,arguments)},c._olm_pickle_session_length=function(){return(c._olm_pickle_session_length=c.asm.y).apply(null,arguments)},c._olm_pickle_account=function(){return(c._olm_pickle_account=c.asm.z).apply(null,arguments)},c._olm_pickle_session=function(){return(c._olm_pickle_session=c.asm.A).apply(null,arguments)},c._olm_unpickle_account=function(){return(c._olm_unpickle_account=c.asm.B).apply(null,arguments)},c._olm_unpickle_session=function(){return(c._olm_unpickle_session=c.asm.C).apply(null,arguments)},c._olm_create_account_random_length=function(){return(c._olm_create_account_random_length=c.asm.D).apply(null,arguments)},c._olm_create_account=function(){return(c._olm_create_account=c.asm.E).apply(null,arguments)},c._olm_account_identity_keys_length=function(){return(c._olm_account_identity_keys_length=c.asm.F).apply(null,arguments)},c._olm_account_identity_keys=function(){return(c._olm_account_identity_keys=c.asm.G).apply(null,arguments)},c._olm_account_signature_length=function(){return(c._olm_account_signature_length=c.asm.H).apply(null,arguments)},c._olm_account_sign=function(){return(c._olm_account_sign=c.asm.I).apply(null,arguments)},c._olm_account_one_time_keys_length=function(){return(c._olm_account_one_time_keys_length=c.asm.J).apply(null,arguments)},c._olm_account_one_time_keys=function(){return(c._olm_account_one_time_keys=c.asm.K).apply(null,arguments)},c._olm_account_mark_keys_as_published=function(){return(c._olm_account_mark_keys_as_published=c.asm.L).apply(null,arguments)},c._olm_account_max_number_of_one_time_keys=function(){return(c._olm_account_max_number_of_one_time_keys=c.asm.M).apply(null,arguments)},c._olm_account_generate_one_time_keys_random_length=function(){return(c._olm_account_generate_one_time_keys_random_length=c.asm.N).apply(null,arguments)},c._olm_account_generate_one_time_keys=function(){return(c._olm_account_generate_one_time_keys=c.asm.O).apply(null,arguments)},c._olm_account_generate_fallback_key_random_length=function(){return(c._olm_account_generate_fallback_key_random_length=c.asm.P).apply(null,arguments)},c._olm_account_generate_fallback_key=function(){return(c._olm_account_generate_fallback_key=c.asm.Q).apply(null,arguments)},c._olm_account_fallback_key_length=function(){return(c._olm_account_fallback_key_length=c.asm.R).apply(null,arguments)},c._olm_account_fallback_key=function(){return(c._olm_account_fallback_key=c.asm.S).apply(null,arguments)},c._olm_account_unpublished_fallback_key_length=function(){return(c._olm_account_unpublished_fallback_key_length=c.asm.T).apply(null,arguments)},c._olm_account_unpublished_fallback_key=function(){return(c._olm_account_unpublished_fallback_key=c.asm.U).apply(null,arguments)},c._olm_account_forget_old_fallback_key=function(){return(c._olm_account_forget_old_fallback_key=c.asm.V).apply(null,arguments)},c._olm_create_outbound_session_random_length=function(){return(c._olm_create_outbound_session_random_length=c.asm.W).apply(null,arguments)},c._olm_create_outbound_session=function(){return(c._olm_create_outbound_session=c.asm.X).apply(null,arguments)},c._olm_create_inbound_session=function(){return(c._olm_create_inbound_session=c.asm.Y).apply(null,arguments)},c._olm_create_inbound_session_from=function(){return(c._olm_create_inbound_session_from=c.asm.Z).apply(null,arguments)},c._olm_session_id_length=function(){return(c._olm_session_id_length=c.asm._).apply(null,arguments)},c._olm_session_id=function(){return(c._olm_session_id=c.asm.$).apply(null,arguments)},c._olm_session_has_received_message=function(){return(c._olm_session_has_received_message=c.asm.aa).apply(null,arguments)},c._olm_session_describe=function(){return(c._olm_session_describe=c.asm.ba).apply(null,arguments)},c._olm_matches_inbound_session=function(){return(c._olm_matches_inbound_session=c.asm.ca).apply(null,arguments)},c._olm_matches_inbound_session_from=function(){return(c._olm_matches_inbound_session_from=c.asm.da).apply(null,arguments)},c._olm_remove_one_time_keys=function(){return(c._olm_remove_one_time_keys=c.asm.ea).apply(null,arguments)},c._olm_encrypt_message_type=function(){return(c._olm_encrypt_message_type=c.asm.fa).apply(null,arguments)},c._olm_encrypt_random_length=function(){return(c._olm_encrypt_random_length=c.asm.ga).apply(null,arguments)},c._olm_encrypt_message_length=function(){return(c._olm_encrypt_message_length=c.asm.ha).apply(null,arguments)},c._olm_encrypt=function(){return(c._olm_encrypt=c.asm.ia).apply(null,arguments)},c._olm_decrypt_max_plaintext_length=function(){return(c._olm_decrypt_max_plaintext_length=c.asm.ja).apply(null,arguments)},c._olm_decrypt=function(){return(c._olm_decrypt=c.asm.ka).apply(null,arguments)},c._olm_sha256_length=function(){return(c._olm_sha256_length=c.asm.la).apply(null,arguments)},c._olm_sha256=function(){return(c._olm_sha256=c.asm.ma).apply(null,arguments)},c._olm_ed25519_verify=function(){return(c._olm_ed25519_verify=c.asm.na).apply(null,arguments)},c._olm_pk_encryption_last_error=function(){return(c._olm_pk_encryption_last_error=c.asm.oa).apply(null,arguments)},c._olm_pk_encryption_last_error_code=function(){return(c._olm_pk_encryption_last_error_code=c.asm.pa).apply(null,arguments)},c._olm_pk_encryption_size=function(){return(c._olm_pk_encryption_size=c.asm.qa).apply(null,arguments)},c._olm_pk_encryption=function(){return(c._olm_pk_encryption=c.asm.ra).apply(null,arguments)},c._olm_clear_pk_encryption=function(){return(c._olm_clear_pk_encryption=c.asm.sa).apply(null,arguments)},c._olm_pk_encryption_set_recipient_key=function(){return(c._olm_pk_encryption_set_recipient_key=c.asm.ta).apply(null,arguments)},c._olm_pk_key_length=function(){return(c._olm_pk_key_length=c.asm.ua).apply(null,arguments)},c._olm_pk_ciphertext_length=function(){return(c._olm_pk_ciphertext_length=c.asm.va).apply(null,arguments)},c._olm_pk_mac_length=function(){return(c._olm_pk_mac_length=c.asm.wa).apply(null,arguments)},c._olm_pk_encrypt_random_length=function(){return(c._olm_pk_encrypt_random_length=c.asm.xa).apply(null,arguments)},c._olm_pk_encrypt=function(){return(c._olm_pk_encrypt=c.asm.ya).apply(null,arguments)},c._olm_pk_decryption_last_error=function(){return(c._olm_pk_decryption_last_error=c.asm.za).apply(null,arguments)},c._olm_pk_decryption_last_error_code=function(){return(c._olm_pk_decryption_last_error_code=c.asm.Aa).apply(null,arguments)},c._olm_pk_decryption_size=function(){return(c._olm_pk_decryption_size=c.asm.Ba).apply(null,arguments)},c._olm_pk_decryption=function(){return(c._olm_pk_decryption=c.asm.Ca).apply(null,arguments)},c._olm_clear_pk_decryption=function(){return(c._olm_clear_pk_decryption=c.asm.Da).apply(null,arguments)},c._olm_pk_private_key_length=function(){return(c._olm_pk_private_key_length=c.asm.Ea).apply(null,arguments)},c._olm_pk_generate_key_random_length=function(){return(c._olm_pk_generate_key_random_length=c.asm.Fa).apply(null,arguments)},c._olm_pk_key_from_private=function(){return(c._olm_pk_key_from_private=c.asm.Ga).apply(null,arguments)},c._olm_pk_generate_key=function(){return(c._olm_pk_generate_key=c.asm.Ha).apply(null,arguments)},c._olm_pickle_pk_decryption_length=function(){return(c._olm_pickle_pk_decryption_length=c.asm.Ia).apply(null,arguments)},c._olm_pickle_pk_decryption=function(){return(c._olm_pickle_pk_decryption=c.asm.Ja).apply(null,arguments)},c._olm_unpickle_pk_decryption=function(){return(c._olm_unpickle_pk_decryption=c.asm.Ka).apply(null,arguments)},c._olm_pk_max_plaintext_length=function(){return(c._olm_pk_max_plaintext_length=c.asm.La).apply(null,arguments)},c._olm_pk_decrypt=function(){return(c._olm_pk_decrypt=c.asm.Ma).apply(null,arguments)},c._olm_pk_get_private_key=function(){return(c._olm_pk_get_private_key=c.asm.Na).apply(null,arguments)},c._olm_pk_signing_size=function(){return(c._olm_pk_signing_size=c.asm.Oa).apply(null,arguments)},c._olm_pk_signing=function(){return(c._olm_pk_signing=c.asm.Pa).apply(null,arguments)},c._olm_pk_signing_last_error=function(){return(c._olm_pk_signing_last_error=c.asm.Qa).apply(null,arguments)},c._olm_pk_signing_last_error_code=function(){return(c._olm_pk_signing_last_error_code=c.asm.Ra).apply(null,arguments)},c._olm_clear_pk_signing=function(){return(c._olm_clear_pk_signing=c.asm.Sa).apply(null,arguments)},c._olm_pk_signing_seed_length=function(){return(c._olm_pk_signing_seed_length=c.asm.Ta).apply(null,arguments)},c._olm_pk_signing_public_key_length=function(){return(c._olm_pk_signing_public_key_length=c.asm.Ua).apply(null,arguments)},c._olm_pk_signing_key_from_seed=function(){return(c._olm_pk_signing_key_from_seed=c.asm.Va).apply(null,arguments)},c._olm_pk_signature_length=function(){return(c._olm_pk_signature_length=c.asm.Wa).apply(null,arguments)},c._olm_pk_sign=function(){return(c._olm_pk_sign=c.asm.Xa).apply(null,arguments)},c._olm_inbound_group_session_size=function(){return(c._olm_inbound_group_session_size=c.asm.Ya).apply(null,arguments)},c._olm_inbound_group_session=function(){return(c._olm_inbound_group_session=c.asm.Za).apply(null,arguments)},c._olm_clear_inbound_group_session=function(){return(c._olm_clear_inbound_group_session=c.asm._a).apply(null,arguments)},c._olm_inbound_group_session_last_error=function(){return(c._olm_inbound_group_session_last_error=c.asm.$a).apply(null,arguments)},c._olm_inbound_group_session_last_error_code=function(){return(c._olm_inbound_group_session_last_error_code=c.asm.ab).apply(null,arguments)},c._olm_init_inbound_group_session=function(){return(c._olm_init_inbound_group_session=c.asm.bb).apply(null,arguments)},c._olm_import_inbound_group_session=function(){return(c._olm_import_inbound_group_session=c.asm.cb).apply(null,arguments)},c._olm_pickle_inbound_group_session_length=function(){return(c._olm_pickle_inbound_group_session_length=c.asm.db).apply(null,arguments)},c._olm_pickle_inbound_group_session=function(){return(c._olm_pickle_inbound_group_session=c.asm.eb).apply(null,arguments)},c._olm_unpickle_inbound_group_session=function(){return(c._olm_unpickle_inbound_group_session=c.asm.fb).apply(null,arguments)},c._olm_group_decrypt_max_plaintext_length=function(){return(c._olm_group_decrypt_max_plaintext_length=c.asm.gb).apply(null,arguments)},c._olm_group_decrypt=function(){return(c._olm_group_decrypt=c.asm.hb).apply(null,arguments)},c._olm_inbound_group_session_id_length=function(){return(c._olm_inbound_group_session_id_length=c.asm.ib).apply(null,arguments)},c._olm_inbound_group_session_id=function(){return(c._olm_inbound_group_session_id=c.asm.jb).apply(null,arguments)},c._olm_inbound_group_session_first_known_index=function(){return(c._olm_inbound_group_session_first_known_index=c.asm.kb).apply(null,arguments)},c._olm_inbound_group_session_is_verified=function(){return(c._olm_inbound_group_session_is_verified=c.asm.lb).apply(null,arguments)},c._olm_export_inbound_group_session_length=function(){return(c._olm_export_inbound_group_session_length=c.asm.mb).apply(null,arguments)},c._olm_export_inbound_group_session=function(){return(c._olm_export_inbound_group_session=c.asm.nb).apply(null,arguments)},c._olm_outbound_group_session_size=function(){return(c._olm_outbound_group_session_size=c.asm.ob).apply(null,arguments)},c._olm_outbound_group_session=function(){return(c._olm_outbound_group_session=c.asm.pb).apply(null,arguments)},c._olm_clear_outbound_group_session=function(){return(c._olm_clear_outbound_group_session=c.asm.qb).apply(null,arguments)},c._olm_outbound_group_session_last_error=function(){return(c._olm_outbound_group_session_last_error=c.asm.rb).apply(null,arguments)},c._olm_outbound_group_session_last_error_code=function(){return(c._olm_outbound_group_session_last_error_code=c.asm.sb).apply(null,arguments)},c._olm_pickle_outbound_group_session_length=function(){return(c._olm_pickle_outbound_group_session_length=c.asm.tb).apply(null,arguments)},c._olm_pickle_outbound_group_session=function(){return(c._olm_pickle_outbound_group_session=c.asm.ub).apply(null,arguments)},c._olm_unpickle_outbound_group_session=function(){return(c._olm_unpickle_outbound_group_session=c.asm.vb).apply(null,arguments)},c._olm_init_outbound_group_session_random_length=function(){return(c._olm_init_outbound_group_session_random_length=c.asm.wb).apply(null,arguments)},c._olm_init_outbound_group_session=function(){return(c._olm_init_outbound_group_session=c.asm.xb).apply(null,arguments)},c._olm_group_encrypt_message_length=function(){return(c._olm_group_encrypt_message_length=c.asm.yb).apply(null,arguments)},c._olm_group_encrypt=function(){return(c._olm_group_encrypt=c.asm.zb).apply(null,arguments)},c._olm_outbound_group_session_id_length=function(){return(c._olm_outbound_group_session_id_length=c.asm.Ab).apply(null,arguments)},c._olm_outbound_group_session_id=function(){return(c._olm_outbound_group_session_id=c.asm.Bb).apply(null,arguments)},c._olm_outbound_group_session_message_index=function(){return(c._olm_outbound_group_session_message_index=c.asm.Cb).apply(null,arguments)},c._olm_outbound_group_session_key_length=function(){return(c._olm_outbound_group_session_key_length=c.asm.Db).apply(null,arguments)},c._olm_outbound_group_session_key=function(){return(c._olm_outbound_group_session_key=c.asm.Eb).apply(null,arguments)},c._olm_sas_last_error=function(){return(c._olm_sas_last_error=c.asm.Fb).apply(null,arguments)},c._olm_sas_last_error_code=function(){return(c._olm_sas_last_error_code=c.asm.Gb).apply(null,arguments)},c._olm_sas_size=function(){return(c._olm_sas_size=c.asm.Hb).apply(null,arguments)},c._olm_sas=function(){return(c._olm_sas=c.asm.Ib).apply(null,arguments)},c._olm_clear_sas=function(){return(c._olm_clear_sas=c.asm.Jb).apply(null,arguments)},c._olm_create_sas_random_length=function(){return(c._olm_create_sas_random_length=c.asm.Kb).apply(null,arguments)},c._olm_create_sas=function(){return(c._olm_create_sas=c.asm.Lb).apply(null,arguments)},c._olm_sas_pubkey_length=function(){return(c._olm_sas_pubkey_length=c.asm.Mb).apply(null,arguments)},c._olm_sas_get_pubkey=function(){return(c._olm_sas_get_pubkey=c.asm.Nb).apply(null,arguments)},c._olm_sas_set_their_key=function(){return(c._olm_sas_set_their_key=c.asm.Ob).apply(null,arguments)},c._olm_sas_is_their_key_set=function(){return(c._olm_sas_is_their_key_set=c.asm.Pb).apply(null,arguments)},c._olm_sas_generate_bytes=function(){return(c._olm_sas_generate_bytes=c.asm.Qb).apply(null,arguments)},c._olm_sas_mac_length=function(){return(c._olm_sas_mac_length=c.asm.Rb).apply(null,arguments)},c._olm_sas_calculate_mac_fixed_base64=function(){return(c._olm_sas_calculate_mac_fixed_base64=c.asm.Sb).apply(null,arguments)},c._olm_sas_calculate_mac=function(){return(c._olm_sas_calculate_mac=c.asm.Tb).apply(null,arguments)},c._olm_sas_calculate_mac_long_kdf=function(){return(c._olm_sas_calculate_mac_long_kdf=c.asm.Ub).apply(null,arguments)},c._malloc=function(){return(c._malloc=c.asm.Vb).apply(null,arguments)},c._free=function(){return(c._free=c.asm.Wb).apply(null,arguments)};var Zs=c.stackSave=function(){return(Zs=c.stackSave=c.asm.Xb).apply(null,arguments)},er=c.stackRestore=function(){return(er=c.stackRestore=c.asm.Yb).apply(null,arguments)},hs=c.stackAlloc=function(){return(hs=c.stackAlloc=c.asm.Zb).apply(null,arguments)};c.UTF8ToString=V,c.stringToUTF8=ii,c.intArrayFromString=Dt,c.writeAsciiToMemory=rt,c.ALLOC_STACK=1;var Ai;Je=function u(){Ai||Ni(),Ai||(Je=u)};function Ni(){function u(){if(!Ai&&(Ai=!0,c.calledRun=!0,!rs)){if(Qs(ls),h(c),c.onRuntimeInitialized&&c.onRuntimeInitialized(),c.postRun)for(typeof c.postRun=="function"&&(c.postRun=[c.postRun]);c.postRun.length;){var m=c.postRun.shift();Xs.unshift(m)}Qs(Xs)}}if(!(0<ze)){if(c.preRun)for(typeof c.preRun=="function"&&(c.preRun=[c.preRun]);c.preRun.length;)Hr();Qs(Js),0<ze||(c.setStatus?(c.setStatus("Running..."),setTimeout(function(){setTimeout(function(){c.setStatus("")},1),u()},1)):u())}}if(c.preInit)for(typeof c.preInit=="function"&&(c.preInit=[c.preInit]);0<c.preInit.length;)c.preInit.pop()();Ni();function He(){var u=c._olm_outbound_group_session_size();this.ac=Z(u),this.$b=c._olm_outbound_group_session(this.ac)}function le(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_outbound_group_session_last_error(arguments[0])),Error("OLM."+m);return m}}He.prototype.free=function(){c._olm_clear_outbound_group_session(this.$b),Y(this.$b)},He.prototype.pickle=A(function(u){u=F(u);var m=le(c._olm_pickle_outbound_group_session_length)(this.$b),_=R(u),v=R(m+1);try{le(c._olm_pickle_outbound_group_session)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),He.prototype.unpickle=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m);try{le(c._olm_unpickle_outbound_group_session)(this.$b,_,u.length,v,m.length)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}}),He.prototype.create=A(function(){var u=le(c._olm_init_outbound_group_session_random_length)(this.$b),m=Fe(u,g);try{le(c._olm_init_outbound_group_session)(this.$b,m,u)}finally{K(m,u)}}),He.prototype.encrypt=function(u){try{var m=si(u),_=le(c._olm_group_encrypt_message_length)(this.$b,m),v=Z(m+1);ii(u,v,m+1);var S=Z(_+1);return le(c._olm_group_encrypt)(this.$b,v,m,S,_),Ge(S+_),V(S,_)}finally{v!==void 0&&(K(v,m+1),Y(v)),S!==void 0&&Y(S)}},He.prototype.session_id=A(function(){var u=le(c._olm_outbound_group_session_id_length)(this.$b),m=R(u+1);return le(c._olm_outbound_group_session_id)(this.$b,m,u),V(m,u)}),He.prototype.session_key=A(function(){var u=le(c._olm_outbound_group_session_key_length)(this.$b),m=R(u+1);le(c._olm_outbound_group_session_key)(this.$b,m,u);var _=V(m,u);return K(m,u),_}),He.prototype.message_index=function(){return le(c._olm_outbound_group_session_message_index)(this.$b)},i.OutboundGroupSession=He;function xe(){var u=c._olm_inbound_group_session_size();this.ac=Z(u),this.$b=c._olm_inbound_group_session(this.ac)}function Oe(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_inbound_group_session_last_error(arguments[0])),Error("OLM."+m);return m}}xe.prototype.free=function(){c._olm_clear_inbound_group_session(this.$b),Y(this.$b)},xe.prototype.pickle=A(function(u){u=F(u);var m=Oe(c._olm_pickle_inbound_group_session_length)(this.$b),_=R(u),v=R(m+1);try{Oe(c._olm_pickle_inbound_group_session)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),xe.prototype.unpickle=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m);try{Oe(c._olm_unpickle_inbound_group_session)(this.$b,_,u.length,v,m.length)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}}),xe.prototype.create=A(function(u){u=F(u);var m=R(u);try{Oe(c._olm_init_inbound_group_session)(this.$b,m,u.length)}finally{for(K(m,u.length),m=0;m<u.length;m++)u[m]=0}}),xe.prototype.import_session=A(function(u){u=F(u);var m=R(u);try{Oe(c._olm_import_inbound_group_session)(this.$b,m,u.length)}finally{for(K(m,u.length),m=0;m<u.length;m++)u[m]=0}}),xe.prototype.decrypt=A(function(u){try{var m=Z(u.length);rt(u,m,!0);var _=Oe(c._olm_group_decrypt_max_plaintext_length)(this.$b,m,u.length);rt(u,m,!0);var v=Z(_+1),S=R(4),N=Oe(c._olm_group_decrypt)(this.$b,m,u.length,v,_,S);return Ge(v+N),{plaintext:V(v,N),message_index:ri(S,"i32")}}finally{m!==void 0&&Y(m),v!==void 0&&(K(v,N),Y(v))}}),xe.prototype.session_id=A(function(){var u=Oe(c._olm_inbound_group_session_id_length)(this.$b),m=R(u+1);return Oe(c._olm_inbound_group_session_id)(this.$b,m,u),V(m,u)}),xe.prototype.first_known_index=A(function(){return Oe(c._olm_inbound_group_session_first_known_index)(this.$b)}),xe.prototype.export_session=A(function(u){var m=Oe(c._olm_export_inbound_group_session_length)(this.$b),_=R(m+1);return le(c._olm_export_inbound_group_session)(this.$b,_,m,u),u=V(_,m),K(_,m),u}),i.InboundGroupSession=xe;function ni(){var u=c._olm_pk_encryption_size();this.ac=Z(u),this.$b=c._olm_pk_encryption(this.ac)}function Vt(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_pk_encryption_last_error(arguments[0])),Error("OLM."+m);return m}}ni.prototype.free=function(){c._olm_clear_pk_encryption(this.$b),Y(this.$b)},ni.prototype.set_recipient_key=A(function(u){u=F(u);var m=R(u);Vt(c._olm_pk_encryption_set_recipient_key)(this.$b,m,u.length)}),ni.prototype.encrypt=A(function(u){try{var m=si(u),_=Z(m+1);ii(u,_,m+1);var v=Vt(c._olm_pk_encrypt_random_length)(),S=Fe(v,g),N=Vt(c._olm_pk_ciphertext_length)(this.$b,m),E=Z(N+1),f=Vt(c._olm_pk_mac_length)(this.$b),b=R(f+1);Ge(b+f);var I=Vt(c._olm_pk_key_length)(),L=R(I+1);return Ge(L+I),Vt(c._olm_pk_encrypt)(this.$b,_,m,E,N,b,f,L,I,S,v),Ge(E+N),{ciphertext:V(E,N),mac:V(b,f),ephemeral:V(L,I)}}finally{S!==void 0&&K(S,v),_!==void 0&&(K(_,m+1),Y(_)),E!==void 0&&Y(E)}});function Me(){var u=c._olm_pk_decryption_size();this.ac=Z(u),this.$b=c._olm_pk_decryption(this.ac)}function We(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_pk_decryption_last_error(arguments[0])),Error("OLM."+m);return m}}Me.prototype.free=function(){c._olm_clear_pk_decryption(this.$b),Y(this.$b)},Me.prototype.init_with_private_key=A(function(u){var m=R(u.length);c.HEAPU8.set(u,m);var _=We(c._olm_pk_key_length)(),v=R(_+1);try{We(c._olm_pk_key_from_private)(this.$b,v,_,m,u.length)}finally{K(m,u.length)}return V(v,_)}),Me.prototype.generate_key=A(function(){var u=We(c._olm_pk_private_key_length)(),m=Fe(u,g),_=We(c._olm_pk_key_length)(),v=R(_+1);try{We(c._olm_pk_key_from_private)(this.$b,v,_,m,u)}finally{K(m,u)}return V(v,_)}),Me.prototype.get_private_key=A(function(){var u=Vt(c._olm_pk_private_key_length)(),m=R(u);We(c._olm_pk_get_private_key)(this.$b,m,u);var _=new Uint8Array(new Uint8Array(c.HEAPU8.buffer,m,u));return K(m,u),_}),Me.prototype.pickle=A(function(u){u=F(u);var m=We(c._olm_pickle_pk_decryption_length)(this.$b),_=R(u),v=R(m+1);try{We(c._olm_pickle_pk_decryption)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),Me.prototype.unpickle=A(function(u,m){u=F(u);var _=R(u),v=F(m),S=R(v);m=We(c._olm_pk_key_length)();var N=R(m+1);try{We(c._olm_unpickle_pk_decryption)(this.$b,_,u.length,S,v.length,N,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(N,m)}),Me.prototype.decrypt=A(function(u,m,_){try{var v=si(_),S=Z(v+1);ii(_,S,v+1);var N=F(u),E=R(N),f=F(m),b=R(f),I=We(c._olm_pk_max_plaintext_length)(this.$b,v),L=Z(I+1),ke=We(c._olm_pk_decrypt)(this.$b,E,N.length,b,f.length,S,v,L,I);return Ge(L+ke),V(L,ke)}finally{L!==void 0&&(K(L,ke+1),Y(L)),S!==void 0&&Y(S)}});function Di(){var u=c._olm_pk_signing_size();this.ac=Z(u),this.$b=c._olm_pk_signing(this.ac)}function oe(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_pk_signing_last_error(arguments[0])),Error("OLM."+m);return m}}Di.prototype.free=function(){c._olm_clear_pk_signing(this.$b),Y(this.$b)},Di.prototype.init_with_seed=A(function(u){var m=R(u.length);c.HEAPU8.set(u,m);var _=oe(c._olm_pk_signing_public_key_length)(),v=R(_+1);try{oe(c._olm_pk_signing_key_from_seed)(this.$b,v,_,m,u.length)}finally{K(m,u.length)}return V(v,_)}),Di.prototype.generate_seed=A(function(){var u=oe(c._olm_pk_signing_seed_length)(),m=Fe(u,g),_=new Uint8Array(new Uint8Array(c.HEAPU8.buffer,m,u));return K(m,u),_}),Di.prototype.sign=A(function(u){try{var m=si(u),_=Z(m+1);ii(u,_,m+1);var v=oe(c._olm_pk_signature_length)(),S=R(v+1);return oe(c._olm_pk_sign)(this.$b,_,m,S,v),V(S,v)}finally{_!==void 0&&(K(_,m+1),Y(_))}});function Ae(){var u=c._olm_sas_size(),m=c._olm_create_sas_random_length(),_=Fe(m,g);this.ac=Z(u),this.$b=c._olm_sas(this.ac),c._olm_create_sas(this.$b,_,m),K(_,m)}function Xe(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_sas_last_error(arguments[0])),Error("OLM."+m);return m}}Ae.prototype.free=function(){c._olm_clear_sas(this.$b),Y(this.$b)},Ae.prototype.get_pubkey=A(function(){var u=Xe(c._olm_sas_pubkey_length)(this.$b),m=R(u+1);return Xe(c._olm_sas_get_pubkey)(this.$b,m,u),V(m,u)}),Ae.prototype.set_their_key=A(function(u){u=F(u);var m=R(u);Xe(c._olm_sas_set_their_key)(this.$b,m,u.length)}),Ae.prototype.is_their_key_set=A(function(){return!!Xe(c._olm_sas_is_their_key_set)(this.$b)}),Ae.prototype.generate_bytes=A(function(u,m){u=F(u);var _=R(u),v=R(m);return Xe(c._olm_sas_generate_bytes)(this.$b,_,u.length,v,m),new Uint8Array(new Uint8Array(c.HEAPU8.buffer,v,m))}),Ae.prototype.calculate_mac=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m),S=Xe(c._olm_sas_mac_length)(this.$b),N=R(S+1);return Xe(c._olm_sas_calculate_mac)(this.$b,_,u.length,v,m.length,N,S),V(N,S)}),Ae.prototype.calculate_mac_fixed_base64=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m),S=Xe(c._olm_sas_mac_length)(this.$b),N=R(S+1);return Xe(c._olm_sas_calculate_mac_fixed_base64)(this.$b,_,u.length,v,m.length,N,S),V(N,S)}),Ae.prototype.calculate_mac_long_kdf=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m),S=Xe(c._olm_sas_mac_length)(this.$b),N=R(S+1);return Xe(c._olm_sas_calculate_mac_long_kdf)(this.$b,_,u.length,v,m.length,N,S),V(N,S)});var Z=c._malloc,Y=c._free,Qe;function Fe(u,m){var _=hs(u);return m(new Uint8Array(c.HEAPU8.buffer,_,u)),_}function R(u){return typeof u=="number"?Fe(u,function(m){m.fill(0)}):Fe(u.length,function(m){m.set(u)})}function F(u){return u instanceof Uint8Array?u:Dt(u,!0)}function A(u){return function(){var m=Zs();try{return u.apply(this,arguments)}finally{er(m)}}}function K(u,m){for(;0<m--;)c.HEAP8[u++]=0}function ee(){var u=c._olm_account_size();this.ac=Z(u),this.$b=c._olm_account(this.ac)}function J(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_account_last_error(arguments[0])),Error("OLM."+m);return m}}ee.prototype.free=function(){c._olm_clear_account(this.$b),Y(this.$b)},ee.prototype.create=A(function(){var u=J(c._olm_create_account_random_length)(this.$b),m=Fe(u,g);try{J(c._olm_create_account)(this.$b,m,u)}finally{K(m,u)}}),ee.prototype.identity_keys=A(function(){var u=J(c._olm_account_identity_keys_length)(this.$b),m=R(u+1);return J(c._olm_account_identity_keys)(this.$b,m,u),V(m,u)}),ee.prototype.sign=A(function(u){var m=J(c._olm_account_signature_length)(this.$b);u=F(u);var _=R(u),v=R(m+1);try{J(c._olm_account_sign)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),ee.prototype.one_time_keys=A(function(){var u=J(c._olm_account_one_time_keys_length)(this.$b),m=R(u+1);return J(c._olm_account_one_time_keys)(this.$b,m,u),V(m,u)}),ee.prototype.mark_keys_as_published=A(function(){J(c._olm_account_mark_keys_as_published)(this.$b)}),ee.prototype.max_number_of_one_time_keys=A(function(){return J(c._olm_account_max_number_of_one_time_keys)(this.$b)}),ee.prototype.generate_one_time_keys=A(function(u){var m=J(c._olm_account_generate_one_time_keys_random_length)(this.$b,u),_=Fe(m,g);try{J(c._olm_account_generate_one_time_keys)(this.$b,u,_,m)}finally{K(_,m)}}),ee.prototype.remove_one_time_keys=A(function(u){J(c._olm_remove_one_time_keys)(this.$b,u.$b)}),ee.prototype.generate_fallback_key=A(function(){var u=J(c._olm_account_generate_fallback_key_random_length)(this.$b),m=Fe(u,g);try{J(c._olm_account_generate_fallback_key)(this.$b,m,u)}finally{K(m,u)}}),ee.prototype.fallback_key=A(function(){var u=J(c._olm_account_fallback_key_length)(this.$b),m=R(u+1);return J(c._olm_account_fallback_key)(this.$b,m,u),V(m,u)}),ee.prototype.unpublished_fallback_key=A(function(){var u=J(c._olm_account_unpublished_fallback_key_length)(this.$b),m=R(u+1);return J(c._olm_account_unpublished_fallback_key)(this.$b,m,u),V(m,u)}),ee.prototype.forget_old_fallback_key=A(function(){J(c._olm_account_forget_old_fallback_key)(this.$b)}),ee.prototype.pickle=A(function(u){u=F(u);var m=J(c._olm_pickle_account_length)(this.$b),_=R(u),v=R(m+1);try{J(c._olm_pickle_account)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),ee.prototype.unpickle=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m);try{J(c._olm_unpickle_account)(this.$b,_,u.length,v,m.length)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}});function Te(){var u=c._olm_session_size();this.ac=Z(u),this.$b=c._olm_session(this.ac)}function ue(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_session_last_error(arguments[0])),Error("OLM."+m);return m}}Te.prototype.free=function(){c._olm_clear_session(this.$b),Y(this.$b)},Te.prototype.pickle=A(function(u){u=F(u);var m=ue(c._olm_pickle_session_length)(this.$b),_=R(u),v=R(m+1);try{ue(c._olm_pickle_session)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),Te.prototype.unpickle=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m);try{ue(c._olm_unpickle_session)(this.$b,_,u.length,v,m.length)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}}),Te.prototype.create_outbound=A(function(u,m,_){var v=ue(c._olm_create_outbound_session_random_length)(this.$b),S=Fe(v,g);m=F(m),_=F(_);var N=R(m),E=R(_);try{ue(c._olm_create_outbound_session)(this.$b,u.$b,N,m.length,E,_.length,S,v)}finally{K(S,v)}}),Te.prototype.create_inbound=A(function(u,m){m=F(m);var _=R(m);try{ue(c._olm_create_inbound_session)(this.$b,u.$b,_,m.length)}finally{for(K(_,m.length),u=0;u<m.length;u++)m[u]=0}}),Te.prototype.create_inbound_from=A(function(u,m,_){m=F(m);var v=R(m);_=F(_);var S=R(_);try{ue(c._olm_create_inbound_session_from)(this.$b,u.$b,v,m.length,S,_.length)}finally{for(K(S,_.length),u=0;u<_.length;u++)_[u]=0}}),Te.prototype.session_id=A(function(){var u=ue(c._olm_session_id_length)(this.$b),m=R(u+1);return ue(c._olm_session_id)(this.$b,m,u),V(m,u)}),Te.prototype.has_received_message=function(){return!!ue(c._olm_session_has_received_message)(this.$b)},Te.prototype.matches_inbound=A(function(u){u=F(u);var m=R(u);return!!ue(c._olm_matches_inbound_session)(this.$b,m,u.length)}),Te.prototype.matches_inbound_from=A(function(u,m){u=F(u);var _=R(u);m=F(m);var v=R(m);return!!ue(c._olm_matches_inbound_session_from)(this.$b,_,u.length,v,m.length)}),Te.prototype.encrypt=A(function(u){try{var m=ue(c._olm_encrypt_random_length)(this.$b),_=ue(c._olm_encrypt_message_type)(this.$b),v=si(u),S=ue(c._olm_encrypt_message_length)(this.$b,v),N=Fe(m,g),E=Z(v+1);ii(u,E,v+1);var f=Z(S+1);return ue(c._olm_encrypt)(this.$b,E,v,N,m,f,S),Ge(f+S),{type:_,body:V(f,S)}}finally{N!==void 0&&K(N,m),E!==void 0&&(K(E,v+1),Y(E)),f!==void 0&&Y(f)}}),Te.prototype.decrypt=A(function(u,m){try{var _=Z(m.length);rt(m,_,!0);var v=ue(c._olm_decrypt_max_plaintext_length)(this.$b,u,_,m.length);rt(m,_,!0);var S=Z(v+1),N=ue(c._olm_decrypt)(this.$b,u,_,m.length,S,v);return Ge(S+N),V(S,N)}finally{_!==void 0&&Y(_),S!==void 0&&(K(S,v),Y(S))}}),Te.prototype.describe=A(function(){try{var u=Z(256);return ue(c._olm_session_describe)(this.$b,u,256),V(u)}finally{u!==void 0&&Y(u)}});function ms(){var u=c._olm_utility_size();this.ac=Z(u),this.$b=c._olm_utility(this.ac)}function Ut(u){return function(){var m=u.apply(this,arguments);if(m===Qe)throw m=V(c._olm_utility_last_error(arguments[0])),Error("OLM."+m);return m}}return ms.prototype.free=function(){c._olm_clear_utility(this.$b),Y(this.$b)},ms.prototype.sha256=A(function(u){var m=Ut(c._olm_sha256_length)(this.$b);u=F(u);var _=R(u),v=R(m+1);try{Ut(c._olm_sha256)(this.$b,_,u.length,v,m)}finally{for(K(_,u.length),_=0;_<u.length;_++)u[_]=0}return V(v,m)}),ms.prototype.ed25519_verify=A(function(u,m,_){u=F(u);var v=R(u);m=F(m);var S=R(m);_=F(_);var N=R(_);try{Ut(c._olm_ed25519_verify)(this.$b,v,u.length,S,m.length,N,_.length)}finally{for(K(S,m.length),u=0;u<m.length;u++)m[u]=0}}),i.Account=ee,i.Session=Te,i.Utility=ms,i.PkEncryption=ni,i.PkDecryption=Me,i.PkSigning=Di,i.SAS=Ae,i.get_library_version=A(function(){var u=R(3);return c._olm_get_library_version(u,u+1,u+2),[ri(u,"i8"),ri(u+1,"i8"),ri(u+2,"i8")]}),d.ready}})();r.exports=o;var a;return i.init=function(l){return a||(l&&(OLM_OPTIONS=l),a=new Promise(function(d,c){s=function(){d()},n=function(h){c(h)},o()}),a)},i}();typeof window<"u"&&(window.Olm=t),r.exports=t;// @license-end
})(dh);var zi={};(function(){for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<r.length;t++)e[r.charCodeAt(t)]=t;zi.encode=function(i){var s=new Uint8Array(i),n,o=s.length,a="";for(n=0;n<o;n+=3)a+=r[s[n]>>2],a+=r[(s[n]&3)<<4|s[n+1]>>4],a+=r[(s[n+1]&15)<<2|s[n+2]>>6],a+=r[s[n+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},zi.decode=function(i){var s=i.length*.75,n=i.length,o,a=0,l,d,c,h;i[i.length-1]==="="&&(s--,i[i.length-2]==="="&&s--);var p=new ArrayBuffer(s),g=new Uint8Array(p);for(o=0;o<n;o+=4)l=e[i.charCodeAt(o)],d=e[i.charCodeAt(o+1)],c=e[i.charCodeAt(o+2)],h=e[i.charCodeAt(o+3)],g[a++]=l<<2|d>>4,g[a++]=(d&15)<<4|c>>2,g[a++]=(c&3)<<6|h&63;return p}})();/*! @license DOMPurify 2.4.7 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.4.7/LICENSE */function li(r){return li=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},li(r)}function Do(r,e){return Do=Object.setPrototypeOf||function(i,s){return i.__proto__=s,i},Do(r,e)}function mh(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function In(r,e,t){return mh()?In=Reflect.construct:In=function(s,n,o){var a=[null];a.push.apply(a,n);var l=Function.bind.apply(s,a),d=new l;return o&&Do(d,o.prototype),d},In.apply(null,arguments)}function ht(r){return ph(r)||_h(r)||fh(r)||gh()}function ph(r){if(Array.isArray(r))return Vo(r)}function _h(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function fh(r,e){if(!!r){if(typeof r=="string")return Vo(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Vo(r,e)}}function Vo(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function gh(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var yh=Object.hasOwnProperty,ec=Object.setPrototypeOf,vh=Object.isFrozen,wh=Object.getPrototypeOf,bh=Object.getOwnPropertyDescriptor,je=Object.freeze,gt=Object.seal,Sh=Object.create,Al=typeof Reflect<"u"&&Reflect,Vn=Al.apply,Uo=Al.construct;Vn||(Vn=function(e,t,i){return e.apply(t,i)});je||(je=function(e){return e});gt||(gt=function(e){return e});Uo||(Uo=function(e,t){return In(e,ht(t))});var Eh=ct(Array.prototype.forEach),tc=ct(Array.prototype.pop),tr=ct(Array.prototype.push),xn=ct(String.prototype.toLowerCase),uo=ct(String.prototype.toString),kh=ct(String.prototype.match),ut=ct(String.prototype.replace),Ih=ct(String.prototype.indexOf),xh=ct(String.prototype.trim),Le=ct(RegExp.prototype.test),ho=Th(TypeError);function ct(r){return function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),s=1;s<t;s++)i[s-1]=arguments[s];return Vn(r,e,i)}}function Th(r){return function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Uo(r,t)}}function $(r,e,t){var i;t=(i=t)!==null&&i!==void 0?i:xn,ec&&ec(r,null);for(var s=e.length;s--;){var n=e[s];if(typeof n=="string"){var o=t(n);o!==n&&(vh(e)||(e[s]=o),n=o)}r[n]=!0}return r}function Vi(r){var e=Sh(null),t;for(t in r)Vn(yh,r,[t])===!0&&(e[t]=r[t]);return e}function Zr(r,e){for(;r!==null;){var t=bh(r,e);if(t){if(t.get)return ct(t.get);if(typeof t.value=="function")return ct(t.value)}r=wh(r)}function i(s){return console.warn("fallback value for",s),null}return i}var ic=je(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),mo=je(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),po=je(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Rh=je(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),_o=je(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),Ch=je(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),sc=je(["#text"]),rc=je(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),fo=je(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),nc=je(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),en=je(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Mh=gt(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Ah=gt(/<%[\w\W]*|[\w\W]*%>/gm),Nh=gt(/\${[\w\W]*}/gm),Dh=gt(/^data-[\-\w.\u00B7-\uFFFF]/),Vh=gt(/^aria-[\-\w]+$/),Uh=gt(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Ph=gt(/^(?:\w+script|data):/i),Oh=gt(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Fh=gt(/^html$/i),Lh=function(){return typeof window>"u"?null:window},Bh=function(e,t){if(li(e)!=="object"||typeof e.createPolicy!="function")return null;var i=null,s="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(s)&&(i=t.currentScript.getAttribute(s));var n="dompurify"+(i?"#"+i:"");try{return e.createPolicy(n,{createHTML:function(a){return a},createScriptURL:function(a){return a}})}catch{return console.warn("TrustedTypes policy "+n+" could not be created."),null}};function Nl(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Lh(),e=function(f){return Nl(f)};if(e.version="2.4.7",e.removed=[],!r||!r.document||r.document.nodeType!==9)return e.isSupported=!1,e;var t=r.document,i=r.document,s=r.DocumentFragment,n=r.HTMLTemplateElement,o=r.Node,a=r.Element,l=r.NodeFilter,d=r.NamedNodeMap,c=d===void 0?r.NamedNodeMap||r.MozNamedAttrMap:d,h=r.HTMLFormElement,p=r.DOMParser,g=r.trustedTypes,y=a.prototype,w=Zr(y,"cloneNode"),x=Zr(y,"nextSibling"),M=Zr(y,"childNodes"),D=Zr(y,"parentNode");if(typeof n=="function"){var O=i.createElement("template");O.content&&O.content.ownerDocument&&(i=O.content.ownerDocument)}var C=Bh(g,t),U=C?C.createHTML(""):"",B=i,G=B.implementation,wt=B.createNodeIterator,ss=B.createDocumentFragment,Ws=B.getElementsByTagName,Ri=t.importNode,ti={};try{ti=Vi(i).documentMode?i.documentMode:{}}catch{}var qe={};e.isSupported=typeof D=="function"&&G&&G.createHTMLDocument!==void 0&&ti!==9;var rs=Mh,ns=Ah,V=Nh,Gr=Dh,ii=Vh,si=Ph,Ys=Oh,dt=Uh,ne=null,os=$({},[].concat(ht(ic),ht(mo),ht(po),ht(_o),ht(sc))),ie=null,as=$({},[].concat(ht(rc),ht(fo),ht(nc),ht(en))),se=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),At=null,cs=null,Js=!0,ls=!0,Xs=!1,Hr=!0,ze=!1,Je=!1,Nt=!1,ds=!1,ye=!1,Ci=!1,Mi=!1,Wr=!0,us=!1,Qs="user-content-",ri=!0,Ge=!1,rt={},Dt=null,Yr=$({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Zs=null,er=$({},["audio","video","img","source","image","track"]),hs=null,Ai=$({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Ni="http://www.w3.org/1998/Math/MathML",He="http://www.w3.org/2000/svg",le="http://www.w3.org/1999/xhtml",xe=le,Oe=!1,ni=null,Vt=$({},[Ni,He,le],uo),Me,We=["application/xhtml+xml","text/html"],Di="text/html",oe,Ae=null,Xe=i.createElement("form"),Z=function(f){return f instanceof RegExp||f instanceof Function},Y=function(f){Ae&&Ae===f||((!f||li(f)!=="object")&&(f={}),f=Vi(f),Me=We.indexOf(f.PARSER_MEDIA_TYPE)===-1?Me=Di:Me=f.PARSER_MEDIA_TYPE,oe=Me==="application/xhtml+xml"?uo:xn,ne="ALLOWED_TAGS"in f?$({},f.ALLOWED_TAGS,oe):os,ie="ALLOWED_ATTR"in f?$({},f.ALLOWED_ATTR,oe):as,ni="ALLOWED_NAMESPACES"in f?$({},f.ALLOWED_NAMESPACES,uo):Vt,hs="ADD_URI_SAFE_ATTR"in f?$(Vi(Ai),f.ADD_URI_SAFE_ATTR,oe):Ai,Zs="ADD_DATA_URI_TAGS"in f?$(Vi(er),f.ADD_DATA_URI_TAGS,oe):er,Dt="FORBID_CONTENTS"in f?$({},f.FORBID_CONTENTS,oe):Yr,At="FORBID_TAGS"in f?$({},f.FORBID_TAGS,oe):{},cs="FORBID_ATTR"in f?$({},f.FORBID_ATTR,oe):{},rt="USE_PROFILES"in f?f.USE_PROFILES:!1,Js=f.ALLOW_ARIA_ATTR!==!1,ls=f.ALLOW_DATA_ATTR!==!1,Xs=f.ALLOW_UNKNOWN_PROTOCOLS||!1,Hr=f.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ze=f.SAFE_FOR_TEMPLATES||!1,Je=f.WHOLE_DOCUMENT||!1,ye=f.RETURN_DOM||!1,Ci=f.RETURN_DOM_FRAGMENT||!1,Mi=f.RETURN_TRUSTED_TYPE||!1,ds=f.FORCE_BODY||!1,Wr=f.SANITIZE_DOM!==!1,us=f.SANITIZE_NAMED_PROPS||!1,ri=f.KEEP_CONTENT!==!1,Ge=f.IN_PLACE||!1,dt=f.ALLOWED_URI_REGEXP||dt,xe=f.NAMESPACE||le,se=f.CUSTOM_ELEMENT_HANDLING||{},f.CUSTOM_ELEMENT_HANDLING&&Z(f.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(se.tagNameCheck=f.CUSTOM_ELEMENT_HANDLING.tagNameCheck),f.CUSTOM_ELEMENT_HANDLING&&Z(f.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(se.attributeNameCheck=f.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),f.CUSTOM_ELEMENT_HANDLING&&typeof f.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(se.allowCustomizedBuiltInElements=f.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ze&&(ls=!1),Ci&&(ye=!0),rt&&(ne=$({},ht(sc)),ie=[],rt.html===!0&&($(ne,ic),$(ie,rc)),rt.svg===!0&&($(ne,mo),$(ie,fo),$(ie,en)),rt.svgFilters===!0&&($(ne,po),$(ie,fo),$(ie,en)),rt.mathMl===!0&&($(ne,_o),$(ie,nc),$(ie,en))),f.ADD_TAGS&&(ne===os&&(ne=Vi(ne)),$(ne,f.ADD_TAGS,oe)),f.ADD_ATTR&&(ie===as&&(ie=Vi(ie)),$(ie,f.ADD_ATTR,oe)),f.ADD_URI_SAFE_ATTR&&$(hs,f.ADD_URI_SAFE_ATTR,oe),f.FORBID_CONTENTS&&(Dt===Yr&&(Dt=Vi(Dt)),$(Dt,f.FORBID_CONTENTS,oe)),ri&&(ne["#text"]=!0),Je&&$(ne,["html","head","body"]),ne.table&&($(ne,["tbody"]),delete At.tbody),je&&je(f),Ae=f)},Qe=$({},["mi","mo","mn","ms","mtext"]),Fe=$({},["foreignobject","desc","title","annotation-xml"]),R=$({},["title","style","font","a","script"]),F=$({},mo);$(F,po),$(F,Rh);var A=$({},_o);$(A,Ch);var K=function(f){var b=D(f);(!b||!b.tagName)&&(b={namespaceURI:xe,tagName:"template"});var I=xn(f.tagName),L=xn(b.tagName);return ni[f.namespaceURI]?f.namespaceURI===He?b.namespaceURI===le?I==="svg":b.namespaceURI===Ni?I==="svg"&&(L==="annotation-xml"||Qe[L]):Boolean(F[I]):f.namespaceURI===Ni?b.namespaceURI===le?I==="math":b.namespaceURI===He?I==="math"&&Fe[L]:Boolean(A[I]):f.namespaceURI===le?b.namespaceURI===He&&!Fe[L]||b.namespaceURI===Ni&&!Qe[L]?!1:!A[I]&&(R[I]||!F[I]):!!(Me==="application/xhtml+xml"&&ni[f.namespaceURI]):!1},ee=function(f){tr(e.removed,{element:f});try{f.parentNode.removeChild(f)}catch{try{f.outerHTML=U}catch{f.remove()}}},J=function(f,b){try{tr(e.removed,{attribute:b.getAttributeNode(f),from:b})}catch{tr(e.removed,{attribute:null,from:b})}if(b.removeAttribute(f),f==="is"&&!ie[f])if(ye||Ci)try{ee(b)}catch{}else try{b.setAttribute(f,"")}catch{}},Te=function(f){var b,I;if(ds)f="<remove></remove>"+f;else{var L=kh(f,/^[\r\n\t ]+/);I=L&&L[0]}Me==="application/xhtml+xml"&&xe===le&&(f='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+f+"</body></html>");var ke=C?C.createHTML(f):f;if(xe===le)try{b=new p().parseFromString(ke,Me)}catch{}if(!b||!b.documentElement){b=G.createDocument(xe,"template",null);try{b.documentElement.innerHTML=Oe?U:ke}catch{}}var Ne=b.body||b.documentElement;return f&&I&&Ne.insertBefore(i.createTextNode(I),Ne.childNodes[0]||null),xe===le?Ws.call(b,Je?"html":"body")[0]:Je?b.documentElement:Ne},ue=function(f){return wt.call(f.ownerDocument||f,f,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT,null,!1)},ms=function(f){return f instanceof h&&(typeof f.nodeName!="string"||typeof f.textContent!="string"||typeof f.removeChild!="function"||!(f.attributes instanceof c)||typeof f.removeAttribute!="function"||typeof f.setAttribute!="function"||typeof f.namespaceURI!="string"||typeof f.insertBefore!="function"||typeof f.hasChildNodes!="function")},Ut=function(f){return li(o)==="object"?f instanceof o:f&&li(f)==="object"&&typeof f.nodeType=="number"&&typeof f.nodeName=="string"},u=function(f,b,I){!qe[f]||Eh(qe[f],function(L){L.call(e,b,I,Ae)})},m=function(f){var b;if(u("beforeSanitizeElements",f,null),ms(f)||Le(/[\u0080-\uFFFF]/,f.nodeName))return ee(f),!0;var I=oe(f.nodeName);if(u("uponSanitizeElement",f,{tagName:I,allowedTags:ne}),f.hasChildNodes()&&!Ut(f.firstElementChild)&&(!Ut(f.content)||!Ut(f.content.firstElementChild))&&Le(/<[/\w]/g,f.innerHTML)&&Le(/<[/\w]/g,f.textContent)||I==="select"&&Le(/<template/i,f.innerHTML))return ee(f),!0;if(!ne[I]||At[I]){if(!At[I]&&v(I)&&(se.tagNameCheck instanceof RegExp&&Le(se.tagNameCheck,I)||se.tagNameCheck instanceof Function&&se.tagNameCheck(I)))return!1;if(ri&&!Dt[I]){var L=D(f)||f.parentNode,ke=M(f)||f.childNodes;if(ke&&L)for(var Ne=ke.length,Re=Ne-1;Re>=0;--Re)L.insertBefore(w(ke[Re],!0),x(f))}return ee(f),!0}return f instanceof a&&!K(f)||(I==="noscript"||I==="noembed"||I==="noframes")&&Le(/<\/no(script|embed|frames)/i,f.innerHTML)?(ee(f),!0):(ze&&f.nodeType===3&&(b=f.textContent,b=ut(b,rs," "),b=ut(b,ns," "),b=ut(b,V," "),f.textContent!==b&&(tr(e.removed,{element:f.cloneNode()}),f.textContent=b)),u("afterSanitizeElements",f,null),!1)},_=function(f,b,I){if(Wr&&(b==="id"||b==="name")&&(I in i||I in Xe))return!1;if(!(ls&&!cs[b]&&Le(Gr,b))){if(!(Js&&Le(ii,b))){if(!ie[b]||cs[b]){if(!(v(f)&&(se.tagNameCheck instanceof RegExp&&Le(se.tagNameCheck,f)||se.tagNameCheck instanceof Function&&se.tagNameCheck(f))&&(se.attributeNameCheck instanceof RegExp&&Le(se.attributeNameCheck,b)||se.attributeNameCheck instanceof Function&&se.attributeNameCheck(b))||b==="is"&&se.allowCustomizedBuiltInElements&&(se.tagNameCheck instanceof RegExp&&Le(se.tagNameCheck,I)||se.tagNameCheck instanceof Function&&se.tagNameCheck(I))))return!1}else if(!hs[b]){if(!Le(dt,ut(I,Ys,""))){if(!((b==="src"||b==="xlink:href"||b==="href")&&f!=="script"&&Ih(I,"data:")===0&&Zs[f])){if(!(Xs&&!Le(si,ut(I,Ys,"")))){if(I)return!1}}}}}}return!0},v=function(f){return f.indexOf("-")>0},S=function(f){var b,I,L,ke;u("beforeSanitizeAttributes",f,null);var Ne=f.attributes;if(!!Ne){var Re={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:ie};for(ke=Ne.length;ke--;){b=Ne[ke];var Jr=b,Ie=Jr.name,lo=Jr.namespaceURI;if(I=Ie==="value"?b.value:xh(b.value),L=oe(Ie),Re.attrName=L,Re.attrValue=I,Re.keepAttr=!0,Re.forceKeepAttr=void 0,u("uponSanitizeAttribute",f,Re),I=Re.attrValue,!Re.forceKeepAttr&&(J(Ie,f),!!Re.keepAttr)){if(!Hr&&Le(/\/>/i,I)){J(Ie,f);continue}ze&&(I=ut(I,rs," "),I=ut(I,ns," "),I=ut(I,V," "));var Qa=oe(f.nodeName);if(!!_(Qa,L,I)){if(us&&(L==="id"||L==="name")&&(J(Ie,f),I=Qs+I),C&&li(g)==="object"&&typeof g.getAttributeType=="function"&&!lo)switch(g.getAttributeType(Qa,L)){case"TrustedHTML":{I=C.createHTML(I);break}case"TrustedScriptURL":{I=C.createScriptURL(I);break}}try{lo?f.setAttributeNS(lo,Ie,I):f.setAttribute(Ie,I),tc(e.removed)}catch{}}}}u("afterSanitizeAttributes",f,null)}},N=function E(f){var b,I=ue(f);for(u("beforeSanitizeShadowDOM",f,null);b=I.nextNode();)u("uponSanitizeShadowNode",b,null),!m(b)&&(b.content instanceof s&&E(b.content),S(b));u("afterSanitizeShadowDOM",f,null)};return e.sanitize=function(E){var f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},b,I,L,ke,Ne;if(Oe=!E,Oe&&(E="<!-->"),typeof E!="string"&&!Ut(E))if(typeof E.toString=="function"){if(E=E.toString(),typeof E!="string")throw ho("dirty is not a string, aborting")}else throw ho("toString is not a function");if(!e.isSupported){if(li(r.toStaticHTML)==="object"||typeof r.toStaticHTML=="function"){if(typeof E=="string")return r.toStaticHTML(E);if(Ut(E))return r.toStaticHTML(E.outerHTML)}return E}if(Nt||Y(f),e.removed=[],typeof E=="string"&&(Ge=!1),Ge){if(E.nodeName){var Re=oe(E.nodeName);if(!ne[Re]||At[Re])throw ho("root node is forbidden and cannot be sanitized in-place")}}else if(E instanceof o)b=Te("<!---->"),I=b.ownerDocument.importNode(E,!0),I.nodeType===1&&I.nodeName==="BODY"||I.nodeName==="HTML"?b=I:b.appendChild(I);else{if(!ye&&!ze&&!Je&&E.indexOf("<")===-1)return C&&Mi?C.createHTML(E):E;if(b=Te(E),!b)return ye?null:Mi?U:""}b&&ds&&ee(b.firstChild);for(var Jr=ue(Ge?E:b);L=Jr.nextNode();)L.nodeType===3&&L===ke||m(L)||(L.content instanceof s&&N(L.content),S(L),ke=L);if(ke=null,Ge)return E;if(ye){if(Ci)for(Ne=ss.call(b.ownerDocument);b.firstChild;)Ne.appendChild(b.firstChild);else Ne=b;return(ie.shadowroot||ie.shadowrootmod)&&(Ne=Ri.call(t,Ne,!0)),Ne}var Ie=Je?b.outerHTML:b.innerHTML;return Je&&ne["!doctype"]&&b.ownerDocument&&b.ownerDocument.doctype&&b.ownerDocument.doctype.name&&Le(Fh,b.ownerDocument.doctype.name)&&(Ie="<!DOCTYPE "+b.ownerDocument.doctype.name+`>
`+Ie),ze&&(Ie=ut(Ie,rs," "),Ie=ut(Ie,ns," "),Ie=ut(Ie,V," ")),C&&Mi?C.createHTML(Ie):Ie},e.setConfig=function(E){Y(E),Nt=!0},e.clearConfig=function(){Ae=null,Nt=!1},e.isValidAttribute=function(E,f,b){Ae||Y({});var I=oe(E),L=oe(f);return _(I,L,b)},e.addHook=function(E,f){typeof f=="function"&&(qe[E]=qe[E]||[],tr(qe[E],f))},e.removeHook=function(E){if(qe[E])return tc(qe[E])},e.removeHooks=function(E){qe[E]&&(qe[E]=[])},e.removeAllHooks=function(){qe={}},e}var Kh=Nl(),Jn={exports:{}},$h=function(r){var e={};function t(i){if(e[i])return e[i].exports;var s=e[i]={i,l:!1,exports:{}};return r[i].call(s.exports,s,s.exports,t),s.l=!0,s.exports}return t.m=r,t.c=e,t.d=function(i,s,n){t.o(i,s)||Object.defineProperty(i,s,{enumerable:!0,get:n})},t.r=function(i){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},t.t=function(i,s){if(1&s&&(i=t(i)),8&s||4&s&&typeof i=="object"&&i&&i.__esModule)return i;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:i}),2&s&&typeof i!="string")for(var o in i)t.d(n,o,function(a){return i[a]}.bind(null,o));return n},t.n=function(i){var s=i&&i.__esModule?function(){return i.default}:function(){return i};return t.d(s,"a",s),s},t.o=function(i,s){return Object.prototype.hasOwnProperty.call(i,s)},t.p="",t(t.s=0)}([function(r,e,t){function i(d){let c,h;const p={light:function(){return!y()},dark:y,lighten:M,darken:x,saturate:D,desaturate:function(C=0){return D(C*=-1)},increaseContrast:function(C=0){return O(C*=-1)},decreaseContrast:O,active:function(){return O(.123)},highlight:function(){return O(.1)},selected:function(){return O(.066)},text:function(){return h=w()?s("#333333"):s("#FFFFFF"),p},shadow:function(){return h=w()?s("#000000"):s("#FFFFFF"),p},hex:function(){const C=h;return h=c,"#"+C.map(U=>parseInt(U+"",10).toString(16).padStart(2,"0")).join("")},rgb:function(){const C=h;return h=c,`rgb(${C.join()})`},rgba:function(C=1){const U=h;return h=c,`rgba(${U.join()}, ${C})`},setHex:g,setRgb:function(C=[0,0,0]){let[U,B,G]=C;return U=l(U,0,255),B=l(B,0,255),G=l(G,0,255),c=[U,B,G],h=[U,B,G],p}};function g(C="#000000"){return c=s(C),h=c,p}function y(){const[C,U,B]=h;return h=c,(299*C+587*U+114*B)/1e3<128}function w(){const[C,U,B]=h;return(299*C+587*U+114*B)/1e3>=128}function x(C=0){return M(C*=-1)}function M(C=0){let[U,B,G]=a(h);return G=l(G+C,0,1),h=n([U,B,G]),p}function D(C=0){let[U,B,G]=a(h);return B=l(B+C,0,1),h=n([U,B,G]),p}function O(C=0){return w()?x(C):M(C)}return g(d),p}function s(d){if(typeof d!="string")throw new TypeError("Expected a string");(d=d.replace(/^#/,"")).length===3&&(d=d[0]+d[0]+d[1]+d[1]+d[2]+d[2]);var c=parseInt(d,16);return[c>>16,c>>8&255,255&c]}function n(d){const[c,h,p]=d;let g,y,w;if(h===0)g=y=w=p;else{const x=function(O,C,U){return U<0&&(U+=1),U>1&&(U-=1),U<.16666666666666666?O+6*(C-O)*U:U<.5?C:U<.6666666666666666?O+(C-O)*(.6666666666666666-U)*6:O},M=p<.5?p*(1+h):p+h-p*h,D=2*p-M;g=l(x(D,M,c+1/3),0,1),y=l(x(D,M,c),0,1),w=l(x(D,M,c-1/3),0,1)}return[Math.round(255*g),Math.round(255*y),Math.round(255*w)]}t.r(e),t.d(e,"offColor",function(){return i}),t.d(e,"hexRgb",function(){return s}),t.d(e,"hslToRgb",function(){return n}),t.d(e,"color",function(){return o}),t.d(e,"rgbToHsl",function(){return a});const o=i;function a(d){const c=d[0]/255,h=d[1]/255,p=d[2]/255,g=Math.max(c,h,p),y=Math.min(c,h,p);let w=(g+y)/2,x=(g+y)/2;const M=(g+y)/2;if(g===y)w=x=0;else{const D=g-y;switch(x=M>.5?D/(2-g-y):D/(g+y),g){case c:w=(h-p)/D+(h<p?6:0);break;case h:w=(p-c)/D+2;break;case p:w=(c-h)/D+4}w/=6}return[w,x,M]}function l(d,c,h){return d=(d=d<=h?d:h)>=c?d:c}}]);Jn.exports=$h;var Dl=Jn.exports,jh=Object.defineProperty,qh=Object.defineProperties,zh=Object.getOwnPropertyDescriptors,Un=Object.getOwnPropertySymbols,Vl=Object.prototype.hasOwnProperty,Ul=Object.prototype.propertyIsEnumerable,oc=(r,e,t)=>e in r?jh(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ms=(r,e)=>{for(var t in e||(e={}))Vl.call(e,t)&&oc(r,t,e[t]);if(Un)for(var t of Un(e))Ul.call(e,t)&&oc(r,t,e[t]);return r},Pl=(r,e)=>qh(r,zh(e)),Gh=(r,e)=>{var t={};for(var i in r)Vl.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&Un)for(var i of Un(r))e.indexOf(i)<0&&Ul.call(r,i)&&(t[i]=r[i]);return t},ac,cc,ot=(r=>(r[r.All=1]="All",r[r.Debug=2]="Debug",r[r.Detail=3]="Detail",r[r.Info=4]="Info",r[r.Warn=5]="Warn",r[r.Error=6]="Error",r[r.Fatal=7]="Fatal",r[r.Off=8]="Off",r))(ot||{});class Pn{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}class Ss{constructor(e,t,i,s){this._discard=!1,this._logger=i,this.start=i._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=s}discard(){this._discard=!0}runDetached(e,t,i,s){return this._logger.runDetached(e,t,i,s)}wrapDetached(e,t,i,s){this.refDetached(this.runDetached(e,t,i,s))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,i,s){return this.child(e,i,s).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,i)=>{const s=i.durationOfType(e);return t+(s??0)},0):0}log(e,t){const i=this.child(e,t);return i.end=i.start,i}set(e,t){if(typeof e=="object"){const i=e;Object.assign(this._values,i)}else this._values[e]=t;return this}serialize(e,t,i){if(this._discard)return;if(this._filterCreator)try{e=this._filterCreator(new Pn(e),this)}catch(o){console.error("Error creating log filter",o)}let s=null;if(this._children&&(s=this._children.reduce((o,a)=>{const l=a.serialize(e,this.start,!1);return l&&(o===null&&(o=[]),o.push(l)),o},null)),e&&!e.filter(this,s))return;const n={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(n.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),i&&(n.f=!0),s&&(n.c=s),n}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(i=>(this.finish(),i),i=>{throw this.catch(i)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}forceFinish(){this.finish()}get level(){return ot}catch(e){return this.error=e,this.logLevel=ot.Error,this.finish(),e}child(e,t,i){this.end&&console.trace(`log item ${this.values.l} finished, additional log ${JSON.stringify(e)} will likely not be recorded`),t||(t=this.logLevel||ot.Info);const s=new Ss(e,t,this._logger,i);return this._children||(this._children=[]),this._children.push(s),s}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class Hh{constructor({platform:e}){this._openItems=new Set,this.reporters=[],this._platform=e}log(e,t=ot.Info){const i=new Ss(e,t,this);return i.end=i.start,this._persistItem(i,void 0,!1),i}child(e,t=ot.Info,i){const s=new Wh(e,t,this,i);return this._openItems.add(s),s}wrapOrRun(e,t,i,s,n){return e?e.wrap(t,i,s,n):this.run(t,i,s,n)}runDetached(e,t,i,s){i||(i=ot.Info);const n=new Ss(e,i,this);return this._run(n,t,i,!1,s),n}run(e,t,i,s){i===void 0&&(i=ot.Info);const n=new Ss(e,i,this);return this._run(n,t,i,!0,s)}_run(e,t,i,s,n){this._openItems.add(e);const o=()=>{let a=new Pn;if(n)try{a=n(a,e)}catch(l){console.error("Error while creating log filter",l)}else a=a.minLevel(i);try{this._persistItem(e,a,!1)}catch(l){console.error("Could not persist log item",l)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(l=>(o(),l),l=>{if(o(),s)throw l}),s)return a}else if(o(),s)return a}catch(a){if(o(),s)throw a}}addReporter(e){e.setLogger(this),this.reporters.push(e)}getOpenRootItems(){return this._openItems}forceFinish(){for(const e of this._openItems){e.forceFinish();try{this._persistItem(e,new Pn,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}_removeItemFromOpenList(e){this._openItems.delete(e)}_persistItem(e,t,i){for(var s=0;s<this.reporters.length;s+=1)this.reporters[s].reportItem(e,t,i)}get level(){return ot}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class Wh extends Ss{finish(){super.finish(),this._logger._persistItem(this,void 0,!1),this._logger._removeItemFromOpenList(this)}forceFinish(){super.finish()}}var H=(r=>(r.session="session",r.roomState="roomState",r.roomSummary="roomSummary",r.archivedRoomSummary="archivedRoomSummary",r.invites="invites",r.roomMembers="roomMembers",r.timelineEvents="timelineEvents",r.timelineRelations="timelineRelations",r.timelineFragments="timelineFragments",r.pendingEvents="pendingEvents",r.userIdentities="userIdentities",r.deviceKeys="deviceKeys",r.olmSessions="olmSessions",r.inboundGroupSessions="inboundGroupSessions",r.outboundGroupSessions="outboundGroupSessions",r.groupSessionDecryptions="groupSessionDecryptions",r.operations="operations",r.accountData="accountData",r.calls="calls",r.crossSigningKeys="crossSigningKeys",r.sharedSecrets="sharedSecrets",r))(H||{});const Sr=Object.values(H);class qt extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const _e={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};function Yh(r){return"objectStore"in r?`${r.objectStore.name}.${r.name}`:r.name}function Jh(r){var e,t,i,s,n;return"objectStore"in r?(i=(t=(e=r.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:i.name:(n=(s=r.transaction)==null?void 0:s.db)==null?void 0:n.name}class Ol extends qt{constructor(e,t,i=null){const s=t&&"source"in t?t.source:t,n=s?Yh(s):"",o=s?Jh(s):"";let a=`${e} on ${o}.${n}`;i&&(a+=": ",typeof i.name=="string"&&(a+=`(name: ${i.name}) `),typeof i.code=="number"&&(a+=`(code: ${i.code}) `)),i&&(a+=i.message),super(a,i),this.storeName=n,this.databaseName=o}}class la extends Ol{constructor(e){const t=e.target,i=t.source,s=t.error;super("IDBRequest failed",i,s),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class bt extends Ol{constructor(e,t,i,s){super(`${e}(${s.map(n=>JSON.stringify(n)).join(", ")}) failed`,t,i)}}class yt extends Error{get name(){return"AbortError"}}const lc={done:!0},Jt={done:!1};function On(r){const e=r.toString(16);return"0".repeat(8-e.length)+e}function Po(r){return parseInt(r,16)}function da(r,e,t,i=window.indexedDB){const s=i.open(r,t);return s.onupgradeneeded=async n=>{const o=n.target,a=o.result,l=o.transaction,d=n.oldVersion;try{await e(a,l,d,t)}catch{try{l.abort()}catch{}}},$e(s)}function $e(r){return new Promise((e,t)=>{r.addEventListener("success",i=>{e(i.target.result)}),r.addEventListener("error",i=>{const s=new la(i);t(s)})})}function Er(r){return new Promise((e,t)=>{r.addEventListener("complete",()=>{e()}),r.addEventListener("abort",i=>{t(new yt)})})}function Se(r,e){return new Promise((t,i)=>{r.onerror=s=>{i(new la(s))},r.onsuccess=s=>{const n=s.target.result;if(!n){t(!1);return}const o=e(n.value,n.key,n),a=o?.done,l=o?.jumpTo;a?t(!0):l?n.continue(l):n.continue()}}).catch(t=>{throw new qt("iterateCursor failed",t)})}async function Xh(r,e){const t=[];return await Se(r,i=>(t.push(i),{done:e(t)})),t}class Qh{constructor(e){var t;this.options=e,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this.options.platform.clock.createInterval(()=>this._tryFlush(),(t=this.options.flushInterval)!=null?t:60*1e3)}setLogger(e){this.logger=e}reportItem(e,t,i){const s=this.prepareItemForQueue(e,t,i);s&&this._queuedItems.push(s)}async export(){const e=await this._openDB();try{const i=e.transaction(["logs"],"readonly").objectStore("logs"),s=await Xh(i.openCursor(),()=>!1),n=this.getSerializedOpenItems(),o=s.concat(this._queuedItems).concat(n);return new Zh(o,this,this.options.platform)}finally{try{e.close()}catch{}}}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){var e;const t=await this._openDB();try{const i=t.transaction(["logs"],"readwrite"),s=i.objectStore("logs"),n=this._queuedItems.length;for(const l of this._queuedItems)s.add(l);const o=await $e(s.count()),a=(e=this.options.limit)!=null?e:3e3;if(o>a){let l=o-a+Math.round(.1*a);await Se(s.openCursor(),(d,c,h)=>(h.delete(),l-=1,{done:l===0}))}await Er(i),this._queuedItems.splice(0,n)}catch(i){console.error("Could not flush logs",i)}finally{try{t.close()}catch{}}}_finishAllAndFlush(){this.logger&&(this.logger.log({l:"pagehide, closing logs",t:"navigation"}),this.logger.forceFinish()),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this.options.name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return da(this.options.name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}prepareItemForQueue(e,t,i){let s=e.serialize(t,void 0,i);if(s)return this.options.serializedTransformer&&(s=this.options.serializedTransformer(s)),{json:JSON.stringify(s)}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this.options.name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async removeItems(e){const t=await this._openDB();try{const i=t.transaction(["logs"],"readwrite"),s=i.objectStore("logs");for(const n of e)if(typeof n.id=="number")s.delete(n.id);else{const o=this._queuedItems.indexOf(n);o===-1&&this._queuedItems.splice(o,1)}await Er(i)}finally{try{t.close()}catch{}}}getSerializedOpenItems(){const e=[];if(!this.logger)return e;const t=new Pn;for(const i of this.logger.getOpenRootItems()){const s=this.prepareItemForQueue(i,t,!1);s&&e.push(s)}return e}}class Zh{constructor(e,t,i){this._items=e,this._logger=t,this._platform=i}get count(){return this._items.length}removeFromStore(){return this._logger.removeItems(this._items)}asBlob(){const e=this.toJSON(),t=this._platform.encoding.utf8.encode(e);return this._platform.createBlob(t,"application/json")}toJSON(){var e;const t={formatVersion:1,appVersion:(e=this._platform.updateService)==null?void 0:e.version,platform:this._platform.description,items:this._items.map(s=>JSON.parse(s.json))};return JSON.stringify(t)}}class em{reportItem(e){Ll(e)}setLogger(e){this.logger=e}printOpenItems(){if(!!this.logger)for(const e of this.logger.getOpenRootItems())this.reportItem(e)}}const tm=["l","id"];function im(r){return Object.entries(r).filter(([e])=>!tm.includes(e)).reduce((e,[t,i])=>(e=e||{},e[t]=i,e),null)}function Fl(r){if(r.error)return!0;if(r.children){for(const e of r.children)if(Fl(e))return!0}return!1}function Ll(r){const e=`${sm(r)} (@${r.start}ms, duration: ${r.duration}ms)`,t=im(r.values),i=r.children||t;if(i?(Fl(r)?console.group(e):console.groupCollapsed(e),r.error&&console.error(r.error)):r.error?console.error(r.error):console.log(e),t&&console.table(t),r.children)for(const s of r.children)Ll(s);i&&console.groupEnd()}function sm(r){return r.values.t==="network"?`${r.values.method} ${r.values.url}`:r.values.l&&typeof r.values.id<"u"?`${r.values.l} ${r.values.id}`:r.values.l&&typeof r.values.status<"u"?`${r.values.l} (${r.values.status})`:r.values.l&&typeof r.values.type<"u"?`${r.values.l} (${r.values.type})`:r.values.l&&r.error?`${r.values.l} failed`:typeof r.values.ref<"u"?`ref ${r.values.ref}`:r.values.l||r.values.type}class Bl extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class Kl extends Error{constructor(e,t,i,s){super(`${i?i.error:s} on ${e} ${t}`),this.errcode=i?i.errcode:null,this.retry_after_ms=i?i.retry_after_ms:0,this.statusCode=s}get name(){return"HomeServerError"}}class zt extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class Xn{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class Ct extends Xn{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new nm(Promise.resolve(this.get())):new rm(this,e)}flatMap(e){return new am(this,e)}}class rm{constructor(e,t){this._promise=new Promise((i,s)=>{this._reject=s,this._subscription=e.subscribe(n=>{t(n)&&(this._reject=null,i(n),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new yt),this._reject=null)}}class nm{constructor(e){this.promise=e}dispose(){}}class om extends Ct{constructor(e,t){super(),this.value=e,this.eventName=t}onSubscribeFirst(){this.eventSubscription=this.value.disposableOn(this.eventName,()=>{this.emit(this.value)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.eventSubscription(),super.onUnsubscribeLast()}get(){return this.value}}class fi extends Ct{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class am extends Ct{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t?.get()}}function cm(r,e){return e<r}class lm extends Ct{constructor(e,t=cm){super(),this.map=e,this.pickKey=t}updateKey(e){return this.key===void 0||this.pickKey(this.key,e)?(this.key=e,!0):!1}onReset(){this.key=void 0,this.emit(this.get())}onAdd(e,t){this.updateKey(e)&&this.emit(this.get())}onUpdate(e,t,i){this.emit(this.get())}onRemove(e,t){if(e===this.key){this.key=void 0;for(const[i]of this.map)this.updateKey(i);this.emit(this.get())}}onSubscribeFirst(){this.mapSubscription=this.map.subscribe(this);for(const[e]of this.map)this.updateKey(e)}onUnsubscribeLast(){this.mapSubscription(),this.key=void 0}get(){if(this.key!==void 0)return this.map.get(this.key)}}class kr extends fi{constructor(e,t,i=()=>{}){super(e),this.freeCallback=t,this.startCallback=i}onSubscribeFirst(){this.startCallback()}onUnsubscribeLast(){super.onUnsubscribeLast(),this.freeCallback()}}class Bs extends Xn{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let i of this._handlers)i.onAdd(e,t,this)}emitUpdate(e,t,i){for(let s of this._handlers)s.onUpdate(e,t,i,this)}emitRemove(e,t){for(let i of this._handlers)i.onRemove(e,t,this)}emitMove(e,t,i){for(let s of this._handlers)s.onMove(e,t,i,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function Gt(r,e,t){let i=0,s=r.length;for(;i<s;){let n=i+s>>>1,o=t(e,r[n]);o>0?i=n+1:o<0?s=n:i=s=n}return s}class dm extends Bs{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let i of t)this.insert(e,i),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[i]=this._items.splice(e,1);this._items.splice(t,0,i),this.emitMove(e,t,i)}}update(e,t,i=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,i))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function $l(r,e,t,i){const s=e.findIndex(r);if(s!==-1){const n=e[s],o=i(n);return o!==!1&&t.emitUpdate(s,n,o),!0}return!1}class jl extends Bs{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return $l(e,this._items,this,t)}getAndUpdate(e,t,i=null){const s=this.indexOf(e);if(s!==-1){const n=this._items[s],o=t(n,e);this._items[s]=o,this.emitUpdate(s,o,i)}}update(e,t=null){const i=this.indexOf(e);i!==-1&&(this._items[i]=e,this.emitUpdate(i,e,t))}indexOf(e){const t=Gt(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=Gt(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const i=Gt(this._items,e,this._comparator);i>=this._items.length||this._comparator(this._items[i],e)!==0?(this._items.splice(i,0,e),this.emitAdd(i,e)):(this._items[i]=e,this.emitUpdate(i,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new um(this)}}class um{constructor(e){this._consumed=!1,this._sortedArray=e,this._current=null}next(){return this._consumed?{value:void 0,done:!0}:(this._current=this._current?this._sortedArray._getNext(this._current):this._sortedArray.get(0),this._current||(this._consumed=!0),{value:this._current,done:this._consumed})}}class hm extends Bs{constructor(e,t,i,s){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=i,this._removeCallback=s}findAndUpdate(e,t){return $l(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function mm(r,e,t){r._mappedValues.splice(e,0,t),r.emitAdd(e,t)}function pm(r,e,t,i){const s=r._mappedValues[e];r._updater&&r._updater(s,i,t),r.emitUpdate(e,s,i)}function _m(r,e){const t=r._mappedValues[e];r._mappedValues.splice(e,1),r._removeCallback&&r._removeCallback(t),r.emitRemove(e,t)}function fm(r,e,t){const i=r._mappedValues[e];r._mappedValues.splice(e,1),r._mappedValues.splice(t,0,i),r.emitMove(e,t,i)}function gm(r){r._mappedValues=[],r.emitReset()}class ym extends hm{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new dc(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Sm),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new dc(e,t)),this._flush())}onUpdate(e,t,i){this._eventQueue&&(this._eventQueue.push(new vm(e,t,i)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new wm(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new bm(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class dc{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);mm(e,this.index,t)}}class vm{constructor(e,t,i){this.index=e,this.value=t,this.params=i}async run(e){pm(e,this.index,this.value,this.params)}}class wm{constructor(e){this.index=e}async run(e){_m(e,this.index)}}class bm{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){fm(e,this.fromIdx,this.toIdx)}}class Sm{async run(e){gm(e)}}class Em extends Bs{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let i=0;for(let s=0;s<t;++s)i+=this._sourceLists[s].length;return i}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,i){this.emitAdd(this._offsetForSource(i)+e,t)}onUpdate(e,t,i,s){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(s)+e,t,i)}onRemove(e,t,i){this.emitRemove(this._offsetForSource(i)+e,t)}onMove(e,t,i,s){const n=this._offsetForSource(s);this.emitMove(n+e,n+t,i)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let i=t.next();for(;i.done;){if(e+=1,e>=this._sourceLists.length)return i;t=this._sourceLists[e][Symbol.iterator](),i=t.next()}return i}}}}class km extends Bs{constructor(e,t){super(),this._sourceMap=e,this._comparator=(i,s)=>t(i.value,s.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const i={key:e,value:t},s=Gt(this._sortedPairs,i,this._comparator);this._sortedPairs.splice(s,0,i),this.emitAdd(s,t)}onRemove(e,t){const i={key:e,value:t},s=Gt(this._sortedPairs,i,this._comparator);this._sortedPairs.splice(s,1),this.emitRemove(s,t)}onUpdate(e,t,i){if(!this._sortedPairs)return;const s=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(s,1);const n={key:e,value:t},o=Gt(this._sortedPairs,n,this._comparator);this._sortedPairs.splice(o,0,n),s!==o&&this.emitMove(s,o,t),this.emitUpdate(o,t,i)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,i]of this._sourceMap)this._sortedPairs[e]={key:t,value:i},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class Br extends Xn{constructor(){super()}emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let i of this._handlers)i.onAdd(e,t)}emitUpdate(e,t,i){for(let s of this._handlers)s.onUpdate(e,t,i)}emitRemove(e,t){for(let i of this._handlers)i.onRemove(e,t)}join(...e){return new Tm([this].concat(e))}mapValues(e,t){return new Mm(this,e,t)}sortValues(e){return new km(this,e)}filterValues(e){return new Im(this,e)}observeSize(){return new Nm(this)}}class Im extends Br{constructor(e,t){super(),this._source=e,this._filter=t}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){this._included=this._included||new Map;for(const[t,i]of this._source){const s=this._filter(i,t),n=this._included.get(t);if(this._included.set(t,s),!e){const o=n||!0;this._emitForUpdate(o,s,t,i)}}}else{if(this._included&&!e)for(const[t,i]of this._source)this._included.get(t)||this.emitAdd(t,i);this._included=void 0}}onAdd(e,t){if(this._filter)if(this._included){const i=this._filter(t,e);if(this._included.set(e,i),!i)return}else throw new Error("Internal logic error: FilteredMap._included used before initialized");this.emitAdd(e,t)}onRemove(e,t){var i;const s=!this._filter||((i=this._included)==null?void 0:i.get(e));if(this._included)this._included.delete(e),s&&this.emitRemove(e,t);else throw new Error("Internal logic error: FilteredMap._included used before initialized")}onUpdate(e,t,i){if(!!this._included)if(this._filter){const s=this._included.get(e),n=this._filter(t,e);this._included.set(e,n),this._emitForUpdate(s,n,e,t,i)}else this.emitUpdate(e,t,i)}_emitForUpdate(e,t,i,s,n=null){e&&!t?this.emitRemove(i,s):!e&&t?this.emitAdd(i,s):e&&t&&this.emitUpdate(i,s,n)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=void 0,this._subscription&&(this._subscription=this._subscription())}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new xm(this._source,this._included)}get size(){var e;let t=0;return(e=this._included)==null||e.forEach(i=>{i&&(t+=1)}),t}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class xm{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(var e;;){const t=this._sourceIterator.next();if(t.done)return t;const i=t.value[0];if((e=this._included)!=null&&e.get(i))return t}}}class Tm extends Br{constructor(e){super(),this._sources=e}onAdd(e,t,i){if(!this._isKeyAtSourceOccluded(e,t)){const s=this._getValueFromOccludedSources(e,t);s!==void 0&&this.emitRemove(t,s),this.emitAdd(t,i)}}onRemove(e,t,i){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,i);const s=this._getValueFromOccludedSources(e,t);s!==void 0&&this.emitAdd(t,s)}}onUpdate(e,t,i,s){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,i,s)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new Cm(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const i=this._sources.indexOf(e);for(let s=0;s<i;s+=1)if(this._sources[s].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const i=this._sources.indexOf(e);for(let s=i+1;s<this._sources.length;s+=1){const o=this._sources[s].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){if(super.onUnsubscribeLast(),this._subscriptions)for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new Rm(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const i=t.get(e);if(i)return i}}}class Rm{constructor(e){this._sourceIndex=-1,this._encounteredKeys=new Set,this._sources=e}next(){var e;let t;for(;!t;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0,value:null};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const i=(e=this._currentIterator)==null?void 0:e.next();if(!i||i.done){this._currentIterator=void 0;continue}else{const s=i.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),t=i)}}return t}}class Cm{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=void 0}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription&&(this._subscription=this._subscription())}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,i){this._joinedMap.onUpdate(this._source,e,t,i)}onReset(){this._joinedMap.onReset()}}class Mm extends Br{constructor(e,t,i){super(),this._source=e,this._mapper=t,this._updater=i,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const i=this._mappedValues.get(e);i&&this.emitUpdate(e,i,t)}onAdd(e,t){const i=this._emitSpontaneousUpdate.bind(this,e),s=this._mapper(t,i);this._mappedValues.set(e,s),this.emitAdd(e,s)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&t&&this.emitRemove(e,t)}onUpdate(e,t,i){var s;if(!this._mappedValues)return;const n=this._mappedValues.get(e);n!==void 0&&((s=this._updater)==null||s.call(this,i,n,t),this.emitUpdate(e,n,i))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const i=this._emitSpontaneousUpdate.bind(this,e),s=this._mapper(t,i);this._mappedValues.set(e,s)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription()),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class Ht extends Br{constructor(e){super(),this._values=new Map(e)}update(e,t){const i=this._values.get(e);return i!==void 0?(this._values.set(e,i),this.emitUpdate(e,i,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class Am extends Br{constructor(e,t){super(),this.key=e,this.observableValue=t}onSubscribeFirst(){this.subscription=this.observableValue.subscribe(e=>{this.emitUpdate(this.key,e,void 0)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.subscription(),super.onUnsubscribeLast()}*[Symbol.iterator](){yield[this.key,this.observableValue.get()]}get size(){return 1}get(e){if(e==this.key)return this.observableValue.get()}}class Nm extends Ct{constructor(e){super(),this.map=e}onSubscribeFirst(){this.subscription=this.map.subscribe({onAdd:(e,t)=>{this.emit(this.get())},onRemove:(e,t)=>{this.emit(this.get())},onUpdate:(e,t)=>{},onReset:()=>{this.emit(this.get())}})}onUnsubscribeLast(){var e;this.subscription=(e=this.subscription)==null?void 0:e.call(this)}get(){return this.map.size}}function Dm(r,e,t,i){const s=r(e);let n=!1;return s.elapsed().then(()=>{n=!0,t.abort()},()=>{}),i.then(o=>(s.abort(),o),o=>{throw s.abort(),o.name==="AbortError"&&n?new zt(`Request timed out after ${e}ms`,!0):o})}function ql(r,e=Math.random){return r.includes("?")?r=r+"&":r=r+"?",r+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function zl(r){var e;const t=new FormData;for(const[i,s]of r)((e=s.blob)==null?void 0:e.nativeBlob)&&s.name?t.set(i,s.blob.nativeBlob,s.name):t.set(i,s);return t}class Vm{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function Um(r,{method:e,headers:t,timeout:i,format:s,uploadProgress:n}){const o=new XMLHttpRequest;if(n&&o.upload.addEventListener("progress",a=>n(a.loaded)),o.open(e,r),s==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,l]of t.entries())try{o.setRequestHeader(a,l)}catch(d){console.info(`Could not set ${a} header: ${d.message}`)}return i&&(o.timeout=i),o}function Pm(r,e,t){return new Promise((i,s)=>{r.addEventListener("load",()=>i(r)),r.addEventListener("abort",()=>s(new yt)),r.addEventListener("error",()=>s(new zt(`Error ${e} ${t}`))),r.addEventListener("timeout",()=>s(new zt(`Timeout ${e} ${t}`,!0)))})}function Gl(r,e){let{cache:t,format:i,body:s,method:n}=e;t||(r=ql(r));const o=Um(r,e),a=Pm(o,n,r).then(l=>{const{status:d}=l;let c=null;return i==="buffer"?c=l.response:l.getResponseHeader("Content-Type")==="application/json"&&(c=JSON.parse(l.responseText)),{status:d,body:c}});return s?.nativeBlob&&(s=s.nativeBlob),s instanceof Map&&(s=zl(s)),o.send(s||null),new Vm(a,o)}class uc{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const i=new Promise((s,n)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",n(o)}}});this.promise=Promise.race([e,i])}}abort(){this._controller.abort()}response(){return this.promise}}function Om(r,e){return function(i,s){if(e?.haltRequests)return new uc(new Promise(()=>{}),{});if(s?.uploadProgress)return Gl(i,s);let{method:n,headers:o,body:a,timeout:l,format:d,cache:c=!1}=s;const h=typeof AbortController=="function"?new AbortController:null;a?.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=zl(a));let p={method:n,body:a};if(h&&(p=Object.assign(p,{signal:h.signal})),c||(i=ql(i)),p=Object.assign(p,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const w=new Headers;for(const[x,M]of o.entries())w.append(x,M);p.headers=w}const g=fetch(i,p).then(async w=>{const{status:x}=w;let M;try{d==="json"?M=await w.json():d==="buffer"?M=await w.arrayBuffer():d==="text"&&(M=await w.text())}catch(D){if(!(D.name==="SyntaxError"&&x>=400))throw D}return{status:x,body:M}},w=>{throw w.name==="AbortError"?new yt:w instanceof TypeError?new zt(`${n} ${i}: ${w.message}`):w}),y=new uc(g,h);return l&&(y.promise=Dm(r,l,y,y.promise)),y}}function Fn(){}class Fm{constructor(){this.item=new Lm(this)}log(e){return this.item}addReporter(){}get reporters(){return[]}getOpenRootItems(){return[]}forceFinish(){}child(e){return this.item}run(e,t){return t(this.item)}wrapOrRun(e,t,i){return e?e.wrap(t,i):this.run(t,i)}runDetached(e,t){return new Promise(i=>i(t(this.item))).then(Fn,Fn),this.item}get level(){return ot}}class Lm{constructor(e){this.logger=e}discard(){}wrap(e,t){return this.run(t)}run(e){return e(this)}log(e){return this}set(e){return this}runDetached(e,t){return new Promise(i=>i(t(this))).then(Fn,Fn),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return ot}get duration(){return 0}catch(e){return e}child(){return this}finish(){}forceFinish(){}serialize(){}}const Bm=new Fm;class hc{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return $e(this._target.count(e))}get(e){return $e(this._target.get(e))}getKey(e){return this._target.supports("getKey")?$e(this._target.getKey(e)):$e(this._target.get(e)).then(t=>{if(t){let i=this._target.keyPath;return typeof i=="string"&&(i=[i]),i.reduce((s,n)=>s[n],t)}})}reduce(e,t,i){return this._reduce(e,t,i,"next")}reduceReverse(e,t,i){return this._reduce(e,t,i,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const i=this._openCursor(e,t),s=[];return await Se(i,n=>(s.push(n),Jt)),s}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let i;return await Se(t,(s,n)=>(i=n,lc)),i}async iterateValues(e,t){const i=this._target.openCursor(e,"next");await Se(i,(s,n,o)=>({done:t(s,n,o)}))}async iterateKeys(e,t){const i=this._target.openKeyCursor(e,"next");await Se(i,(s,n,o)=>({done:t(n,o)}))}async findExistingKeys(e,t,i){const s=(h,p)=>t?-this.idbFactory.cmp(h,p):this.idbFactory.cmp(h,p),n=e.slice().sort(s),o=n[0],a=n[n.length-1],l=t?"prev":"next",d=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),l);let c=0;await Se(d,(h,p,g)=>{for(;c<n.length&&s(n[c],p)<0;)c+=1;let y=!1;if(n[c]===p){const w=g.primaryKey;y=i(p,w),c+=1}return y||c>=n.length?lc:{done:!1,jumpTo:n[c]}})}_reduce(e,t,i,s){let n=i;const o=this._openCursor(e,s);return Se(o,a=>(n=t(n,a),Jt))}_selectLimit(e,t,i){return this._selectUntil(e,s=>s.length===t,i)}async _selectUntil(e,t,i){const s=this._openCursor(e,i),n=[];return await Se(s,o=>(n.push(o),{done:t(n,o)})),n}async _selectWhile(e,t,i){const s=this._openCursor(e,i),n=[];return await Se(s,o=>{const a=t(o);return a&&n.push(o),{done:!a}}),n}async iterateWhile(e,t){const i=this._openCursor(e,"next");await Se(i,s=>({done:!t(s)}))}async _find(e,t,i){const s=this._openCursor(e,i);let n;if(await Se(s,a=>{const l=t(a);return l&&(n=a),{done:l}}))return n}}const Pt=!1;function Ot(r,e,t){var i,s;const n=t?.name,o=(s=(i=t?.transaction)==null?void 0:i.db)==null?void 0:s.name;console.info(`${o}.${n}.${r}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class mc{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(Pt&&Ot("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(Pt&&Ot("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(i){throw new bt("openKeyCursor",this._qt,i,[e,t])}}openCursor(e,t){try{return Pt&&Ot("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(i){throw new bt("openCursor",this._qt,i,[e,t])}}put(e,t){try{return Pt&&Ot("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(i){throw new bt("put",this._qt,i,[e,t])}}add(e,t){try{return Pt&&Ot("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(i){throw new bt("add",this._qt,i,[e,t])}}get(e){try{return Pt&&Ot("get",[e],this._qt),this._qt.get(e)}catch(t){throw new bt("get",this._qt,t,[e])}}getKey(e){try{return Pt&&Ot("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new bt("getKey",this._qt,t,[e])}}delete(e){try{return Pt&&Ot("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new bt("delete",this._qt,t,[e])}}clear(){try{return Pt&&Ot("clear",[],this._qt),this._qtStore.clear()}catch(e){throw new bt("delete",this._qt,e,[])}}count(e){try{return this._qt.count(e)}catch(t){throw new bt("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new bt("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class Hl extends hc{constructor(e,t){super(new mc(e),t)}get _idbStore(){return this._target}index(e){return new hc(new mc(this._idbStore.index(e)),this._transaction)}put(e,t){const i=this._idbStore.put(e);this._prepareErrorLog(i,t,"put",void 0,e)}add(e,t){const i=this._idbStore.add(e);this._prepareErrorLog(i,t,"add",void 0,e)}async tryAdd(e,t){try{return await $e(this._idbStore.add(e)),!0}catch(i){if(i instanceof la)return t.log({l:"could not write",id:this._getKeys(e),e:i},t.level.Warn),i.preventTransactionAbort(),!1;throw i}}delete(e,t){const i=this._idbStore.delete(e);this._prepareErrorLog(i,t,"delete",e,void 0)}clear(e){const t=this._idbStore.clear();this._prepareErrorLog(t,e,"delete",void 0,void 0)}_prepareErrorLog(e,t,i,s,n){t&&t.ensureRefId(),$e(e).catch(o=>{let a;n?a=this._getKeys(n):s&&(a=[s]),this._transaction.addWriteError(o,t,i,a)})}_getKeys(e){const t=[],{keyPath:i}=this._idbStore;try{t.push(this._readKeyPath(e,i))}catch{console.warn("could not read keyPath",i)}for(const s of this._idbStore.indexNames)try{const n=this._idbStore.index(s);t.push(this._readKeyPath(e,n.keyPath))}catch{console.warn("could not read index",s)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let i=e;for(const s of t)if(typeof i=="object")i=i[s];else break;return i}else return e[t]}}var pi=(r=>(r[r.Sync=0]="Sync",r[r.Timeline=1]="Timeline",r[r.Retry=2]="Retry",r))(pi||{});const Ze="e2ee:",ua="m.olm.v1.curve25519-aes-sha2",Rt="m.megolm.v1.aes-sha2";class De extends Error{constructor(e,t,i){super(`Decryption error ${e}${i?": "+JSON.stringify(i):""}`),this.code=e,this.event=t,this.detailsObj=i}}const Km="ed25519";function Gi(r){return r.keys[`ed25519:${r.device_id}`]}function It(r){return r.keys[`curve25519:${r.device_id}`]}function $m(r,e,t){var i,s;return(s=(i=r?.signatures)==null?void 0:i[e])==null?void 0:s[`${Km}:${t}`]}var he=(r=>(r[r.Valid=0]="Valid",r[r.Invalid=1]="Invalid",r[r.NotSigned=2]="NotSigned",r))(he||{});function ha(r,e,t,i,s,n){const o=$m(s,e,t);if(!o)return n?.set("no_signature",!0),2;const a=Object.assign({},s);delete a.unsigned,delete a.signatures;const l=Lr.stringify(a);try{return r.ed25519_verify(i,l,o),0}catch(d){if(n){const c=n.log({l:"Invalid signature, ignoring.",ed25519Key:i,canonicalJson:l,signature:o});c.error=d,c.logLevel=n.level.Warn}return 1}}function jm(){return{type:"m.room.encryption",state_key:"",content:{algorithm:Rt,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function tn(r,e){switch(e){case"world_readable":return!0;case"shared":return r!==void 0;case"joined":return r==="join";case"invited":return r==="invite"||r==="join";default:return!1}}function qm(r){return JSON.stringify(Wl(r))}function zm(r){return Yl(JSON.parse(r))}function Wl(r){if(typeof r=="object"&&r!==null&&!Array.isArray(r)){if(r.byteLength)return{_type:r.constructor.name,value:Array.from(r)};let e={};for(const t in r)r.hasOwnProperty(t)&&(e[t]=Wl(r[t]));return e}else return r}function Yl(r){if(typeof r=="object"&&r!==null&&!Array.isArray(r)){if(typeof r._type=="string")switch(r._type){case"Int8Array":return Int8Array.from(r.value);case"Uint8Array":return Uint8Array.from(r.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(r.value);case"Int16Array":return Int16Array.from(r.value);case"Uint16Array":return Uint16Array.from(r.value);case"Int32Array":return Int32Array.from(r.value);case"Uint32Array":return Uint32Array.from(r.value);case"Float32Array":return Float32Array.from(r.value);case"Float64Array":return Float64Array.from(r.value);case"BigInt64Array":return BigInt64Array.from(r.value);case"BigUint64Array":return BigUint64Array.from(r.value);default:return r.value}let e={};for(const t in r)r.hasOwnProperty(t)&&(e[t]=Yl(r[t]));return e}else return r}function Jl(r){return`${r}.session.`}function Gm(r,e){const t=[];for(let i=0;i<r.length;i++){const s=r.key(i);s?.startsWith(Jl(e))&&t.push(s)}for(const i of t)r.removeItem(i)}class ma{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return Jl(this._sessionStore.databaseName)}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const i=this._localStorageKeyPrefix+e,s=qm(t);this._localStorage.setItem(i,s)}catch(i){console.error("could not write to localStorage",i)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(Ze)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const i=this._localStorageKeyPrefix,s=i+Ze;for(let n=0;n<this._localStorage.length;n+=1){const o=this._localStorage.key(n);if(o.startsWith(s)){const a=zm(this._localStorage.getItem(o)),l=o.substr(i.length),d=await this._sessionStore.getKey(l)===l;e.set(l,!d),d||(this._sessionStore.put({key:l,value:a}),t=!0)}}return t}set(e,t){e.startsWith(Ze)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(Ze)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(Ze)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class pc{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class Hm{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}class Ee{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new Ee(this.fragmentId+1,_e.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new Ee(this.fragmentId,this.eventIndex-1)}nextKey(){return new Ee(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new Ee(_e.maxStorageKey,_e.maxStorageKey)}static get minKey(){return new Ee(_e.minStorageKey,_e.minStorageKey)}static get defaultLiveKey(){return Ee.defaultFragmentKey(_e.minStorageKey)}static defaultFragmentKey(e){return new Ee(e,_e.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===e?.fragmentId&&this.eventIndex===e?.eventIndex}}function Xl(r,e,t){return{fragmentId:r.fragmentId,eventIndex:r.eventIndex,roomId:e,event:t}}function fr(r,e,t){t.isForward?r.push(e):r.unshift(e)}function Wm(r,e,t){return t.isForward?r.concat(e):e.concat(r)}function mt(r,e,t){return`${r}|${On(e)}|${On(t)}`}function Ym(r){const[e,t,i]=r.split("|");return{roomId:e,eventKey:new Ee(Po(t),Po(i))}}function sn(r,e){return`${r}|${e}`}function _c(r){const[e,t]=r.split("|");return{roomId:e,eventId:t}}class rn{constructor(e,t,i,s,n=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=i,this._upper=s,this._lowerOpen=n,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(mt(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(mt(e,this._lower.fragmentId,this._lower.eventIndex),mt(e,this._lower.fragmentId,_e.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(mt(e,this._upper.fragmentId,_e.minStorageKey),mt(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(mt(e,this._lower.fragmentId,this._lower.eventIndex),mt(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new qt("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class Jm{constructor(e){this._timelineStore=e}onlyRange(e){return new rn(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new rn(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new rn(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,i=!1,s=!1){return new rn(this._timelineStore.IDBKeyRange,void 0,e,t,i,s)}async lastEvents(e,t,i){const s=Ee.maxKey;return s.fragmentId=t,this.eventsBefore(e,s,i)}async firstEvents(e,t,i){const s=Ee.minKey;return s.fragmentId=t,this.eventsAfter(e,s,i)}eventsAfter(e,t,i){const s=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(s,i)}async eventsBefore(e,t,i){const s=this.upperBoundRange(t,!0).asIDBKeyRange(e),n=await this._timelineStore.selectLimitReverse(s,i);return n.reverse(),n}async getEventKeysForIds(e,t){const i=this._timelineStore.index("byEventId"),s=t.map(o=>sn(e,o)),n=new Map;return await i.findExistingKeys(s,!1,(o,a)=>{const{eventId:l}=_c(o),{eventKey:d}=Ym(a);return n.set(l,d),!1}),n}async findFirstOccurringEventId(e,t){const i=this._timelineStore.index("byEventId"),s=t.map(l=>sn(e,l)),n=new Array(s.length);let o;function a(){for(let l=0;l<n.length;++l){if(n[l]===void 0)return;if(n[l]===!0)return s[l]}}return await i.findExistingKeys(s,!1,(l,d)=>{const c=s.indexOf(l);return n[c]=d,o=a(),!!o}),o&&_c(o).eventId}tryInsert(e,t){return e.key=mt(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=sn(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(mt(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(sn(e,t))}removeAllForRoom(e){const t=mt(e,_e.minStorageKey,_e.minStorageKey),i=mt(e,_e.maxStorageKey,_e.maxStorageKey),s=this._timelineStore.IDBKeyRange.bound(t,i);this._timelineStore.delete(s)}}const fe="\0",pe="\u{10FFFF}";function St(r,e,t,i){return`${r}|${e}|${t}|${i}`}function fc(r){const[e,t,i,s]=r.split("|");return{roomId:e,targetEventId:t,relType:i,sourceEventId:s}}class Xm{constructor(e){this._store=e}add(e,t,i,s){this._store.add({key:St(e,t,i,s)})}remove(e,t,i,s){this._store.delete(St(e,t,i,s))}removeAllForTarget(e,t){const i=this._store.IDBKeyRange.bound(St(e,t,fe,fe),St(e,t,pe,pe),!0,!0);this._store.delete(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(St(e,fe,fe,fe),St(e,pe,pe,pe),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,i){const s=this._store.IDBKeyRange.bound(St(e,t,i,fe),St(e,t,i,pe),!0,!0);return(await this._store.selectAll(s)).map(o=>fc(o.key))}async getAllForTarget(e,t){const i=this._store.IDBKeyRange.bound(St(e,t,fe,fe),St(e,t,pe,pe),!0,!0);return(await this._store.selectAll(i)).map(n=>fc(n.key))}}function nn(r,e,t){return`${r}|${e}|${t}`}class Qm{constructor(e){this._roomStateStore=e}get(e,t,i){const s=nn(e,t,i);return this._roomStateStore.get(s)}getAllForType(e,t){const i=this._roomStateStore.IDBKeyRange.bound(nn(e,t,""),nn(e,t,pe),!1,!0);return this._roomStateStore.selectAll(i)}set(e,t){const i=nn(e,t.type,t.state_key),s={roomId:e,event:t,key:i};this._roomStateStore.put(s)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${pe}`,!0,!0);this._roomStateStore.delete(t)}}function on(r,e){return`${r}|${e}`}function Zm(r){const[e,t]=r.split("|");return{roomId:e,userId:t}}class Ql{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(on(e,t))}set(e){e.key=on(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(on(e,""));return this._roomMembersStore.selectWhile(t,i=>i.roomId===e)}async getAllUserIds(e){const t=[],i=this._roomMembersStore.IDBKeyRange.lowerBound(on(e,""));return await this._roomMembersStore.iterateKeys(i,s=>{const n=Zm(s);return n.roomId===e?(t.push(n.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${pe}`,!0,!0);this._roomMembersStore.delete(t)}}function an(r,e){return`${r}|${On(e)}`}class ep{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(an(e,_e.minStorageKey),an(e,_e.maxStorageKey))}catch(t){throw new qt(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=an(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(an(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function Ui(r,e){return`${r}|${On(e)}`}function tp(r){const[e,t]=r.split("|"),i=Po(t);return{roomId:e,queueIndex:i}}class ip{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(Ui(e,_e.minStorageKey),Ui(e,_e.maxStorageKey),!1,!1),i=await this._eventStore.findMaxKey(t);if(i)return tp(i).queueIndex}remove(e,t){const i=this._eventStore.IDBKeyRange.only(Ui(e,t));this._eventStore.delete(i)}async exists(e,t){const i=this._eventStore.IDBKeyRange.only(Ui(e,t));return!!await this._eventStore.getKey(i)}add(e){e.key=Ui(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=Ui(e,_e.minStorageKey),i=Ui(e,_e.maxStorageKey),s=this._eventStore.IDBKeyRange.bound(t,i);this._eventStore.delete(s)}}class sp{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function Pi(r,e){return`${r}|${e}`}function rp(r){const[e,t]=r.split("|");return{userId:e,deviceId:t}}class np{constructor(e){this._store=e}async getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(Pi(e,fe));return(await this._store.selectWhile(t,s=>s.deviceKey.user_id===e)).map(s=>s.deviceKey)}async getAllDeviceIds(e){const t=[],i=this._store.IDBKeyRange.lowerBound(Pi(e,fe));return await this._store.iterateKeys(i,s=>{const n=rp(s);return n.userId===e?(t.push(n.deviceId),!1):!0}),t}async get(e,t){var i;return(i=await this._store.get(Pi(e,t)))==null?void 0:i.deviceKey}set(e){this._store.put({key:Pi(e.user_id,e.device_id),curve25519Key:It(e),deviceKey:e})}async getByCurve25519Key(e){const t=await this._store.index("byCurve25519Key").get(e);return t?.deviceKey}remove(e,t){this._store.delete(Pi(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(Pi(e,fe),Pi(e,pe),!0,!0);this._store.delete(t)}}function ir(r,e){return`${r}|${e}`}class op{constructor(e){this._store=e}async get(e,t){var i;return(i=await this._store.get(ir(e,t)))==null?void 0:i.crossSigningKey}set(e){this._store.put({key:ir(e.user_id,e.usage[0]),crossSigningKey:e})}remove(e,t){this._store.delete(ir(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(ir(e,fe),ir(e,pe),!0,!0);this._store.delete(t)}}function sr(r,e){return`${r}|${e}`}function ap(r){const[e,t]=r.split("|");return{senderKey:e,sessionId:t}}class cp{constructor(e){this._store=e}async getSessionIds(e){const t=[],i=this._store.IDBKeyRange.lowerBound(sr(e,""));return await this._store.iterateKeys(i,s=>{const n=ap(s);return n.senderKey===e?(t.push(n.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(sr(e,""));return this._store.selectWhile(t,i=>i.senderKey===e)}get(e,t){return this._store.get(sr(e,t))}set(e){e.key=sr(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(sr(e,t))}}var Qn=(r=>(r[r.NotBackedUp=0]="NotBackedUp",r[r.BackedUp=1]="BackedUp",r))(Qn||{}),Kr=(r=>(r[r.DeviceMessage=1]="DeviceMessage",r[r.Backup=2]="Backup",r[r.Outbound=3]="Outbound",r))(Kr||{});function ps(r,e,t){return`${r}|${e}|${t}`}class lp{constructor(e){this._store=e}async has(e,t,i){const s=ps(e,t,i),n=await this._store.getKey(s);return s===n}get(e,t,i){return this._store.get(ps(e,t,i))}set(e){const t=e;t.key=ps(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ps(e,fe,fe),ps(e,pe,pe));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,i){const s=await this._store.get(ps(e,t,i));s&&(s.backup=1,this._store.put(s))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(i,s,n)=>(i.backup=0,n.update(i),t+=1,!1)),t}}class dp{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function cn(r,e,t){return`${r}|${e}|${t}`}class up{constructor(e){this._store=e}get(e,t,i){return this._store.get(cn(e,t,i))}set(e,t,i,s){s.key=cn(e,t,i),this._store.put(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(cn(e,fe,fe),cn(e,pe,pe));this._store.delete(t)}}function dr(r,e){return`${r}|${e}`}class hp{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const i=dr(t,e),s=[];return await this._store.index("byScopeAndType").iterateWhile(i,n=>n.scopeTypeKey!==i?!1:(s.push(n),!0)),s}add(e){e.scopeTypeKey=dr(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(dr(e,fe),dr(e,pe));await this._store.index("byScopeAndType").iterateValues(t,(s,n,o)=>(o.delete(),!0))}}class mp{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}async getAll(){return await this._store.selectAll()}}function _s(r,e,t){return`${r}|${e}|${t}`}function gc(r){const[e,t,i]=r.key.split("|");return{intent:e,roomId:t,callId:i,timestamp:r.timestamp}}class pp{constructor(e){this._callStore=e}async getByIntent(e){const t=this._callStore.IDBKeyRange.bound(_s(e,fe,fe),_s(e,pe,pe),!0,!0);return(await this._callStore.selectAll(t)).map(s=>gc(s))}async getByIntentAndRoom(e,t){const i=this._callStore.IDBKeyRange.bound(_s(e,t,fe),_s(e,t,pe),!0,!0);return(await this._callStore.selectAll(i)).map(n=>gc(n))}add(e){const t={key:_s(e.intent,e.roomId,e.callId),timestamp:e.timestamp};this._callStore.add(t)}remove(e,t,i){this._callStore.delete(_s(e,t,i))}}class _p{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e,t){t.key=e,this._store.put(t)}remove(e){this._store.delete(e)}deleteAllSecrets(){this._store.clear()}}class fp{constructor(e,t,i,s){this.error=e,this.refItem=t,this.operationName=i,this.keys=s}}class yc{constructor(e,t,i){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=i,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new qt(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new Hl(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const i=this._idbStore(e);this._stores[e]=t(i)}return this._stores[e]}get session(){return this._store(H.session,e=>new ma(e,this._storage.localStorage))}get roomSummary(){return this._store(H.roomSummary,e=>new pc(e))}get archivedRoomSummary(){return this._store(H.archivedRoomSummary,e=>new pc(e))}get invites(){return this._store(H.invites,e=>new Hm(e))}get timelineFragments(){return this._store(H.timelineFragments,e=>new ep(e))}get timelineEvents(){return this._store(H.timelineEvents,e=>new Jm(e))}get timelineRelations(){return this._store(H.timelineRelations,e=>new Xm(e))}get roomState(){return this._store(H.roomState,e=>new Qm(e))}get roomMembers(){return this._store(H.roomMembers,e=>new Ql(e))}get pendingEvents(){return this._store(H.pendingEvents,e=>new ip(e))}get userIdentities(){return this._store(H.userIdentities,e=>new sp(e))}get deviceKeys(){return this._store(H.deviceKeys,e=>new np(e))}get crossSigningKeys(){return this._store(H.crossSigningKeys,e=>new op(e))}get olmSessions(){return this._store(H.olmSessions,e=>new cp(e))}get inboundGroupSessions(){return this._store(H.inboundGroupSessions,e=>new lp(e))}get outboundGroupSessions(){return this._store(H.outboundGroupSessions,e=>new dp(e))}get groupSessionDecryptions(){return this._store(H.groupSessionDecryptions,e=>new up(e))}get operations(){return this._store(H.operations,e=>new hp(e))}get accountData(){return this._store(H.accountData,e=>new mp(e))}get calls(){return this._store(H.calls,e=>new pp(e))}get sharedSecrets(){return this._store(H.sharedSecrets,e=>new _p(e))}async complete(e){try{await Er(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof qt&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e?.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,i,s){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new fp(e,t,i,s))}_logWriteErrors(e){const t=s=>{e||s.set("allowedStoreNames",this._allowedStoreNames);for(const n of this._writeErrors)s.wrap({l:n.operationName,id:n.keys},o=>{n.refItem&&o.refDetached(n.refItem),o.catch(n.error)})},i=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(i,t):this.logger.run(i,t)}}const vc="782rh281re38-boguskey";class gp{constructor(e,t,i,s,n,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=i,this._hasWebkitEarlyCloseTxnBug=s,this.storeNames=H,this.localStorage=n,this.logger=o}_validateStoreNames(e){const t=e.findIndex(i=>!Sr.includes(i));if(t!==-1)throw new qt(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await $e(t.objectStore(e[0]).get(vc)),new yc(t,e,this)}catch(t){throw new qt("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await $e(t.objectStore(e[0]).get(vc)),new yc(t,e,this)}catch(t){throw new qt("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function yp(r){const e=r.transaction(Sr,"readonly"),t={};return await Promise.all(Sr.map(async i=>{const s=t[i]=[],n=e.objectStore(i);await Se(n.openCursor(),o=>(s.push(o),Jt))})),t}async function vp(r,e){const t=r.transaction(Sr,"readwrite");for(const i of Sr){const s=t.objectStore(i);for(const n of e[i])s.add(n)}await Er(t)}function Oo(r){var e;return((e=r.unsigned)==null?void 0:e.prev_content)||r.prev_content}const Tt="m.room.redaction";function Fo(r){var e;return!!((e=r?.unsigned)!=null&&e.redacted_because)}var we=(r=>(r[r.None=1]="None",r[r.BeingCreated=2]="BeingCreated",r[r.Invited=4]="Invited",r[r.Joined=8]="Joined",r[r.Replaced=16]="Replaced",r[r.Archived=32]="Archived",r))(we||{}),Wt=(r=>(r[r.DirectMessage=0]="DirectMessage",r[r.Private=1]="Private",r[r.Public=2]="Public",r))(Wt||{});function Es(r,e){var t,i;let s;const n=l=>{const d=e(l);d instanceof Promise&&(s=s??[],s.push(d))},o=(t=r.state)==null?void 0:t.events;if(o)for(let l=0;l<o.length;l++)n(o[l]);let a=(i=r.timeline)==null?void 0:i.events;if(a)for(let l=0;l<a.length;l++){const d=a[l];typeof d.state_key=="string"&&n(d)}if(s)return Promise.all(s).then(()=>{})}const st="m.room.member";class Q{constructor(e){this._data=e}static fromUserId(e,t,i){return new Q({roomId:e,userId:t,membership:i})}static fromMemberEvent(e,t){const i=t?.state_key;if(typeof i!="string")return;const s=t.content,n=Oo(t),o=s?.membership,a=s?.displayname||n?.displayname,l=s?.avatar_url||n?.avatar_url;return this._validateAndCreateMember(e,i,o,a,l)}static fromReplacingMemberEvent(e,t){const i=t&&t.state_key;if(typeof i!="string")return;const s=Oo(t);return this._validateAndCreateMember(e,i,s?.membership,s?.displayname,s?.avatar_url)}static _validateAndCreateMember(e,t,i,s,n){if(typeof i=="string")return new Q({roomId:e,userId:t,membership:i,avatarUrl:n,displayName:s})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,i=e._data;return t.roomId===i.roomId&&t.userId===i.userId&&t.membership===i.membership&&t.displayName===i.displayName&&t.avatarUrl===i.avatarUrl}}class Zl{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get wasInvited(){return this.previousMembership==="invite"&&this.membership!=="invite"}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}function wp(r,e,t,i,s){let n=!1;if(t instanceof Uint8Array){const l=new r.PkSigning;s=l.init_with_seed(t),t=l,n=!0}const o=e.signatures||{};delete e.signatures;const a=e.unsigned;e.unsigned&&delete e.unsigned;try{const l=o[i]||{};return o[i]=l,l["ed25519:"+s]=t.sign(Lr.stringify(e))}finally{e.signatures=o,a&&(e.unsigned=a),n&&t.free()}}class Zt{constructor(e){this.options=e,this.ourUserId=e.ourUserId,this.ourUserDeviceId=e.ourUserDeviceId,this.otherUserId=e.otherUserId,this.log=e.log,this.olmSAS=e.olmSas,this.olmUtil=e.olmUtil,this.channel=e.channel,this.e2eeAccount=e.e2eeAccount,this.deviceTracker=e.deviceTracker,this.hsApi=e.hsApi,this.eventEmitter=e.eventEmitter}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}get otherUserDeviceId(){const e=this.channel.otherUserDeviceId;if(!e)throw new Error("Accessed otherUserDeviceId before it was set in channel!");return e}}var P=(r=>(r.Request="m.key.verification.request",r.Ready="m.key.verification.ready",r.Start="m.key.verification.start",r.Accept="m.key.verification.accept",r.Key="m.key.verification.key",r.Cancel="m.key.verification.cancel",r.Mac="m.key.verification.mac",r.Done="m.key.verification.done",r))(P||{}),ae=(r=>(r.UserCancelled="m.user",r.TimedOut="m.timeout",r.UnknownTransaction="m.unknown_transaction",r.UnknownMethod="m.unknown_method",r.UnexpectedMessage="m.unexpected_message",r.KeyMismatch="m.key_mismatch",r.UserMismatch="m.user_mismatch",r.InvalidMessage="m.invalid_message",r.OtherDeviceAccepted="m.accepted",r.MismatchedCommitment="m.mismatched_commitment",r.MismatchedSAS="m.mismatched_sas",r))(ae||{});const ed=["curve25519-hkdf-sha256","curve25519"],td=["sha256"],id=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],sd=["decimal","emoji"],bp=new Set(sd),Sp=[["\u{1F436}","dog"],["\u{1F431}","cat"],["\u{1F981}","lion"],["\u{1F40E}","horse"],["\u{1F984}","unicorn"],["\u{1F437}","pig"],["\u{1F418}","elephant"],["\u{1F430}","rabbit"],["\u{1F43C}","panda"],["\u{1F413}","rooster"],["\u{1F427}","penguin"],["\u{1F422}","turtle"],["\u{1F41F}","fish"],["\u{1F419}","octopus"],["\u{1F98B}","butterfly"],["\u{1F337}","flower"],["\u{1F333}","tree"],["\u{1F335}","cactus"],["\u{1F344}","mushroom"],["\u{1F30F}","globe"],["\u{1F319}","moon"],["\u2601\uFE0F","cloud"],["\u{1F525}","fire"],["\u{1F34C}","banana"],["\u{1F34E}","apple"],["\u{1F353}","strawberry"],["\u{1F33D}","corn"],["\u{1F355}","pizza"],["\u{1F382}","cake"],["\u2764\uFE0F","heart"],["\u{1F642}","smiley"],["\u{1F916}","robot"],["\u{1F3A9}","hat"],["\u{1F453}","glasses"],["\u{1F527}","spanner"],["\u{1F385}","santa"],["\u{1F44D}","thumbs up"],["\u2602\uFE0F","umbrella"],["\u231B","hourglass"],["\u23F0","clock"],["\u{1F381}","gift"],["\u{1F4A1}","light bulb"],["\u{1F4D5}","book"],["\u270F\uFE0F","pencil"],["\u{1F4CE}","paperclip"],["\u2702\uFE0F","scissors"],["\u{1F512}","lock"],["\u{1F511}","key"],["\u{1F528}","hammer"],["\u260E\uFE0F","telephone"],["\u{1F3C1}","flag"],["\u{1F682}","train"],["\u{1F6B2}","bicycle"],["\u2708\uFE0F","aeroplane"],["\u{1F680}","rocket"],["\u{1F3C6}","trophy"],["\u26BD","ball"],["\u{1F3B8}","guitar"],["\u{1F3BA}","trumpet"],["\u{1F514}","bell"],["\u2693\uFE0F","anchor"],["\u{1F3A7}","headphones"],["\u{1F4C1}","folder"],["\u{1F4CC}","pin"]];function Ep(r){return[r[0]>>2,(r[0]&3)<<4|r[1]>>4,(r[1]&15)<<2|r[2]>>6,r[2]&63,r[3]>>2,(r[3]&3)<<4|r[4]>>4,(r[4]&15)<<2|r[5]>>6].map(t=>Sp[t])}const kp={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function rd(r,e){return function(t,i,s){return s.wrap({l:"calculate MAC",method:e},()=>r[kp[e]](t,i))}}class Ip extends Zt{async completeStage(){await this.log.wrap("SendDoneStage.completeStage",async e=>{await this.channel.send(P.Done,{},e),await this.channel.waitForEvent(P.Done),this.eventEmitter.emit("VerificationCompleted",this.otherUserDeviceId)})}}class xp extends Zt{async completeStage(){await this.log.wrap("VerifyMacStage.completeStage",async e=>{const i=this.channel.acceptMessage.content.message_authentication_code,s=rd(this.olmSAS,i);await this.checkMAC(s,e),this.setNextStage(new Ip(this.options))})}async checkMAC(e,t){const{content:i}=this.channel.getReceivedMessage(P.Mac),s="MATRIX_KEY_VERIFICATION_MAC"+this.otherUserId+this.otherUserDeviceId+this.ourUserId+this.ourUserDeviceId+this.channel.id,n=e(Object.keys(i.mac).sort().join(","),s+"KEY_IDS",t);if(i.keys!==n){t.log({l:"MAC verification failed for keys field",keys:i.keys,calculated:n}),this.channel.cancelVerification(ae.KeyMismatch);return}await this.verifyKeys(i.mac,(o,a,l)=>{const d=e(a,s+o,t),c=l===d;return c||(t.log({l:"Mac verification failed for key",keyMac:l,calculatedMAC:d,keyId:o,key:a}),this.channel.cancelVerification(ae.KeyMismatch)),c},t)}async verifyKeys(e,t,i){const s=this.otherUserId;for(const[n,o]of Object.entries(e)){const a=n.split(":",2)[1],l=await this.deviceTracker.deviceForId(s,a,this.hsApi,i);if(l){if(!t(n,Gi(l),o))throw new Error(`MAC verification failed for key ${o}`)}else{const d=await this.deviceTracker.getCrossSigningKeyForUser(s,Lt.Master,this.hsApi,i);if(!d)throw i.log({l:"Fetching msk failed",userId:s}),new Error("Fetching MSK for user failed!");const c=ks(d);if(!(c&&t(n,c,o)))throw new Error(`MAC verification failed for key ${o}`)}}}}class Tp extends Zt{async completeStage(){await this.log.wrap("SendMacStage.completeStage",async e=>{const i=this.channel.acceptMessage.content.message_authentication_code,s=rd(this.olmSAS,i);await this.sendMAC(s,e),await this.channel.waitForEvent(P.Mac),this.setNextStage(new xp(this.options))})}async sendMAC(e,t){const i={},s=[],n="MATRIX_KEY_VERIFICATION_MAC"+this.ourUserId+this.ourUserDeviceId+this.otherUserId+this.otherUserDeviceId+this.channel.id,o=`ed25519:${this.ourUserDeviceId}`,a=this.e2eeAccount.getUnsignedDeviceKey();i[o]=e(a.keys[o],n+o,t),s.push(o);const l=await this.deviceTracker.getCrossSigningKeyForUser(this.ourUserId,Lt.Master,this.hsApi,t);if(!l)throw t.log({l:"Fetching msk failed",userId:this.ourUserId}),new Error("Fetching MSK for user failed!");const d=ks(l);if(d){const h=`ed25519:${d}`;i[h]=e(d,n+h,t),s.push(h)}const c=e(s.sort().join(","),n+"KEY_IDS",t);await this.channel.send(P.Mac,{mac:i,keys:c},t)}}class xt extends Error{get name(){return"VerificationCancelledError"}get message(){return"Verification is cancelled!"}}const Rp={"curve25519-hkdf-sha256":function(r,e,t){const i=`${r.our.userId}|${r.our.deviceId}|${r.our.publicKey}|`,s=`${r.their.userId}|${r.their.deviceId}|${r.their.publicKey}|`,n="MATRIX_KEY_VERIFICATION_SAS|"+(r.initiatedByMe?i+s:s+i)+r.id;return e.generate_bytes(n,t)},curve25519:function(r,e,t){const i=`${r.our.userId}${r.our.deviceId}`,s=`${r.their.userId}${r.their.deviceId}`,n="MATRIX_KEY_VERIFICATION_SAS"+(r.initiatedByMe?i+s:s+i)+r.id;return e.generate_bytes(n,t)}};class Cp extends Zt{async completeStage(){await this.log.wrap("CalculateSASStage.completeStage",async e=>{if(this.channel.initiatedByUs&&!await this.verifyHashCommitment(e))return;const t=new Promise((n,o)=>{this.resolve=n,this.reject=o});this.olmSAS.set_their_key(this.theirKey);const i=this.generateSASBytes();this.emoji=Ep(Array.from(i)),this.eventEmitter.emit("EmojiGenerated",this);const s=this.channel.waitForEvent(P.Cancel);await Promise.race([t,s]),this.setNextStage(new Tp(this.options))})}async verifyHashCommitment(e){return await e.wrap("CalculateSASStage.verifyHashCommitment",async()=>{const t=this.channel.getReceivedMessage(P.Accept).content,s=this.channel.getReceivedMessage(P.Key).content.key+Lr.stringify(this.channel.startMessage.content),n=t.commitment,o=this.olmUtil.sha256(s);return o!==n?(e.log({l:"Commitment mismatched!",received:n,calculated:o}),await this.channel.cancelVerification(ae.MismatchedCommitment),!1):!0})}generateSASBytes(){const e=this.channel.acceptMessage.content.key_agreement_protocol,t=this.otherUserDeviceId;return Rp[e]({our:{userId:this.ourUserId,deviceId:this.ourUserDeviceId,publicKey:this.olmSAS.get_pubkey()},their:{userId:this.otherUserId,deviceId:t,publicKey:this.theirKey},id:this.channel.id,initiatedByMe:this.channel.initiatedByUs},this.olmSAS,6)}async setEmojiMatch(e){e?this.resolve():(await this.channel.cancelVerification(ae.MismatchedSAS),this.reject(new xt))}get theirKey(){const{content:e}=this.channel.getReceivedMessage(P.Key);return e.key}}class nd extends Zt{async completeStage(){await this.log.wrap("SendKeyStage.completeStage",async e=>{const t=this.olmSAS.get_pubkey();await this.channel.send(P.Key,{key:t},e),await this.channel.waitForEvent(P.Key),this.setNextStage(new Cp(this.options))})}}function ln(r,e){return Array.isArray(r)?r.filter(t=>e.has(t)):[]}class Mp extends Zt{async completeStage(){await this.log.wrap("SendAcceptVerificationStage.completeStage",async e=>{const{content:t}=this.channel.startMessage,i=ln(ed,new Set(t.key_agreement_protocols))[0],s=ln(td,new Set(t.hashes))[0],n=ln(id,new Set(t.message_authentication_codes))[0],o=ln(t.short_authentication_string,bp);if(!i||!s||!n||!o.length){await this.channel.cancelVerification(ae.UnknownMethod);return}const l=this.olmSAS.get_pubkey()+Lr.stringify(t),d={key_agreement_protocol:i,hash:s,message_authentication_code:n,short_authentication_string:o,commitment:this.olmUtil.sha256(l)};await this.channel.send(P.Accept,d,e),await this.channel.waitForEvent(P.Key),this.setNextStage(new nd(this.options))})}}class Qi{constructor(){let e,t;this.promise=new Promise((i,s)=>{e=i,t=s}),this.resolve=i=>{this._value=i,e(i)},this.reject=t}get value(){return this._value}}class pa extends Zt{constructor(){super(...arguments),this.allowSelection=!0}async completeStage(){await this.log.wrap("SelectVerificationMethodStage.completeStage",async e=>{await this.findDeviceName(e),this.eventEmitter.emit("SelectVerificationStage",this);const t=this.channel.waitForEvent(P.Start),i=this.channel.waitForEvent(P.Accept),{content:s}=await Promise.race([t,i]);s.method?(this.allowSelection=!1,this.hasSentStartMessage?(await this.hasSentStartMessage,await this.resolveStartConflict(e)):this.channel.setStartMessage(this.channel.getReceivedMessage(P.Start))):this.channel.setStartMessage(this.channel.getSentMessage(P.Start)),this.channel.initiatedByUs?(await i,this.setNextStage(new nd(this.options))):this.setNextStage(new Mp(this.options))})}async resolveStartConflict(e){await e.wrap("resolveStartConflict",async()=>{const t=this.channel.getReceivedMessage(P.Start),i=this.channel.getSentMessage(P.Start);if(t.content.method!==i.content.method){e.log({l:"Methods don't match for the start messages",received:t.content.method,sent:i.content.method}),await this.channel.cancelVerification(ae.UnexpectedMessage);return}const s=this.ourUserId===this.otherUserId?this.ourUserDeviceId:this.ourUserId,n=this.ourUserId===this.otherUserId?this.otherUserDeviceId:this.otherUserId,o=s<n?i:t;e.log({l:"Start message resolved",message:o,our:s,their:n}),this.channel.setStartMessage(o)})}async findDeviceName(e){await e.wrap("SelectVerificationMethodStage.findDeviceName",async()=>{var t;const i=await this.options.deviceTracker.deviceForId(this.otherUserId,this.otherUserDeviceId,this.options.hsApi,e);if(!i)throw e.log({l:"Cannot find device",userId:this.otherUserId,deviceId:this.otherUserDeviceId}),new Error("Cannot find device");this.otherDeviceName=(t=i.unsigned.device_display_name)!=null?t:i.device_id})}async selectEmojiMethod(e){if(!this.allowSelection)return;const t=new Qi;this.hasSentStartMessage=t.promise;const i={method:"m.sas.v1",from_device:this.ourUserDeviceId,key_agreement_protocols:ed,hashes:td,message_authentication_codes:id,short_authentication_string:sd};await this.channel.send(P.Start,i,e),t.resolve()}}class Ap extends Zt{async completeStage(){await this.log.wrap("SendRequestVerificationStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(P.Request,t,e),this.setNextStage(new pa(this.options)),await this.channel.waitForEvent(P.Ready)})}}class Np extends Zt{async completeStage(){await this.log.wrap("SendReadyStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(P.Ready,t,e),this.setNextStage(new pa(this.options))})}}class Mt{constructor(){this._handlersByName={}}emit(e,t){const i=this._handlersByName[e];i&&i.forEach(s=>s(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let i=this._handlersByName[e];i||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=i=new Set),i.add(t)}off(e,t){const i=this._handlersByName[e];i&&(i.delete(t),i.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}class Dp extends Mt{constructor(e){super(),this.finished=!1;const{olm:t,channel:i,clock:s}=e,n=new t.SAS;this.olmSas=n,this.channel=i,this.otherUserId=e.otherUserId,this.ourUserId=e.ourUserId,this.setupCancelAfterTimeout(s);const o=Pl(Ms({},e),{olmSas:n,eventEmitter:this});i.getReceivedMessage(P.Start)?this.startStage=new pa(o):i.getReceivedMessage(P.Request)?this.startStage=new Np(o):this.startStage=new Ap(o)}async setupCancelAfterTimeout(e){try{this.timeout=e.createTimeout(6e5),await this.timeout.elapsed(),await this.channel.cancelVerification(ae.TimedOut)}catch{}}async abort(){await this.channel.cancelVerification(ae.UserCancelled),this.finished=!0}async verify(){let e=!0;try{let t=this.startStage;do await t.completeStage(),t=t.nextStage;while(t)}catch(t){if(!(t instanceof xt))throw t;e=!1}finally{this.channel.isCancelled&&this.emit("VerificationCancelled",this.channel.cancellation),this.olmSas.free(),this.timeout.abort(),this.finished=!0}return e}get otherDeviceId(){return this.channel.otherUserDeviceId}get isCrossSigningAnotherUser(){return this.otherUserId!==this.ourUserId}}const Ln={[ae.UserCancelled]:"User declined",[ae.InvalidMessage]:"Invalid Message.",[ae.KeyMismatch]:"Key Mismatch.",[ae.OtherDeviceAccepted]:"Another device has accepted this request.",[ae.TimedOut]:"Timed Out",[ae.UnexpectedMessage]:"Unexpected Message.",[ae.UnknownMethod]:"Unknown method.",[ae.UnknownTransaction]:"Unknown Transaction.",[ae.UserMismatch]:"User Mismatch",[ae.MismatchedCommitment]:"Hash commitment does not match.",[ae.MismatchedSAS]:"Emoji/decimal does not match."};function As(r,e){return _a(r,e,()=>[],(t,i)=>t.push(i))}function _a(r,e,t,i){return r.reduce((s,n)=>{const o=e(n);let a=s.get(o);return a||(a=t(),s.set(o,a)),i(a,n),s},new Map)}function wc(r,e){return r.reduce((t,i)=>{const s=e(i);return t[s]?t[s]+=1:t[s]=1,t},{})}function et(){return Bn("t")}function Bn(r){const t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return r+"0".repeat(14-t.length)+t}function bc(r){return r.startsWith("t")&&r.length===15}function Ir(r){const e=As(r,i=>i.device.user_id);return{messages:Array.from(e.entries()).reduce((i,[s,n])=>(i[s]=n.reduce((o,a)=>(o[a.device.device_id]=a.content,o),{}),i),{})}}function go(r){typeof r=="function"?r():r.dispose()}function Vp(r){return r&&(typeof r=="function"||typeof r.dispose=="function")}class Ks{constructor(){this._disposables=[]}track(e){if(!Vp(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),go(e),e):(this._disposables.push(e),e)}untrack(e){if(!this._disposables)return;const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)go(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[i]=this._disposables.splice(t,1);go(i)}else console.warn("disposable not found, did it leak?",e)}}class Up extends Ks{constructor(e,t){super(),this.sentMessages=new Map,this.receivedMessages=new Map,this.waitMap=new Map,this.hsApi=e.hsApi,this.deviceTracker=e.deviceTracker,this.otherUserId=e.otherUserId,this.ourDeviceId=e.ourUserDeviceId,this.clock=e.clock,this.log=e.log,this.deviceMessageHandler=e.deviceMessageHandler,this.track(this.deviceMessageHandler.disposableOn("message",async({unencrypted:i})=>{!i||await this.handleDeviceMessage(i)})),this.track(()=>{this.waitMap.forEach(i=>{i.reject(new xt)})}),t&&(this.id=t.content.transaction_id,this.receivedMessages.set(t.type,t),this.otherUserDeviceId=t.content.from_device)}get cancellation(){return this._cancellation}get isCancelled(){return!!this._cancellation}async send(e,t,i){await i.wrap("ToDeviceChannel.send",async()=>{if(this.isCancelled)throw new xt;if(e===P.Request){await this.handleRequestEventSpecially(e,t,i);return}Object.assign(t,{transaction_id:this.id});const s={messages:{[this.otherUserId]:{[this.otherUserDeviceId]:t}}};await this.hsApi.sendToDevice(e,s,et(),{log:i}).response(),this.sentMessages.set(e,{content:t})})}async handleRequestEventSpecially(e,t,i){await i.wrap("ToDeviceChannel.handleRequestEventSpecially",async()=>{const s=this.clock.now(),n=et();this.id=n,Object.assign(t,{timestamp:s,transaction_id:n});const o={messages:{[this.otherUserId]:{"*":t}}};await this.hsApi.sendToDevice(e,o,et(),{log:i}).response(),this.sentMessages.set(e,{content:t})})}getReceivedMessage(e){return this.receivedMessages.get(e)}getSentMessage(e){return this.sentMessages.get(e)}get acceptMessage(){var e;return(e=this.receivedMessages.get(P.Accept))!=null?e:this.sentMessages.get(P.Accept)}async handleDeviceMessage(e){await this.log.wrap("ToDeviceChannel.handleDeviceMessage",async t=>{if(!!e.type.startsWith("m.key.verification.")){if(e.content.transaction_id!==this.id){await this.cancelVerification(ae.UnknownTransaction);return}if(this.resolveAnyWaits(e),this.receivedMessages.set(e.type,e),e.type===P.Ready){this.handleReadyMessage(e,t);return}if(e.type===P.Cancel){this._cancellation={code:e.content.code,cancelledByUs:!1},this.dispose();return}}})}async handleReadyMessage(e,t){const i=e.content.from_device;this.otherUserDeviceId=i;const n=(await this.deviceTracker.devicesForUsers([this.otherUserId],this.hsApi,t)).filter(d=>d.device_id!==i&&d.device_id!==this.ourDeviceId),o={code:ae.OtherDeviceAccepted,reason:Ln[ae.OtherDeviceAccepted],transaction_id:this.id},a=n.reduce((d,c)=>(d[c.device_id]=o,d),{}),l={messages:{[this.otherUserId]:a}};await this.hsApi.sendToDevice(P.Cancel,l,et(),{log:t}).response()}async cancelVerification(e){await this.log.wrap("Channel.cancelVerification",async t=>{var i;if(this.isCancelled)throw new xt;const s={messages:{[this.otherUserId]:{[(i=this.otherUserDeviceId)!=null?i:"*"]:{code:e,reason:Ln[e],transaction_id:this.id}}}};await this.hsApi.sendToDevice(P.Cancel,s,et(),{log:t}).response(),this._cancellation={code:e,cancelledByUs:!0},this.dispose()})}resolveAnyWaits(e){const{type:t}=e,i=this.waitMap.get(t);i&&(i.resolve(e),this.waitMap.delete(t))}waitForEvent(e){if(this.isCancelled)throw new xt;const t=this.receivedMessages.get(e);if(t)return Promise.resolve(t);const i=this.waitMap.get(e);if(i)return i.promise;const s=new Qi;return this.waitMap.set(e,s),s.promise}setStartMessage(e){this.startMessage=e,this._initiatedByUs=e.content.from_device===this.ourDeviceId}get initiatedByUs(){return this._initiatedByUs}}const Pp="m.reaction",gi="m.annotation",od="m.reference";function Op(r,e){return{"m.relates_to":{event_id:r,key:e,rel_type:gi}}}function Fp(r){return{"m.relates_to":{event_id:r,rel_type:od}}}function fa(r){var e;return r.event_id||((e=r["m.in_reply_to"])==null?void 0:e.event_id)}function ad(r,e){r.event_id!==void 0?r.event_id=e:r["m.in_reply_to"]&&(r["m.in_reply_to"].event_id=e)}function cd(r){if(r.type===Tt)return r.redacts;{const e=oi(r);if(e)return fa(e)}return null}function Ei(r){return r?.["m.relates_to"]}function oi(r){return Ei(r.content)}class Lp extends Ks{constructor(e,t){var i,s;if(super(),this.sentMessages=new Map,this.receivedMessages=new Map,this.waitMap=new Map,this.otherUserId=e.otherUserId,this.ourUserId=e.ourUserId,this.ourDeviceId=e.ourUserDeviceId,this.log=e.log,this.room=e.room,this.subscribeToTimeline(),this.track(()=>{this.waitMap.forEach(n=>{n.reject(new xt)})}),t){this.id=t.id;const n=(s=(i=t.content)==null?void 0:i.msgtype)!=null?s:t.eventType;this.receivedMessages.set(n,t),this.otherUserDeviceId=t.content.from_device}}async subscribeToTimeline(){const e=await this.room.openTimeline();this.track(()=>e.release()),this.track(e.entries.subscribe({onAdd:async(t,i)=>{this.handleRoomMessage(i)},onRemove:()=>{},onUpdate:()=>{}}))}get cancellation(){return this._cancellation}get isCancelled(){return!!this._cancellation}async send(e,t,i){await i.wrap("RoomChannel.send",async s=>{if(this.isCancelled)throw new xt;if(e===P.Request){await this.handleRequestEventSpecially(e,t,i);return}!this.id||(await this.room.ensureMessageKeyIsShared(s),Object.assign(t,Fp(this.id)),await this.room.sendEvent(e,t,void 0,i),this.sentMessages.set(e,{content:t}))})}async handleRequestEventSpecially(e,t,i){await i.wrap("RoomChannel.handleRequestEventSpecially",async()=>{Object.assign(t,{body:`${this.otherUserId} is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.`,msgtype:P.Request,to:this.otherUserId});const s=await this.room.sendEvent("m.room.message",t,void 0,i);this.id=await s.getRemoteId(),this.sentMessages.set(e,{content:t})})}getReceivedMessage(e){return this.receivedMessages.get(e)}getSentMessage(e){return this.sentMessages.get(e)}get acceptMessage(){var e;return(e=this.receivedMessages.get(P.Accept))!=null?e:this.sentMessages.get(P.Accept)}async handleRoomMessage(e){var t,i;const s=(i=(t=e.content)==null?void 0:t.msgtype)!=null?i:e.eventType;!s?.startsWith("m.key.verification")||e.sender===this.ourUserId||e.isLoadedFromStorage||await this.log.wrap("RoomChannel.handleRoomMessage",async n=>{if(!this.id)throw new Error("Couldn't find event-id of request message!");if(cd(e.event)!==this.id){await this.cancelVerification(ae.UnknownTransaction);return}if(this.resolveAnyWaits(e),this.receivedMessages.set(e.eventType,e),e.eventType===P.Ready){const o=e.content.from_device;this.otherUserDeviceId=o;return}if(e.eventType===P.Cancel){this._cancellation={code:e.content.code,cancelledByUs:!1},this.dispose();return}})}async cancelVerification(e){await this.log.wrap("RoomChannel.cancelVerification",async t=>{if(t.log({reason:Ln[e]}),this.isCancelled)throw new xt;const i={code:e,reason:Ln[e]};await this.send(P.Cancel,i,t),this._cancellation={code:e,cancelledByUs:!0},this.dispose()})}resolveAnyWaits(e){const{eventType:t}=e,i=this.waitMap.get(t);i&&(i.resolve(e),this.waitMap.delete(t))}waitForEvent(e){if(this.isCancelled)throw new xt;const t=this.receivedMessages.get(e);if(t)return Promise.resolve(t);const i=this.waitMap.get(e);if(i)return i.promise;const s=new Qi;return this.waitMap.set(e,s),s.promise}setStartMessage(e){if(e.content["m.relates_to"])this.startMessage=e;else{const t=e.clone();t.content["m.relates_to"]=t.event.content["m.relates_to"],this.startMessage=t}this._initiatedByUs=e.content.from_device===this.ourDeviceId}get initiatedByUs(){return this._initiatedByUs}}class Tn{constructor(e){this.startingMessage=e}get deviceId(){return this.startingMessage.content.from_device}get sender(){return this.startingMessage.sender}get id(){var e;return(e=this.startingMessage.content.transaction_id)!=null?e:this.startingMessage.eventId}async reject(e,t,i){const s=e.startVerification(this,t,i);await s?.abort()}}var Lt=(r=>(r.Master="master",r.SelfSigning="self_signing",r.UserSigning="user_signing",r))(Lt||{});class Bp{constructor(e){this._isMasterKeyTrusted=!1,this.observedUsers=new Map,this.receivedSASVerifications=new Ht,this.storage=e.storage,this.secretFetcher=e.secretFetcher,this.platform=e.platform,this.deviceTracker=e.deviceTracker,this.olm=e.olm,this.olmUtil=e.olmUtil,this.hsApi=e.hsApi,this.ownUserId=e.ownUserId,this.deviceId=e.deviceId,this.e2eeAccount=e.e2eeAccount,this.deviceMessageHandler=e.deviceMessageHandler,this.handleSASDeviceMessage=this.handleSASDeviceMessage.bind(this),this.deviceMessageHandler.on("message",this.handleSASDeviceMessage)}async load(e){return await this.verifyMSKFrom4S(!1,e)!==0}async start(e){this.isMasterKeyTrusted||await this.verifyMSKFrom4S(!0,e)}async verifyMSKFrom4S(e,t){return await t.wrap("CrossSigning.verifyMSKFrom4S",async i=>{const s=await this.getSigningKey("master");if(!s)return i.set("failure","no_priv_msk"),0;const n=new this.olm.PkSigning;let o;try{o=n.init_with_seed(s)}finally{n.free()}const a=await this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",e?this.hsApi:void 0,i);if(!a)return i.set("failure","no_pub_msk"),1;const l=a&&ks(a);return i.set({publishedMasterKey:l,derivedPublicKey:o}),this._isMasterKeyTrusted=!!l&&l===o,this._isMasterKeyTrusted?3:(i.set("failure","mismatch"),2)})}get isMasterKeyTrusted(){return this._isMasterKeyTrusted}startVerification(e,t,i){const s=i??t;if(this.sasVerificationInProgress&&!this.sasVerificationInProgress.finished){s.log({sasVerificationAlreadyInProgress:!0});return}const n=e instanceof Tn?e.sender:e,o=e instanceof Tn?e.startingMessage:void 0;let a;return n===this.ownUserId?a=new Up({deviceTracker:this.deviceTracker,hsApi:this.hsApi,otherUserId:n,clock:this.platform.clock,deviceMessageHandler:this.deviceMessageHandler,ourUserDeviceId:this.deviceId,log:s},o):a=new Lp({room:t,otherUserId:n,ourUserId:this.ownUserId,ourUserDeviceId:this.deviceId,log:s},o),this.sasVerificationInProgress=new Dp({olm:this.olm,olmUtil:this.olmUtil,ourUserId:this.ownUserId,ourUserDeviceId:this.deviceId,otherUserId:n,log:s,channel:a,e2eeAccount:this.e2eeAccount,deviceTracker:this.deviceTracker,hsApi:this.hsApi,clock:this.platform.clock}),this.sasVerificationInProgress}async handleSASDeviceMessage({unencrypted:e}){!e||e.type!==P.Request&&e.type!==P.Start||await this.platform.logger.run("CrossSigning.handleSASDeviceMessage",async t=>{var i;const s=e.content.transaction_id,n=e.content.from_device,o=e.sender;if(!n||o!==this.ownUserId)return;if(!await this.areWeVerified(t)){const l=await this.deviceTracker.deviceForId(this.ownUserId,n,this.hsApi,t);if(!l||!await this.isOurUserDeviceTrusted(l,t))return}if(((i=this.sasVerificationInProgress)==null?void 0:i.channel.id)!==s)switch(e.type){case P.Cancel:this.receivedSASVerifications.remove(s);return;case P.Request:case P.Start:this.platform.logger.run("Create SASRequest",()=>{this.receivedSASVerifications.set(s,new Tn(e))});return;default:return}})}async signOwnDevice(e){return e.wrap("CrossSigning.signOwnDevice",async t=>{if(!this._isMasterKeyTrusted){t.set("mskNotTrusted",!0);return}const i=this.e2eeAccount.getUnsignedDeviceKey();return this.signDeviceKey(i,t)})}async signDevice(e,t){return t.wrap("CrossSigning.signDevice",async i=>{this._isMasterKeyTrusted||i.set("mskNotTrusted",!0);const s=await e.verify()&&this._isMasterKeyTrusted;if(i.set("shouldSign",s),!s)return;const n=e.otherDeviceId;i.set("id",n);const o=await this.deviceTracker.deviceForId(this.ownUserId,n,this.hsApi,i);if(!!o)return delete o.signatures,this.signDeviceKey(o,i)})}async signUser(e,t){return t.wrap("CrossSigning.signUser",async i=>{const s=e.otherUserId;if(i.set("id",s),!this._isMasterKeyTrusted){i.set("mskNotTrusted",!0);return}if(s===this.ownUserId)return;const n=await e.verify();if(i.set("shouldSign",n),!n)return;const o=await this.deviceTracker.getCrossSigningKeyForUser(s,"master",this.hsApi,i);if(!o)return;const a=await this.getSigningKey("user_signing");if(!a)return;delete o.signatures,this.signKey(o,a);const l={[o.user_id]:{[ks(o)]:o}};return await this.hsApi.uploadSignatures(l,{log:i}).response(),await this.deviceTracker.invalidateUserKeys(s),this.emitUserTrustUpdate(s,i),o})}async isOurUserDeviceTrusted(e,t){return await this.platform.logger.wrapOrRun(t,"CrossSigning.isOurUserDeviceTrusted",async i=>{const s=await this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"self_signing",this.hsApi,i);return s?this.hasValidSignatureFrom(e,s,i)===he.Valid:!1})}areWeVerified(e){return this.platform.logger.wrapOrRun(e,"CrossSigning.areWeVerified",async t=>{const i=await this.deviceTracker.deviceForId(this.ownUserId,this.deviceId,this.hsApi,t);return this.isOurUserDeviceTrusted(i,e)})}getUserTrust(e,t){return t.wrap("CrossSigning.getUserTrust",async i=>{i.set("id",e);const s=y=>(i.set("result",y),y);if(!this.isMasterKeyTrusted)return s(7);const n=await i.wrap("get our msk",y=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",this.hsApi,y));if(!n)return s(7);const o=await i.wrap("get our usk",y=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"user_signing",this.hsApi,y));if(!o||i.wrap("verify our usk",y=>this.hasValidSignatureFrom(o,n,y))!==he.Valid)return s(7);const l=await i.wrap("get their msk",y=>this.deviceTracker.getCrossSigningKeyForUser(e,"master",this.hsApi,y));if(!l)return s(2);const d=i.wrap("verify their msk",y=>this.hasValidSignatureFrom(l,o,y));if(d!==he.Valid)return d===he.NotSigned?s(2):s(3);const c=await i.wrap("get their ssk",y=>this.deviceTracker.getCrossSigningKeyForUser(e,"self_signing",this.hsApi,y));if(!c||i.wrap("verify their ssk",y=>this.hasValidSignatureFrom(c,l,y))!==he.Valid)return s(6);const g=(await i.wrap("get their devices",y=>this.deviceTracker.devicesForUsers([e],this.hsApi,y))).reduce((y,w)=>i.wrap({l:"verify device",id:w.device_id},x=>{const M=this.hasValidSignatureFrom(w,c,x);return y===he.Invalid||M===he.Invalid?he.Invalid:y===he.NotSigned||M===he.NotSigned?he.NotSigned:y===he.Valid||M===he.Valid?he.Valid:he.Invalid}),he.Valid);return g!==he.Valid?g===he.NotSigned?s(4):s(5):s(1)})}dispose(){this.deviceMessageHandler.off("message",this.handleSASDeviceMessage)}observeUserTrust(e,t){const i=this.observedUsers.get(e);if(i)return i;const s=new kr(void 0,()=>{this.observedUsers.delete(e)});return this.observedUsers.set(e,s),t.wrapDetached("get user trust",async n=>{s.get()===void 0&&s.set(await this.getUserTrust(e,n))}),s}async signDeviceKey(e,t){const i=await this.getSigningKey("self_signing");if(!i)return;this.signKey(e,i);const s={[e.user_id]:{[e.device_id]:e}};return await this.hsApi.uploadSignatures(s,{log:t}).response(),await this.deviceTracker.invalidateUserKeys(this.ownUserId),this.emitUserTrustUpdate(this.ownUserId,t),e}async getSigningKey(e){const t=await this.secretFetcher.getSecret(`m.cross_signing.${e}`);if(t)return new Uint8Array(this.platform.encoding.base64.decode(t))}signKey(e,t){wp(this.olm,e,t,this.ownUserId,"")}hasValidSignatureFrom(e,t,i){const s=ks(t);return s?ha(this.olmUtil,t.user_id,s,s,e,i):he.NotSigned}emitUserTrustUpdate(e,t){const i=this.observedUsers.get(e);i&&i.get()!==void 0&&(i.set(void 0),t.wrapDetached("update user trust",async s=>{i.set(await this.getUserTrust(e,s))}))}}function Kp(r){if(!Array.isArray(r.usage)||r.usage.length!==1)return;const e=r.usage[0];if(!(e!=="master"&&e!=="self_signing"&&e!=="user_signing"))return e}const $p="ed25519",jp=`${$p}:`;function ks(r){const e=Object.keys(r.keys).filter(s=>s.startsWith(jp));if(e.length!==1)return;const t=e[0];return r.keys[t]}function Sc(r){return r.user_id}var ld=(r=>(r[r.Outdated=0]="Outdated",r[r.UpToDate=1]="UpToDate",r))(ld||{});function dd(r,e){return{userId:r,roomIds:e?[e]:[],keysTrackingStatus:0}}function qp(r,e,t){if(r){if(!r.roomIds.includes(t))return r.roomIds.push(t),r}else return r=dd(e,t),r}class zp{constructor(e){this._storage=e.storage,this._getSyncToken=e.getSyncToken,this._olmUtil=e.olmUtil,this._ownUserId=e.ownUserId,this._ownDeviceId=e.ownDeviceId}async writeDeviceChanges(e,t,i){const{userIdentities:s}=t;i.set("changed",e.length),await Promise.all(e.map(async n=>{const o=await s.get(n);o&&(i.log({l:"outdated",id:n}),o.keysTrackingStatus=0,s.set(o))}))}async writeMemberChanges(e,t,i,s){const n=[],o=[];return await Promise.all(Array.from(t.values()).map(async a=>{if(tn(a.membership,i))await this._addRoomToUserIdentity(a.roomId,a.userId,s)&&n.push(a.userId);else if(tn(a.previousMembership,i)){const{roomId:l}=a;if(a.userId===this._ownUserId){const d=await s.roomMembers.getAllUserIds(l);await Promise.all(d.map(c=>this._removeRoomFromUserIdentity(l,c,s)))}else await this._removeRoomFromUserIdentity(l,a.userId,s);o.push(a.userId)}})),{added:n,removed:o}}async trackRoom(e,t,i){if(e.isTrackingMembers||!e.isEncrypted)return;const s=await e.loadMemberList(void 0,i),n=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys]);try{let o;try{o=e.writeIsTrackingMembers(!0,n);const a=Array.from(s.members.values());i.set("members",a.length),await Promise.all(a.map(async l=>{tn(l.membership,t)?await this._addRoomToUserIdentity(l.roomId,l.userId,n):await this._removeRoomFromUserIdentity(l.roomId,l.userId,n)}))}catch(a){throw n.abort(),a}await n.complete(),e.applyIsTrackingMembersChanges(o)}finally{s.release()}}async invalidateUserKeys(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities]),i=await t.userIdentities.get(e);i&&(i.keysTrackingStatus=0,t.userIdentities.set(i)),await t.complete()}async getCrossSigningKeyForUser(e,t,i,s){return await s.wrap({l:"DeviceTracker.getCrossSigningKeyForUser",id:e,usage:t},async n=>{const o=await this._storage.readTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.crossSigningKeys]),a=await o.userIdentities.get(e);if(a&&a.keysTrackingStatus!==0)return await o.crossSigningKeys.get(e,t);if(!i)return;const l=await this._queryKeys([e],i,n);switch(t){case Lt.Master:return l.masterKeys.get(e);case Lt.SelfSigning:return l.selfSigningKeys.get(e);case Lt.UserSigning:return l.userSigningKeys.get(e)}})}async writeHistoryVisibility(e,t,i,s){const n=[],o=[];return e.isTrackingMembers&&e.isEncrypted&&await s.wrap("rewriting userIdentities",async a=>{const l=await e.loadMemberList(i,a);try{const d=Array.from(l.members.values());a.set("members",d.length),await Promise.all(d.map(async c=>{tn(c.membership,t)?await this._addRoomToUserIdentity(c.roomId,c.userId,i)&&n.push(c.userId):await this._removeRoomFromUserIdentity(c.roomId,c.userId,i)&&o.push(c.userId)}))}finally{l.release()}}),{added:n,removed:o}}async _addRoomToUserIdentity(e,t,i){const{userIdentities:s}=i,n=await s.get(t),o=qp(n,t,e);return o?(s.set(o),!0):!1}async _removeRoomFromUserIdentity(e,t,i){const{userIdentities:s,deviceKeys:n}=i,o=await s.get(t);return o?(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(s.remove(t),n.removeAllForUser(t)):s.set(o),!0):!1}async _queryKeys(e,t,i){const s=await t.queryKeys({timeout:1e4,device_keys:e.reduce((c,h)=>(c[h]=[],c),{}),token:this._getSyncToken()},{log:i}).response(),n=i.wrap("master keys",c=>this._filterVerifiedCrossSigningKeys(s.master_keys,Lt.Master,c)),o=i.wrap("self-signing keys",c=>this._filterVerifiedCrossSigningKeys(s.self_signing_keys,Lt.SelfSigning,c)),a=i.wrap("user-signing keys",c=>this._filterVerifiedCrossSigningKeys(s.user_signing_keys,Lt.UserSigning,c)),l=i.wrap("device keys",c=>this._filterVerifiedDeviceKeys(s.device_keys,c)),d=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys,this._storage.storeNames.crossSigningKeys]);try{for(const h of n.values())d.crossSigningKeys.set(h);for(const h of o.values())d.crossSigningKeys.set(h);for(const h of a.values())d.crossSigningKeys.set(h);let c=0;await Promise.all(Array.from(l.keys()).map(async h=>{let p=l.get(h);c+=p.length,p=await this._storeQueriedDevicesForUserId(h,p,d),l.set(h,p)})),i.set("devices",c)}catch(c){throw d.abort(),c}return await d.complete(),{deviceKeys:l,masterKeys:n,selfSigningKeys:o,userSigningKeys:a}}async _storeQueriedDevicesForUserId(e,t,i){const s=await i.deviceKeys.getAllDeviceIds(e);for(const l of s)t.every(d=>d.device_id!==l)&&i.deviceKeys.remove(e,l);const n=[],o=[];await Promise.all(t.map(async l=>{if(s.includes(l.device_id)){const d=await i.deviceKeys.get(l.user_id,l.device_id);if(d&&Gi(d)!==Gi(l)){n.push(d);return}}n.push(l),o.push(l)}));for(const l of o)i.deviceKeys.set(l);let a=await i.userIdentities.get(e);return a||(a=dd(e)),a.keysTrackingStatus=1,i.userIdentities.set(a),n}_filterVerifiedCrossSigningKeys(e,t,i){const s=new Map;if(!e)return s;for(const[n,o]of Object.entries(e))i.wrap({l:n},a=>{this._validateCrossSigningKey(n,o,t,a)&&s.set(Sc(o),o)});return s}_validateCrossSigningKey(e,t,i,s){return Sc(t)!==e?(s.log({l:"user_id mismatch",userId:t.user_id}),!1):Kp(t)!==i?(s.log({l:"usage mismatch",usage:t.usage}),!1):ks(t)?!0:(s.log({l:"no ed25519 key",keys:t.keys}),!1)}_filterVerifiedDeviceKeys(e,t){const i=new Set,s=new Map;if(!e)return s;for(const[n,o]of Object.entries(e))t.wrap(n,a=>{const d=Object.entries(o).filter(([c,h])=>a.wrap(c,p=>{if(this._validateDeviceKey(n,c,h,p)){const g=It(h);return i.has(g)?(t.log({l:"ignore device with duplicate curve25519 key",keys:h},t.level.Warn),!1):(i.add(g),!0)}else return!1})).map(([,c])=>c);s.set(n,d)});return s}_validateDeviceKey(e,t,i,s){const n=i.device_id,o=i.user_id;if(o!==e)return s.log("user_id mismatch"),!1;if(n!==t)return s.log("device_id mismatch"),!1;const a=Gi(i),l=It(i);if(typeof a!="string"||typeof l!="string")return s.log("ed25519 and/or curve25519 key invalid").set({deviceKey:i}),!1;const d=ha(this._olmUtil,o,n,a,i,s)===he.Valid;return d||s.log({l:"ignore device with invalid signature",keys:i},s.level.Warn),d}async devicesForTrackedRoom(e,t,i){const s=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),n=await s.roomMembers.getAllUserIds(e);return await this._devicesForUserIdsInTrackedRoom(e,n,s,t,i)}async devicesForRoomMembers(e,t,i,s){const n=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIdsInTrackedRoom(e,t,n,i,s)}async devicesForUsers(e,t,i){const s=await this._storage.readTxn([this._storage.storeNames.userIdentities]),n=[],o=[];return await Promise.all(e.map(async a=>{const l=await s.userIdentities.get(a);l&&l.keysTrackingStatus===1?n.push(l):(!l||l.keysTrackingStatus===0)&&o.push(a)})),this._devicesForUserIdentities(n,o,t,i)}async deviceForId(e,t,i,s){var n;const a=await(await this._storage.readTxn([this._storage.storeNames.userIdentities])).userIdentities.get(e);if(a?.keysTrackingStatus!==1){const{deviceKeys:c}=await this._queryKeys([e],i,s);return c.get(e).find(g=>g.device_id===t)}let d=await(await this._storage.readTxn([this._storage.storeNames.deviceKeys])).deviceKeys.get(e,t);if(d)s.set("existingDevice",!0);else{const c=await i.queryKeys({timeout:1e4,device_keys:{[e]:[t]},token:this._getSyncToken()},{log:s}).response(),p=(n=s.wrap("verify",w=>this._filterVerifiedDeviceKeys(c.device_keys,w)).get(e))==null?void 0:n.find(w=>w.device_id===t);if(!p)return;const g=await this._storage.readWriteTxn([this._storage.storeNames.deviceKeys]),y=await g.deviceKeys.get(e,t);if(y)d=y,s.set("existingDeviceAfterFetch",!0);else{try{g.deviceKeys.set(p),d=p,s.set("newDevice",!0)}catch(w){throw g.abort(),w}await g.complete()}}return d}async deviceForCurveKey(e,t,i,s){const n=await this._storage.readTxn([this._storage.storeNames.deviceKeys,this._storage.storeNames.userIdentities]),o=await n.userIdentities.get(e);if(o?.keysTrackingStatus!==1){const{deviceKeys:l}=await this._queryKeys([e],i,s);return l.get(e).find(h=>It(h)===t)}return await n.deviceKeys.getByCurve25519Key(t)}async _devicesForUserIdsInTrackedRoom(e,t,i,s,n){const a=(await Promise.all(t.map(h=>i.userIdentities.get(h)))).filter(h=>h&&h.roomIds.includes(e)),l=a.filter(h=>h.keysTrackingStatus===1),d=a.filter(h=>h.keysTrackingStatus===0).map(h=>h.userId);let c=await this._devicesForUserIdentities(l,d,s,n);return c=c.filter(h=>!(h.user_id===this._ownUserId&&h.device_id===this._ownDeviceId)),c}async _devicesForUserIdentities(e,t,i,s){s.set("uptodate",e.length),s.set("outdated",t.length);let n;if(t.length){const{deviceKeys:d}=await this._queryKeys(t,i,s);n=d}const o=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);let l=(await Promise.all(e.map(d=>o.deviceKeys.getAllForUserId(d.userId)))).reduce((d,c)=>d.concat(c),[]);if(n&&n.size)for(const d of n.values())l=l.concat(d);return l}async getDeviceByCurve25519Key(e,t){return await t.deviceKeys.getByCurve25519Key(e)}get ownDeviceId(){return this._ownDeviceId}}const ud=[Hp,Wp,Yp,Jp,Xp,Qp,Zp,e_,t_,i_,s_,r_,n_,o_,a_,c_,l_,d_,u_];function Gp(r){return{databaseName:r.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function Hp(r){r.createObjectStore("session",{keyPath:"key"}),r.createObjectStore("roomSummary",{keyPath:"roomId"}),r.createObjectStore("timelineFragments",{keyPath:"key"}),r.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),r.createObjectStore("roomState",{keyPath:"key"}),r.createObjectStore("pendingEvents",{keyPath:"key"})}async function Wp(r,e){const t=new Ql(r.createObjectStore("roomMembers",{keyPath:"key"})),i=e.objectStore("roomState");await Se(i.openCursor(),s=>{if(s.event.type===st){i.delete(s.key);const n=Q.fromMemberEvent(s.roomId,s.event);n&&t.set(n.serialize())}return Jt})}async function Yp(r,e,t){const i=e.objectStore("session");try{const n=await $e(i.get(1));if(n){i.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:l}=n.value,d=new ma(i,t);d.set("sync",{token:o,filterId:a}),d.set("serverVersions",l)}}catch(s){e.abort(),console.error("could not migrate session",s.stack)}}function Jp(r){r.createObjectStore("userIdentities",{keyPath:"userId"}),r.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),r.createObjectStore("olmSessions",{keyPath:"key"}),r.createObjectStore("inboundGroupSessions",{keyPath:"key"}),r.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),r.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),r.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function Xp(r,e){var t;const i=e.objectStore("roomSummary"),s=e.objectStore("roomState"),n=[];await Se(i.openCursor(),o=>(n.push(o),Jt));for(const o of n){const a=await $e(s.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(t=a?.event)==null?void 0:t.content,delete o.isEncrypted,i.put(o))}}function Qp(r){r.createObjectStore("accountData",{keyPath:"type"})}function Zp(r){r.createObjectStore("invites",{keyPath:"roomId"})}function e_(r){r.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function t_(r,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await Se(t.openCursor(),(i,s,n)=>{const{typeScopeKey:o}=i;delete i.typeScopeKey;const[a,l]=o.split("|");return i.scopeTypeKey=dr(l,a),n.update(i),Jt}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function i_(r){r.createObjectStore("timelineRelations",{keyPath:"key"})}function s_(){}async function r_(r,e){const t=e.objectStore("session"),i=await $e(t.get("ssssKey"));i&&t.put({key:`${Ze}ssssKey`,value:i.value})}async function n_(r,e,t,i){const s=e.objectStore("session"),n=new ma(new Hl(s,Gp(r)),t);n.writeE2EEIdentityToLocalStorage();const o=await n.tryRestoreE2EEIdentityFromLocalStorage(i);i.set("restored",o)}async function o_(r,e){for(const t of r.objectStoreNames){const i=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await Se(i.openCursor(),(s,n,o)=>(n.startsWith(Ze)||o.delete(),Jt));break}default:{i.clear();break}}}}async function a_(r,e,t,i){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function c_(r,e,t,i){const s=e.objectStore("inboundGroupSessions");let n=0,o=0;await Se(s.openCursor(),(a,l,d)=>(a.session?(a.backup=Qn.NotBackedUp,a.source=Kr.DeviceMessage,d.update(a),n+=1):o+=1,Jt)),i.set("countWithoutSession",o),i.set("countWithSession",n)}function l_(r){r.createObjectStore("calls",{keyPath:"key"})}async function d_(r,e,t,i){r.createObjectStore("crossSigningKeys",{keyPath:"key"}),r.deleteObjectStore("deviceIdentities"),r.createObjectStore("deviceKeys",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0});const n=e.objectStore("userIdentities");let o=0;await Se(n.openCursor(),(a,l,d)=>(delete a.deviceTrackingStatus,delete a.crossSigningKeys,a.keysTrackingStatus=ld.Outdated,d.update(a),o+=1,Jt)),i.set("marked_outdated",o)}function u_(r){r.createObjectStore("sharedSecrets",{keyPath:"key"})}async function h_(r){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await da(e,n=>{n.createObjectStore("test",{keyPath:"key"})},1,r),i=t.transaction(["test"],"readonly");await $e(i.objectStore("test").get("somekey")),await new Promise(n=>setTimeout(n,0));const s=t.transaction(["test"],"readwrite");await Promise.resolve(),s.objectStore("test").add({key:"somekey",value:"foo"}),await Er(s),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const hd=r=>`hydrogen_session_${r}`,yo=function(r,e,t,i){const s=(n,o,a,l)=>__(n,o,a,l,t,i);return da(hd(r),s,ud.length,e)};async function m_(){var r,e;const t=this;if((e=(r=t?.navigator)==null?void 0:r.storage)!=null&&e.persist)return await t.navigator.storage.persist();if(t?.document.requestStorageAccess)try{return await t.document.requestStorageAccess(),!0}catch(i){return console.warn("requestStorageAccess threw an error:",i),!1}else return!1}class p_{constructor(e,t=window.indexedDB,i=window.IDBKeyRange,s=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=i,this._localStorage=s}async create(e,t){var i;await((i=this._serviceWorkerHandler)==null?void 0:i.preventConcurrentSessionAccess(e)),m_().then(o=>{o||t.log("no persisted storage, database can be evicted by browser",t.level.Warn)});const s=await h_(this._idbFactory),n=await yo(e,this._idbFactory,this._localStorage,t);return new gp(n,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}async delete(e){const t=hd(e);try{Gm(this._localStorage,t)}catch{}try{const i=this._idbFactory.deleteDatabase(t);await $e(i)}catch{}}async export(e,t){const i=await yo(e,this._idbFactory,this._localStorage,t);return await yp(i)}async import(e,t,i){const s=await yo(e,this._idbFactory,this._localStorage,i);return await vp(s,t)}}async function __(r,e,t,i,s,n){const o=t||0;return n.wrap({l:"storage migration",oldVersion:t,version:i},async a=>{for(let l=o;l<i;++l){const d=ud[l];await a.wrap(`v${l+1}`,c=>d(r,e,s,c))}})}class f_{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const i=await this.getAll();if(i){const s=i.find(n=>n.id===e);s&&(s.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(i)))}}async get(e){const t=await this.getAll();if(t)return t.find(i=>i.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(i=>i.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class g_{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const i=window.localStorage.getItem(`${this._prefix}${e}`);return typeof i=="string"?parseInt(i,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const i=window.localStorage.getItem(`${this._prefix}${e}`);return typeof i=="string"?i==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class y_{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class v_{encodeUnpadded(e){const t=zi.encode(e),i=t.indexOf("=");return i!==-1?t.substr(0,i):t}encode(e){return zi.encode(e)}decode(e){return zi.decode(e)}}function w_(r){if(r.__esModule)return r;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(r).forEach(function(t){var i=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:function(){return r[t]}})}),e}var md={isBuffer:function(r){return r instanceof Uint8Array},from:function(r){return r},allocUnsafe:function(r){return md.alloc(r)},alloc:function(r){return new Uint8Array(r)}},b_=Object.freeze(Object.defineProperty({__proto__:null,Buffer:md},Symbol.toStringTag,{value:"Module"})),S_=w_(b_),dn=S_.Buffer;function E_(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),n=s.charCodeAt(0);if(e[n]!==255)throw new TypeError(s+" is ambiguous");e[n]=i}var o=r.length,a=r.charAt(0),l=Math.log(o)/Math.log(256),d=Math.log(256)/Math.log(o);function c(g){if((Array.isArray(g)||g instanceof Uint8Array)&&(g=dn.from(g)),!dn.isBuffer(g))throw new TypeError("Expected Buffer");if(g.length===0)return"";for(var y=0,w=0,x=0,M=g.length;x!==M&&g[x]===0;)x++,y++;for(var D=(M-x)*d+1>>>0,O=new Uint8Array(D);x!==M;){for(var C=g[x],U=0,B=D-1;(C!==0||U<w)&&B!==-1;B--,U++)C+=256*O[B]>>>0,O[B]=C%o>>>0,C=C/o>>>0;if(C!==0)throw new Error("Non-zero carry");w=U,x++}for(var G=D-w;G!==D&&O[G]===0;)G++;for(var wt=a.repeat(y);G<D;++G)wt+=r.charAt(O[G]);return wt}function h(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return dn.alloc(0);var y=0;if(g[y]!==" "){for(var w=0,x=0;g[y]===a;)w++,y++;for(var M=(g.length-y)*l+1>>>0,D=new Uint8Array(M);g[y];){var O=e[g.charCodeAt(y)];if(O===255)return;for(var C=0,U=M-1;(O!==0||C<x)&&U!==-1;U--,C++)O+=o*D[U]>>>0,D[U]=O%256>>>0,O=O/256>>>0;if(O!==0)throw new Error("Non-zero carry");x=C,y++}if(g[y]!==" "){for(var B=M-x;B!==M&&D[B]===0;)B++;var G=dn.allocUnsafe(w+(M-B));G.fill(0,0,w);for(var wt=w;B!==M;)G[wt++]=D[B++];return G}}}function p(g){var y=h(g);if(y)return y;throw new Error("Non-base"+o+" character")}return{encode:c,decodeUnsafe:h,decode:p}}var k_=E_,I_=k_,x_="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Ec=I_(x_);class T_{encode(e){return Ec.encode(e)}decode(e){return Ec.decode(e)}}class R_{constructor(){this.utf8=new y_,this.base64=new v_,this.base58=new T_}}class C_{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const i=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:i})}async createAccountAndOTKs(e,t){let i;window.msCrypto&&(i=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const s=await this._workerPool.send({type:"olm_create_account_otks",randomValues:i,otkAmount:t}).response();e.unpickle("",s)}async createOutboundOlmSession(e,t,i,s){const n=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:n,theirIdentityKey:i,theirOneTimeKey:s,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}function pd(r){return typeof r!="object"||"nodeType"in r||Array.isArray(r)}function Ns(r,e){return Object.entries(r).reduce((t,[i,s])=>(typeof s=="function"&&(s=s(e)),s?t+(t.length?" ":"")+i:t),"")}function Is(r,e,t){e==="className"&&(e="class"),t===!1?r.removeAttribute(e):(t===!0&&(t=e),r.setAttribute(e,t))}function M_(r,e,t){return _d(ga,r,e,t)}function _d(r,e,t,i){t&&pd(t)&&(i=t,t=void 0);const s=document.createElementNS(r,e);if(t)for(let[n,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&n==="className"?Ns(o,void 0):!1),Is(s,n,o);if(i){Array.isArray(i)||(i=[i]);for(let n of i)typeof n=="string"&&(n=Yt(n)),s.appendChild(n)}return s}function Yt(r){return document.createTextNode(r)}const ga="http://www.w3.org/1999/xhtml",A_="http://www.w3.org/2000/svg",fd={[ga]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","header","main","footer","dialog","article","aside","del","blockquote","details","summary","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","optgroup","label","form","progress","output","video","style"],[A_]:["svg","g","path","circle","ellipse","rect","use"]},z={};for(const[r,e]of Object.entries(fd))for(const t of e)z[t]=function(i,s){return _d(r,t,i,s)};function xr(r,e){let t;try{t=r.mount(e)}catch(i){console.error(i),t=N_(i)}return t}function N_(r){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),z.div([z.h2("Something went wrong\u2026"),z.h3(r.message),z.p(`This occurred while running ${t}.`),z.pre(r.stack)])}function kc(r,e,t){if(e===r.childElementCount)r.appendChild(t);else{const s=r.children[e];r.insertBefore(t,s)}}function D_(r){r.innerHTML=""}function ya(r){return async e=>{var t,i;(t=e.target)==null||t.setAttribute("disabled","disabled"),await r(e),(i=e.target)==null||i.removeAttribute("disabled")}}class xi{constructor({list:e,onItemClick:t,className:i,tagName:s="ul",parentProvidesUpdates:n=!0},o){this._onItemClick=t,this._list=e,this._className=i,this._tagName=s,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:n}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=M_(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const i=Array.prototype.indexOf.call(this._root.childNodes,t),s=this._childInstances[i];s&&this._onItemClick(s,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const i=this._childCreator(t);this._childInstances.push(i),e.appendChild(xr(i,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,i){this.moveChild(e,t)}onUpdate(e,t,i){this.updateChild(e,t,i)}addChild(e,t){const i=this._childCreator(t);this._childInstances.splice(e,0,i),kc(this._root,e,xr(i,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[i]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,i),i.root().remove(),kc(this._root,t,i.root())}updateChild(e,t,i){if(this._childInstances){const s=this._childInstances[e];s&&s.update(t,i)}}recreateItem(e,t){if(this._childInstances){const i=this._childCreator(t);if(!i)this.onRemove(e,t);else{const[s]=this._childInstances.splice(e,1,i);this._root.replaceChild(i.mount(this._mountArgs),s.root()),s.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class gd{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function V_(r){for(const e of Object.values(r))if(typeof e=="function")return!0;return!1}class T extends gd{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:i,useCapture:s}of this._eventListeners)e.addEventListener(t,i,s)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:i,useCapture:s}of this._eventListeners)e.removeEventListener(t,i,s)}mount(e){const t=new yd(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const i of this._bindings)i()}_addEventListener(e,t,i,s=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:i,useCapture:s})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const i of this._subViews)i.update(e,t)}}class yd{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,i,s=!1){this._templateView._addEventListener(e,t,i,s)}_addAttributeBinding(e,t,i){let s;const n=()=>{const o=i(this._value);s!==o&&(s=o,Is(e,t,o))};this._addBinding(n),n()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",i=>Ns(t,i))}_addTextBinding(e){const t=e(this._value)+"",i=Yt(t);let s=t;const n=()=>{const o=e(this._value)+"";s!==o&&(s=o,i.textContent=o)};return this._addBinding(n),i}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[i,s]of Object.entries(t))if(typeof s=="object"){if(i!=="className"||s===null)continue;V_(s)?this._addClassNamesBinding(e,s):Is(e,i,Ns(s,this._value))}else if(this._isEventHandler(i,s)){const n=i.substr(2,1).toLowerCase()+i.substr(3),o=s;this._templateView._addEventListener(e,n,o)}else typeof s=="function"?this._addAttributeBinding(e,i,s):Is(e,i,s)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let i of t)typeof i=="function"?i=this._addTextBinding(i):typeof i=="string"&&(i=Yt(i)),e.appendChild(i)}_addReplaceNodeBinding(e,t){let i=e(this._value),s=t(null);const n=()=>{const o=e(this._value);if(i!==o){i=o;const a=t(s);s.parentNode&&s.parentNode.replaceChild(a,s),s=a}};return this._addBinding(n),s}el(e,t,i){return this.elNS(ga,e,t,i)}elNS(e,t,i,s){let n;i&&(pd(i)?s=i:n=i);const o=document.createElementNS(e,t);return n&&this._setNodeAttributes(o,n),s&&this._setNodeChildren(o,s),o}view(e,t){return this._templateView.addSubView(e),xr(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,i=>{if(i&&i.nodeType!==Node.COMMENT_NODE){const n=this._templateView._subViews;if(n){const o=n.findIndex(a=>a.root()===i);if(o!==-1){const[a]=n.splice(o,1);a.unmount()}}}const s=t(e(this._value));return s?this.view(s):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,i=>new Tr(this._value,(s,n)=>{const o=t(i,s,n);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(i=>!!e(i),i=>i?t(this._value):null)}if(e,t){return this.ifView(e,i=>new Tr(i,t))}mapSideEffect(e,t){let i=e(this._value);const s=()=>{const n=e(this._value);i!==n&&(t(n,i,this._value),i=n)};this._addBinding(s),t(i,void 0,this._value)}}for(const[r,e]of Object.entries(fd))for(const t of e)yd.prototype[t]=function(i,s){return this.elNS(r,t,i,s)};class Tr extends T{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function ji(r,e,t=void 0){const i=!!r.avatarUrl(e);let s=Ns({avatar:!0,[`size-${e}`]:!0,[`usercolor${r.avatarColorNumber}`]:!i});t&&(s+=` ${t}`);const n=i?vd(r,e):Yt(r.avatarLetter),o=z.div({className:s,title:r.avatarTitle,"data-testid":"avatar"},[n]);return i&&(Is(o,"data-avatar-letter",r.avatarLetter),Is(o,"data-avatar-color",r.avatarColorNumber)),o}function vd(r,e){const t=e.toString();return z.img({src:r.avatarUrl(e),width:t,height:t,title:r.avatarTitle})}function U_(r){const e=r.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Ic(r){if(!U_(r))return;const e=r.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const i=e.getAttribute("data-avatar-letter");e.textContent=i}class vt extends gd{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=ji(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const i=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(vd(e,this._size),this._root.firstChild),this._root.classList.remove(i)):(this._root.textContent=e.avatarLetter,this._root.classList.add(i))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const i=this._root.firstChild;i.tagName==="IMG"&&i.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let un;function Pe(r,e=void 0){un===void 0&&(un=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return un?.classList.contains("legacy")?r.div({className:t},[r.div(),r.div(),r.div(),r.div()]):r.svg({className:t,viewBox:"0 0 100 100"},r.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class P_ extends T{render(e,t){const i={active:s=>s.isOpen,hidden:s=>s.hidden};return e.li({className:i},[e.a({href:t.url},[e.view(new vt(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:s=>s.isUnread}},s=>s.name),e.map(s=>s.busy,s=>s?Pe(e):e.div({className:{badge:!0,highlighted:n=>n.isHighlighted,hidden:n=>!n.badgeCount}},n=>n.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class ge extends T{static option(e,t){return new O_(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class O_{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class Zn{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=z.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=F_(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,i=this._popup.clientHeight,s=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>s.bottom||e.left>s.right||e.bottom<s.top||e.right<s.left)return!1;if(s.bottom>=e.bottom+i)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(s.top<=e.top-i)this._popup.style.top=`${e.top-i-this._verticalPadding}px`;else return!1;if(s.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(s.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function F_(r){let e=r;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const i=window.getComputedStyle(e).getPropertyValue("overflow-y");if(i==="auto"||i==="scroll")return e}while(e!==document.body)}class L_ extends T{render(e,t){const i=()=>{s.value="",s.blur(),n.blur(),t.clear()},s=e.input({type:"text",placeholder:t?.label,"aria-label":t?.label,autocomplete:t?.autocomplete,enterkeyhint:"search",name:t?.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&i()},onFocus:()=>s.select()}),n=e.button({onClick:i,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[s,n])}}class B_ extends T{constructor(e){super(e),this._createMenuPopup=null}render(e,t){const i=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,s=e.view(new xi({className:"RoomList",list:t.tileViewModels},o=>new P_(o))),n=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new L_({i18n:t.i18n,label:t.i18n`Filter rooms`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(s.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:i,"aria-label":i}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.button({className:"button-utility create","aria-label":t.i18n`Create room`,onClick:o=>this._toggleCreateMenu(o)})]);return e.div({className:"LeftPanel"},[n,s])}_toggleCreateMenu(e){if(this._createMenuPopup&&this._createMenuPopup.isOpen)this._createMenuPopup.close();else{const t=this.value,i=[];i.push(ge.option(t.i18n`Create Room`,()=>t.showCreateRoomView())),i.push(ge.option(t.i18n`Join Room`,()=>t.showJoinRoomView())),this._createMenuPopup=new Zn(new ge(i)),this._createMenuPopup.trackInTemplateView(this),this._createMenuPopup.showRelativeTo(e.target,10)}}}function xc(r){return r.offsetTop+r.clientHeight}function Tc(r,e,t=r.children.length-1){for(var i=t;i>=0;i--)if(r.children[i].offsetTop<e)return i;return 0}class wd extends T{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new K_(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const i=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:s=>!s.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(i)),i}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,i=e.clientHeight-t.clientHeight;if(i>0){t.style.setProperty("margin-top",`${i}px`);const s=this.value.tiles.length;this.updateVisibleRange(0,s-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const s=xc(this.anchoredNode);if(s!==this.anchoredBottom){const n=s-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,n):e.scrollTop=e.scrollTop+n,this.anchoredBottom=s}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:i,scrollTop:s,clientHeight:n}=e;let o;if(this.stickToBottom=Math.abs(i-(s+n))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const l=s+n,d=Tc(t,l);this.anchoredNode=t.childNodes[d],this.anchoredBottom=xc(this.anchoredNode),o=d}let a=Tc(t,s,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const i=this.tilesView.getChildInstanceByIndex(e),s=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(i?.value,s?.value)}}class K_ extends xi{constructor(e,t,i){super({list:e,onItemClick:(s,n)=>s.onClick(n)},s=>{const n=i(s);return new n(s,i)}),this.viewClassForTile=i,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,i){if(i==="shape"){const s=this.viewClassForTile(t),n=this.getChildInstanceByIndex(e);if(!s||!(n instanceof s)){super.recreateItem(e,t);return}}super.onUpdate(e,t,i),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,i){super.onMove(e,t,i),this.onChanged()}}class $_ extends T{render(e,t){return e.div({className:"TimelineLoadingView"},[Pe(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages`:t.i18n`Loading messages`)])}}class bd extends T{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:n=>this._onKeyDown(n),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:n=>n.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const i=e.map(n=>n.replyViewModel,(n,o)=>{const a=n&&this._viewClassForTile(n);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(n,this._viewClassForTile,{interactive:!1},"div"))]):null}),s=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:n=>this._toggleAttachmentMenu(n)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:n=>n.canSend}},[i,s])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(i){t(),console.error(i)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new Zn(new ge([ge.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),ge.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),ge.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class j_ extends T{render(e){return e.div({className:"DisabledComposerView"},e.h3(t=>t.description))}}class ts extends T{constructor(e,t={inline:!1}){super(e),this.options=t}render(e,t){const i=e.button({className:"ErrorView_submit",onClick:ya(async n=>{n.stopPropagation(),await t.submitLogs()?alert("Logs submitted!"):alert("Could not submit logs")})},"Submit logs"),s=e.button({className:"ErrorView_close",onClick:n=>{n.stopPropagation(),t.close()},title:"Dismiss error"});return e.div({className:{ErrorView:!0,ErrorView_inline:this.options.inline,ErrorView_block:!this.options.inline}},[e.p({className:"ErrorView_message"},t.message),i,s])}}class q_ extends T{render(e,t){const i=e.view(new xi({className:"CallView_members",list:t.memberViewModels},s=>new z_(s)));return this.bindMembersCssClasses(e,i),e.div({class:"CallView"},[i,e.div({class:"CallView_buttons"},[e.button({className:{CallView_mutedMicrophone:s=>s.isMicrophoneMuted,CallView_unmutedMicrophone:s=>!s.isMicrophoneMuted},onClick:vo(()=>t.toggleMicrophone())}),e.button({className:{CallView_mutedCamera:s=>s.isCameraMuted,CallView_unmutedCamera:s=>!s.isCameraMuted},onClick:vo(()=>t.toggleCamera())}),e.button({className:"CallView_hangup",onClick:vo(()=>t.hangup())})]),e.if(s=>!!s.errorViewModel,s=>s.div({className:"CallView_error"},s.view(new ts(t.errorViewModel))))])}bindMembersCssClasses(e,t){if(e.mapSideEffect(i=>i.memberCount,i=>{t.classList.forEach((s,n,o)=>{s.startsWith("size")&&o.remove(s)}),t.classList.add(`size${i}`)}),typeof ResizeObserver=="function"){const i=(s,n)=>{n?t.classList.add(s):t.classList.remove(s)};this.resizeObserver=new ResizeObserver(()=>{const s=t.clientWidth/t.clientHeight,n=s<.5,o=!n&&s<1.8,a=!n&&!o;i("tall",n),i("square",o),i("wide",a)}),this.resizeObserver.observe(t)}}unmount(){this.resizeObserver&&(this.resizeObserver.unobserve(this.root().querySelector(".CallView_members")),this.resizeObserver=void 0),super.unmount()}}class z_ extends T{render(e,t){const i=e.video({autoplay:!0,disablePictureInPicture:!0,className:{hidden:s=>s.isCameraMuted}});return e.mapSideEffect(s=>s.stream,s=>{i.srcObject=s}),e.div({className:"StreamView"},[i,e.div({className:{StreamView_avatar:!0,hidden:s=>!s.isCameraMuted}},e.view(new vt(t,96),{parentProvidesUpdates:!0})),e.div({className:{StreamView_muteStatus:!0,hidden:s=>!s.isCameraMuted&&!s.isMicrophoneMuted,microphoneMuted:s=>s.isMicrophoneMuted&&!s.isCameraMuted,cameraMuted:s=>s.isCameraMuted}}),e.if(s=>!!s.errorViewModel,s=>s.div({className:"StreamView_error"},s.view(new ts(t.errorViewModel))))])}update(e,t){super.update(e),this.updateSubViews(e,t)}}function vo(r){return async e=>{var t,i;(t=e.target)==null||t.setAttribute("disabled","disabled"),await r(e),(i=e.target)==null||i.removeAttribute("disabled")}}class Sd extends T{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new vt(t,32)),e.div({className:"room-description"},[e.h2(i=>i.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:i=>this._toggleOptionsMenu(i)})]),e.div({className:"RoomView_body"},[e.if(i=>i.errorViewModel,i=>i.div({className:"RoomView_error"},i.view(new ts(t.errorViewModel)))),e.mapView(i=>i.callViewModel,i=>i?new q_(i):null),e.mapView(i=>i.timelineViewModel,i=>i?new wd(i,this._viewClassForTile):new $_(t)),e.mapView(i=>i.composerViewModel,i=>{switch(i?.kind){case"composer":return new bd(t.composerViewModel,this._viewClassForTile);case"disabled":return new j_(t.composerViewModel)}})])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,i=[];if(i.push(ge.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.features.calls&&i.push(ge.option(t.i18n`Start call`,()=>t.startCall())),t.canLeave&&i.push(ge.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&i.push(ge.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&i.push(ge.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!i.length)return;this._optionsPopup=new Zn(new ge(i)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class G_ extends T{render(e,t){return e.main({className:"UnknownRoomView middle"},[e.div({className:"UnknownRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.h2("Join room")]),e.div({className:"UnknownRoomView_body centered-column"},[e.div({className:"UnknownRoomView_container"},[e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:i=>i.busy},t.i18n`Join room`),e.if(i=>i.error,i=>i.p({className:"error"},t.error))])])])}}class Ds{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(z,e):this.render(z,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class Ed extends Ds{constructor(e="Loading"){super(e,(t,i)=>t.div({className:"LoadingView"},[Pe(t),i]))}}class kd extends T{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new vt(t,32)),e.div({className:"room-description"},[e.h2(i=>i.name)])]),e.div({className:"RoomView_body"},[e.mapView(i=>i.error,i=>i?new H_(t):new Ed(t.i18n`Setting up the room`))])])}}class H_ extends T{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class Id extends T{render(e,t){var i;let s=[];t.isDirectMessage&&s.push(ji(t,128,"InviteView_dmAvatar"));let n;return t.isDirectMessage?n=[e.strong(t.name),` (${(i=t.inviter)==null?void 0:i.id}) wants to chat with you.`]:t.inviter?n=[ji(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:n="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},n)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[ji(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),ji(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class W_ extends T{render(e,t){const i=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),s=e.div({role:"img","aria-label":l=>l.name,title:l=>l.name,className:{picture:!0,hidden:l=>!l.imageUrl},style:l=>`background-image: url('${l.imageUrl}'); max-width: ${l.imageWidth}px; max-height: ${l.imageHeight}px;`}),n=e.div({className:{loading:!0,hidden:l=>!!l.imageUrl}},[Pe(e),e.div(t.i18n`Loading image`)]),o=e.div({className:"details"},[e.strong(l=>l.name),e.br(),"uploaded by ",e.strong(l=>l.sender),l=>` at ${l.time} on ${l.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:l=>this.clickToClose(l),onKeydown:l=>this.closeOnEscKey(l)},[s,n,o,i]);return Y_(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function Y_(r,e){const t=J_(e),i=t[0],s=t[t.length-1];r.addEventListener(e,"keydown",n=>{n.key==="Tab"&&(n.shiftKey?document.activeElement===i&&(s.focus(),n.preventDefault()):document.activeElement===s&&(i.focus(),n.preventDefault()))},!0),Promise.resolve().then(()=>{i.focus()})}function J_(r){return r.querySelectorAll("a[href], button, textarea, input, select")}class X_ extends T{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:i=>!i.isShown}},[Pe(e,{hidden:i=>!i.isWaiting}),e.p(i=>i.statusLabel),e.if(i=>i.isConnectNowShown,i=>i.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(i=>i.isSecretStorageShown,i=>i.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(i=>i.canDismiss,i=>i.div({className:"end"},i.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class Q_ extends T{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const i=[];for(let s=0;s<t.height*t.width;s+=1)i.push(e.div({onClick:()=>t.focusTile(s),onFocusin:()=>t.focusTile(s),className:{container:!0,[`tile${s}`]:!0,focused:n=>n.focusIndex===s}},e.mapView(n=>n.roomViewModelAt(s),n=>n?n.kind==="roomBeingCreated"?new kd(n):n.kind==="invite"?new Id(n):new Sd(n,this._viewClassForTile):new Ds(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return i.push(e.div({className:s=>`focus-ring tile${s.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},i)}}class lt extends Mt{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const s=this.navigation.observe(e).subscribe(n=>{t(n,e)});this.track(s)}track(e){return this.disposables||(this.disposables=new Ks),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let i="";for(let s=0;s<e.length;++s)i=i+e[s],s<t.length&&(i=i+t[s]);return i}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlRouter(){return this._options.urlRouter}get features(){return this._options.features}get navigation(){return this._options.navigation}get timeFormatter(){return this._options.platform.timeFormatter}}class va{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const i=this._keyDescription;if(i.mac){const s=await Z_(e.binaryKey,i.iv,t);return i.mac===s}else if(i.passphrase){const s=e.description._keyDescription;return s.passphrase?i.passphrase.algorithm===s.passphrase.algorithm&&i.passphrase.iterations===s.passphrase.iterations&&i.passphrase.salt===s.passphrase.salt:!1}}return!1}}class $r{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new $r(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function Z_(r,e,t){const{crypto:i,encoding:s}=t,{utf8:n,base64:o}=s,{derive:a,aes:l,hmac:d}=i,c=o.decode(e),h=new Uint8Array(8),p="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",g=n.encode(""),y=await a.hkdf(r,h,g,"SHA-256",512),w=y.slice(0,32),x=y.slice(32),M=await l.encryptCTR({key:w,iv:c,data:n.encode(p)}),D=await d.compute(x,M,"SHA-256");return o.encode(D)}const ef=5e5,tf=256;async function sf(r,e,t){const{passphraseParams:i}=r;if(!i)throw new Error("not a passphrase key");if(i.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${i.algorithm}`);const{utf8:s}=t.encoding,n=await t.crypto.derive.pbkdf2(s.encode(e),i.iterations||ef,s.encode(i.salt),"SHA-512",i.bits||tf);return new $r(r,n)}const rr=[139,1];function rf(r,e,t,i){const s=i.encoding.base58.decode(e.replace(/ /g,""));let n=0;for(const a of s)n^=a;if(n!==0)throw new Error("Incorrect parity");for(let a=0;a<rr.length;++a)if(s[a]!==rr[a])throw new Error("Incorrect prefix");if(s.length!==rr.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(s.slice(rr.length,rr.length+t.PRIVATE_KEY_LENGTH));return new $r(r,o)}class nf{async getSecret(e){var t,i,s;return(s=await((t=this.secretStorage)==null?void 0:t.readSecret(e)))!=null?s:await((i=this.secretSharing)==null?void 0:i.getLocallyStoredSecret(e))}setSecretStorage(e){this.secretStorage=e}setSecretSharing(e){this.secretSharing=e,this.secretSharing.setSecretFetcher(this)}}const nr="secretRequestIds";class of{constructor(e){this.waitMap=new Map,this.hsApi=e.hsApi,this.storage=e.storage,this.deviceMessageHandler=e.deviceMessageHandler,this.deviceTracker=e.deviceTracker,this.ourUserId=e.ourUserId,this.olmEncryption=e.olmEncryption,this.encoding=e.encoding,this.crossSigning=e.crossSigning,this.logger=e.logger,this.aesEncryption=new cf(this.storage,e.crypto,this.encoding)}async load(){this.deviceMessageHandler.on("message",async({encrypted:e})=>{switch(e?.event.type){case"m.secret.request":{await this._respondToRequest(e);break}case"m.secret.send":{const{secret:i}=e.event.content,s=await this.shouldAcceptSecret(e);s&&this.writeSecretToStorage(s,i);break}}}),await this.aesEncryption.load()}async _respondToRequest(e){await this.logger.run("SharedSecret.respondToRequest",async t=>{if(!await this.shouldRespondToRequest(e,t))return;const i=e.event.content,s=i.request_id,n=i.requesting_device_id,o=i.name,a=await this.secretFetcher.getSecret(o);if(!a){t.log({l:"Secret not available to share"});return}const l={secret:a,request_id:s},d=await this.deviceTracker.deviceForId(this.ourUserId,n,this.hsApi,t);if(!d){t.log({l:"Cannot find device",deviceId:n});return}const c=await t.wrap("olm encrypt",p=>this.olmEncryption.encrypt("m.secret.send",l,[d],this.hsApi,p)),h=Ir(c);await this.hsApi.sendToDevice("m.room.encrypted",h,et(),{log:t}).response()})}async shouldRespondToRequest(e,t){return t.wrap("SecretSharing.shouldRespondToRequest",async()=>{if(e.event.content.requesting_device_id===this.deviceTracker.ownDeviceId)return!1;const i=this.crossSigning.get();if(!i)return t.log({crossSigningNotAvailable:!0}),!1;const s=e.event.content;if(e.event.sender!==this.ourUserId||!(s.name&&s.action&&s.requesting_device_id&&s.request_id)||s.action==="request_cancellation")return!1;const n=s.requesting_device_id,o=await this.deviceTracker.deviceForId(this.ourUserId,n,this.hsApi,t);return o?await i.isOurUserDeviceTrusted(o,t)?!0:(t.log({l:"Device not trusted, returning"}),!1):(t.log({l:"Device could not be acquired",deviceId:n}),!1)})}async shouldAcceptSecret(e){const t=this.crossSigning.get();if(!t)return;const i=e.device;if(!i||!await t.isOurUserDeviceTrusted(i))return;const n=e.event.content.request_id,o=this.waitMap.get(n);if(o){const{name:c,deferred:h}=o;return h.resolve(e),this.waitMap.delete(n),await this.removeStoredRequestId(n),c}const l=await(await this.storage.readTxn([this.storage.storeNames.session])).session.get(nr),d=l?.[n];if(d)return await this.removeStoredRequestId(n),d}async removeStoredRequestId(e){const t=await this.storage.readWriteTxn([this.storage.storeNames.session]),i=await t.session.get(nr);i&&(delete i[e],t.session.set(nr,i))}async checkSecretValidity(e){const t=this.crossSigning.get();!await t?.areWeVerified(e)&&(await this.storage.readWriteTxn([this.storage.storeNames.sharedSecrets])).sharedSecrets.deleteAllSecrets()}async getLocallyStoredSecret(e){const i=await(await this.storage.readTxn([this.storage.storeNames.sharedSecrets])).sharedSecrets.get(e);if(i)return await this.aesEncryption.decrypt(i.encrypted)}requestSecret(e,t){return t.wrap("SharedSecret.requestSecret",async i=>{const s=et(),n=this.trackSecretRequest(s,e);return await this.sendRequestForSecret(e,s,i),await this.writeRequestIdToStorage(s,e),new af(n)})}async writeRequestIdToStorage(e,t){var i;const s=await this.storage.readWriteTxn([this.storage.storeNames.session]),n=(i=await s.session.get(nr))!=null?i:{};n[e]=t,s.session.set(nr,n)}async writeSecretToStorage(e,t){const i=await this.aesEncryption.encrypt(t);(await this.storage.readWriteTxn([H.sharedSecrets])).sharedSecrets.set(e,{encrypted:i})}trackSecretRequest(e,t){const i=new Qi;return this.waitMap.set(e,{deferred:i,name:t}),i.promise}async sendRequestForSecret(e,t,i){const s={action:"request",name:e,request_id:t,requesting_device_id:this.deviceTracker.ownDeviceId};let n=await this.deviceTracker.devicesForUsers([this.ourUserId],this.hsApi,i);n=n.filter(l=>l.device_id!==this.deviceTracker.ownDeviceId);const o=await i.wrap("olm encrypt",l=>this.olmEncryption.encrypt("m.secret.request",s,n,this.hsApi,l)),a=Ir(o);await this.hsApi.sendToDevice("m.room.encrypted",a,et(),{log:i}).response()}setSecretFetcher(e){this.secretFetcher=e}}class af{constructor(e){this.receivedSecretPromise=e}async waitForResponse(e=30){const t=new Promise((s,n)=>{setTimeout(n,e*1e3)});return(await Promise.race([this.receivedSecretPromise,t])).event.content.secret}}class cf{constructor(e,t,i){this.storage=e,this.crypto=t,this.encoding=i}async load(){var e;const t=`${Ze}localAESKey`,i=await this.storage.readTxn([H.session]);let{key:s,iv:n}=(e=await i.session.get(t))!=null?e:{};s||(s=await this.crypto.aes.generateKey("jwk"),n=await this.crypto.aes.generateIV(),(await this.storage.readWriteTxn([H.session])).session.set(t,{key:s,iv:n})),this.key=s,this.iv=n}async encrypt(e){const t=this.encoding.utf8.encode(e);return await this.crypto.aes.encryptCTR({jwkKey:this.key,iv:this.iv,data:t})}async decrypt(e){const t=await this.crypto.aes.decryptCTR({jwkKey:this.key,iv:this.iv,data:e});return this.encoding.utf8.decode(t)}}class hn extends Error{constructor(e,t){super(e),this.reason=t}}class lf{constructor({key:e,platform:t,storage:i}){this._key=e,this._platform=t,this._storage=i}async hasValidKeyForAnyAccountData(){const t=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.getAll();for(const i of t)try{const s=await this._decryptAccountData(i);return!0}catch(s){if(s instanceof hn&&s.reason!==0)throw s;continue}return!1}async readSecret(e){const i=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.get(e);if(!!i)return await this._decryptAccountData(i)}async _decryptAccountData(e){var t,i;const s=(i=(t=e?.content)==null?void 0:t.encrypted)==null?void 0:i[this._key.id];if(!s)throw new hn(`Secret ${e.type} is not encrypted for key ${this._key.id}`,0);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(e.type,s);throw new hn(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`,2)}async _decryptAESSecret(e,t){const{base64:i,utf8:s}=this._platform.encoding,n=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,s.encode(e),"SHA-256",512),o=n.slice(0,32),a=n.slice(32),l=i.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,i.decode(t.mac),l,"SHA-256"))throw new hn("Bad MAC",1);const c=await this._platform.crypto.aes.decryptCTR({key:o,iv:i.decode(t.iv),data:l});return s.decode(c)}}const wa=`${Ze}ssssKey`,Rc=`${Ze}keyBackupVersion`;async function xd(r){var e;const t=await r.readTxn([r.storeNames.accountData]),i=await t.accountData.get("m.secret_storage.default_key"),s=(e=i?.content)==null?void 0:e.key;if(!s)return;const n=await t.accountData.get(`m.secret_storage.key.${s}`);if(!!n)return new va(s,n.content)}async function df(r,e,t){const i=await t.session.get(Rc);return t.session.set(Rc,e),t.session.set(wa,{id:r.id,binaryKey:r.binaryKey}),i}async function uf(r){const e=await r.session.get(wa);if(!e)return;const t=await r.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new $r(new va(e.id,t.content),e.binaryKey)}async function hf(r){r.session.remove(wa)}async function mf(r,e,t,i,s){const n=await xd(t);if(!n)throw new Error("Could not find a default secret storage key in account data");return await Td(r,e,n,i,s)}async function Td(r,e,t,i,s){let n;if(r===1)n=await sf(t,e,i);else if(r===0)n=rf(t,e,s,i);else throw new Error(`Invalid type: ${r}`);return n}async function pf(r,e,t){const i=await xd(e);if(await i?.isCompatible(r,t))return r.withDescription(i)}var gs=(r=>(r[r.Enabled=0]="Enabled",r[r.SetupWithPassphrase=1]="SetupWithPassphrase",r[r.SetupWithRecoveryKey=2]="SetupWithRecoveryKey",r[r.Pending=3]="Pending",r[r.NewVersionAvailable=4]="NewVersionAvailable",r))(gs||{}),Rn=(r=>(r[r.Writing=0]="Writing",r[r.Stopped=1]="Stopped",r[r.Done=2]="Done",r[r.Pending=3]="Pending",r))(Rn||{});class Rd extends T{render(e,t){return e.div([e.map(i=>i.status,(i,s,n)=>{switch(i){case gs.Enabled:return _f(s,n);case gs.NewVersionAvailable:return ff(s,n);case gs.SetupWithPassphrase:return yf(s,n);case gs.SetupWithRecoveryKey:return gf(s,n);case gs.Pending:return s.p(n.i18n`Waiting to go online`)}}),e.map(i=>i.backupWriteStatus,(i,s,n)=>{switch(i){case Rn.Writing:{const o=s.progress({min:0+"",max:100+"",value:a=>a.backupPercentage});return s.div(["Backup in progress ",o," ",a=>a.backupInProgressLabel])}case Rn.Stopped:{let o;return n.backupError?o=`Backup has stopped because of an error: ${n.backupError}`:o="Backup has stopped",s.p([o," ",s.button({onClick:()=>n.startBackup()},"Backup now")])}case Rn.Done:return s.p("All keys are backed up.");default:return}}),e.if(i=>i.isMasterKeyTrusted,i=>i.p("Cross-signing master key found and trusted.")),e.if(i=>i.canSignOwnDevice,i=>i.div([i.button({onClick:ya(async()=>{t.navigateToVerification()})},"Verify by emoji")]))])}}function _f(r,e){const t=[r.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,r.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(r.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),r.div(t)}function ff(r,e){const t=[r.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,r.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return r.div(t)}function gf(r,e){const t=r.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return r.div([r.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Md(r),Cd(r,e,e.i18n`Security key`,(i,s)=>e.enterSecurityKey(i,s)),r.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function yf(r,e){const t=r.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return r.div([r.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Md(r),Cd(r,e,e.i18n`Security phrase`,(i,s)=>e.enterSecurityPhrase(i,s)),r.p([e.i18n`You can also `,t,e.i18n`.`])])}function Cd(r,e,t,i){let s;const n=()=>i(o.value,s?.checked||!1),o=r.input({type:"password",disabled:l=>l.isBusy,placeholder:t}),a=[r.p([o,r.button({disabled:l=>l.isBusy,onClick:n},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){s=r.input({type:"checkbox",id:"enable-dehydrated-device"});const l=r.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(r.p([s,r.label({for:s.id},[e.i18n`Back up my device as well (`,l,")"])]))}return r.div({className:"row"},[r.div({className:"label"},t),r.div({className:"content"},a)])}function Md(r){return r.if(e=>e.error!==void 0,(e,t)=>e.div([e.p({className:"error"},i=>i.i18n`Could not enable key backup: ${i.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class vf extends T{render(e,t){return e.div({className:"FeaturesView"},[e.p("Enable experimental features here that are still in development. These are not yet ready for primetime, so expect bugs."),e.ul(t.featureViewModels.map(i=>e.li(e.view(new wf(i)))))])}}class wf extends T{render(e,t){let i=`feature_${t.id}`;return e.div({className:"FeatureView"},[e.input({type:"checkbox",id:i,checked:s=>s.enabled,onChange:s=>t.enableFeature(s.target.checked)}),e.div({class:"FeatureView_container"},[e.h4(e.label({for:i},t.name)),e.p(t.description)])])}}class bf extends T{render(e,t){let i=t.version;t.showUpdateButton&&(i=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const s=(a,l,d,c="")=>a.div({className:`row ${c}`},[a.div({className:"label"},l),a.div({className:"content"},d)]),n=[];n.push(e.h3("Session"),s(e,t.i18n`User ID`,t.userId),s(e,t.i18n`Session ID`,t.deviceId,"code"),s(e,t.i18n`Session key`,t.fingerprintKey,"code"),s(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),n.push(e.h3("Key backup & security"),e.view(new Rd(t.keyBackupViewModel))),n.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,l)=>{if(a===null)return l.p(t.i18n`Loading`);if(a){const d=h=>h.pushNotifications.enabled?h.i18n`Push notifications are enabled`:h.i18n`Push notifications are disabled`,c=h=>h.pushNotifications.enabled?h.i18n`Disable`:h.i18n`Enable`;return s(l,d,l.button({onClick:()=>t.togglePushNotifications(),disabled:h=>h.pushNotifications.updating},c))}else return l.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(l=>l.pushNotifications.enabledOnServer,(l,d)=>{if(l===!0)return d.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(l===!1)return d.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(l=>l.pushNotifications.serverError,(l,d)=>{if(l)return d.p("Couldn't not check on server: "+l.message)})]))),n.push(e.h3("Preferences"),s(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,l)=>s(a,l.i18n`Use the following theme`,this._themeOptions(a,l))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:ya(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),n.push(e.h3("Experimental features"),e.view(new vf(t.featuresViewModel))),n.push(e.h3("Application"),s(e,t.i18n`Version`,i),s(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),s(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."]),e.p([])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},n)])}_imageCompressionRange(e,t){const s=Math.ceil(t.minSentImageSizeLimit/32)*32,n=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:s,max:n,value:a=>a.sentImageSizeLimit||n,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:i,themeVariant:s}=t.activeTheme,n=[];for(const y of Object.keys(t.themeMapping))n.push(e.option({value:y,selected:y===i},y));const o=e.select({onChange:y=>{const w=y.target.value;if(!("id"in t.themeMapping[w])){const x=c.checked?"dark":p.checked?"light":"default";a(x);return}t.changeThemeOption(w)}},n),a=y=>{const w=o.options[o.selectedIndex].value;t.changeThemeOption(w,y)},l=s==="dark",d=s==="light",c=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:l}),h=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(l||d)}),p=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:d}),g=e.form({className:{hidden:()=>{const y=o.options[o.selectedIndex].value;return"id"in t.themeMapping[y]}},onChange:y=>a(y.target.value)},[h,e.label({for:"default"},"Match system theme"),c,e.label({for:"dark"},"dark"),p,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,g])}}class Sf extends T{render(e,t){return e.main({className:"CreateRoomView middle"},[e.div({className:"CreateRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room creation`}),e.h2("Create room")]),e.div({className:"CreateRoomView_body centered-column"},[e.form({className:"CreateRoomView_detailsForm form",onChange:i=>this.onFormChange(i),onSubmit:i=>this.onSubmit(i)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(i=>i.hasAvatar,i=>i?new vt(t,64):new Ds(void 0,s=>s.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:i=>t.setName(i.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:i=>t.setTopic(i.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:i=>i.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:i=>!i.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:i=>t.setRoomAlias(i.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},i=>i.isAdvancedShown?i.i18n`Hide advanced settings`:i.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:i=>!i.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:i=>!i.canCreate},t.i18n`Create room`)])])])])}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class Ef extends T{render(e,t){const i=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new vt(t,52)),e.mapView(s=>s.isEncrypted,s=>new kf(s))]),e.div({className:"RoomDetailsView_name"},[e.h2(s=>s.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},s=>s.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},i)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?z.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,i,s){const n=Ns(Ms({RoomDetailsView_label:!0},i));return e.div({className:"RoomDetailsView_row"},[e.div({className:n},[t]),e.div({className:"RoomDetailsView_value"},s)])}_createRightPanelButtonRow(e,t,i,s,n){const o=Ns(Ms({RoomDetailsView_label:!0},i));return e.button({className:"RoomDetailsView_row",onClick:n},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},s)])}}class kf extends T{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class If{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let i=0;for(i=0;i<this.start;i+=1)e.next();for(i=0;i<this.length;i+=1){const s=e.next();if(s.done)break;t(s.value,this.start+i)}}[Symbol.iterator](){return new xf(this)}reverseIterable(){return new Tf(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?Hi.Before:e<this.end?Hi.Inside:Hi.After}}var Hi=(r=>(r[r.Before=1]="Before",r[r.Inside=2]="Inside",r[r.After=3]="After",r))(Hi||{});class xf{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class Tf{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function Rf(r,e){let t=0;for(;t<e;)if(t+=1,r.next().done)return!1;return!0}function mn(r,e){if(Rf(r,e)){const t=r.next();if(!t.done)return t.value}}var ys=(r=>(r[r.Move=0]="Move",r[r.Add=1]="Add",r[r.Remove=2]="Remove",r[r.RemoveAndAdd=3]="RemoveAndAdd",r[r.UpdateRange=4]="UpdateRange",r))(ys||{});class gr extends If{constructor(e,t,i,s=t-e){super(e,t),this._totalLength=i,this._viewportItemCount=s}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),i=Math.min(this.totalLength,this.end+e);return new gr(t,i,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,i,s){const n=Math.min(Math.max(0,Math.floor(s/t)),e),o=e-n,a=i!==0?Math.ceil(i/t):0,l=Math.min(a,o);return new gr(n,n+l,e,a)}queryAdd(e,t,i){const s=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=s){const n=this.clampIndex(e,s),o=n===e?t:mn(i[Symbol.iterator](),n);return this.createAddResult(n,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const i=this.clampIndex(e);return this.createRemoveResult(i,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,i,s){const n=this.getIndexZone(e),o=this.getIndexZone(t);if(n===o){if(n===Hi.Before||n===Hi.After)return;if(n===Hi.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),l=this.clampIndex(e),d=a===t?i:mn(s[Symbol.iterator](),a);return{type:3,removeIdx:l,addIdx:a,value:d}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const i=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:i,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const i=this.clampIndex(Number.MAX_SAFE_INTEGER),s=mn(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:s,addIdx:i,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const i=this.deriveRange(-1,0,1),s=i.start,n=mn(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:n,addIdx:s,newRange:i}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,i=0){const s=this.start-i,n=this.totalLength+e,o=Math.min(Math.max(s,this.end-i+t),n);return new gr(s,o,n,this.viewportItemCount)}}class Cf extends xi{constructor(e,t){var i=e,{itemHeight:s,overflowItems:n=20}=i,o=Gh(i,["itemHeight","overflowItems"]);super(o,t),this.itemHeight=s,this.overflowItems=n}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return gr.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){D_(this._listElement);const t=document.createDocumentFragment(),i=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(i,s=>{const n=this._childCreator(s);this._childInstances.push(n),t.appendChild(xr(n,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const i of e.reverseIterable())if(!t.containsIndex(i)){const s=i-e.start;this.removeChild(s)}t.forEachInIterator(this._list[Symbol.iterator](),(i,s)=>{if(!e.containsIndex(s)){const n=s-t.start;this.addChild(n,i)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,i=(e.totalLength-e.end)*this.itemHeight,s=this._listElement.style;s.paddingTop=`${t}px`,s.paddingBottom=`${i}px`}mount(){const e=super.mount();return this.scrollContainer=z.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const i=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(i)}onRemove(e,t){const i=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(i)}onMove(e,t,i){const s=this.renderRange.queryMove(e,t,i,this._list);s&&(s.type===ys.Move?this.moveChild(this.renderRange.toLocalIndex(s.fromIdx),this.renderRange.toLocalIndex(s.toIdx)):this.applyRemoveAddResult(s))}onUpdate(e,t,i){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,i)}applyRemoveAddResult(e){(e.type===ys.Remove||e.type===ys.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===ys.Add||e.type===ys.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class Mf extends T{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new vt(t,32)),e.div({className:"MemberTileView_name"},i=>i.name)]))}}class Af extends T{render(e,t){const i=new Cf({list:t.memberTileViewModels,className:"MemberListView__list",itemHeight:40},s=>new Mf(s));return e.div({className:"MemberListView"},[e.div({className:"MemberListView__invite-container"},[e.button({className:"MemberListView__invite-btn button-action primary",onClick:()=>t.openInvitePanel()},t.i18n`Invite to this room`)]),e.view(i)])}}class Nf extends T{render(e,t){const i=[e.p(t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`)];return t.features.crossSigning&&i.push(e.div({className:"MemberDetailsView_shield_container"},[e.span({className:s=>`MemberDetailsView_shield_${s.trustShieldColor}`}),e.p({className:"MemberDetailsView_shield_description"},s=>s.trustDescription)])),e.div({className:"MemberDetailsView"},[e.view(new vt(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,i),this._createOptions(e,t)])}_createSection(e,t,i){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},i)])}_createOptions(e,t){const i=[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)];if(t.features.crossSigning){t.canVerifyUser&&i.push(e.button({className:"text",onClick:()=>t.verifyUser()},t.i18n`Verify`));const s=()=>{confirm("You don't want to do this with any account but a test account. This will cross-sign this user without verifying their keys first. You won't be able to undo this apart from resetting your cross-signing keys.")&&t.signUser()};i.push(e.button({className:"text",onClick:s},t.i18n`Cross-sign user (DO NOT USE, TESTING ONLY)`))}return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},i)])}}class Df extends T{render(e,t){return e.div({className:"WaitingForOtherUserView"},[e.div({className:"WaitingForOtherUserView__heading"},[Pe(e),e.h2({className:"WaitingForOtherUserView__title"},t.title)]),e.p({className:"WaitingForOtherUserView__description"},t.description),e.div({className:"WaitingForOtherUserView__actions"},e.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>t.cancel()},"Cancel"))])}}class Vf extends T{render(e,t){return e.div({className:"VerificationCancelledView"},[e.h2({className:"VerificationCancelledView__title"},t.title),e.p({className:"VerificationCancelledView__description"},t.description),e.div({className:"VerificationCancelledView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.dismiss()},"Got it")])])}}class Uf extends T{render(e){return e.div({className:"SelectMethodView"},[e.map(t=>t.hasProceeded,(t,i,s)=>t?Pe(i):i.div([i.div({className:"SelectMethodView__heading"},[i.h2({className:"SelectMethodView__title"},this.getHeading(i,s))]),i.p({className:"SelectMethodView__description"},this.getSubheading(s)),i.div({className:"SelectMethodView__actions"},[i.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>s.cancel()},"Cancel"),i.button({className:{"button-action":!0,primary:!0},onclick:()=>s.proceed()},"Proceed")])]))])}getHeading(e,t){return t.isCrossSigningAnotherUser?[t.i18n`Verify user `,e.span({className:"SelectMethodView__name"},t.otherUserId),t.i18n` by comparing emojis?`]:[t.i18n`Verify device`,e.span({className:"SelectMethodView__name"},t.deviceName),t.i18n` by comparing emojis?`]}getSubheading(e){return e.isCrossSigningAnotherUser?e.i18n`You are about to verify user (${e.otherUserId}) by comparing emojis.`:e.i18n`You are about to verify your other device (${e.deviceName}) by comparing emojis.`}}class Pf extends T{render(e,t){const i=t.emojis.reduce((n,[o,a])=>{const l=e.div({className:"EmojiContainer"},[e.div({className:"EmojiContainer__emoji"},o),e.div({className:"EmojiContainer__name"},a)]);return n.push(l),n},[]),s=e.div({className:"EmojiCollection"},i);return e.div({className:"VerifyEmojisView"},[e.div({className:"VerifyEmojisView__heading"},[e.h2({className:"VerifyEmojisView__title"},t.i18n`Do the emojis match?`)]),e.p({className:"VerifyEmojisView__description"},t.i18n`Confirm the emoji below are displayed on both devices, in the same order:`),e.div({className:"VerifyEmojisView__emojis"},s),e.map(n=>n.isWaiting,(n,o,a)=>n?o.div({className:"VerifyEmojisView__waiting"},[Pe(o),o.span(a.i18n`Waiting for you to verify on your other device`)]):o.div({className:"VerifyEmojisView__actions"},[o.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>a.setEmojiMatch(!1)},a.i18n`They don't match`),o.button({className:{"button-action":!0,primary:!0},onclick:()=>a.setEmojiMatch(!0)},a.i18n`They match`)]))])}}class Of extends T{render(e,t){return e.div({className:"VerificationCompleteView"},[e.div({className:"VerificationCompleteView__icon"}),e.div({className:"VerificationCompleteView__heading"},[e.h2({className:"VerificationCompleteView__title"},t.i18n`Verification completed successfully!`)]),e.p({className:"VerificationCompleteView__description"},t.verificationSuccessfulMessage),e.div({className:"VerificationCompleteView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.dismiss()},"Got it")])])}}class Ff extends T{render(e,t){return e.div({className:"MissingKeysView"},[e.h2({className:"MissingKeysView__heading"},t.i18n`Verification is currently not possible!`),e.p({className:"MissingKeysView__description"},t.i18n`Some keys needed for verification are missing. You can fix this by enabling key backup in settings.`),e.div({className:"MissingKeysView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.gotoSettings()},"Open Settings")])])}}class Ad extends T{render(e,t){return e.div({className:{middle:!t.isHappeningInRoom,DeviceVerificationView:!0}},[e.mapView(i=>i.currentStageViewModel,i=>{switch(i?.kind){case"waiting-for-user":return new Df(i);case"verification-cancelled":return new Vf(i);case"select-method":return new Uf(i);case"verify-emojis":return new Pf(i);case"verification-completed":return new Of(i);case"keys-missing":return new Ff(i);default:return new Tr(i,()=>Pe(e))}})])}}class Lf extends T{render(e,t){const i=e.input({className:"InvitePanelView__input",type:"text",placeholder:"Enter user-id of user",onkeydown:s=>{s.key==="Enter"&&t.invite(i.value)}});return e.div({className:"InvitePanelView"},[e.h3({className:"InvitePanelView__heading"},s=>s.i18n`Invite to ${s.roomName}`),e.div({className:"InvitePanelView__form"},[i,e.button({className:"InvitePanelView__btn button-action primary",onClick:()=>t.invite(i.value)},"Invite")]),e.div({className:"InvitePanelView__error"},[e.ifView(s=>!!s.errorViewModel,s=>new ts(s.errorViewModel))])])}}class Bf extends T{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new Kf(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e?.type){case"room-details":return new Ef(e);case"member-list":return new Af(e);case"member-details":return new Nf(e);case"invite":return new Lf(e);case"verification":return new Ad(e);default:return new Ed}}}class Kf extends T{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:i=>!i.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class $f extends xi{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:i=>i.onClick()};super(t,i=>new jf(i))}}class jf extends T{render(e,t){return e.button({className:{active:i=>i.isActive,pending:i=>i.isPending}},[t.key," ",i=>`${i.count}`])}onClick(){this.value.toggle()}}class $s extends T{constructor(e,t,i,s="li"){super(e),this._menuPopup=null,this._tagName=s,this._viewClassForTile=t,this._renderFlags=i}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const i=[this.renderMessageBody(e,t)];this._interactive&&i.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const s=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:o=>o.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},i);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)s.removeChild(s.querySelector(".Timeline_messageAvatar")),s.removeChild(s.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const l=z.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[ji(t,30)]),d=z.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`,title:t.sender},t.displayName);s.insertBefore(l,s.firstChild),s.insertBefore(d,s.firstChild)}});let n=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!n?(n=new $f(o),this.addSubView(n),s.appendChild(xr(n))):!o&&n&&(s.removeChild(n.root()),n.unmount(),this.removeSubView(n),n=null)}),s}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const i=()=>this.root().classList.remove("menuOpen");this._menuPopup=new Zn(new ge(t),i),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new qf(e)),t.push(ge.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(ge.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(ge.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t.push(ge.option(e.i18n`Copy matrix.to permalink`,()=>e.copyPermalink())),t}renderMessageBody(){}}class qf{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(s=>e.button({onClick:()=>this._vm.react(s)},s)),i=e.button({onClick:()=>{const s=prompt("Enter your reaction (emoji)");s&&this._vm.react(s)}},"\u2026");return e.li({className:"quick-reactions"},[...t,i])}}class zf extends T{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const i=this._viewClassForTile(t);if(!i)throw new Error(`Shape ${t.shape} is unrecognized.`);const s=new i(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",href:t.permaLink},"In reply to"),e.a({className:"pill",href:t.senderProfileLink},[ji(t,12,void 0),t.displayName]),e.br(),e.view(s)]))}}class Gf extends T{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class Hf extends $s{renderMessageBody(e,t){const i=e.time({className:{hidden:!t.time}},t.time),s=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new Gf:o?new zf(o,this._viewClassForTile):null)),n=o=>o?.nodeType!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;n(s.lastChild);)s.removeChild(s.lastChild);for(const a of o.parts)s.appendChild(Nd(a));s.appendChild(i)}),s}}function Wf(r){const e=r.items.map(i=>z.li(Wi(i))),t=r.startOffset;return t?z.ol({start:t},e):z.ul(e)}function Yf(r){const e={src:r.src};return r.width&&(e.width=r.width),r.height&&(e.height=r.height),r.alt&&(e.alt=r.alt),r.title&&(e.title=r.title),z.img(e)}function Jf(r){const e=`avatar size-12 usercolor${r.avatarColorNumber}`,t=z.div({class:e},Yt(r.avatarInitials)),i=Wi(r.children);return i.unshift(t),z.a({class:"pill",href:r.href,rel:"noopener",target:"_blank"},i)}function Xf(r){const e=[];if(r.head){const i=r.head.map(s=>z.th(Wi(s)));e.push(z.thead(z.tr(i)))}const t=[];for(const i of r.body){const s=i.map(n=>z.td(Wi(n)));t.push(z.tr(s))}return e.push(z.tbody(t)),z.table(e)}const Qf={header:r=>z["h"+Math.min(6,r.level)](Wi(r.inlines)),codeblock:r=>z.pre(z.code(Yt(r.text))),table:r=>Xf(r),code:r=>z.code(Yt(r.text)),text:r=>Yt(r.text),link:r=>z.a({href:r.url,className:"link",target:"_blank",rel:"noopener"},Wi(r.inlines)),pill:Jf,format:r=>z[r.format](Wi(r.children)),rule:()=>z.hr(),list:Wf,image:Yf,newline:()=>z.br()};function Nd(r){const e=Qf[r.type];return e?e(r):Yt(`[unknown part type ${r.type}]`)}function Wi(r){return Array.from(r,Nd)}class Dd extends $s{renderMessageBody(e,t){let s=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(s=`height: ${t.height}px`);const n=[e.div({className:"spacer",style:s}),this.renderMedia(e,t),e.time(t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(n.push(o),t.isPending){const a=e.progress({min:0,max:100,value:l=>l.uploadPercentage,className:{hidden:l=>!l.isUploading}});n.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`,"data-testid":"media"},n),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let i;switch(e.shape){case"image":i=e.i18n`Download image`;break;case"video":i=e.i18n`Download video`;break;default:i=e.i18n`Download media`;break}t.push(ge.option(i,()=>e.downloadMedia()))}return t}}class Zf extends Dd{renderMedia(e,t){const i=e.img({src:s=>s.thumbnailUrl,alt:s=>s.label,title:s=>s.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending||!t.lightboxUrl?i:e.a({href:t.lightboxUrl},i)}}function Kn(r,e){return new Promise((t,i)=>{let s;const n=a=>{s(),i(a.target.error)},o=()=>{s(),t()};s=()=>{r.removeEventListener(e,o),r.removeEventListener("error",n)},r.addEventListener(e,o),r.addEventListener("error",n)})}async function eg(r){var e;try{if((e=navigator?.clipboard)!=null&&e.writeText)return await navigator.clipboard.writeText(r),!0;{const t=document.createElement("textarea");t.value=r,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const i=document.getSelection();if(!i)return console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because `selection` was null/undefined"),!1;const s=document.createRange();s.selectNode(t),i.removeAllRanges(),i.addRange(s);const n=document.execCommand("copy");return i.removeAllRanges(),document.body.removeChild(t),n||console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because the `copy` command is unsupported or disabled"),n}}catch(t){console.error("copyPlaintext: Ran into an error",t)}return!1}class tg extends Dd{renderMedia(e){const t=e.video({src:i=>i.videoUrl||`data:${i.mimeType},`,title:i=>i.label,controls:!0,preload:"none",poster:i=>i.thumbnailUrl,onPlay:this._onPlay.bind(this),style:i=>`max-width: ${i.width}px; max-height: ${i.height}px;${i.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const i=e.target;await t.loadVideo();const s=Kn(i,"loadeddata");i.load(),await s,i.play()}catch{}}_onError(e){const t=this.value,i=e.target,s=i.error;if(s instanceof window.MediaError&&s.code===4)if(!i.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(s)}}class ig extends $s{renderMessageBody(e,t){const i=[];return t.isPending?i.push(s=>s.label):i.push(e.button({className:"link",onClick:()=>t.download()},s=>s.label),e.time(t.time)),e.p({className:"Timeline_messageBody statusMessage"},i)}}class sg extends $s{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.time)])}}class rg extends $s{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class ng extends T{constructor(e){super(e)}render(e,t){return e.li({className:"AnnouncementView","data-event-id":t.eventId},e.div(i=>i.announcement))}onClick(){}}class og extends $s{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(ge.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}var be=(r=>(r.Message="message",r.MessageStatus="message-status",r.Announcement="announcement",r.File="file",r.Gap="gap",r.Image="image",r.Location="location",r.MissingAttachment="missing-attachment",r.Redacted="redacted",r.Video="video",r.DateHeader="date-header",r.Call="call",r.Verification="verification",r))(be||{});class ag extends T{constructor(e){super(e)}render(e,t){const i={GapView:!0,isLoading:s=>s.isLoading,isAtTop:s=>s.isAtTop};return e.li({className:i},[e.div({class:"GapView_container"},[e.if(s=>s.showSpinner,s=>Pe(s)),e.span(s=>s.status)]),e.if(s=>!!s.errorViewModel,s=>s.view(new ts(t.errorViewModel,{inline:!0})))])}onClick(){}}class cg extends T{render(e,t){return e.li({className:"CallTileView AnnouncementView"},e.div([e.if(i=>i.errorViewModel,i=>i.div({className:"CallTileView_error"},i.view(new ts(t.errorViewModel,{inline:!0})))),e.div([e.div({className:"CallTileView_title"},i=>i.title),e.div({className:"CallTileView_subtitle"},[t.typeLabel," \u2022 ",e.span({className:"CallTileView_memberCount"},i=>i.memberCount)]),e.view(new xi({className:"CallTileView_members",tagName:"div",list:t.memberViewModels},i=>new vt(i,24))),e.div(i=>i.duration),e.div([e.button({className:"CallTileView_join button-action primary",hidden:i=>!i.canJoin},"Join"),e.button({className:"CallTileView_leave button-action primary destructive",hidden:i=>!i.canLeave},"Leave")])])]))}onClick(e){e.target.classList.contains("CallTileView_join")?this.value.join():e.target.classList.contains("CallTileView_leave")&&this.value.leave()}}class lg extends T{render(e,t){return e.h2({className:"DateHeader"},e.time({dateTime:t.machineReadableDate},t.relativeDate))}onClick(){}}class it{constructor(e,t,i,s){this._remove=e,this._update=t,this._replace=i,this._updateParams=s}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new it(!0,!1,!1,null)}static Update(e){return new it(!1,!0,!1,e)}static Nothing(){return new it(!1,!1,!1,null)}static Replace(e){return new it(!1,!1,!0,e)}}async function dg(r,e,t,i){const s=new Map;r.text&&s.set("text",r.text),s.set("user_agent",r.userAgent),s.set("app",r.app),s.set("version",r.version),r.label&&s.set("label",r.label),s.set("file",{name:"logs.json",blob:e});const n=new Map;n.set("Accept","application/json");const o=i(t,{method:"POST",body:s,headers:n});let a;try{a=await o.response()}catch(c){throw new Error(`Could not submit logs to ${t}, got error ${c.message}`)}const{status:l,body:d}=a;if(l<200||l>=300)throw new Error(`Could not submit logs to ${t}, got status code ${l} with body ${d}`)}async function ug(r,e){const{bugReportEndpointUrl:t}=e.config;if(!t)throw new Error("no server configured to submit logs");const s=e.logger.reporters.find(o=>!!o.export);if(!s)throw new Error("No logger that can export configured");const n=await s.export();await dg({app:"hydrogen",userAgent:e.description,version:e.version,text:`Submit logs from settings for user ${r.userId} on device ${r.deviceId}`},n.asBlob(),t,e.request)}class hg extends lt{get message(){return this.error.message}get error(){return this.getOption("error")}close(){this.getOption("onClose")()}async submitLogs(){try{return await ug(this.getOption("session"),this.platform),!0}catch{return!1}}}class jr extends lt{get errorViewModel(){return this._errorViewModel}reportError(e){var t;((t=this._errorViewModel)==null?void 0:t.error)!==e&&(this.disposeTracked(this._errorViewModel),this._errorViewModel=this.track(new hg(this.childOptions({error:e,onClose:()=>{this._errorViewModel=this.disposeTracked(this._errorViewModel),this.emitChange("errorViewModel")}}))),this.emitChange("errorViewModel"))}logAndCatch(e,t,i=void 0){try{let s=this.logger.run(e,t);return s instanceof Promise&&(s=s.catch(n=>(this.reportError(n),i))),s}catch(s){return this.reportError(s),i}}}function js(...r){const e={};for(const t of r)e[t]=t;return Object.freeze(e)}const te=js("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),Cc=["m.relates_to"];class mg{constructor({data:e,remove:t,emitUpdate:i,attachments:s}){this._data=e,this._attachments=s,this._emitUpdate=i,this._removeFromQueueCallback=t,this._aborted=!1,this._status=te.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._deferred=new Qi,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((n,o)=>n+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=Ei(this.content);return e?fa(e):this._data.relatedEventId}setRelatedEventId(e){const t=Ei(this.content);t?ad(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=te.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of Cc)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const i of Cc)t[i]!==void 0&&(e[i]=t[i])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=te.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=te.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===te.Sending||this._status===te.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=te.EncryptingAttachments,this._emitUpdate("status");for(const s of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",s.size),s.encrypt())),this.aborted)throw new yt}this._status=te.UploadingAttachments,this._emitUpdate("status");const i=Object.entries(this._attachments);i.sort(([,s],[,n])=>s.size-n.size);for(const[s,n]of i)await t.wrap("upload",o=>(o.set("size",n.size),n.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),n.applyToContent(s,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=te.Sending,this._emitUpdate("status");const i=this._data.encryptedEventType||this._data.eventType,s=this._data.encryptedContent||this._data.content;i===Tt?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,s,{log:t}):this._sendRequest=e.send(this.roomId,i,this.txnId,s,{log:t});const n=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=n.event_id,this._deferred.resolve(n.event_id),t.set("id",this._data.remoteId),this._status=te.Sent,this._emitUpdate("status")}getRemoteId(){return this._deferred.promise}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}const Lo=Number.MAX_SAFE_INTEGER;class Vd{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===Lo?1:e.fragmentId===Lo?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new Ee(this.fragmentId,this.entryIndex)}}class pg{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,i)=>!t||i.pendingEvent.queueIndex>t.pendingEvent.queueIndex?i:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function Mc(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function _g(r){switch(r){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function fg(r){return r==="m.emote"?"* ":""}function gg(r,e,t,i){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:i,"m.relates_to":{"m.in_reply_to":{event_id:r}}}}function yg(r,e,t){const i=_g(r.content.msgtype),s=fg(r.content.msgtype),n=r.sender,o=r.displayName||n,a=i||r.content.formatted_body||r.content.body&&Mc(r.content.body)||"",l=`<mx-reply><blockquote>In reply to ${s}<a href="https://matrix.to/#/${n}">${o}</a><br />${a}</blockquote></mx-reply>`,c=(i||r.content.body||"").split(`
`);c[0]=`> ${s}<${n}> ${c[0]}`;const p=c.join(`
> `)+`

`+t,g=l+Mc(t);return gg(r.id,e,p,g)}class Ud extends Vd{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isReference(){var e;return((e=this.relation)==null?void 0:e.rel_type)===od}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===Tt}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===Tt&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===gi&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===Tt&&e.isRelatedToId(this.id)&&this._pendingRedactions){const i=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(s=>s!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,i!==0))return"isRedacted"}else{const i=e.redactingEntry||e;if(i.isRelatedToId(this.id)&&((t=i.relation)==null?void 0:t.rel_type)===gi&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let i=this._pendingAnnotations.get(t);return i||(i=new pg,this._pendingAnnotations.set(t,i)),i.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let i=this._pendingAnnotations.get(t);return i.remove(e)&&i.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Op(this.id,e)}createReplyContent(e,t){return yg(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var t,i,s;const n=((i=(t=this.annotations)==null?void 0:t[e])==null?void 0:i.me)||!1,o=(s=this.pendingAnnotations)==null?void 0:s.get(e),a=o?.willAnnotate||!1;return n&&(!o||a)||!n&&a}get relation(){return Ei(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class vg extends Ud{constructor({pendingEvent:e,member:t,clock:i,redactingEntry:s}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=i.now()-(100-e.queueIndex),this._redactingEntry=s}get fragmentId(){return Lo}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}class at extends Ud{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new at(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return Oo(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return cd(this.event)}get isRedacted(){return super.isRedacted||Fo(this._eventEntry.event)}get redactionReason(){var e,t;const i=(e=this._eventEntry.event.unsigned)==null?void 0:e.redacted_because;return i?(t=i.content)==null?void 0:t.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&Ei(e)||Ei(this.content)}get contextEventId(){return this.isReply||this.isReference?this.relatedEventId:null}}class wg extends lt{constructor(e,t){super(t),this._firstTileInDay=e}setUpdateEmit(e){this._emitUpdate=e}get upperEntry(){return this.refEntry}get lowerEntry(){return this.refEntry}get refEntry(){return this._firstTileInDay.lowerEntry}compare(e){return this.compareEntry(e.upperEntry)}get relativeDate(){return this._dateString||(this._dateString=this.timeFormatter.formatRelativeDate(new Date(this.refEntry.timestamp))),this._dateString}get machineReadableDate(){return this._machineReadableString||(this._machineReadableString=this.timeFormatter.formatMachineReadableDate(new Date(this.refEntry.timestamp))),this._machineReadableString}get shape(){return be.DateHeader}get needsDateSeparator(){return!1}createDateSeparator(){}compareEntry(e){const t=this.refEntry.compare(e);return t===0?-1:t}updateEntry(e,t){return it.Nothing()}removeEntry(e){return!1}tryIncludeEntry(){return!1}get comparisonIsNotCommutative(){return!0}updatePreviousSibling(e){this._firstTileInDay.updatePreviousSibling(e)}updateNextSibling(e){var t;if(!e)return;this._firstTileInDay=e;const i=this._dateString;this._dateString=void 0,this._machineReadableString=void 0,i&&i!==this.relativeDate&&((t=this._emitUpdate)==null||t.call(this,this,"relativeDate"))}notifyVisible(){}dispose(){}}class is extends jr{constructor(e,t){super(t),this._needsDateSeparator=!1,this._entry=e,this._date=this._entry.timestamp?new Date(this._entry.timestamp):void 0}get isContinuation(){return!1}get needsDateSeparator(){return this._needsDateSeparator}createDateSeparator(){return new wg(this,this.childOptions({}))}_updateDateSeparator(e){e&&e._date&&this._date?this._needsDateSeparator=e._date.getFullYear()!==this._date.getFullYear()||e._date.getMonth()!==this._date.getMonth()||e._date.getDate()!==this._date.getDate():this._needsDateSeparator=!!this._date}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==te.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}async abortSending(){var e;await((e=this._entry.pendingEvent)==null?void 0:e.abort())}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}get comparisonIsNotCommutative(){return!1}compare(e){return e.comparisonIsNotCommutative?-e.compare(this):this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const i=this.shape==="redacted";return!e.isGap&&e.isRedacted!==i?it.Replace("shape"):(this._entry=e,it.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(e){e?.shape!==be.DateHeader&&this._updateDateSeparator(e)}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(void 0),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this.options.roomVM}get _timeline(){return this.options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this.options.timeline.me}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}}var ur=(r=>(r[r.Ready=0]="Ready",r[r.InProgress=1]="InProgress",r[r.Completed=2]="Completed",r[r.Cancelled=3]="Cancelled",r))(ur||{});class bg extends is{constructor(e,t){super(e,t),this.status=0,this.request=new Tn(this.lowerEntry),this.updateStatusFromAvailableContextForEntries()}get shape(){return be.Verification}get description(){return this.i18n`${this.sender} wants to verify`}accept(){this.getOption("session").crossSigning.get().receivedSASVerifications.set(this.eventId,this.request),this.openVerificationPanel(this.eventId)}async reject(){await this.logAndCatch("VerificationTile.reject",async e=>{const t=this.getOption("session").crossSigning.get();await this.request.reject(t,this._room,e)})}openVerificationPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment("verification",e)),this.navigation.applyPath(t)}updateEntry(e,t){return t==="context-added"?this.updateStatusFromAvailableContextForEntries()?it.Update(t):it.Nothing():super.updateEntry(e,t)}updateStatusFromAvailableContextForEntries(){var e;let t=!1;for(const i of(e=this.lowerEntry.contextForEntries)!=null?e:[])switch(i.eventType){case P.Cancel:return this.status=3,this.isCancelledByUs=i.sender===this.getOption("session").userId,!0;case P.Done:return this.status=2,!0;default:this.status=1,t=!0}return t}}class Sg extends T{render(e,t){return e.div({className:"VerificationTileView"},e.mapView(i=>i.status,i=>{switch(i){case ur.Ready:return new Eg(t);case ur.Cancelled:return new kg(t);case ur.Completed:return new Ig(t);case ur.InProgress:return new xg(t)}}))}onClick(e){var t;(t=this._subViews)==null||t.forEach(i=>{var s;return(s=i.onClick)==null?void 0:s.call(i,e)})}}class Eg extends T{render(e,t){return e.div({className:"VerificationReadyTileView"},[e.div({className:"VerificationTileView__shield"}),e.div({className:"VerificationTileView__description"},[e.div(t.description)]),e.div({className:"VerificationTileView__actions"},[e.button({className:"VerificationTileView__accept button-action primary"},"Accept"),e.button({className:"VerificationTileView__reject button-action secondary"},"Reject")])])}onClick(e){e.target.classList.contains("VerificationTileView__accept")?this.value.accept():e.target.classList.contains("VerificationTileView__reject")&&this.value.reject()}}class kg extends T{render(e,t){return e.div({className:"VerificationCancelledTileView"},[e.div({className:"VerificationTileView__description"},t.i18n`${t.isCancelledByUs?"You":t.sender} cancelled the verification!`)])}}class Ig extends T{render(e,t){return e.div({className:"VerificationCompletedTileView"},[e.div({className:"VerificationTileView__description"},[e.div({className:"VerificationTileView__shield"}),e.div(t.i18n`You verified ${t.sender}`)])])}}class xg extends T{render(e,t){return e.div({className:"VerificationInProgressTileView"},[e.div({className:"VerificationTileView__description"},t.i18n`Verification in progress`),e.div({className:"VerificationTileView__actions"},[Pe(e)])])}}function Bo(r){switch(r.shape){case be.Gap:return ag;case be.Announcement:return ng;case be.Message:case be.MessageStatus:return Hf;case be.Image:return Zf;case be.Video:return tg;case be.File:return ig;case be.Location:return sg;case be.MissingAttachment:return rg;case be.Redacted:return og;case be.Call:return cg;case be.DateHeader:return lg;case be.Verification:return Sg;default:throw new Error(`Tiles of shape "${r.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class Tg extends T{render(e,t){const i=e.input({type:"text",name:"id",id:"id",placeholder:t.i18n`Enter a room id or alias`,disabled:s=>s.joinInProgress});return e.main({className:"JoinRoomView middle"},[e.div({className:"JoinRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.h2("Join room")]),e.div({className:"JoinRoomView_body centered-column"},[e.form({className:"JoinRoomView_detailsForm form",onSubmit:s=>this.onSubmit(s,i.value)},[e.div({className:"vertical-layout"},[e.div({className:"stretch form-row text"},[e.label({for:"id"},t.i18n`Room id`),i])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>s.joinInProgress},t.i18n`Join`)]),e.map(s=>s.status,(s,n)=>n.div({className:"JoinRoomView_status"},[Pe(n,{hidden:o=>!o.joinInProgress}),n.span(s)]))])])])}onSubmit(e,t){e.preventDefault(),this.value.join(t)}}class Rg extends T{render(e,t){return e.div({className:"CallToastNotificationView"},[e.div({className:"CallToastNotificationView__top"},[e.view(new vt(t,24)),e.span({className:"CallToastNotificationView__name"},i=>i.roomName),e.button({className:"button-action CallToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"CallToastNotificationView__description"},[e.span(t.i18n`Video call started`)]),e.div({className:"CallToastNotificationView__info"},[e.span({className:"CallToastNotificationView__call-type"},t.i18n`Video`),e.span({className:"CallToastNotificationView__member-count"},i=>i.memberCount)]),e.div({className:"CallToastNotificationView__action"},[e.button({className:"button-action primary",onClick:()=>t.join()},t.i18n`Join`)]),e.if(i=>!!i.errorViewModel,i=>i.div({className:"CallView_error"},i.view(new ts(t.errorViewModel))))])}}class Cg extends T{render(e,t){return e.div({className:"VerificationToastNotificationView"},[e.div({className:"VerificationToastNotificationView__top"},[e.span({className:"VerificationToastNotificationView__title"},t.i18n`Device Verification`),e.button({className:"button-action VerificationToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"VerificationToastNotificationView__description"},[e.span(t.i18n`Do you want to verify device ${t.otherDeviceId}?`)]),e.div({className:"VerificationToastNotificationView__action"},[e.button({className:"button-action primary destructive",onClick:()=>t.dismiss()},t.i18n`Ignore`),e.button({className:"button-action primary",onClick:()=>t.accept()},t.i18n`Accept`)])])}}function Mg(r){switch(r.kind){case"calls":return new Rg(r);case"verification":return new Cg(r);default:throw new Error(`Cannot find view class for notification kind ${r.kind}`)}}class Ag extends T{render(e,t){return e.div({className:"ToastCollectionView"},[e.ifView(i=>!!i.toastViewModels,i=>new xi({list:t.toastViewModels,parentProvidesUpdates:!1},s=>Mg(s)))])}}class Ng extends T{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":i=>!!i.activeMiddleViewModel,"right-shown":i=>!!i.rightPanelViewModel}},[e.view(new Ag(t.toastCollectionViewModel)),e.view(new X_(t.sessionStatusViewModel)),e.view(new B_(t.leftPanelViewModel)),e.mapView(i=>i.activeMiddleViewModel,()=>t.roomGridViewModel?new Q_(t.roomGridViewModel,Bo):t.settingsViewModel?new bf(t.settingsViewModel):t.createRoomViewModel?new Sf(t.createRoomViewModel):t.joinRoomViewModel?new Tg(t.joinRoomViewModel):t.verificationViewModel?new Ad(t.verificationViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new Id(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new Sd(t.currentRoomViewModel,Bo):t.currentRoomViewModel.kind==="roomBeingCreated"?new kd(t.currentRoomViewModel):new G_(t.currentRoomViewModel):new Ds(i=>i.div({className:"room-placeholder"},i.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(i=>i.lightboxViewModel,i=>i?new W_(i):null),e.mapView(i=>i.rightPanelViewModel,i=>i?new Bf(i):null)])}}function Pd(r){return r.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class Dg extends T{render(e,t){const i=o=>!!o.isBusy,s=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:i}),n=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:i});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(s.value,n.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),s]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),n]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:i},t.i18n`Log In`)])])])}}class Vg extends T{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(i=>i.decryptDehydratedDeviceViewModel,i=>new Rd(i.decryptDehydratedDeviceViewModel)),e.map(i=>i.deviceDecrypted,(i,s)=>i?s.p(t.i18n`That worked out, you're good to go!`):s.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},i=>i.deviceDecrypted?i.i18n`Continue`:i.i18n`Continue without restoring`)])])}}class eo extends T{render(e){const t=e.if(s=>s.hasError,(s,n)=>s.button({onClick:()=>n.exportLogs()},n.i18n`Export logs`)),i=e.if(s=>s.hasError,(s,n)=>s.button({onClick:()=>n.logout()},n.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[Pe(e,{hidden:s=>!s.loading}),e.p(s=>s.loadLabel),t,i]),e.ifView(s=>s.accountSetupViewModel,s=>new Vg(s.accountSetupViewModel))])}}class Ug extends T{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,i)=>t.p({className:"error"},i.i18n(i.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new eo(t):null)])}}class Pg extends T{render(e,t){const i=s=>s.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:i}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(s=>s.completeSSOLoginViewModel,s=>s?new Ug(s):null),e.if(s=>s.showHomeserver,(s,n)=>s.div({className:"LoginView_sso form-row text"},[s.label({for:"homeserver"},n.i18n`Homeserver`),s.input({id:"homeserver",type:"text",placeholder:n.i18n`Your matrix homeserver`,value:n.homeserver,disabled:i,onInput:o=>n.setHomeserver(o.target.value),onChange:()=>n.queryHomeserver()}),s.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),s.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(s=>s.isFetchingLoginOptions,s=>s.div({className:"LoginView_query-spinner"},[Pe(s),s.p("Fetching available login options...")])),e.mapView(s=>s.passwordLoginViewModel,s=>s?new Dg(s):null),e.if(s=>s.passwordLoginViewModel&&s.startSSOLoginViewModel,s=>s.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(s=>s.startSSOLoginViewModel,s=>s?new Og(s):null),e.mapView(s=>s.loadViewModel,s=>s?new eo(s):null),e.p(Pd(e))])}}class Og extends T{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:i=>i.isBusy},t.i18n`Log in with SSO`))}}class Fg extends T{render(e,t){const i=new Tr(t,n=>n.div([n.p("Are you sure you want to log out?"),n.div({className:"button-row"},[n.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),n.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),s=new Tr(t,n=>n.p({className:"status",hidden:o=>!o.showStatus},[Pe(n,{hidden:o=>!o.busy}),n.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(n=>n.showConfirm,n=>n?i:s)])])}}class Lg extends T{render(e){return e.div({className:"LogoutScreen"},[e.div({className:"content"},e.map(t=>t.showStatus,(t,i,s)=>t?i.p({className:"status"},[Pe(i,{hidden:n=>!n.showSpinner}),i.span(n=>n.status)]):i.div([i.p("Your access token is no longer valid! You can reauthenticate in the next screen."),i.div({className:"button-row"},[i.button({className:"button-action primary",type:"submit",onClick:()=>s.proceed()},s.i18n`Proceed`)])])))])}}class Bg extends T{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new eo(t))]),e.div({className:{"button-row":!0,hidden:i=>i.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class Kg extends T{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},i=>i.avatarInitials),e.div({className:"user-id"},i=>i.label)])])}}class $g extends T{render(e,t){const i=new xi({list:t.sessions,parentProvidesUpdates:!1},s=>new Kg(s));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(i),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(s=>s.loadViewModel,()=>new eo(t.loadViewModel)),e.p(Pd(e))])])}}class jg extends T{render(e,t){return e.mapView(i=>i.activeSection,i=>{switch(i){case"error":return new Ds(s=>s.div({className:"StatusView"},[s.h1("Something went wrong"),s.p(t.errorText)]));case"session":return new Ng(t.sessionViewModel);case"login":return new Pg(t.loginViewModel);case"logout":return new Fg(t.logoutViewModel);case"forced-logout":return new Lg(t.forcedLogoutViewModel);case"picker":return new $g(t.sessionPickerViewModel);case"redirecting":return new Ds(s=>s.p("Redirecting..."));case"loading":return new Bg(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class qg{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,i)=>{this._reject=i,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new yt),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class zg{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class Gg{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class Hg{createMeasure(){return new Gg}createTimeout(e){return new qg(e)}createInterval(e,t){return new zg(t,e)}now(){return Date.now()}}class Wg{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,i=t.replyTo;if(i){const s=this._waitingForReply.get(i);s&&(this._waitingForReply.delete(i),s(t.payload))}if(t.type==="hasSessionOpen"){const s=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:s})}else if(t.type==="hasRoomOpen"){const s=this._navigation.observe("session").get()===t.payload.sessionId,n=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:s&&n})}else if(t.type==="closeSession"){const{sessionId:s}=t.payload;this._closeSessionIfNeeded(s).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){var t;const i=(t=this._navigation)==null?void 0:t.path.get("session");return e&&i?.value===e?new Promise(s=>{const n=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(n(),s())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,i=void 0){this._registrationPromise&&await this._registrationPromise,i||(i=this._registration.active),i.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,i=void 0){this._registrationPromise&&await this._registrationPromise,i||(i=this._registration.active),this._messageIdCounter+=1;const s=this._messageIdCounter,n=new Promise(o=>{this._waitingForReply.set(s,o)});return i.postMessage({type:e,id:s,payload:t}),await n}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.4.1"}get buildHash(){return null}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class Yg{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var i;const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());if(s?.pushManager){const o=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,l={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,l)}}async disablePush(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());if(t?.pushManager){const i=await t.pushManager.getSubscription();i&&await i.unsubscribe()}}async isPushEnabled(){var e;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t?.pushManager?!!await t.pushManager.getSubscription():!1}async supportsPush(){var e;if(!this._pushConfig)return!1;const t=await((e=this._serviceWorkerHandler)==null?void 0:e.getRegistration());return t&&"pushManager"in t}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var i;if("Notification"in window){new Notification(e,{body:t});return}const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());s?.showNotification(e,{body:t})}}class Jg extends Ct{constructor(){super(),this._lastSessionHash=void 0}handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){var e;this._lastSessionHash=(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash"),window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastSessionUrl(){return this._lastSessionHash}}class Xg extends Ct{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function Ke(r,e){return r instanceof Promise?r:new Promise((t,i)=>{r.oncomplete=s=>t(s.target.result),r.onerror=()=>i(new Error("Crypto error on "+e))})}class Qg{constructor(e){this._subtleCrypto=e}async verify(e,t,i,s){const n={name:"HMAC",hash:{name:Yi(s)}},o=await Ke(this._subtleCrypto.importKey("raw",e,n,!1,["verify"]),"importKey");return await Ke(this._subtleCrypto.verify(n,o,t,i),"verify")}async compute(e,t,i){const s={name:"HMAC",hash:{name:Yi(i)}},n=await Ke(this._subtleCrypto.importKey("raw",e,s,!1,["sign"]),"importKey"),o=await Ke(this._subtleCrypto.sign(s,n,t),"sign");return new Uint8Array(o)}}class Zg{constructor(e,t,i){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=i}async pbkdf2(e,t,i,s,n){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await Ke(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await Ke(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:i,iterations:t,hash:Yi(s)},o,n),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,i,s,n){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,i,s,n);const o=await Ke(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await Ke(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:i,hash:Yi(s)},o,n),"deriveBits");return new Uint8Array(a)}}class ey{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:i,data:s,counterLength:n=64}){const o={name:"AES-CTR",counter:i,length:n};let a;try{const l=e||t,d=t?"jwk":"raw";a=await Ke(this._subtleCrypto.importKey(d,l,o,!1,["decrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR decryption: ${l.message}`)}try{const l=await Ke(this._subtleCrypto.decrypt(o,a,s),"decrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not decrypt with AES-CTR: ${l.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:i,data:s}){const n={name:"AES-CTR",counter:i,length:64};let o;const a=e||t,l=t?"jwk":"raw";try{o=await Ke(this._subtleCrypto.importKey(l,a,n,!1,["encrypt"]),"importKey")}catch(d){throw new Error(`Could not import key for AES-CTR encryption: ${d.message}`)}try{const d=await Ke(this._subtleCrypto.encrypt(n,o,s),"encrypt");return new Uint8Array(d)}catch(d){throw new Error(`Could not encrypt with AES-CTR: ${d.message}`)}}async generateKey(e,t=256){const i=await Ke(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return Ke(this._subtleCrypto.exportKey(e,i))}async generateIV(){return Od(this._crypto)}}function Od(r){const e=r.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let i=0;i<e.length;i+=1)t[i]=e[i];return t}function Ac(r){if(r.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${r.alg}`);if(!r.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(r.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${r.kty}`);const t=r.k.replace(/-/g,"+").replace(/_/g,"/");return zi.decode(t)}function ty(r){const e=zi.encode(r),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function iy(r){return ty(r).replace(/\+/g,"-").replace(/\//g,"_")}function sy(r){return{alg:"A256CTR",ext:!0,k:iy(r),key_ops:["encrypt","decrypt"],kty:"oct"}}class ry{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:i,data:s,counterLength:n=64}){if(n!==64)throw new Error(`Unsupported counter length: ${n}`);t&&(e=Ac(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(i)));return a.decrypt(new Uint8Array(s))}async encryptCTR({key:e,jwkKey:t,iv:i,data:s}){t&&(e=Ac(t));const n=this._aesjs;var o=new n.ModeOfOperation.ctr(new Uint8Array(e),new n.Counter(new Uint8Array(i)));return o.encrypt(new Uint8Array(s))}async generateKey(e,t=256){let i=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(i=sy(i)),i}async generateIV(){return Od(this._crypto)}}function Yi(r){if(r!=="SHA-256"&&r!=="SHA-512")throw new Error(`Invalid hash name: ${r}`);return r}class ny{constructor(e){const t=window.crypto||window.msCrypto,i=t.subtle||t.webkitSubtle;this._subtleCrypto=i,!i.deriveBits&&e?.aesjs?this.aes=new ry(e.aesjs,t):this.aes=new ey(i,t),this.hmac=new Qg(i),this.derive=new Zg(i,this,e)}async digest(e,t){return await Ke(this._subtleCrypto.digest(Yi(e),t))}digestSize(e){switch(Yi(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${Yi(e)}`)}}}async function oy(){var r;if((r=navigator?.storage)!=null&&r.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class ay{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class cy{constructor(e,t){this._promise=new Promise((i,s)=>{this._resolve=i,this._reject=s}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class ly{constructor(e,t){this._workers=[];for(let i=0;i<t;++i){const s=new ay(new Worker(e));s.attach(this),this._workers[i]=s}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,i)=>{this._init={resolve:t,reject:i}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,i=this._requests.get(t.replyToId);if(i){if(i._worker.busy=!1,i._isNotDisposed){if(t.type==="success")i._resolve(t.payload);else if(t.type==="error"){const s=new Error(t.message);s.stack=t.stack,i._reject(s)}i._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const i=this._getFreeWorker();i&&(this._sendWith(t,i),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new cy(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),i=this._getFreeWorker();return i&&this._sendWith(t,i),t}sendAll(e){const t=this._workers.map(i=>{const s=this._enqueueRequest(Object.assign({},e));return this._sendWith(s,i),s.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new yt),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}const dy={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Nc="application/octet-stream";class Zi{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",dy[t]||(t=Nc),new Zi(new Blob([e],{type:t}),e)}static fromBlobUnsafe(e){return new Zi(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((i,s)=>{e.addEventListener("load",n=>i(n.target.result)),e.addEventListener("error",n=>s(n.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Nc}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}class Rr{static async fromBlob(e){const t=await Dc(e),{width:i,height:s}=t;return new Rr(e,i,s,t)}constructor(e,t,i,s){this.blob=e,this.width=t,this.height=i,this._domElement=s}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await Dc(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,i=Math.min(1,e/(t>=1?this.width:this.height)),s=Math.round(this.width*i),n=Math.round(this.height*i),o=document.createElement("canvas");o.width=s,o.height=n;const a=o.getContext("2d"),l=await this._getDomElement();a.drawImage(l,0,0,s,n);let d=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",c;if(o.toBlob)c=await new Promise(p=>o.toBlob(p,d));else if(o.msToBlob)d="image/png",c=o.msToBlob();else throw new Error("canvas can't be turned into blob");const h=Zi.fromBlobUnsafe(c);return new Rr(h,s,n,null)}dispose(){this.blob.dispose()}}class ba extends Rr{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await hy(e),{videoWidth:i,videoHeight:s}=t;return new ba(e,i,s,t)}}function uy(){const r=document.createElement("canvas");r.width=1,r.height=1;const e=r.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const i=e.getImageData(0,0,1,1).data;return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]}async function Dc(r){const e=document.createElement("img"),t=Kn(e,"load");return e.src=r.url,await t,e}async function hy(r){const e=document.createElement("video");e.muted=!0;const t=Kn(e,"loadedmetadata");e.src=r.url,e.load(),await t;const i=Kn(e,"seeked");return await new Promise(s=>setTimeout(s,200)),e.currentTime=.1,await i,e}async function my(r,e,t,i,s){let n=r.querySelector("iframe.downloadSandbox");if(!n){n=document.createElement("iframe"),n.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),n.setAttribute("src",e),n.className="hidden downloadSandbox",r.appendChild(n);let o;await new Promise((a,l)=>{o=()=>{n.removeEventListener("load",a),n.removeEventListener("error",l)},n.addEventListener("load",a),n.addEventListener("error",l)}),o()}if(s){const o=await t.readAsBuffer();n.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:i},"*")}else n.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:i},"*")}class py{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const _y={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function fy(r){const e=Kh.sanitize(r,_y),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new py(t)}const gy=200,yy=-60,vy=8;class wy{constructor(e){this.mediaDevices=e}enumerate(){return this.mediaDevices.enumerateDevices()}async getMediaTracks(e,t){const i=await this.mediaDevices.getUserMedia(this.getUserMediaContraints(e,t));return i.addEventListener("removetrack",s=>{console.log(`removing track ${s.track.id} (${s.track.kind}) from stream ${i.id}`)}),i}async getScreenShareTrack(){return await this.mediaDevices.getDisplayMedia(this.getScreenshareContraints())}getUserMediaContraints(e,t){const i=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:typeof e!="boolean"?{ideal:e.deviceId}:void 0}:!1,video:t?{deviceId:typeof t!="boolean"?{ideal:t.deviceId}:void 0,width:i?{exact:640}:{ideal:640},height:i?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(){return{audio:!1,video:!0}}createVolumeMeasurer(e,t){return new by(e,t)}}class by{constructor(e,t){this.measuringVolumeActivity=!1,this.speakingThreshold=yy,this.speaking=!1,this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let i=-1/0;for(let n=0;n<this.frequencyBinCount.length;n++)this.frequencyBinCount[n]>i&&(i=this.frequencyBinCount[n]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(i),this.callback();let s=!1;for(let n=0;n<this.speakingVolumeSamples.length;n++)if(this.speakingVolumeSamples[n]>this.speakingThreshold){s=!0;break}this.speaking!==s&&(this.speaking=s,this.callback()),this.volumeLooperTimeout=setTimeout(this.volumeLooper,gy)},this.stream=e,this.callback=t,this.speakingVolumeSamples=new Array(vy).fill(-1/0),this.initVolumeMeasuring(),this.measureVolumeActivity(!0)}get isSpeaking(){return this.speaking}measureVolumeActivity(e){if(e){if(!this.audioContext||!this.analyser||!this.frequencyBinCount)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.callback()}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}setSpeakingThreshold(e){this.speakingThreshold=e}stop(){var e;clearTimeout(this.volumeLooperTimeout),this.analyser.disconnect(),(e=this.audioContext)==null||e.close()}}var q=(r=>(r.GroupCall="org.matrix.msc3401.call",r.GroupCallMember="org.matrix.msc3401.call.member",r.Invite="m.call.invite",r.Candidates="m.call.candidates",r.Answer="m.call.answer",r.Hangup="m.call.hangup",r.Reject="m.call.reject",r.SelectAnswer="m.call.select_answer",r.Negotiate="m.call.negotiate",r.SDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",r.SDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",r.Replaces="m.call.replaces",r.AssertedIdentity="m.call.asserted_identity",r.AssertedIdentityPrefix="org.matrix.call.asserted_identity",r))(q||{});const Et="org.matrix.msc3077.sdp_stream_metadata";var ai=(r=>(r.Usermedia="m.usermedia",r.Screenshare="m.screenshare",r))(ai||{}),re=(r=>(r.UserHangup="user_hangup",r.LocalOfferFailed="local_offer_failed",r.NoUserMedia="no_user_media",r.UnknownDevices="unknown_devices",r.SendInvite="send_invite",r.CreateAnswer="create_answer",r.SendAnswer="send_answer",r.SetRemoteDescription="set_remote_description",r.SetLocalDescription="set_local_description",r.AnsweredElsewhere="answered_elsewhere",r.IceFailed="ice_failed",r.InviteTimeout="invite_timeout",r.Replaced="replaced",r.SignallingFailed="signalling_timeout",r.UserBusy="user_busy",r.Transfered="transferred",r.NewSession="new_session",r))(re||{}),Cr=(r=>(r.Ring="m.ring",r.Prompt="m.prompt",r.Room="m.room",r))(Cr||{}),Cn=(r=>(r.Video="m.video",r.Voice="m.voice",r))(Cn||{});class Sy{createPeerConnection(e,t,i){const s=new RTCPeerConnection({iceTransportPolicy:e?"relay":void 0,iceServers:t,iceCandidatePoolSize:i});return new Proxy(s,{get(n,o,a){o==="close"&&console.trace("calling peerConnection.close");const l=n[o];return typeof l=="function"?l.bind(n):l}})}prepareSenderForPurpose(e,t,i){i===ai.Screenshare&&this.getRidOfRTXCodecs(e,t)}getRidOfRTXCodecs(e,t){var i,s,n,o,a,l;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const d=(s=(i=RTCRtpReceiver.getCapabilities("video"))==null?void 0:i.codecs)!=null?s:[],h=[...(o=(n=RTCRtpSender.getCapabilities("video"))==null?void 0:n.codecs)!=null?o:[],...d];for(const g of h)if(g.mimeType==="video/rtx"){const y=h.indexOf(g);h.splice(y,1)}const p=e.getTransceivers().find(g=>g.sender===t);p&&(((a=p.sender.track)==null?void 0:a.kind)==="video"||((l=p.receiver.track)==null?void 0:l.kind)==="video")&&p.setCodecPreferences(h)}}var di=(r=>(r[r.Dark=0]="Dark",r[r.Light=1]="Light",r))(di||{});function Ey(r,e,t){let i=r.replaceAll("#ff00ff",e);if(i=i.replaceAll("#00ffff",t),r===i)throw new Error("svg-colorizer made no color replacements! The input svg should only contain colors #ff00ff (primary, case-sensitive) and #00ffff (secondary, case-sensitive).");return i}class ky{constructor(e,t,i,s){this._platform=e,this._iconVariables=t,this._resolvedVariables=i,this._manifestLocation=s}async toVariables(){const{parsedStructure:e,promises:t}=await this._fetchAndParseIcons();return await Promise.all(t),this._produceColoredIconVariables(e)}async _fetchAndParseIcons(){const e=[],t={};for(const[i,s]of Object.entries(this._iconVariables)){const n=new URL(`https://${s}`),o=n.hostname,a=new URL(o,new URL(this._manifestLocation,window.location.origin)),l=this._platform.request(a,{method:"GET",format:"text",cache:!0}).response();e.push(l);const d=n.searchParams;t[i]={svg:l,primary:d.get("primary"),secondary:d.get("secondary")}}return{parsedStructure:t,promises:e}}async _produceColoredIconVariables(e){let t={};for(const[i,{svg:s,primary:n,secondary:o}]of Object.entries(e)){const{body:a}=await s;if(!n)throw new Error(`Primary color variable ${n} not in list of variables!`);const l=this._resolvedVariables[n],d=this._resolvedVariables[o],c=Ey(a,l,d),h=`url('data:image/svg+xml;utf8,${encodeURIComponent(c)}')`;t[i]=h}return t}}const wo=(ac=Jn.exports.offColor)!=null?ac:Dl.offColor;function Vc(r,e,t,i){const s=parseInt(t);switch(i&&(e==="darker"?e="lighter":e==="lighter"&&(e="darker")),e){case"darker":return wo(r).darken(s/100).hex();case"lighter":return wo(r).lighten(s/100).hex();case"alpha":return wo(r).rgba(s/100)}}class Iy{constructor(e,t,i){this._aliases={},this._derivedAliases=[],this._baseVariables=e,this._variablesToDerive=t,this._isDark=i}toVariables(){var e;const t={};this._detectAliases();for(const i of this._variablesToDerive){const s=this._derive(i);s&&(t[i]=s)}for(const[i,s]of Object.entries(this._aliases))t[i]=(e=this._baseVariables[s])!=null?e:t[s];for(const i of this._derivedAliases){const s=this._deriveAlias(i,t);s&&(t[i]=s)}return t}_detectAliases(){const e=[];for(const t of this._variablesToDerive){const[i,s]=t.split("=");s?this._aliases[i]=s:e.push(t)}this._variablesToDerive=e}_derive(e){const t=/(.+)--(.+)-(.+)/,i=e.match(t);if(i){const[,s,n,o]=i,a=this._baseVariables[s];if(!a)if(this._aliases[s]){this._derivedAliases.push(e);return}else throw new Error(`Cannot find value for base variable "${s}"!`);return Vc(a,n,o,this._isDark)}}_deriveAlias(e,t){const i=/(.+)--(.+)-(.+)/,s=e.match(i);if(s){const[,n,o,a]=s,l=t[n];if(!l)throw new Error(`Cannot find value for alias "${n}" when trying to derive ${e}!`);return Vc(l,o,a,this._isDark)}}}(cc=Jn.exports.offColor)!=null||Dl.offColor;class xy{constructor(e,t){this._themeMapping={},this._preferredColorScheme=t,this._platform=e}async parse(e,t,i,s){await s.wrap("RuntimeThemeParser.parse",async()=>{var n;const{cssLocation:o,derivedVariables:a,icons:l}=this._getSourceData(t,i,s),d=e.name;if(!d)throw new Error("Theme name not found in manifest!");let c={},h={};for(const[p,g]of Object.entries((n=e.values)==null?void 0:n.variants))try{const y=`${e.id}-${p}`,{name:w,default:x,dark:M,variables:D}=g,O=new Iy(D,a,M).toVariables();Object.assign(D,O);const C=await new ky(this._platform,l,D,i).toVariables();Object.assign(D,O,C);const U=`${d} ${w}`;if(x){Object.assign(M?c:h,{variantName:w,id:y,cssLocation:o,variables:D});continue}this._themeMapping[U]={cssLocation:o,id:y,variables:D}}catch(y){console.error(y);continue}if(c.id&&h.id){const p=this._preferredColorScheme===di.Dark?c:h;this._themeMapping[d]={dark:c,light:h,default:p}}else{const p=c.id?c:h;this._themeMapping[`${d} ${p.variantName}`]={id:p.id,cssLocation:p.cssLocation}}})}_getSourceData(e,t,i){return i.wrap("getSourceData",()=>{var s,n,o;const a=(s=e.source)==null?void 0:s["runtime-asset"];if(!a)throw new Error(`Run-time asset not found in source section for theme at ${t}`);const l=new URL(a,new URL(t,window.location.origin)).href,d=(n=e.source)==null?void 0:n["derived-variables"];if(!d)throw new Error(`Derived variables not found in source section for theme at ${t}`);const c=(o=e.source)==null?void 0:o.icon;if(!c)throw new Error(`Icon mapping not found in source section for theme at ${t}`);return{cssLocation:l,derivedVariables:d,icons:c}})}get themeMapping(){return this._themeMapping}}class Ty{constructor(e){this._themeMapping={},this._preferredColorScheme=e}parse(e,t,i){i.wrap("BuiltThemeParser.parse",()=>{var s,n,o;const a=(s=e.source)==null?void 0:s["built-assets"],l=e.name;if(!l)throw new Error(`Theme name not found in manifest at ${t}`);let d={},c={};for(let[h,p]of Object.entries(a)){try{p=new URL(p,new URL(t,window.location.origin)).href}catch{continue}const g=(n=h.match(/.+-(.+)/))==null?void 0:n[1],y=(o=e.values)==null?void 0:o.variants[g];if(!y)throw new Error(`Variant ${g} is missing in manifest at ${t}`);const{name:w,default:x,dark:M}=y,D=`${l} ${w}`;if(x){const O=M?d:c;O.variantName=w,O.id=h,O.cssLocation=p;continue}this._themeMapping[D]={cssLocation:p,id:h}}if(d.id&&c.id){const h=this._preferredColorScheme===di.Dark?d:c;this._themeMapping[l]={dark:d,light:c,default:h}}else{const h=d.id?d:c;this._themeMapping[`${l} ${h.variantName}`]={id:h.id,cssLocation:h.cssLocation}}})}get themeMapping(){return this._themeMapping}}class Ry{constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async i=>{let s=!0;const n=[],o=[],a=await Promise.all(e.map(h=>this._platform.request(h,{method:"GET",format:"json",cache:!0}).response())),l=new xy(this._platform,this.preferredColorScheme),d=new Ty(this.preferredColorScheme),c=[];for(let h=0;h<a.length;++h){const p=a[h],{status:g,body:y}=p;if(!(g>=200&&g<=299)){console.error(`Failed to load manifest at ${e[h]}, status: ${g}`),i.log({l:"Manifest fetch failed",location:e[h],status:g},ot.Error),n.push(e[h]);continue}s=!1;try{if(y.extends){const w=a.findIndex(O=>"value"in O&&O.value.body.id===y.extends);if(w===-1)throw new Error(`Base manifest for derived theme at ${e[h]} not found!`);const{body:x}=a[w].value,M=e[w],D=l.parse(y,x,M,i);c.push(D)}else d.parse(y,e[h],i)}catch(w){console.error(w),o.push(w.message)}}if(await Promise.all(c),this._themeMapping=Ms(Ms({},d.themeMapping),l.themeMapping),s)throw new Error(`All configured theme manifests failed to load, the following were tried: ${n.join(", ")}`);if(Object.keys(this._themeMapping).length===0&&o.length)throw new Error(`Failed to parse theme manifests, the following errors were encountered: ${o.join(", ")}`);this._addDefaultThemeToMapping(i),i.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===di.Dark?"dark":"light"}),i.log({l:"Result",themeMapping:this._themeMapping})})}async setTheme(e,t,i){await this._platform.logger.wrapOrRun(i,{l:"change theme",name:e,variant:t},async s=>{let n,o,a=this._themeMapping[e];if("id"in a)n=a.cssLocation,o=a.variables;else{if(!t)throw new Error("themeVariant is undefined!");n=a[t].cssLocation,o=a[t].variables}await this._platform.replaceStylesheet(n,s),o?(i?.log({l:"Derived Theme",variables:o}),this._injectCSSVariables(o)):this._removePreviousCSSVariables(),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}_injectCSSVariables(e){const t=document.documentElement;for(const[i,s]of Object.entries(e))t.style.setProperty(`--${i}`,s);this._injectedVariables=e}_removePreviousCSSVariables(){if(!this._injectedVariables)return;const e=document.documentElement;for(const t of Object.keys(this._injectedVariables))e.style.removeProperty(`--${t}`);this._injectedVariables=void 0}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){var e,t;switch(this.preferredColorScheme){case di.Dark:return(e=this._platform.config.defaultTheme)==null?void 0:e.dark;case di.Light:return(t=this._platform.config.defaultTheme)==null?void 0:t.light}}_findThemeDetailsFromId(e){var t,i;for(const[s,n]of Object.entries(this._themeMapping)){if("id"in n&&n.id===e)return{themeName:s,themeData:n};if("light"in n&&((t=n.light)==null?void 0:t.id)===e)return{themeName:s,themeData:n.light};if("dark"in n&&((i=n.dark)==null?void 0:i.id)===e)return{themeName:s,themeData:n.dark}}}_addDefaultThemeToMapping(e){e.wrap("addDefaultThemeToMapping",t=>{const i=this.getDefaultTheme();if(i){const s=this._findThemeDetailsFromId(i);if(s){this._themeMapping.Default={id:"default",cssLocation:s.themeData.cssLocation};const n=s.themeData.variables;n&&(this._themeMapping.Default.variables=n)}}t.log({l:"Default Theme",theme:i})})}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return di.Dark;if(window.matchMedia("(prefers-color-scheme: light)").matches)return di.Light}}var Fd=(r=>(r[r.Minute=6e4]="Minute",r[r.Hours=36e5]="Hours",r[r.Day=864e5]="Day",r))(Fd||{});function Cy(r){let e=0,t=0,i=0;r>=864e5&&(e=Math.floor(r/864e5),r-=e*864e5),r>=36e5&&(t=Math.floor(r/36e5),r-=t*36e5),r>=6e4&&(i=Math.floor(r/6e4),r-=i*6e4);const s=Math.floor(r/1e3);let n="";return e&&(n=`${e}d `),(t||e)&&(n+=`${t}h `),(i||t||e)&&(n+=`${i}m `),n+=`${s}s`,n}class My{constructor(e){this.clock=e,this.todayMidnight=new Date,this.todayMidnight.setHours(0,0,0,0),this.relativeDayFormatter=new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}),this.weekdayFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long"}),this.currentYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",month:"long",day:"numeric"}),this.otherYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.timeFormatter=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"})}formatTime(e){return this.timeFormatter.format(e)}formatMachineReadableDate(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}`}formatRelativeDate(e){let t=Math.floor((e.getTime()-this.todayMidnight.getTime())/Fd.Day);return t>=-1&&t<=1?Ay(this.relativeDayFormatter.format(t,"day")):t>-7&&t<0?this.weekdayFormatter.format(e):this.todayMidnight.getFullYear()===e.getFullYear()?this.currentYearFormatter.format(e):this.otherYearFormatter.format(e)}formatDuration(e){return Cy(e)}}function Ay(r){return r.slice(0,1).toLocaleUpperCase()+r.slice(1)}function Uc(r){return new Promise(function(e,t){var i=document.createElement("script");i.setAttribute("src",r),i.onload=e,i.onerror=t,document.body.appendChild(i)})}async function Ny(r){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),r?(window.WebAssembly?(await Uc(r.wasmBundle),await window.Olm.init({locateFile:()=>r.wasm})):(await Uc(r.legacyBundle),await window.Olm.init()),window.Olm):null}function Dy(r){return r.startsWith("/")?r:new URL(r,document.location.href).pathname}async function Vy(r){const e=new ly(r.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:Dy(r.olm.legacyBundle)}),new C_(e)}function Uy(r){if(!window.visualViewport)return;const e=()=>{const t=r.querySelector(".SessionView");if(!t)return;const i=r.querySelector(".bottom-aligned-scroll");let s,n,o;i&&(s=i.scrollTop,n=i.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;r.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),r.style.setProperty("--ios-viewport-top",a.toString()+"px"),i&&(o=i.offsetHeight,i.scrollTop=s+n-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class Py{constructor({container:e,assetPaths:t,config:i,configURL:s,logger:n,options:o=null,cryptoExtras:a=null}){this._container=e,this._assetPaths=t,this._config=i,this._configURL=s,this.settingsStorage=new g_("hydrogen_setting_v1_"),this.clock=new Hg,this.encoding=new R_,this.random=Math.random,this.logger=n??this._createLogger(o?.development),this.history=new Jg,this.onlineStatus=new Xg,this.timeFormatter=new My,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new Wg,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new ny(a)),this.storageFactory=new p_(this._serviceWorkerHandler),this.sessionInfoStorage=new f_("hydrogen_sessions_v1"),this.estimateStorageUsage=oy,typeof fetch=="function"?this.request=Om(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Gl;const l=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=l;const d=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=d,this._disposables=new Ks,this._olmPromise=void 0,this._workerPromise=void 0,this.mediaDevices=new wy(navigator.mediaDevices),this.webRTC=new Sy,this._themeLoader=new Ry(this)}async init(){try{await this.logger.run("Platform init",async e=>{var t;if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:i,body:s}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(i===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(i>=400)throw new Error(`Got status ${i} while trying to fetch ${this._configURL}`);this._config=s}if(this.notificationService=new Yg(this._serviceWorkerHandler,this._config.push),this._themeLoader){const i=this.config.themeManifests;await((t=this._themeLoader)==null?void 0:t.init(i,e));const{themeName:s,themeVariant:n}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:s,variant:n}),await this._themeLoader.setTheme(s,n,e)}})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=new Hh({platform:this}),i=n=>{var o;return(o=n.e)!=null&&o.stack&&(n.e.stack=n.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),n},s=new Qh({name:"hydrogen_logs",platform:this,serializedTransformer:i});return t.addReporter(s),e&&t.addReporter(new em),t}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=Ny(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=Vy(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const i=Uy(this._container);i&&this._disposables.track(i)}this._container.addEventListener("error",Ic,!0),this._disposables.track(()=>this._container.removeEventListener("error",Ic,!0)),window.__hydrogenViewModel=e;const t=new jg(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return Zi.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):my(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}async copyPlaintext(e){return await eg(e)}restart(){document.location.reload()}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const i=new Promise(s=>{const n=()=>{t.removeEventListener("change",n,!0);const o=t.files[0];this._container.removeChild(t),o?s({name:o.name,blob:Zi.fromBlobUnsafe(o)}):s()};t.addEventListener("change",n,!0)});return this._container.appendChild(t),t.click(),i}openUrl(e){location.href=e}parseHTML(e){return fy(e)}async loadImage(e){return Rr.fromBlob(e)}async loadVideo(e){return ba.fromBlob(e)}hasReadPixelPermission(){return uy()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.4.1"}get themeLoader(){return this._themeLoader}async replaceStylesheet(e,t){const i=await this.logger.wrapOrRun(t,{l:"replaceStylesheet",location:e},async s=>{let n;const o=document.querySelector("head");document.querySelectorAll(".theme").forEach(d=>d.remove());const a=document.createElement("link");a.href=e,a.rel="stylesheet",a.type="text/css",a.className="theme";const l=new Promise(d=>{a.onerror=()=>{n=new Error(`Failed to load stylesheet from ${e}`),s.catch(n),d()},a.onload=()=>{d()}});return o.appendChild(a),await l,n});if(i)throw i}get description(){var e;return"web-"+((e=navigator.userAgent)!=null?e:"<unknown>")}dispose(){this._disposables.dispose()}}function Pc(r){try{return new URL(r).origin}catch{return new URL(`https://${r}`).origin}}async function Oy(r,e){const t={format:"json",timeout:3e4,method:"GET"};try{const i=`${r}/.well-known/matrix/client`;return await e(i,t).response()}catch(i){if(i.name==="ConnectionError")return null;throw i}}async function Fy(r,e){var t;r=Pc(r);const i=await Oy(r,e);if(i&&i.status===200){const{body:s}=i,n=(t=s["m.homeserver"])==null?void 0:t.base_url;typeof n=="string"&&(r=Pc(n))}return r}class Ld extends Mt{constructor(e){super(),this._abortable=void 0;const t=s=>(this._abortable=s,s);this._progress=void 0;const i=s=>{this._progress=s,this.emit("change","progress")};this.result=e(t,i)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}function Bd(r){return Object.entries(r||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function Ly(r){if(r instanceof Zi){const e=r;return{mimeType:e.mimeType,body:e}}else{if(r instanceof Map)return{mimeType:"multipart/form-data",body:r};if(typeof r=="object"){const e=JSON.stringify(r);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+r)}}class By{constructor(e,t,i,s){let n;if(s?.log){const o=s?.log;n=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=n,this._sourceRequest=i,this._promise=i.response().then(o=>{var a,l;if(n?.set("status",o.status),o.status>=200&&o.status<300||((a=s?.allowedStatusCodes)==null?void 0:a.includes(o.status)))return n?.finish(),o.body;if(o.status>=500){const d=new zt("Internal Server Error");throw n?.catch(d),d}else if(o.status>=400&&!((l=o.body)!=null&&l.errcode)){const d=new zt(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw n?.catch(d),d}else{const d=new Kl(e,t,o.body,o.status);throw n?.set("errcode",d.errcode),n?.catch(d),d}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new zt("Service worker aborted, either updating or hit #187.");throw n?.catch(a),a}else throw o.name==="ConnectionError"&&n?.set("timeout",o.isTimeout),n?.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const pn="/_matrix/client/r0",Ky="/_matrix/client/v3",bo="/_matrix/client/unstable/org.matrix.msc2697.v2";class Bi{constructor({homeserver:e,accessToken:t,request:i,reconnector:s}){this._homeserver=e,this._accessToken=t,this._requestFn=i,this._reconnector=s}_url(e,t=pn){return this._homeserver+t+e}_baseRequest(e,t,i,s,n,o){const a=Bd(i);t=`${t}?${a}`;let l;const d=new Map;if(o&&d.set("Authorization",`Bearer ${o}`),d.set("Accept","application/json"),s){const p=Ly(s);d.set("Content-Type",p.mimeType),l=p.body}const c=this._requestFn(t,{method:e,headers:d,body:l,timeout:n?.timeout,uploadProgress:n?.uploadProgress,format:"json",cache:e!=="GET"}),h=new By(e,t,c,n);return this._reconnector&&h.response().catch(p=>{p.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),h}_unauthedRequest(e,t,i,s,n){return this._baseRequest(e,t,i,s,n)}_authedRequest(e,t,i,s,n){return this._baseRequest(e,t,i,s,n,this._accessToken)}_post(e,t,i,s){return this._authedRequest("POST",this._url(e,s?.prefix||pn),t,i,s)}_put(e,t,i,s){return this._authedRequest("PUT",this._url(e,s?.prefix||pn),t,i,s)}_get(e,t,i,s){return this._authedRequest("GET",this._url(e,s?.prefix||pn),t,i,s)}sync(e,t,i,s){return this._get("/sync",{since:e,timeout:i,filter:t},void 0,s)}context(e,t,i,s){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:s,limit:i})}messages(e,t,i){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,i)}members(e,t,i){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,i)}send(e,t,i,s,n){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{},s,n)}redact(e,t,i,s,n){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{},s,n)}receipt(e,t,i,s){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{},{},s)}state(e,t,i,s){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{},void 0,s)}sendState(e,t,i,s,n){return this._put(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{},s,n)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,i,s,n=!1,o={}){o.allowedStatusCodes=[401];const a={auth:s,password:t,initial_device_displayname:i,inhibit_login:n};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",Ky),void 0,a,o)}passwordLogin(e,t,i,s){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:i},s)}tokenLogin(e,t,i,s){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:i},s)}createFilter(e,t,i){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,i)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,i){let s="/keys/upload";return e&&(s=s+`/${encodeURIComponent(e)}`),this._post(s,{},t,i)}uploadSignatures(e,t){return this._post("/keys/signatures/upload",{},e,t)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,i,s){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(i)}`,{},t,s)}roomKeysVersion(e,t){let i="";return e&&(i=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${i}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,i,s){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(i)}`,{version:e},void 0,s)}uploadRoomKeysToBackup(e,t,i){return this._put("/room_keys/keys",{version:e},t,i)}uploadAttachment(e,t,i){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,i)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}invite(e,t,i,s){return this._post(`/rooms/${encodeURIComponent(e)}/invite`,{},{user_id:t,reason:i},s)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=bo,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=bo,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=bo,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,i,s){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},i,s)}getTurnServer(e){return this._get("/voip/turnServer",void 0,void 0,e)}}class Kd{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof yt))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var Sa=(r=>(r[r.Waiting=0]="Waiting",r[r.Reconnecting=1]="Reconnecting",r[r.Online=2]="Online",r))(Sa||{});class $y{constructor({retryDelay:e,createMeasure:t,onlineStatus:i}){this._onlineStatus=i,this._retryDelay=e,this._createTimeMeasure=t,this._state=new fi(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(i=>{i&&this.tryNow()});try{await this._reconnectLoop(e)}catch(i){console.error(i)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function jy(r,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:i}=r,{base64:s}=r.encoding;var n=s.decode(t.iv),o=s.encode(s.decode(t.hashes.sha256));const a=await i.digest("SHA-256",e);if(s.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var l;return t.v=="v1"||t.v=="v2"?l=64:l=128,await i.aes.decryptCTR({jwkKey:t.key,iv:n,data:e,counterLength:l})}async function qy(r,e){const{crypto:t}=r,{base64:i}=r.encoding,s=await t.aes.generateIV(),n=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:n,iv:s,data:o}),l=await t.digest("SHA-256",a);return{blob:r.createBlob(a,"application/octet-stream"),info:{v:"v2",key:n,iv:i.encodeUnpadded(s),hashes:{sha256:i.encodeUnpadded(l)}}}}class zy{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,i,s){const n=this._parseMxcUrl(e);if(n){const[o,a]=n;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Bd({width:Math.round(t),height:Math.round(i),method:s})}}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[i,s]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(i)}/${encodeURIComponent(s)}`}}_parseMxcUrl(e){const t="mxc://";if(e.startsWith(t))return e.substr(t.length).split("/",2)}async downloadEncryptedFile(e,t=!1){const i=this.mxcUrl(e.url),{body:s}=await this._platform.request(i,{method:"GET",format:"buffer",cache:t}).response(),n=await jy(this._platform,s,e);return this._platform.createBlob(n,e.mimetype)}async downloadPlaintextFile(e,t,i=!1){const s=this.mxcUrl(e),{body:n}=await this._platform.request(s,{method:"GET",format:"buffer",cache:i}).response();return this._platform.createBlob(n,t)}async downloadAttachment(e,t=!1){var i;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(i=e.info)==null?void 0:i.mimetype,t)}}class Gy{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((i,s)=>{this.responseResolve=i,this.responseReject=s})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new yt),(e=this.responseCodeReject)==null||e.call(this,new yt))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var t,i,s;this._requestResult=e;const n=await((t=this._requestResult)==null?void 0:t.response());this.responseResolve(n);const o=await((i=this._requestResult)==null?void 0:i.responseCode());(s=this.responseCodeResolve)==null||s.call(this,o)}get requestResult(){return this._requestResult}}class $d{constructor(e){this._scheduler=e}}for(const r of Object.getOwnPropertyNames(Bi.prototype))r!=="constructor"&&!r.startsWith("_")&&($d.prototype[r]=function(...e){return this._scheduler._hsApiRequest(r,e)});class Hy{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new $d(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const i=new Gy(e,t);return this._doSend(i),i}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const i=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(i);return}catch(i){if(i instanceof Kl&&i.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(i.retry_after_ms)?await this._clock.createTimeout(i.retry_after_ms).elapsed():(t||(t=new Kd(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(i);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const Wy=3e4,ve=js("InitialSync","CatchupSync","Syncing","Stopped");function Yy(r){var e;try{const t=(e=r?.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class Jy{constructor({hsApi:e,session:t,storage:i,logger:s}){this._hsApi=e,this._logger=s,this._session=t,this._storage=i,this._currentRequest=null,this._status=new fi(ve.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==ve.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(ve.CatchupSync):this._status.set(ve.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==ve.Stopped;){let t,i,s=this._status.get()===ve.CatchupSync||this._status.get()===ve.InitialSync;await this._logger.run("sync",async n=>{n.set("token",e),n.set("status",this._status.get());try{const o=this._status.get()===ve.Syncing?Wy:0,a=await this._syncRequest(e,o,n);e=a.syncToken,t=a.roomStates,i=a.sessionChanges,this._status.get()!==ve.Syncing&&a.hadToDeviceMessages?this._status.set(ve.CatchupSync):this._status.set(ve.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(n.error=o,n.logLevel=n.level.Fatal),n.set("stopping",!0),this._status.set(ve.Stopped)}this._status.get()!==ve.Stopped&&await n.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(i,t,o))},this._logger.level.Info,(n,o)=>o.durationWithoutType("network")>=2e3||o.error||s?n.minLevel(o.level.Detail):n.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,i){const s=this._status.get()===ve.CatchupSync,n=(async()=>{try{await i.wrap("session",a=>this._session.afterSyncCompleted(e,s,a))}catch{}})(),o=t.map(async a=>{try{await a.room.afterSyncCompleted(a.changes,i)}catch{}});await Promise.all(o.concat(n))}async _syncRequest(e,t,i){var s;let{syncFilterId:n}=this._session;typeof n!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:i}),n=(await this._currentRequest.response()).filter_id);const o=t+80*1e3;this._currentRequest=this._hsApi.sync(e,n,t,{timeout:o,log:i});const a=await this._currentRequest.response(),l=!e,d=new Xy,c=this._parseInvites(a.rooms),{roomStates:h,archivedRoomStates:p}=await this._parseRoomsResponse(a.rooms,c,l,i);try{d.lock=await i.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(a)),await i.wrap("prepare",y=>this._prepareSync(d,h,a,y)),await i.wrap("afterPrepareSync",y=>Promise.all(h.map(w=>w.room.afterPrepareSync(w.preparation,y)))),await i.wrap("write",async y=>this._writeSync(d,c,h,p,a,n,l,y))}finally{d.dispose()}i.wrap("after",y=>this._afterSync(d,c,h,p,y));const g=(s=a.to_device)==null?void 0:s.events;return{syncToken:a.next_batch,roomStates:h,sessionChanges:d.changes,hadToDeviceMessages:Array.isArray(g)&&g.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.deviceKeys,e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,i,s){var n,o;const a=await this._openPrepareSyncTxn();e.preparation=await s.wrap("session",d=>this._session.prepareSync(i,e.lock,a,d));const l=(n=e.preparation)==null?void 0:n.newKeysByRoom;if(l){const{hasOwnProperty:d}=Object.prototype;for(const c of l.keys())if(!(((o=i.rooms)==null?void 0:o.join)&&d.call(i.rooms.join,c))){let p=this._session.rooms.get(c);p&&t.push(new Oc(p,!1,{},p.membership))}}await Promise.all(t.map(async d=>{const c=l?.get(d.room.id);d.preparation=await s.wrap("room",async h=>(d.isNewRoom&&await d.room.load(null,a,h),d.room.prepareSync(d.roomResponse,d.membership,c,a,h)),s.level.Detail)})),await a.complete()}async _writeSync(e,t,i,s,n,o,a,l){const d=await this._openSyncTxn();try{e.changes=await l.wrap("session",c=>this._session.writeSync(n,o,e.preparation,d,c)),await Promise.all(t.map(async c=>{c.changes=await l.wrap("invite",h=>c.invite.writeSync(c.membership,c.roomResponse,d,h))})),await Promise.all(i.map(async c=>{c.changes=await l.wrap("room",h=>c.room.writeSync(c.roomResponse,a,c.preparation,d,h))})),await Promise.all(s.map(async c=>{var h;const p=(h=c.roomState)==null?void 0:h.summaryChanges;c.changes=await l.wrap("archivedRoom",g=>c.archivedRoom.writeSync(p,c.roomResponse,c.membership,d,g))}))}catch(c){throw d.abort(l),d.getCause(c)}await d.complete(l)}_afterSync(e,t,i,s,n){n.wrap("session",o=>this._session.afterSync(e.changes,o),n.level.Detail);for(let o of s)n.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},n.level.Detail);for(let o of i)n.wrap("room",a=>o.room.afterSync(o.changes,a),n.level.Detail);for(let o of t)n.wrap("invite",a=>o.invite.afterSync(o.changes,a),n.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,i,s,n)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceKeys,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions,e.calls])}async _parseRoomsResponse(e,t,i,s){const n=[],o=[];if(e){const a=["join","leave"];for(const l of a){const d=e[l];if(d)for(const[c,h]of Object.entries(d)){if(i&&Yy(h))continue;const p=this._session.invites.get(c);p&&t.push(new Fc(p,!1,null,l));const g=this._createRoomSyncState(c,h,l,i);g&&n.push(g);const y=await this._createArchivedRoomSyncState(c,g,h,l,i,s);y&&o.push(y)}}}return{roomStates:n,archivedRoomStates:o}}_createRoomSyncState(e,t,i,s){let n=!1,o=this._session.rooms.get(e);if(!o&&(i==="join"||s&&i==="leave")&&(o=this._session.createJoinedRoom(e),n=!0),o)return new Oc(o,n,t,i)}async _createArchivedRoomSyncState(e,t,i,s,n,o){let a;if(t?.shouldAdd&&!n?a=this._session.createOrGetArchivedRoomForSync(e):s==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new Qy(a,t,i,s)}_parseInvites(e){const t=[];if(e?.invite)for(const[i,s]of Object.entries(e.invite)){let n=this._session.invites.get(i),o=!1;n||(n=this._session.createInvite(i),o=!0),t.push(new Fc(n,o,s,"invite"))}return t}stop(){this._status.get()!==ve.Stopped&&(this._status.set(ve.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class Xy{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class Oc{constructor(e,t,i,s){this.room=e,this.isNewRoom=t,this.roomResponse=i,this.membership=s,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class Qy{constructor(e,t,i,s,n){this.archivedRoom=e,this.roomState=t,this.roomResponse=i,this.membership=s,this.isInitialSync=n,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class Fc{constructor(e,t,i,s){this.invite=e,this.isNewInvite=t,this.membership=s,this.roomResponse=i,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}function Zy(r,e,t,i,s){return e.length&&(r=e.reduce((n,o)=>sv(n,o,t,i,s),r)),r}function ev(r,e,t,i){e.summary&&(r=rv(r,e.summary)),t!==r.membership&&(r=r.cloneIfNeeded(),r.membership=t),e.account_data&&(r=e.account_data.events.reduce(iv,r)),Es(e,n=>{r=jd(r,n,i)});const s=e.unread_notifications;return s&&(r=tv(r,s)),r}function tv(r,e){const t=e.highlight_count||0;t!==r.highlightCount&&(r=r.cloneIfNeeded(),r.highlightCount=t);const i=e.notification_count;return i!==r.notificationCount&&(r=r.cloneIfNeeded(),r.notificationCount=i),r}function iv(r,e){var t;if(e?.type==="m.tag"){let i=(t=e?.content)==null?void 0:t.tags;(!i||Array.isArray(i)||typeof i!="object")&&(i=null),r=r.cloneIfNeeded(),r.tags=i}return r}function jd(r,e,t){var i,s,n;if(e.type==="m.room.create")r=r.cloneIfNeeded(),r.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(i=e.content)==null?void 0:i.algorithm;!r.encryption&&o===Rt&&(r=r.cloneIfNeeded(),r.encryption=e.content)}else if(e.type==="m.room.name"){const o=(s=e.content)==null?void 0:s.name;o!==r.name&&(r=r.cloneIfNeeded(),r.name=o)}else if(e.type==="m.room.avatar"){const o=(n=e.content)==null?void 0:n.url;o!==r.avatarUrl&&(r=r.cloneIfNeeded(),r.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;r=r.cloneIfNeeded(),r.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!r.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(r=r.cloneIfNeeded(),r.isDirectMessage=!0,r.dmUserId=a)}else o.membership==="leave"&&r.isDirectMessage&&r.dmUserId===e.state_key&&(r=r.cloneIfNeeded(),r.isDirectMessage=!1,r.dmUserId=null)}return r}function sv(r,e,t,i,s){return e.eventType==="m.room.message"&&((!r.lastMessageTimestamp||e.timestamp>r.lastMessageTimestamp)&&(r=r.cloneIfNeeded(),r.lastMessageTimestamp=e.timestamp),!t&&e.sender!==s&&i&&(r=r.cloneIfNeeded(),r.isUnread=!0)),r}function rv(r,e){const t=e["m.heroes"],i=e["m.joined_member_count"],s=e["m.invited_member_count"];return t&&Array.isArray(t)&&(r=r.cloneIfNeeded(),r.heroes=t),Number.isInteger(s)&&(r=r.cloneIfNeeded(),r.inviteCount=s),Number.isInteger(i)&&(r=r.cloneIfNeeded(),r.joinCount=i),r}class Bt{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(i=>i!=="cloned"&&this[i]!==e[i])}cloneIfNeeded(){return this.cloned?this:new Bt(this)}serialize(){return Object.entries(this).reduce((e,[t,i])=>(t!=="cloned"&&i!==null&&(e[t]=i),e),{})}applyTimelineEntries(e,t,i,s){return Zy(this,e,t,i,s)}applySyncResponse(e,t,i){return ev(this,e,t,i)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class nv{constructor(e){this._data=null,this.applyChanges(new Bt(null,e))}get data(){return this._data}writeClearUnread(e){const t=new Bt(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const i=new Bt(this._data);return i.hasFetchedMembers=e,t.roomSummary.set(i.serialize()),i}writeIsTrackingMembers(e,t){const i=new Bt(this._data);return i.isTrackingMembers=e,t.roomSummary.set(i.serialize()),i}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const i=await t.readWriteTxn([t.storeNames.roomSummary]);try{i.roomSummary.set(e.serialize())}catch(s){throw i.abort(),s}return await i.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new Bt(e))}}function Ea(r){return typeof r=="number"}const ov=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(r,e){return r[e]=1,r},{}),av={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function cv(r,e){for(const s of Object.keys(e))ov[s]||delete e[s];const{content:t}=e,i=av[e.type];for(const s of Object.keys(t))i?.[s]||delete t[s];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=r}function lv(r,e){const t=[];for(;Ea(r.previousId);){const i=e.get(r.previousId);if(!i)break;if(i.nextId!==r.id)throw new Error(`Previous fragment ${i.id} doesn't point back to ${r.id}`);e.delete(r.previousId),t.unshift(i),r=i}return t}function dv(r,e){const t=[];for(;Ea(r.nextId);){const i=e.get(r.nextId);if(!i)break;if(i.previousId!==r.id)throw new Error(`Next fragment ${i.id} doesn't point back to ${r.id}`);e.delete(r.nextId),t.push(i),r=i}return t}function uv(r){const e=new Map;for(let i of r)e.set(i.id,i);const t=[];for(;e.size;){const i=e.values().next().value;e.delete(i.id);const s=lv(i,e),n=dv(i,e),o=s.concat(i,n);t.push(o)}return t.map(i=>new hv(i))}class So{constructor(e,t,i){this.id=e,this.previousId=t,this.nextId=i}}class hv{constructor(e){this._idToSortIndex=new Map,e.forEach((t,i)=>{this._idToSortIndex.set(t.id,i)})}compare(e,t){const i=this._idToSortIndex.get(e);if(i===void 0)throw new Error(`first id ${e} isn't part of this island`);const s=this._idToSortIndex.get(t);if(s===void 0)throw new Error(`second id ${t} isn't part of this island`);return i-s}get fragmentIds(){return this._idToSortIndex.keys()}}class Lc extends Error{get name(){return"CompareError"}}class mv{constructor(e){this._fragmentsById=e.reduce((t,i)=>(t.set(i.id,i),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new Lc(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const i=this._getIsland(e),s=this._getIsland(t);if(i!==s)throw new Lc(`${e} and ${t} are on different islands, can't tell order`);return i.compare(e,t)}rebuild(e){const t=uv(e);this._idToIsland=new Map;for(let i of t)for(let s of i.fragmentIds)this._idToIsland.set(s,i)}add(e){const t=new So(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const i=new So(e,t,null),s=this._fragmentsById.get(t);s&&(s.nextId=e),this._fragmentsById.set(e,i),this.rebuild(this._fragmentsById.values())}prepend(e,t){const i=new So(e,null,t),s=this._fragmentsById.get(t);s&&(s.previousId=e),this._fragmentsById.set(e,i),this.rebuild(this._fragmentsById.values())}}class qd{constructor({roomId:e,ownUserId:t,fragmentIdComparer:i}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=i}async writeRelation(e,t,i){const{relatedEventId:s}=e;if(s){const n=oi(e.event);n&&n.rel_type&&t.timelineRelations.add(this._roomId,n.event_id,n.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,s);if(o){const a=await this._applyRelation(e,o,t,i);if(a)return a.map(l=>(t.timelineEvents.update(l),new at(l,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,i,s){const n=new at(e,this._fragmentIdComparer),o=await this.writeRelation(n,i,s);if(t.isBackward&&!Fo(e.event)){const a=await i.timelineRelations.getAllForTarget(this._roomId,n.id);if(a.length)for(const l of a){const d=await i.timelineEvents.getByEventId(this._roomId,l.sourceEventId);if(d){const c=new at(d,this._fragmentIdComparer);await this._applyRelation(c,e,i,s)}}}return o}async _applyRelation(e,t,i,s){if(e.eventType===Tt)return s.wrap("redact",async n=>{const o=t.event,a=oi(o);if(this._applyRedaction(e.event,t,i,n)){const d=[t];if(a){const c=await this._reaggregateRelation(o,a,i,n);c&&d.push(c)}return d}return null});{const n=oi(e.event);if(n&&!Fo(t.event)&&n.rel_type===gi&&s.wrap("react",l=>this._aggregateAnnotation(e.event,t,l)))return[t]}return null}_applyRedaction(e,t,i,s){const n=t.event;s.set("redactionId",e.event_id),s.set("id",n.event_id);const o=oi(n);return o&&o.rel_type&&i.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,n.event_id),i.timelineRelations.removeAllForTarget(this._roomId,n.event_id),cv(e,n),delete t.annotations,!0}_aggregateAnnotation(e,t){const i=oi(e);if(!i)return!1;let{annotations:s}=t;s||(t.annotations=s={});let n=s[i.key];n||(s[i.key]=n={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return n.me=n.me||o,n.count+=1,n.firstTimestamp=Math.min(n.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,i,s){return t.rel_type===gi?s.wrap("reaggregate annotations",n=>this._reaggregateAnnotation(t.event_id,t.key,i,n)):null}async _reaggregateAnnotation(e,t,i,s){const n=await i.timelineEvents.getByEventId(this._roomId,e);if(!n||!n.annotations)return null;s.set("id",e);const o=await i.timelineRelations.getForTargetAndType(this._roomId,e,gi);return s.set("relations",o.length),delete n.annotations[t],pv(n.annotations)&&delete n.annotations,await Promise.all(o.map(async a=>{const l=await i.timelineEvents.getByEventId(this._roomId,a.sourceEventId);l||s.log({l:"missing annotation",id:a.sourceEventId}),oi(l.event).key===t&&this._aggregateAnnotation(l.event,n,s)})),n}}function pv(r){for(const e in r)if(r.hasOwnProperty(e))return!1;return!0}class Xt{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Xt.Backward:Xt.Forward}static get Forward(){return _v}static get Backward(){return fv}}const _v=new Xt(!0),fv=new Xt(!1);class _t extends Vd{constructor(e,t,i){super(i),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new _t(e,!0,t)}static end(e,t){return new _t(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?_e.minStorageKey:_e.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return Ea(this.linkedFragmentId)}get direction(){return this.started?Xt.Backward:Xt.Forward}withUpdatedFragment(e){return new _t(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new _t(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function gv(r){const e=new Set;return r.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class yv{constructor({roomId:e,fragmentIdComparer:t,memberWriter:i,relationWriter:s}){this._roomId=e,this._memberWriter=i,this._relationWriter=s,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const i=await e.timelineFragments.liveFragment(this._roomId);if(i){const[s]=await e.timelineEvents.lastEvents(this._roomId,i.id,1),n=s?s.eventIndex:Ee.defaultLiveKey.eventIndex;this._lastLiveKey=new Ee(i.id,n)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const i=await e.timelineFragments.liveFragment(this._roomId);if(i)return i;{t||(t=null);const s={roomId:this._roomId,id:Ee.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(s),this._fragmentIdComparer.add(s),s}}async _replaceLiveFragment(e,t,i,s){const n=await s.timelineFragments.get(this._roomId,e);if(!n)throw new Error(`old live fragment doesn't exist: ${e}`);n.nextId=t,s.timelineFragments.update(n);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:i,nextToken:null};return s.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:n,newFragment:o}}async _ensureLiveFragment(e,t,i,s,n){if(e){if(i.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:l}=await this._replaceLiveFragment(o,e.fragmentId,i.prev_batch,s);t.push(_t.end(a,this._fragmentIdComparer)),t.push(_t.start(l,this._fragmentIdComparer)),n.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(s,i.prev_batch);e=new Ee(o.id,Ee.defaultLiveKey.eventIndex),t.push(_t.start(o,this._fragmentIdComparer)),n.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,i){let s=0;for(const n of e)n.type!==st&&(t.roomState.set(this._roomId,n),s+=1);i.set("stateEvents",s)}async _writeTimeline(e,t,i,s,n,o){const a=[],l=[];if(e?.length){s=await this._ensureLiveFragment(s,a,t,n,o),o.set("timelineEvents",e.length);let d=0;for(const c of e){s=s.nextKey();const h=Xl(s,this._roomId,c);let p=await i.lookupMemberAtEvent(c.sender,c,n);if(p&&(h.displayName=p.displayName,h.avatarUrl=p.avatarUrl),!await n.timelineEvents.tryInsert(h,o))continue;const y=new at(h,this._fragmentIdComparer);a.push(y);const w=await this._relationWriter.writeRelation(y,n,o);w&&l.push(...w),typeof c.state_key=="string"&&c.type!==st&&(d+=1,n.roomState.set(this._roomId,c))}o.set("timelineStateEventCount",d)}return{currentKey:s,entries:a,updatedEntries:l}}async _handleRejoinOverlap(e,t,i){if(this._lastLiveKey){const{fragmentId:s}=this._lastLiveKey,[n]=await t.timelineEvents.lastEvents(this._roomId,s,1);if(n){const o=n.event.event_id,{events:a}=e,l=a.findIndex(d=>d.event_id===o);if(l!==-1)return i.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(l+1)})}}return e.limited?e:(i.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,i,s,n){let{timeline:o}=e;n.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,s,n));let a;Array.isArray(o?.events)&&(a=gv(o.events));const{state:l}=e;let d;Array.isArray(l?.events)&&(d=l.events);const c=this._memberWriter.prepareMemberSync(d,a,i);d&&await this._writeStateEvents(d,s,n);const{currentKey:h,entries:p,updatedEntries:g}=await this._writeTimeline(a,o,c,this._lastLiveKey,s,n),y=await c.write(s);return{entries:p,updatedEntries:g,newLiveKey:h,memberChanges:y,memberSync:c}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class zd{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let i=t?this._entries.findIndex(t):-1;this._entries.unshift(e),i===-1?this._entries.length>this.limit&&(i=this._entries.length-1):i+=1,i!==-1&&(this.onEvictEntry(this._entries[i]),this._entries.splice(i,1))}onEvictEntry(e){}}class Gd extends zd{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,i=>this._keyFn(i)===t)}}class vv{constructor(e){this._roomId=e,this._cache=new Gd(5,t=>t.userId)}prepareMemberSync(e,t,i){return new wv(this,e,t,i)}async _writeMember(e,t){let i=this._cache.get(e.userId);if(!i){const s=await t.roomMembers.get(this._roomId,e.userId);s&&(i=new Q(s))}if(!i||!i.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new Zl(e,i?.membership)}async lookupMember(e,t){let i=this._cache.get(e);if(!i){const s=await t.roomMembers.get(this._roomId,e);s&&(i=new Q(s),this._cache.set(i))}return i}}class wv{constructor(e,t,i,s){this._memberWriter=e,this._timelineEvents=i,this._hasFetchedMembers=s,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const i of e)if(i.type===st){const s=Q.fromMemberEvent(this._roomId,i);s&&(t||(t=new Map),t.set(s.userId,s))}return t}_timelineEventsToMembers(e){let t;for(let i=e.length-1;i>=0;i--){const s=e[i],n=s.state_key;if(s.type===st&&!t?.has(n)){const o=Q.fromMemberEvent(this._roomId,s);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,i){var s;let n;return this._timelineEvents&&(n=this._findPrecedingMemberEventInTimeline(e,t),n)||(n=(s=this._newStateMembers)==null?void 0:s.get(e),n)?n:await this._memberWriter.lookupMember(e,i)}async write(e){const t=new Map;let i;if(this._timelineEvents&&(i=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const s of this._newStateMembers.values())if(!i?.has(s.userId)){const n=await this._memberWriter._writeMember(s,e);n&&(!this._hasFetchedMembers&&!n.previousMembership&&(n.previousMembership=s.membership),t.set(n.userId,n))}}if(i)for(const s of i.values()){const n=await this._memberWriter._writeMember(s,e);n&&t.set(n.userId,n)}return t}_findPrecedingMemberEventInTimeline(e,t){let i=-1;for(let s=this._timelineEvents.length-1;s>=0;s--)if(this._timelineEvents[s].event_id===t.event_id){i=s;break}for(let s=i-1;s>=0;s--){const n=this._timelineEvents[s];if(n.type===st&&n.state_key===e){const o=Q.fromMemberEvent(this._roomId,n);if(o)return o}}}}class bv{constructor({roomId:e,storage:t,fragmentIdComparer:i,relationWriter:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=i,this._relationWriter=s}async _findOverlappingEvents(e,t,i,s){const n=t.map(d=>d.event_id),o=await i.timelineEvents.getEventKeysForIds(this._roomId,n);s.set("existingEvents",o.size);const a=t.filter(d=>!o.has(d.event_id));s.set("nonOverlappingEvents",a.length);let l;if(e.hasLinkedFragment){s.set("linkedFragmentId",e.linkedFragmentId);for(const d of o.values())if(d.fragmentId===e.linkedFragmentId){s.set("foundLinkedFragment",!0);const c=await i.timelineFragments.get(this._roomId,e.linkedFragmentId);l=e.createNeighbourEntry(c);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:l}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:i,direction:s}=e,n=await this._findFragmentEdgeEvent(i,s,t);return n?new Ee(n.fragmentId,n.eventIndex):Ee.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,i){if(t.isBackward){const[s]=await i.timelineEvents.firstEvents(this._roomId,e,1);return s}else{const[s]=await i.timelineEvents.lastEvents(this._roomId,e,1);return s}}async _storeEvents(e,t,i,s,n,o){const a=[],l=[];let d=t;for(let c=0;c<e.length;++c){const h=e[c];d=d.nextKeyForDirection(i);const p=Xl(d,this._roomId,h),g=this._findMember(h.sender,s,e,c,i);g&&(p.displayName=g.displayName,p.avatarUrl=g.avatarUrl);const y=await this._relationWriter.writeGapRelation(p,i,n,o);if(y&&l.push(...y),await n.timelineEvents.tryInsert(p,o)){const w=new at(p,this._fragmentIdComparer);fr(a,w,i)}}return{entries:a,updatedEntries:l}}_findMember(e,t,i,s,n){function o(d){return d.type===st&&d.state_key===e}const a=n.isBackward?1:-1;for(let d=s+a;d>=0&&d<i.length;d+=a){const c=i[d];if(o(c))return Q.fromMemberEvent(this._roomId,c)}for(let d=s;d>=0&&d<i.length;d-=a){const c=i[d];if(o(c))return Q.fromReplacingMemberEvent(this._roomId,c)}const l=t?.find(o);if(l)return Q.fromMemberEvent(this._roomId,l)}async _updateFragments(e,t,i,s,n,o){const{direction:a}=e,l=[];return fr(s,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,n.timelineFragments.update(t.fragment),fr(s,t,a),l.push(e.fragment),l.push(t.fragment)):e.token=i,n.timelineFragments.update(e.fragment),l}async writeFragmentFill(e,t,i,s,n){const{fragmentId:o,direction:a}=e,{chunk:l,state:d}=t;let{end:c}=t;if(!Array.isArray(l))throw new Error("Invalid chunk in response");if(typeof c!="string"&&typeof c<"u")throw new Error("Invalid end token in response");const h=await s.timelineFragments.get(this._roomId,o);if(!h)throw new Error(`Unknown fragment: ${o}`);if(e=e.withUpdatedFragment(h),e.token!==i)throw new Error("The pagination token has changed locally while fetching messages.");if(l.length===0)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let p=await this._findFragmentEdgeEventKey(e,s);n.set("lastKey",p.toString());const{nonOverlappingEvents:g,neighbourFragmentEntry:y}=await this._findOverlappingEvents(e,l,s,n),{entries:w,updatedEntries:x}=await this._storeEvents(g,p,a,d,s,n),M=await this._updateFragments(e,y,c,w,s,n);return{entries:w,updatedEntries:x,fragments:M}}}class Bc{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function Sv(r,e,t,i,s,n){let o=[];const a=n.timelineEvents,l=n.timelineFragments;for(;o.length<i&&e;){let d;t.isForward?d=await a.eventsAfter(r,e,i):d=await a.eventsBefore(r,e,i);let c=d.map(h=>new at(h,s));if(o=Wm(o,c,t),o.length<i){const h=await l.get(r,e.fragmentId);let p=new _t(h,t.isBackward,s);if(fr(o,p,t),!p.token&&p.hasLinkedFragment){const g=await l.get(r,p.linkedFragmentId);s.add(g);const y=new _t(g,t.isForward,s);fr(o,y,t),e=y.asEventKey()}else e=null}}return o}class Hd{constructor({roomId:e,storage:t,fragmentIdComparer:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=i,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,i,s){return new Bc(async(n,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,i,n,a,o)},s)}readFromEnd(e,t=null,i){return new Bc(async(s,n)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let l;if(!a)l=[];else{this._fragmentIdComparer.add(a);const d=_t.end(a,this._fragmentIdComparer),c=d.asEventKey();l=await this._readFrom(c,Xt.Backward,e,s,o,n),l.unshift(d)}return l},i)}async readById(e,t){let i=[this._storage.storeNames.timelineEvents];this._decryptEntries&&i.push(this._storage.storeNames.inboundGroupSessions);const s=await this._storage.readTxn(i),n=await s.timelineEvents.getByEventId(this._roomId,e);if(n){const o=new at(n,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],s,t).complete(),o}}async _readFrom(e,t,i,s,n,o){const a=await Sv(this._roomId,e,t,i,this._fragmentIdComparer,n);if(this._decryptEntries){s.decryptRequest=this._decryptEntries(a,n,o);try{await s.decryptRequest.complete()}finally{s.decryptRequest=null}}return a}}class Ev extends at{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class Wd{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class kv{constructor(e){this._userId=e}get id(){return this._userId}}class $n extends Wd{constructor({roomId:e,storage:t,closeCallback:i,fragmentIdComparer:s,pendingEvents:n,clock:o,powerLevelsObservable:a,hsApi:l}){super(()=>{this.dispose()}),this._roomId=e,this._storage=t,this._closeCallback=i,this._fragmentIdComparer=s,this._disposables=new Ks,this._pendingEvents=n,this._clock=o,this._remoteEntries=new jl((d,c)=>d.compare(c)),this._ownMember=null,this._timelineReader=new Hd({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=l,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,i){const s=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),n=await s.roomMembers.get(this._roomId,e.id);n?this._ownMember=new Q(n):this._ownMember=Q.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,s,i));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new ym(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,i)=>{t.notifyUpdate(i)},t=>this._applyAndEmitLocalRelationChange(t,i=>i.removeLocalRelation(t))):this._localEntries=new dm,this._allEntries=new Em(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===Tt&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const i=new vg({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([i]),this._applyAndEmitLocalRelationChange(i,s=>s.addLocalRelation(i)),i}_applyAndEmitLocalRelationChange(e,t){var i,s;const n=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,n),e.redactingEntry){const o=(i=e.redactingEntry.pendingEvent)==null?void 0:i.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,n),(s=e.redactingEntry.contextForEntries)==null||s.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,i){let s=!1;e&&(s=this._localEntries.findAndUpdate(n=>n.id===e,i)),!s&&t&&this._remoteEntries.findAndUpdate(n=>n.id===t,i)}async getOwnAnnotationEntry(e,t){const i=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),s=await i.timelineRelations.getForTargetAndType(this._roomId,e,gi);for(const n of s){const o=await i.timelineEvents.getByEventId(this._roomId,n.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&oi(o.event).key===t){const a=new at(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)!=null&&t.hasSubscriptions))for(const i of this._localEntries){if(i.relatedEventId){const s=e.find(n=>n.id===i.relatedEventId);s?.addLocalRelation(i)}if(i.redactingEntry){const s=i.redactingEntry.relatedEventId,n=e.find(o=>o.id===s);n?.addLocalRelation(i)}}}static _entryUpdater(e,t){var i;return(i=e.contextForEntries)==null||i.forEach(s=>s.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const i of e)try{this._remoteEntries.getAndUpdate(i,$n._entryUpdater);const s=this._contextEntriesNotInTimeline.get(i.id);s&&($n._entryUpdater(s,i),this._contextEntriesNotInTimeline.set(i.id,i)),(t=i.contextForEntries)==null||t.forEach(n=>this._emitUpdateForEntry(n,"contextEntry"))}catch(s){if(s.name==="CompareError")continue;throw s}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const i of e){const s=this._contextEntriesNotInTimeline.get(i.relatedEventId);s?.isNonPersisted&&s?.addLocalRelation(i)&&((t=s.contextForEntries)==null||t.forEach(n=>this._emitUpdateForEntry(n,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const i=this._contextEntriesNotInTimeline.get(t.id);i&&(i.contextForEntries.forEach(s=>{s.setContextEntry(t),this._emitUpdateForEntry(s,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const i=e.isPending?e.id:null,s=e.isPending?null:e.id;this._findAndUpdateEntryById(i,s,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const i=t.contextEventId;let s=e.find(n=>n.id===i);s||(s=this._findLoadedEventById(i)),s?(t.setContextEntry(s),this._emitUpdateForEntry(s,"context-added")):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let i=await this._getEventFromStorage(t);i||(i=await this._getEventFromHomeserver(t)),i&&(this._contextEntriesNotInTimeline.set(t,i),e.setContextEntry(i),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),i=t.event.sender,s=t.state.find(a=>a.type===st&&a.user_id===i),n={event:t.event,displayName:s.content.displayname,avatarUrl:s.content.avatar_url},o=new Ev(n,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(s=>!!s.eventType);if(!t)return!0;const i=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Xt.Backward,e));try{const s=await i.complete();return this.addEntries(s),s.length<e}finally{this._disposables.disposeTracked(i)}}async _getOrLoadEntry(e,t){var i;if(e){for(const s of this._localEntries)if(s.id===e)return s}return t?(i=this.getByEventId(t))!=null?i:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const i=this._remoteEntries.get(t);if(i.id===e)return i}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function Iv({roomId:r,storage:e,txn:t}){return t||(t=await e.readTxn([e.storeNames.roomMembers])),(await t.roomMembers.getAll(r)).map(s=>new Q(s))}async function xv({summary:r,syncToken:e,roomId:t,hsApi:i,storage:s,setChangedMembersMap:n},o){const a=new Map;n(a);const l=await i.members(t,{at:e},{log:o}).response(),d=await s.readWriteTxn([s.storeNames.roomSummary,s.storeNames.roomMembers]);let c,h;try{c=r.writeHasFetchedMembers(!0,d);const{roomMembers:p}=d,g=l.chunk;if(!Array.isArray(g))throw new Error("malformed");o.set("members",g.length),h=await Promise.all(g.map(async y=>{const w=y?.state_key;if(!w)throw new Error("malformed");const x=a.get(w);if(x)return x;{const M=Q.fromMemberEvent(t,y);return M&&p.set(M.serialize()),M}}))}catch(p){throw d.abort(),p}finally{n(null)}return await d.complete(),r.applyChanges(c),h}async function Tv(r,e){const{summary:t}=r;return t.data.hasFetchedMembers?Iv(r):e.wrapOrRun(r.log,"fetchMembers",i=>xv(r,i))}async function Rv(r,e){const t=await Cv(r),{summary:i}=r;return!i.data.hasFetchedMembers&&!t?e.wrapOrRun(r.log,"fetchMember",s=>Mv(r,s)):t}async function Cv({roomId:r,userId:e,storage:t}){const s=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(r,e);return s?new Q(s):null}async function Mv({roomId:r,userId:e,hsApi:t,storage:i},s){let n;try{n=await t.state(r,"m.room.member",e,{log:s}).response()}catch(l){if(l.name==="HomeServerError"&&l.errcode==="M_NOT_FOUND")return null;throw l}const o=new Q({roomId:r,userId:e,membership:n.membership,avatarUrl:n.avatar_url,displayName:n.displayname}),a=await i.readWriteTxn([i.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(l){throw a.abort(),l}return await a.complete(),o}class Av extends Wd{constructor({members:e,closeCallback:t}){super(t),this._members=new Ht;for(const i of e)this._members.add(i.userId,i)}afterSync(e){for(const[t,i]of e.entries())this._members.set(t,i.member)}get members(){return this._members}}function Ko(r,e,t){const i=e.joinCount+e.inviteCount-1;if(r.length>=i)if(r.length>1){const s=r[r.length-1];return r.slice(0,r.length-1).map(o=>o.name).join(", ")+" and "+s.name}else{const s=r[0];return s?s.name:(t.log({l:"could get get other member name",length:r.length,otherMember:!!s,otherMemberMembership:s?.membership}),"Unknown DM Name")}else return r.length<i?r.map(s=>s.name).join(", ")+` and ${i} others`:null}class ka{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,i){const s=new Map,n=[];for(const o of this._members.keys())e.indexOf(o)===-1&&n.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&s.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!s.has(o)){const a=await i.roomMembers.get(this._roomId,o);if(a){const l=new Q(a);s.set(l.userId,l)}}return{updatedHeroMembers:s.values(),removedUserIds:n}}applyChanges({updatedHeroMembers:e,removedUserIds:t},i,s){for(const o of t)this._members.delete(o);for(const o of e)t.includes(o.userId)||this._members.set(o.userId,o);const n=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=Ko(n,i,s)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class Nv{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let i=this._map.get(e);return i||(i=new Dv(this,t,e),this._map.set(e,i)),i}updateEvents(e){for(let t=0;t<e.length;t+=1){const i=e[t],s=this._map.get(i.id);s?.update(i)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class Dv extends Ct{constructor(e,t,i){super(),this._eventMap=e,this._entry=t,this._id=i,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function Vv(r){return r||Bm.item}const Uv="m.room.power_levels",Pv=50;class Mn{constructor({powerLevelEvent:e,createEvent:t,ownUserId:i,membership:s}){this._plEvent=e,this._createEvent=t,this._ownUserId=i,this._membership=s}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,i,s,n;if(this._plEvent){let o=(i=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:i[e];if(typeof o!="number"&&(o=(s=this._plEvent.content)==null?void 0:s.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((n=this._createEvent.content)==null?void 0:n.creator))return 100;return 0}_getActionLevel(e){var t,i;const s=(i=(t=this._plEvent)==null?void 0:t.content)==null?void 0:i[e];return typeof s=="number"?s:Pv}_getEventTypeLevel(e){var t,i,s,n,o;const a=(s=(i=(t=this._plEvent)==null?void 0:t.content)==null?void 0:i.events)==null?void 0:s[e];if(typeof a=="number")return a;{const l=(o=(n=this._plEvent)==null?void 0:n.content)==null?void 0:o.events_default;return typeof l=="number"?l:0}}}class Ov extends Ht{constructor(e){super(),this.type=e}async load(e,t){const i=await t.roomState.getAllForType(e,this.type);for(let s=0;s<i.length;++s){const{event:n}=i[s];this.add(n.state_key,n)}}handleStateEvent(e){e.type===this.type&&this.set(e.state_key,e)}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}class Fv extends Ct{constructor(e,t){super(),this.type=e,this.stateKey=t}async load(e,t){var i;this.event=(i=await t.roomState.get(e,this.type,this.stateKey))==null?void 0:i.event}handleStateEvent(e){e.type===this.type&&e.state_key===this.stateKey&&(this.event=e,this.emit(this.get()))}get(){return this.event}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}const Lv="m.room.encrypted";class Yd extends Mt{constructor({roomId:e,storage:t,hsApi:i,mediaRepository:s,emitCollectionChange:n,user:o,createRoomEncryption:a,getSyncToken:l,platform:d}){super(),this._roomId=e,this._storage=t,this._hsApi=i,this._mediaRepository=s,this._summary=new nv(e),this._fragmentIdComparer=new mv([]),this._emitCollectionChange=n,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=l,this._platform=d,this._observedEvents=null,this._roomStateObservers=new Set,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null,this._timelineLoadPromise=null}async observeStateType(e,t=void 0){const i=new Ov(e);return await this._addStateObserver(i,t),i}async observeStateTypeAndKey(e,t,i=void 0){const s=new Fv(e,t);return await this._addStateObserver(s,i),s}async _addStateObserver(e,t){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState])),await e.load(this.id,t),this._roomStateObservers.add(e),e.setRemoveCallback(()=>{this._roomStateObservers.delete(e)})}async _eventIdsToEntries(e,t){const i=[];return await Promise.all(e.map(async s=>{const n=await t.timelineEvents.getByEventId(this._roomId,s);n&&i.push(new at(n,this._fragmentIdComparer))})),i}_getAdditionalTimelineRetryEntries(e,t){let i=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const s=e.reduce((n,o)=>(n.add(o.id),n),new Set);return i=i.filter(n=>!s.has(n.id)),i}async notifyRoomKey(e,t,i){var s;if(!this._roomEncryption)return;const n=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let o=await this._eventIdsToEntries(t,n);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(o,[e]);o=o.concat(a)}if(o.length){await this._decryptEntries(pi.Retry,o,n,i).complete(),(s=this._timeline)==null||s.replaceEntries(o);const l=this._summary.data.applyTimelineEntries(o,!1,!1);await this._summary.writeAndApplyData(l,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,pi.Timeline)),!0):!1}_decryptEntries(e,t,i,s=null){return new Bv(async(o,a)=>{if(i||(i=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const l=t.filter(y=>y.eventType===Lv).map(y=>y.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(l,null,e,i),o.cancelled)return;const d=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const c=[this._storage.storeNames.groupSessionDecryptions],h=this._isTimelineOpen;h&&c.push(this._storage.storeNames.deviceKeys);const p=await this._storage.readWriteTxn(c);let g;try{g=await d.write(p,a),h&&await g.verifyKnownSenders(p)}catch(y){throw p.abort(),y}await p.complete(),g.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t),h&&g.hasUnverifiedSenders&&a.wrapDetached("fetch unknown senders keys",async y=>{var w,x;const M=await g.fetchAndVerifyRemainingSenders(this._hsApi,y),D=[];M.applyToEntries(t,O=>D.push(O)),(w=this._timeline)==null||w.replaceEntries(D),(x=this._observedEvents)==null||x.updateEvents(D)})},Vv(s))}async _getSyncRetryDecryptEntries(e,t,i){let n=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,i);if(a)return this._eventIdsToEntries(a,i)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(n,e).map(l=>l.clone());n=n.concat(a)}return n}async load(e,t,i){i.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const s=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(s)}if(this._summary.data.needsHeroes){this._heroes=new ka(this._roomId);const s=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(s,this._summary.data,i)}}catch(s){throw new Bl(`Could not load room ${this._roomId}`,s)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const i=await Rv({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!i)return null;const s=new kr(i,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,s),s}async loadMemberList(e=void 0,t=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const i=await Tv({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,txn:e,syncToken:this._getSyncToken(),setChangedMembersMap:s=>this._changedMembersDuringSync=s,log:t},this._platform.logger);return this._memberList=new Av({members:i,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,i=null){return this._platform.logger.wrapOrRun(i,"fillGap",async s=>{if(s.set("id",this.id),s.set("fragment",e.fragmentId),s.set("dir",e.direction.asApiString()),e.edgeReached){s.set("edgeReached",!0);return}const n=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:s}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,l;try{a=await this._writeGapFill(n.chunk,o,s);const d=new qd({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});l=await new bv({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:d}).writeFragmentFill(e,n,e.token,o,s)}catch(d){throw o.abort(),d}await o.complete(),this._roomEncryption&&await this._decryptEntries(pi.Timeline,l.entries,null,s).complete();for(const d of l.fragments)this._fragmentIdComparer.add(d);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(l.updatedEntries),this._timeline.addEntries(l.entries))})}async _writeGapFill(e,t,i){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}get user(){return this._user}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:i,inviteCount:s}=this._summary.data;if(t&&t.includes(e)&&i+s===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new Mn({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const i=await e.roomState.get(this._roomId,"m.room.create","");if(i)return new Mn({createEvent:i.event,ownUserId:this._user.id,membership:this.membership});{const s=this.membership;return new Mn({ownUserId:this._user.id,membership:s})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new kr(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",i=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,i))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}async openTimeline(e=null){return await this._platform.logger.wrapOrRun(e,"open timeline",async t=>{this._timelineLoadPromise&&await this._timelineLoadPromise;let i;if(this._timelineLoadPromise=new Promise(s=>{i=()=>{this._timelineLoadPromise=null,s()}}),t.set("id",this.id),this._timeline)return t.log({l:"Returning existing timeline"}),i(),this._timeline.retain(),this._timeline;this._timeline=new $n({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,pi.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}finally{i()}return this._timeline.retain(),this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new Nv(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const i=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(s=>{i.update(s)}).catch(s=>{console.warn(`could not load event ${e} from storage`,s)}),i}async _readEventById(e){return await new Hd({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e;(e=this._roomEncryption)==null||e.dispose()}}class Bv{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",i=>e(this,i))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}class Kv{constructor({roomId:e,storage:t,hsApi:i,pendingEvents:s}){s=s||[],this._roomId=e,this._storage=t,this._hsApi=i,this._pendingEvents=new jl((n,o)=>n.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(s.map(n=>this._createPendingEvent(n))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const i=new mg({data:e,remove:()=>this._removeEvent(i),emitUpdate:s=>this._pendingEvents.update(i,s),attachments:t});return i}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const i of this._pendingEvents)await t.wrap("send event",async s=>{s.set("queueIndex",i.queueIndex);try{this._currentQueueIndex=i.queueIndex,await this._sendEvent(i,s)}catch(n){n instanceof zt?(this._offline=!0,s.set("offline",!0),i.setWaiting()):(s.catch(n),n.name==="HomeServerError"&&(n.statusCode===400||n.statusCode===403||n.statusCode===404)?(s.set("remove",!0),await i.abort()):i.setError(n))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",i=>e.uploadAttachments(this._hsApi,i)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const i=e.contentForEncryption,{type:s,content:n}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,i,this._hsApi,o));e.setEncrypted(s,n),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const i=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,i),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,i)}catch(s){throw i.abort(),s}await i.complete()}}async _resolveRemoteIdInPendingRelations(e,t,i){const s=this._pendingEvents.array.filter(n=>n.relatedTxnId===e&&n.relatedEventId!==t);for(const n of s)n.setRelatedEventId(t),await this._tryUpdateEventWithTxn(n,i);return s}async removeRemoteEchos(e,t,i){const s=[];for(const n of e){const o=n.unsigned&&n.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(l=>l.txnId===o):a=this._pendingEvents.array.findIndex(l=>l.remoteId===n.event_id),a!==-1){const l=this._pendingEvents.get(a),d=n.event_id;i.log({l:"removeRemoteEcho",queueIndex:l.queueIndex,remoteId:d,txnId:o}),t.pendingEvents.remove(l.roomId,l.queueIndex),s.push(l),await this._resolveRemoteIdInPendingRelations(o,d,t)}}return s}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const i=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{i.pendingEvents.remove(e.roomId,e.queueIndex)}catch{i.abort()}await i.complete();const s=this._pendingEvents.array.indexOf(e);s!==-1&&this._pendingEvents.remove(s)}e.dispose()}emitRemovals(e){for(const t of e){const i=this._pendingEvents.array.indexOf(t);i!==-1&&this._pendingEvents.remove(i),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,i,s){const n=Ei(t);let o=null;if(n){const a=fa(n);if(bc(a)&&(o=a,ad(n,null)),n.rel_type===gi&&this._pendingEvents.array.some(d=>{const c=Ei(d.content);return d.eventType===e&&c&&c.key===n.key&&(d.relatedTxnId===o||c.event_id===n.event_id)})){s.set("already_annotating",!0);return}}return await this._enqueueEvent(e,t,i,o,null,s)}async _enqueueEvent(e,t,i,s,n,o){const a=await this._createAndStoreEvent(e,t,s,n,i);return this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem),a}async enqueueRedaction(e,t,i){if(this._pendingEvents.array.some(a=>a.eventType===Tt&&(a.relatedTxnId===e||a.relatedEventId===e))){i.set("already_redacting",!0);return}let n,o;if(bc(e)){n=e;const a=e,l=this._pendingEvents.array.find(d=>d.txnId===a);if(l&&!l.remoteId&&l.status!==te.Sending){i.set("remove",n),await l.abort();return}else if(l)o=l.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(l=>l.remoteId===o);a&&(n=a.txnId)}i.set("relatedTxnId",n),i.set("relatedEventId",o),await this._enqueueEvent(Tt,{reason:t},null,n,o,i)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(i){throw t.abort(),i}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,i,s,n){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const l=o.pendingEvents,d=await l.getMaxQueueIndex(this._roomId)||0,h=Math.max(d,this._currentQueueIndex)+1,p=e!==Tt&&e!==Pp&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:h,eventType:e,content:t,relatedTxnId:i,relatedEventId:s,txnId:et(),needsEncryption:p,needsUpload:!!n},n),l.add(a.data)}catch(l){throw o.abort(),l}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class Jd{constructor({filename:e,blob:t,platform:i}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=i,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await qy(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,i){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:n=>{this._sentBytes=n,t()},log:i});const{content_uri:s}=await this._uploadRequest.response();this._mxcUrl=s}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let i=e.substr(0,e.lastIndexOf("url"));_n(`${i}info.size`,t,this._transferredBlob.size),_n(`${i}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?_n(`${i}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):_n(`${i}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function _n(r,e,t){const i=r.split(".");let s=e;for(let o=0;o<i.length-1;o+=1){const a=i[o];s[a]||(s[a]={}),s=s[a]}const n=i[i.length-1];s[n]=t}const $v="m.room.encrypted";class jv extends Yd{constructor(e){super(e),this._roomStateHandler=e.roomStateHandler;const{pendingEvents:t}=e,i=new qd({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new yv({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:i,memberWriter:new vv(this.id)}),this._sendQueue=new Kv({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,i,s,n){var o;n.set("id",this.id),i&&n.set("newKeys",i.length);let a=this._summary.data.applySyncResponse(e,t,this._user.id),l=this._roomEncryption;!l&&a.encryption&&(n.set("enableEncryption",!0),l=this._createRoomEncryption(this,a.encryption));let d,c;if(l){let h=((o=e?.timeline)==null?void 0:o.events)||[];i&&(d=await this._getSyncRetryDecryptEntries(i,l,s),d.length&&(n.set("retry",d.length),h=h.concat(d.map(p=>p.event)))),h=h.filter(p=>p?.type===$v),h.length&&(c=await l.prepareDecryptAll(h,i,pi.Sync,s))}return{roomEncryption:l,summaryChanges:a,decryptPreparation:c,decryptChanges:null,retryEntries:d}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async i=>{i.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:i,decryptChanges:s,roomEncryption:n,retryEntries:o},a,l){var d;l.set("id",this.id);const c=i.isNewJoin(this._summary.data);c&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:h,updatedEntries:p,newLiveKey:g,memberChanges:y,memberSync:w}=await l.wrap("syncWriter",B=>this._syncWriter.writeSync(e,c,i.hasFetchedMembers,a,B),l.level.Detail);let x;s&&(x=await l.wrap("decryptChanges",B=>s.write(a,B)),l.set("decryptionResults",x.results.size),l.set("decryptionErrors",x.errors.size),this._isTimelineOpen&&await x.verifyKnownSenders(a),x.applyToEntries(h),o?.length&&(x.applyToEntries(o),p.push(...o))),l.set("newEntries",h.length),l.set("updatedEntries",p.length);let M;n&&(M=await n.writeSync(e,y,a,l),l.set("shouldFlushKeyShares",M.shouldFlush));const D=h.concat(p);i=i.applyTimelineEntries(D,t,!this._isTimelineOpen,this._user.id),i.membership!=="join"?a.roomSummary.remove(this.id):i=this._summary.writeData(i,a),i&&l.set("summaryChanges",i.changedKeys(this._summary.data));let O;i?.needsHeroes&&(this._heroes||(this._heroes=new ka(this._roomId)),O=await this._heroes.calculateChanges(i.heroes,y,a));let C;Array.isArray((d=e.timeline)==null?void 0:d.events)&&(C=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,l));const U=this._getPowerLevelsEvent(e);return await this._runRoomStateHandlers(e,w,a,l),{roomResponse:e,summaryChanges:i,roomEncryption:n,newEntries:h,updatedEntries:p,newLiveKey:g,removedPendingEvents:C,memberChanges:y,heroChanges:O,powerLevelsEvent:U,encryptionChanges:M,decryption:x}}afterSync(e,t){const{summaryChanges:i,newEntries:s,updatedEntries:n,newLiveKey:o,removedPendingEvents:a,memberChanges:l,powerLevelsEvent:d,heroChanges:c,roomEncryption:h,roomResponse:p,encryptionChanges:g}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(h),this._roomEncryption&&this._roomEncryption.afterSync(g),l.size){if(this._changedMembersDuringSync)for(const[w,x]of l.entries())this._changedMembersDuringSync.set(w,x.member);if(this._memberList&&this._memberList.afterSync(l),this._roomStateHandler.updateRoomMembers(this,l),this._observedMembers&&this._updateObservedMembers(l),this._timeline){for(const[w,x]of l.entries())if(w===this._user.id){this._timeline.updateOwnMember(x.member);break}}}let y=!1;if(i&&(this._summary.applyChanges(i),this._summary.data.needsHeroes||(this._heroes=null),y=!0),this._heroes&&c){const w=this.name;this._heroes.applyChanges(c,this._summary.data,t),w!==this.name&&(y=!0)}d&&this._updatePowerLevels(d),y&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(n),this._timeline.addEntries(s)),this._observedEvents&&(this._observedEvents.updateEvents(n),this._observedEvents.updateEvents(s)),a&&this._sendQueue.emitRemovals(a),this._emitSyncRoomState(p)}_updateObservedMembers(e){for(const[t,i]of e){const s=this._observedMembers.get(t);s&&s.set(i.member)}}_getPowerLevelsEvent(e){let t;return Es(e,i=>{i.state_key===""&&i.type===Uv&&(t=i)}),t}_updatePowerLevels(e){if(this._powerLevels){const t=new Mn({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}async afterSyncCompleted({encryptionChanges:e,decryption:t,newEntries:i,updatedEntries:s},n){const o=e?.shouldFlush,a=this._isTimelineOpen&&t?.hasUnverifiedSenders;(o||a)&&await n.wrap({l:"room",id:this.id},async l=>{const d=[];if(o&&d.push(this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,l)),a){const c=l.wrap("verify senders",async h=>{var p,g;const y=await t.fetchAndVerifyRemainingSenders(this._hsApi,h),w=[],x=M=>w.push(M);y.applyToEntries(i,x),y.applyToEntries(s,x),h.set("verifiedEntries",w.length),(p=this._timeline)==null||p.replaceEntries(w),(g=this._observedEvents)==null||g.updateEvents(w)});d.push(c)}await Promise.all(d)})}start(e,t){if(this._roomEncryption){const i=e?.get("share_room_key");i&&t.wrapDetached("flush room keys",s=>(s.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,i,s)))}this._sendQueue.resumeSending(t)}async load(e,t,i){try{await super.load(e,t,i),await this._syncWriter.load(t,i)}catch(s){throw new Bl(`Could not load room ${this._roomId}`,s)}}async _writeGapFill(e,t,i){return await this._sendQueue.removeRemoteEchos(e,t,i)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,i,s=null){return this._platform.logger.wrapOrRun(s,"send",n=>(n.set("id",this.id),this._sendQueue.enqueueEvent(e,t,i,n)))}sendRedaction(e,t,i=null){return this._platform.logger.wrapOrRun(i,"redact",s=>(s.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,s)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var e;const t=this._syncWriter.lastMessageKey;if(t){const s=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,t);return(e=s?.event)==null?void 0:e.event_id}}async clearUnread(e=null,t=!0){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async i=>{i.set("id",this.id);const s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let n;try{n=this._summary.writeClearUnread(s)}catch(o){throw s.abort(),o}await s.complete(),this._summary.applyChanges(n),this._emitUpdate();try{const o=t&&await this._getLastEventId();o&&await this._hsApi.receipt(this._roomId,"m.read",o)}catch(o){if(o.name!=="ConnectionError")throw o}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}async inviteUser(e,t){if(!e)throw new Error("userId is null/undefined");await this._hsApi.invite(this.id,e,t).response()}_getPendingEvents(){return this._sendQueue.pendingEvents}_runRoomStateHandlers(e,t,i,s){const n=[];return Es(e,o=>{n.push(this._roomStateHandler.handleRoomState(this,o,t,i,s))}),Promise.all(n)}_emitSyncRoomState(e){Es(e,t=>{for(const i of this._roomStateObservers)i.handleStateEvent(t)})}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new Jd({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class qv extends Yd{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const i=await t.roomMembers.get(this.id,e);return i?new Q(i):Q.fromUserId(this.id,e,"join")}async load(e,t,i){const{summary:s,kickDetails:n}=e;return this._kickDetails=n,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(s,t,i)}async writeSync(e,t,i,s,n){if(n.set("id",this.id),i==="leave"){const o=zv(t,this._user.id);if(o||e){const a=o||this._kickDetails;let l;o&&(l=await this._getKickAuthor(o.sender,s));const d=e||this._summary.data;return s.archivedRoomSummary.set({summary:d.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:l,summaryData:d}}}else i==="join"&&s.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:i},s){s.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),i&&(this._kickedBy=i),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const i=this._storage.storeNames,s=await this._storage.readWriteTxn([i.roomState,i.archivedRoomSummary,i.roomMembers,i.timelineEvents,i.timelineFragments,i.timelineRelations,i.pendingEvents,i.inboundGroupSessions,i.groupSessionDecryptions,i.operations]);s.roomState.removeAllForRoom(this.id),s.archivedRoomSummary.remove(this.id),s.roomMembers.removeAllForRoom(this.id),s.timelineEvents.removeAllForRoom(this.id),s.timelineFragments.removeAllForRoom(this.id),s.timelineRelations.removeAllForRoom(this.id),s.pendingEvents.removeAllForRoom(this.id),s.inboundGroupSessions.removeAllForRoom(this.id),s.groupSessionDecryptions.removeAllForRoom(this.id),await s.operations.removeAllForScope(this.id),await s.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function zv(r,e){var t,i;let s;if(Es(r,n=>{n.type===st&&n.state_key===e&&n.sender!==n.state_key&&(s=n)}),s)return{membership:(t=s.content)==null?void 0:t.membership,reason:(i=s.content)==null?void 0:i.reason,sender:s.sender}}async function Gv(r,e,t){const i=await Promise.all(r.map(async s=>{const n=await e.profile(s,{log:t}).response();return new Hv(s,n.displayname,n.avatar_url)}));return i.sort((s,n)=>s.name.localeCompare(n.name)),i}class Hv{constructor(e,t,i){this.userId=e,this.displayName=t,this.avatarUrl=i}get name(){return this.displayName||this.userId}}class Wv{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function Yv(r){switch(r){case Wt.DirectMessage:case Wt.Private:return!0;case Wt.Public:return!1}}function Jv(r){switch(r){case Wt.DirectMessage:return"trusted_private_chat";case Wt.Private:return"private_chat";case Wt.Public:return"public_chat"}}class Xv extends Mt{constructor(e,t,i,s,n,o){var a;if(super(),this.id=e,this.options=t,this.updateCallback=i,this.mediaRepository=s,this.platform=n,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?Yv(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const l={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},d=(t.invites||[]).map(c=>new Wv(c));this._calculatedName=Ko(d,l,o)}}async create(e,t){try{let i;if(this.options.avatar){const{avatar:o}=this.options,a=new Jd({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),i={info:o.info},a.applyToContent("url",i)}const s={is_direct:this.options.type===Wt.DirectMessage,preset:Jv(this.options.type),initial_state:[]};this.options.name&&(s.name=this.options.name),this.options.topic&&(s.topic=this.options.topic),this.options.invites&&(s.invite=this.options.invites),this.options.alias&&(s.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(s.creation_content={"m.federate":!1}),this.options.powerLevelContentOverride&&(s.power_level_content_override=this.options.powerLevelContentOverride),this.isEncrypted&&s.initial_state.push(jm()),i&&s.initial_state.push({type:"m.room.avatar",state_key:"",content:i});const n=await e.createRoom(s,{log:t}).response();this._roomId=n.room_id}catch(i){this._error=i}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await Gv(this.options.invites,e,t);const i={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=Ko(this.profiles,i,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,i;return(i=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?i:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,i,s){if(!this.options.invites||this.options.type!==Wt.DirectMessage)return;const n=this.options.invites[0],o="m.direct";await s.wrap("set "+o,async a=>{try{const l=await t.readWriteTxn([t.storeNames.accountData]);let d;try{d=await l.accountData.get(o),d||(d={type:o,content:{}});const c=d.content;let h=c[n];h||(c[n]=h=[]),h.push(this._roomId),l.accountData.set(d),await l.complete()}catch(c){throw l.abort(),c}await i.setAccountData(e.id,o,d.content,{log:a}).response()}catch(l){a.catch(l)}})}}class Qv extends Mt{constructor({roomId:e,user:t,hsApi:i,mediaRepository:s,emitCollectionRemove:n,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=i,this._emitCollectionRemove=n,this._emitCollectionUpdate=o,this._mediaRepository=s,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new Q(e.inviter):null}async writeSync(e,t,i,s){var n;if(e==="invite"){s.set("id",this.id),s.set("add",!0);const o=(n=t.invite_state)==null?void 0:n.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let l;!a.name&&!a.canonicalAlias&&(l=await this._createHeroes(o,s));const d=this._getMyInvite(o);if(!d)return null;const c=this._getInviter(d,o),h=this._createData(o,d,c,a,l);return i.invites.set(h),{inviteData:h,inviter:c}}else return s.set("id",this.id),s.set("membership",e),i.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,i,s,n){const o=n?n.roomName:s.name,a=n?n.roomAvatarUrl:s.avatarUrl,l=n?.roomAvatarColorId||this.id;return{roomId:this.id,isEncrypted:!!s.encryption,isDirectMessage:s.isDirectMessage,name:o,avatarUrl:a,avatarColorId:l,canonicalAlias:s.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:i?.serialize()}}_createSummaryData(e){return e.reduce((t,i)=>jd(t,i,this._user.id),new Bt(null,this.id))}async _createHeroes(e,t){const i=e.filter(c=>c.type===st),s=i.filter(c=>c.state_key!==this._user.id),n=s.reduce((c,h)=>{const p=Q.fromMemberEvent(this.id,h);return c.set(p.userId,new Zl(p,null)),c},new Map),o=s.map(c=>c.state_key),a=new ka(this.id),l=await a.calculateChanges(o,n,null),d=new Bt(null,this.id);return d.joinCount=i.reduce((c,h)=>{var p;return c+(((p=h.content)==null?void 0:p.membership)==="join"?1:0)},0),d.inviteCount=i.reduce((c,h)=>{var p;return c+(((p=h.content)==null?void 0:p.membership)==="invite"?1:0)},0),a.applyChanges(l,d,t),a}_getMyInvite(e){return e.find(t=>t.type===st&&t.state_key===this._user.id)}_getInviter(e,t){const i=t.find(s=>s.type===st&&s.state_key===e.sender);if(i)return Q.fromMemberEvent(this.id,i)}_getJoinRule(e){var t;const i=e.find(s=>s.type==="m.room.join_rules");return i?(t=i.content)==null?void 0:t.join_rule:null}}class $i{constructor(e){this._description=e}static httpPusher(e,t,i,s){return new $i({kind:"http",append:!0,data:Object.assign({},s,{url:e+"/_matrix/push/v1/notify"}),pushkey:i,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const i=Object.assign({},this._description,{kind:null});await e.setPusher(i,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}class Zv extends Mt{constructor({storage:e,callHandler:t}){super(),this._storage=e,this._olmDecryption=null,this._megolmDecryption=null,this._callHandler=t,this._senderDeviceCache=new Gd(10,i=>i.curve25519Key)}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,i,s){s.set("messageTypes",wc(e,a=>a.type));const n=e.filter(a=>a.type==="m.room.encrypted");if(this._emitUnencryptedEvents(e),!this._olmDecryption){s.log("can't decrypt, encryption not enabled",s.level.Warn);return}const o=n.filter(a=>{var l;return((l=a.content)==null?void 0:l.algorithm)===ua});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,i);s.set("decryptedTypes",wc(a.results,d=>{var c;return(c=d.event)==null?void 0:c.type}));for(const d of a.errors)s.child("decrypt_error").catch(d);const l=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,s);return new ew(a,l)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),{hasNewRoomKeys:(await Promise.all(e.newRoomKeys.map(n=>this._megolmDecryption.writeRoomKey(n,t)))).some(n=>!!n),decryptionResults:e.olmDecryptChanges.results}}async afterSyncCompleted(e,t,i,s){if(await s.wrap("Verifying fingerprint of encrypted toDevice messages",async n=>{for(const o of e){const a=o.event.sender,l=await t.deviceForCurveKey(a,o.senderCurve25519Key,i,n);o.setDevice(l),o.isVerified?this.emit("message",{encrypted:o}):n.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:o.device.ed25519Key,claimedEd25519Key:o.claimedEd25519Key,deviceId:l.deviceId,userId:l.userId})}}),this._callHandler){const n=e.filter(o=>{var a;return this._callHandler.handlesDeviceMessageEventType((a=o.event)==null?void 0:a.type)});n.length&&await s.wrap("process call signalling messages",async o=>{for(const a of n){const l=await t.deviceForId(a.event.sender,a.event.content.device_id,i,o);a.setDevice(l),a.isVerified?this._callHandler.handleDeviceMessage(a.event,a.userId,a.deviceId,o):o.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:a.device.ed25519Key,claimedEd25519Key:a.claimedEd25519Key,deviceId:l.deviceId,userId:l.userId})}})}}_emitUnencryptedEvents(e){const t=e.filter(i=>i.type!=="m.room.encrypted");for(const i of t)this.emit("message",{unencrypted:i})}}class ew{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=As(t,i=>i.roomId)}}const hr=Ze+"olmAccount",$o=Ze+"areDeviceKeysUploaded",An=Ze+"serverOTKCount";async function Kc(r,e,t,i,s){const n=r.pickle(e),o=await s.readWriteTxn([s.storeNames.session]);try{o.session.add(hr,n),o.session.add($o,t),o.session.add(An,i)}catch(a){throw o.abort(),a}await o.complete()}class Ji{static async load({olm:e,pickleKey:t,hsApi:i,userId:s,deviceId:n,olmWorker:o,txn:a}){const l=await a.session.get(hr);if(l){const d=new e.Account,c=await a.session.get($o);d.unpickle(t,l);const h=await a.session.get(An);return new Ji({pickleKey:t,hsApi:i,account:d,userId:s,deviceId:n,areDeviceKeysUploaded:c,serverOTKCount:h,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:i,hsApi:s,userId:n,olmWorker:o,storage:a}){const l=t.adoptUnpickledOlmAccount(),d=JSON.parse(l.one_time_keys()),h=Object.entries(d.curve25519).length,p=!0;return await Kc(l,i,p,h,a),new Ji({pickleKey:i,hsApi:s,account:l,userId:n,deviceId:t.deviceId,areDeviceKeysUploaded:p,serverOTKCount:h,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:i,userId:s,deviceId:n,olmWorker:o,storage:a}){const l=new e.Account;o?await o.createAccountAndOTKs(l,l.max_number_of_one_time_keys()):(l.create(),l.generate_one_time_keys(l.max_number_of_one_time_keys()));const d=!1,c=0;return a&&await Kc(l,t,d,c,a),new Ji({pickleKey:t,hsApi:i,account:l,userId:s,deviceId:n,areDeviceKeysUploaded:d,serverOTKCount:c,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:i,userId:s,deviceId:n,areDeviceKeysUploaded:o,serverOTKCount:a,olm:l,olmWorker:d}){this._olm=l,this._pickleKey=e,this._hsApi=t,this._account=i,this._userId=s,this._deviceId=n,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=d,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,i){var s;const n=JSON.parse(this._account.one_time_keys()),o=Object.entries(n.curve25519);if(o.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){i.set("identity",!0);const c=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(c)}o.length&&(i.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(o));const l=t?this._deviceId:void 0,d=await this._hsApi.uploadKeys(l,a,{log:i}).response();this._serverOTKCount=(s=d?.one_time_key_counts)==null?void 0:s.signed_curve25519,i.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,c=>{o.length&&(this._account.mark_keys_as_published(),c?.set(hr,this._account.pickle(this._pickleKey)),c?.set(An,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,c?.set($o,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const i=this._account.max_number_of_one_time_keys(),s=Math.floor(i/2);if(this._serverOTKCount<s){const n=JSON.parse(this._account.one_time_keys()),a=Object.entries(n.curve25519).length,l=s-a-this._serverOTKCount;return l>0&&await t.wrap("generate otks",d=>{d.set("max",i),d.set("server",this._serverOTKCount),d.set("unpublished",a),d.set("new",l),d.set("limit",s),this._account.generate_one_time_keys(l),this._updateSessionStorage(e,c=>{c.set(hr,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const i=new this._olm.Session;try{return i.create_inbound_from(this._account,e,t),i}catch(s){throw i.free(),s}}async createOutboundOlmSession(e,t){const i=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,i,e,t):i.create_outbound(this._account,e,t),i}catch(s){throw i.free(),s}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(hr,this._account.pickle(this._pickleKey))}writeSync(e,t,i){const s=e.signed_curve25519;if(Number.isSafeInteger(s)&&s!==this._serverOTKCount)return t.session.set(An,s),i.set("otkCount",s),s}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_keysAsSignableObject(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[ua,Rt],keys:{}};for(const[i,s]of Object.entries(e))t.keys[`${i}:${this._deviceId}`]=s;return t}getUnsignedDeviceKey(){const e=JSON.parse(this._account.identity_keys());return this._keysAsSignableObject(e)}_deviceKeysPayload(e){const t=this._keysAsSignableObject(e);return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[i,s]of e){const n={key:s};this.signObject(n),t[`signed_curve25519:${i}`]=n}return t}async _updateSessionStorage(e,t){if(e){const i=await e.readWriteTxn([e.storeNames.session]);try{await t(i.session)}catch(s){throw i.abort(),s}await i.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},i=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(Lr.stringify(e)),e.signatures=t,i!==void 0&&(e.unsigned=i)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}const Xd="org.matrix.msc2697.v1.olm.libolm_pickle";async function tw(r,e,t,i){try{const s=await r.getDehydratedDevice({log:i}).response();if(s.device_data.algorithm===Xd)return new sw(s,e,t)}catch(s){s.name!=="HomeServerError"&&(i.error=s);return}}async function iw(r,e,t,i,s){var n;const a=(await e.createDehydratedDevice({device_data:{algorithm:Xd,account:r.pickleWithKey(t.binaryKey.slice()),passphrase:((n=t.description)==null?void 0:n.passphraseParams)||{}},initial_device_display_name:i}).response()).device_id;return r.setDeviceId(a),await r.uploadKeys(void 0,!0,s),a}class sw{constructor(e,t,i){this._dehydratedDevice=e,this._olm=t,this._platform=i}async decrypt(e,t){const i=new va("dehydrated_device",this._dehydratedDevice.device_data.passphrase),s=await Td(e,t,i,this._platform,this._olm),n=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return n.unpickle(s.binaryKey.slice(),o),new rw(this._dehydratedDevice,n,s)}catch(o){if(n.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class rw{constructor(e,t,i){this._dehydratedDevice=e,this._account=t,this._key=i}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class Qd{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class Zd{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function eu(r,e,t,i){return{session:r.pickle(i),sessionId:r.session_id(),senderKey:e,lastUsed:t}}class jn{constructor(e,t,i,s=!1){this.data=e,this.pickleKey=t,this.olm=i,this.isNew=s,this.isModified=s}static create(e,t,i,s,n){const o=eu(t,e,n,s);return new jn(o,s,i,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class tu{constructor(e,t,i,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=i,this.encryptedEvent=s}setDevice(e){this.device=e}get isVerified(){return this.device?Gi(this.device)===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!0}get userId(){var e;return(e=this.device)==null?void 0:e.user_id}get deviceId(){var e;return(e=this.device)==null?void 0:e.device_id}get isVerificationUnknown(){return!this.device}}var qn=(r=>(r[r.PreKey=0]="PreKey",r[r.Normal=1]="Normal",r))(qn||{});const $c=4;function iu(r){r.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class nw{constructor(e,t,i,s,n,o){this.account=e,this.pickleKey=t,this.now=i,this.ownUserId=s,this.olm=n,this.senderKeyLock=o}async obtainDecryptionLock(e){var t;const i=new Set;for(const n of e){const o=(t=n.content)==null?void 0:t.sender_key;o&&i.add(o)}const s=await Promise.all(Array.from(i).map(n=>this.senderKeyLock.takeLock(n)));return new Zd(s)}async decryptAll(e,t,i){try{const s=As(e,c=>{var h;return(h=c.content)==null?void 0:h.sender_key}),n=this.now(),o=await Promise.all(Array.from(s.entries()).map(([c,h])=>this._decryptAllForSenderKey(c,h,n,i))),a=o.reduce((c,h)=>c.concat(h.results),[]),l=o.reduce((c,h)=>c.concat(h.errors),[]),d=o.map(c=>c.senderKeyDecryption);return new aw(d,a,l,this.account,t)}catch(s){throw t.release(),s}}async _decryptAllForSenderKey(e,t,i,s){const n=await this._getSessions(e,s),o=new ow(e,n,i),a=[],l=[];for(const d of t)try{const c=this._decryptForSenderKey(o,d,i);a.push(c)}catch(c){l.push(c)}return{results:a,errors:l,senderKeyDecryption:o}}_decryptForSenderKey(e,t,i){const s=e.senderKey,n=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(n)}catch(a){throw new De("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:s,error:a.message})}if(typeof o!="string"&&n.type===qn.PreKey){let a;try{a=this._createSessionAndDecrypt(s,n,i)}catch(l){throw new De(`Could not create inbound olm session: ${l.message}`,t,{senderKey:s,error:l})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(l){throw new De("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:l})}return this._validatePayload(a,t),new tu(a,s,a.keys.ed25519)}else throw new De("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,i){let s;const n=this.account.createInboundOlmSession(e,t.body);try{s=n.decrypt(t.type,t.body);const o=jn.create(e,n,this.olm,this.pickleKey,i);return o.unload(n),{session:o,plaintext:s}}catch(o){throw n.free(),o}}_getMessageAndValidateEvent(e){var t;const i=(t=e.content)==null?void 0:t.ciphertext;if(!i)throw new De("OLM_MISSING_CIPHERTEXT",e);const s=i?.[this.account.identityKeys.curve25519];if(!s)throw new De("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const s=(await t.olmSessions.getAll(e)).map(n=>new jn(n,this.pickleKey,this.olm));return iu(s),s}_validatePayload(e,t){var i,s,n;if(e.sender!==t.sender)throw new De("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new De("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((i=e.recipient_keys)==null?void 0:i.ed25519)!==this.account.identityKeys.ed25519)throw new De("OLM_BAD_RECIPIENT_KEY",t,{key:(s=e.recipient_keys)==null?void 0:s.ed25519});if(!e.type)throw new De("missing type on payload",t,{payload:e});if(typeof((n=e.keys)==null?void 0:n.ed25519)!="string")throw new De("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class ow{constructor(e,t,i){this.senderKey=e,this.sessions=t,this.timestamp=i}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const i=this.decryptWithSession(t,e);if(typeof i=="string")return iu(this.sessions),i}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const i=e.load();try{if(t.type===qn.PreKey&&!i.matches_inbound(t.body))return;try{const s=i.decrypt(t.type,t.body);return e.save(i),e.data.lastUsed=this.timestamp,s}catch(s){if(t.type===qn.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${s.message}`);return}}finally{e.unload(i)}}}class aw{constructor(e,t,i,s,n){this.senderKeyDecryptions=e,this.results=t,this.errors=i,this.account=s,this.lock=n}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const i of t.getModifiedSessions())if(e.olmSessions.set(i.data),i.isNew){const s=i.load();try{this.account.writeRemoveOneTimeKey(s,e)}finally{i.unload(s)}}if(t.sessions.length>$c){const{senderKey:i,sessions:s}=t;for(let n=s.length-1;n>=$c;n-=1){const o=s[n];e.olmSessions.remove(i,o.id)}}}}finally{this.lock.release()}}}function cw(r){return r.reduce((e,t)=>!e||t<e?t:e,null)}const jc="signed_curve25519",fn=20;class lw{constructor(e,t,i,s,n,o,a,l){this.account=e,this.pickleKey=t,this.olm=i,this.storage=s,this.now=n,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=l,this._batchLocks=new Array(fn);for(let d=0;d<fn;d+=1)this._batchLocks[d]=new Qd}async _takeBatchLock(e){const t=this._batchLocks.filter(i=>!i.isTaken).slice(0,e);if(t.length<e){const i=this._batchLocks.filter(s=>s.isTaken).slice(0,e-t.length);t.push(...i)}return await Promise.all(t.map(i=>i.take())),new Zd(t)}async encrypt(e,t,i,s,n){let o=[];for(let a=0;a<i.length;a+=fn){const l=i.slice(a,a+fn),d=await this._takeBatchLock(l.length);try{const c=await this._encryptForMaxDevices(e,t,l,s,n);o=o.concat(c)}finally{d.release()}}return o}async _encryptForMaxDevices(e,t,i,s,n){const o=await Promise.all(i.map(a=>this.senderKeyLock.takeLock(It(a))));try{const{devicesWithoutSession:a,existingEncryptionTargets:l}=await this._findExistingSessions(i),d=this.now();let c=[];try{if(a.length){const g=await n.wrap("create sessions",y=>this._createNewSessions(a,s,d,y));c=c.concat(g)}await this._loadSessions(l),c=c.concat(l);const h={l:"encrypt",targets:c.length},p=n.wrap(h,()=>c.map(g=>{const y=this._encryptForDevice(e,t,g);return new dw(y,g.device)}));return await this._storeSessions(c,d),p}finally{for(const h of c)h.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),i=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(It(o)))),s=e.filter((o,a)=>{const l=i[a];return!l?.length}),n=e.map((o,a)=>{const l=i[a];if(l?.length>0){const d=cw(l);return Mr.fromSessionId(o,d)}}).filter(o=>!!o);return{devicesWithoutSession:s,existingEncryptionTargets:n}}_encryptForDevice(e,t,i){const{session:s,device:n}=i,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,n)),a=s.encrypt(o);return{algorithm:ua,sender_key:this.account.identityKeys.curve25519,ciphertext:{[It(n)]:a}}}_buildPlainTextMessageForDevice(e,t,i){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:Gi(i)},recipient:i.user_id,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,i,s){const n=await s.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of n){const{device:a,oneTimeKey:l}=o;o.session=await this.account.createOutboundOlmSession(It(a),l)}await this._storeSessions(n,i)}catch(o){for(const a of n)a.dispose();throw o}return n}async _claimOneTimeKeys(e,t,i){const s=_a(t,l=>l.user_id,()=>new Map,(l,d)=>l.set(d.device_id,d)),n=Array.from(s.entries()).reduce((l,[d,c])=>(l[d]=Array.from(c.values()).reduce((h,p)=>(h[p.device_id]=jc,h),{}),l),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:n},{log:i}).response();Object.keys(o.failures).length&&i.log({l:"failures",servers:Object.keys(o.failures)},i.level.Warn);const a=o?.one_time_keys;return this._verifyAndCreateOTKTargets(a,s,i)}_verifyAndCreateOTKTargets(e,t,i){var s;const n=[];for(const[o,a]of Object.entries(e))for(const[l,d]of Object.entries(a)){const[c,h]=Object.entries(d)[0],[p]=c.split(":");if(p===jc){const g=(s=t.get(o))==null?void 0:s.get(l);if(g&&ha(this.olmUtil,o,l,Gi(g),h,i)===he.Valid){const w=Mr.fromOTK(g,h.key);n.push(w)}}}return n}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let i=!1;try{await Promise.all(e.map(async s=>{const n=await t.olmSessions.get(It(s.device),s.sessionId);if(n&&!i){const o=new this.olm.Session;o.unpickle(this.pickleKey,n.session),s.session=o}}))}catch(s){i=!0;for(const n of e)n.dispose();throw s}}async _storeSessions(e,t){const i=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const s of e){const n=eu(s.session,It(s.device),t,this.pickleKey);i.olmSessions.set(n)}}catch(s){throw i.abort(),s}await i.complete()}}class Mr{constructor(e,t,i){this.device=e,this.oneTimeKey=t,this.sessionId=i,this.session=null}static fromOTK(e,t){return new Mr(e,t,null)}static fromSessionId(e,t){return new Mr(e,null,t)}dispose(){this.session&&this.session.free()}}class dw{constructor(e,t){this.content=e,this.device=t}}class uw{constructor(e,t,i,s){this._roomId=e,this._results=t,this._errors=i,this._replayEntries=s}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(i){this._errors.set(t.eventId,i)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,i){const{messageIndex:s,sessionId:n,eventId:o,timestamp:a}=t,l=await i.groupSessionDecryptions.get(e,n,s);if(l&&l.eventId!==o){const c=l.timestamp<a?o:l.eventId;throw this._results.delete(o),new De("MEGOLM_REPLAYED_INDEX",event,{messageIndex:s,badEventId:c,otherEventId:l.eventId})}l||i.groupSessionDecryptions.set(e,n,s,{eventId:o,timestamp:a})}}function jo(r,e){if(r)for(const[t,i]of r.entries())e.set(t,i)}class hw{constructor(e,t,i){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=i}async decrypt(){try{const e=this._initialErrors,t=new Map,i=[];return await Promise.all(this._sessionDecryptions.map(async s=>{const n=await s.decryptAll();jo(n.errors,e),jo(n.results,t),i.push(...n.replayEntries)})),new uw(this._roomId,t,e,i)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class mw{constructor(e,t,i){this.sessionId=e,this.messageIndex=t,this.event=i}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class pw{constructor(e,t,i,s){this.key=e,this.events=t,this.olmWorker=i,this.keyLoader=s,this.decryptionRequests=i?[]:void 0}async decryptAll(){const e=[],t=new Map;let i;return await this.keyLoader.useKey(this.key,async s=>{for(const n of this.events)try{const o=n.content.ciphertext;let a;if(this.olmWorker){const h=this.olmWorker.megolmDecrypt(s,o);this.decryptionRequests.push(h),a=await h.response()}else a=s.decrypt(o);const{plaintext:l}=a;let d;try{d=JSON.parse(l)}catch(h){throw new De("PLAINTEXT_NOT_JSON",n,{plaintext:l,err:h})}if(d.room_id!==this.key.roomId)throw new De("MEGOLM_WRONG_ROOM",n,{encryptedRoomId:d.room_id,eventRoomId:this.key.roomId});e.push(new mw(this.key.sessionId,a.message_index,n));const c=new tu(d,this.key.senderKey,this.key.claimedEd25519Key,n);t.set(n.event_id,c)}catch(o){if(o.name==="AbortError")return;i||(i=new Map),i.set(n.event_id,o)}}),{results:t,errors:i,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Ia(r){var e;return(e=r.content)==null?void 0:e.sender_key}function xa(r){var e;return(e=r.content)==null?void 0:e.session_id}function _w(r){var e;return(e=r.content)==null?void 0:e.ciphertext}function fw(r){return typeof Ia(r)=="string"&&typeof xa(r)=="string"&&typeof _w(r)=="string"}class gw{constructor(){this.events=[]}get senderKey(){return Ia(this.events[0])}get sessionId(){return xa(this.events[0])}}function qo(r){return _a(r,e=>`${Ia(e)}|${xa(e)}`,()=>new gw,(e,t)=>e.events.push(t))}class su{isForSession(e,t,i){return this.roomId===e&&this.senderKey===t&&this.sessionId===i}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function ru(r,e){return r.first_known_index()<e.first_known_index()}class Ta extends su{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let i;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(n,o)=>{i=n.pickle(o)},t),this.isBetter===!1)return!1;i||(i=await e.useKey(this,(n,o)=>n.pickle(o)));const s={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:i,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(s),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,i){if(this.isBetter!==void 0)return this.isBetter;let s=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!s){const n=await au(this.roomId,this.senderKey,this.sessionId,i);n&&(n.hasSession?s=n:n.eventIds&&(this._eventIds=n.eventIds))}if(s){const n=s;await e.useKey(this,async o=>{await e.useKey(n,(a,l)=>{this.isBetter=ru(o,a),n.isBetter=!this.isBetter,this.isBetter&&t&&t(o,l)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Qn.NotBackedUp}}class yw extends Ta{constructor(e){super(),this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return Kr.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class vw extends Ta{constructor(e,t,i){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=i,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return Kr.Outbound}loadInto(e){e.create(this.serializationKey)}}class ww extends Ta{constructor(e,t,i){super(),this._roomId=e,this._sessionId=t,this._backupInfo=i}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return Kr.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Qn.BackedUp}}class nu extends su{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function bw(r){var e;const t=(e=r.event.content)==null?void 0:e.session_key,i=new yw(r);if(typeof i.roomId=="string"&&typeof i.sessionId=="string"&&typeof i.senderKey=="string"&&typeof t=="string")return i}function ou(r,e,t){var i;const s=t.session_key,n=t.sender_key,o=(i=t.sender_claimed_keys)==null?void 0:i.ed25519;if(typeof r=="string"&&typeof e=="string"&&typeof n=="string"&&typeof s=="string"&&typeof o=="string")return new ww(r,e,t)}async function au(r,e,t,i){const s=await i.inboundGroupSessions.get(r,e,t);if(s)return new nu(s)}class Sw{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,i,s,n){let o=await n.inboundGroupSessions.get(e,t,i);if(!o?.session){if(o){const a=new Set(o.eventIds);for(const l of s)a.add(l);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:i,eventIds:s};n.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,i,s){const n=await s.inboundGroupSessions.get(e,t,i);if(n&&!n.session)return n.eventIds}async hasSession(e,t,i,s){const n=await s.inboundGroupSessions.get(e,t,i);return typeof n?.session=="string"}async prepareDecryptAll(e,t,i,s){const n=new Map,o=[];for(const d of t)fw(d)?o.push(d):n.set(d.event_id,new De("MEGOLM_INVALID_EVENT",d));const a=qo(o),l=[];return await Promise.all(Array.from(a.values()).map(async d=>{const c=await this.getRoomKey(e,d.senderKey,d.sessionId,i,s);if(c)l.push(new pw(c,d.events,this.olmWorker,this.keyLoader));else for(const h of d.events)n.set(h.event_id,new De("MEGOLM_NO_SESSION",h))})),new hw(e,l,n)}async getRoomKey(e,t,i,s,n){if(s){const l=s.find(d=>d.isForSession(e,t,i));if(l&&await l.checkBetterThanKeyInStorage(this.keyLoader,n))return l}const o=this.keyLoader.getCachedKey(e,t,i);if(o)return o;const a=await au(e,t,i,n);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var i,s;const n=[];for(const o of e)((i=o.event)==null?void 0:i.type)!=="m.room_key"||((s=o.event.content)==null?void 0:s.algorithm)!==Rt||t.wrap("room_key",a=>{const l=bw(o);l?(a.set("roomId",l.roomId),a.set("id",l.sessionId),n.push(l)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return n}roomKeyFromBackup(e,t,i){return ou(e,t,i)}dispose(){this.keyLoader.dispose()}}class Ew extends zd{constructor(e,t,i){super(i),this.pickleKey=t,this.olm=e}getCachedKey(e,t,i){const s=this.findCachedKeyIndex(e,t,i);if(s!==-1)return this._getByIndexAndMoveUp(s).key}async useKey(e,t){const i=await this.allocateOperation(e);try{return await t(i.session,this.pickleKey)}finally{this.releaseOperation(i)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const i=this._getByIndexAndMoveUp(t);return i.isForKey(e)?(i.refCount+=1,i):(i.refCount=1,i.key=e,e.loadInto(i.session,this.pickleKey),i)}else{const i=new this.olm.InboundGroupSession;e.loadInto(i,this.pickleKey);const s=new kw(e,i);return this._set(s),s}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,i){return this._entries.reduce((s,n,o,a)=>{const l=s===-1?void 0:a[s];return n.isBest===!0&&n.isForSameSession(e,t,i)&&(!l||n.isBetter(l))?o:s},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,i,s,n)=>{const o=t===-1?void 0:n[t];return i.refCount===0&&i.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!i.isBetter(o))?s:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class kw{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,i){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===i}isBetter(e){return ru(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const Iw="m.megolm_backup.v1.curve25519-aes-sha2";class Ra{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,i){const s=e.public_key,n=new i.PkDecryption,o=new i.PkEncryption;try{const a=n.init_with_private_key(t);if(a!==s)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${s}`);o.set_recipient_key(a)}catch(a){throw n.free(),o.free(),a}return new Ra(o,n)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const i={algorithm:Rt,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(i))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const xw=200;class Tw{constructor(e,t){this.info=e,this.crypto=t}}class Rw extends Mt{constructor(e,t,i,s,n,o=1e4){super(),this.hsApi=e,this.olm=t,this.keyLoader=i,this.storage=s,this.platform=n,this.maxDelay=o,this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1,this.backupConfigDeferred=new Qi,this.backupConfigDeferred=new Qi}get hasStopped(){return this._stopped}get error(){return this._error}get version(){var e,t;return(t=(e=this.backupConfigDeferred.value)==null?void 0:e.info)==null?void 0:t.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}get operationInProgress(){return this._operationInProgress}async getRoomKey(e,t,i){if(this.needsNewKey)return;const s=await this.backupConfigDeferred.promise;if(!s)return;const n=await this.hsApi.roomKeyForRoomAndSession(s.info.version,e,t,{log:i}).response();if(!n.session_data)return;const o=s.crypto.decryptRoomKey(n.session_data);if(o?.algorithm===Rt)return ou(e,t,o);o?.algorithm&&i.set("unknown algorithm",o.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}async load(e,t){const i=await e.readSecret("m.megolm_backup.v1");return i?(this.privateKey=new Uint8Array(this.platform.encoding.base64.decode(i)),!0):(this.backupConfigDeferred.resolve(void 0),!1)}async start(e){await e.wrap("KeyBackup.start",async t=>{if(this.privateKey&&!this.backupInfoRequest){let i;try{this.backupInfoRequest=this.hsApi.roomKeysVersion(void 0,{log:t}),i=await this.backupInfoRequest.response()}catch(s){if(s.name==="AbortError"){t.set("aborted",!0);return}else throw s}finally{this.backupInfoRequest=void 0}if(i.algorithm===Iw){const s=Ra.fromAuthData(i.auth_data,this.privateKey,this.olm);this.backupConfigDeferred.resolve(new Tw(i,s)),this.emit("change")}else this.backupConfigDeferred.resolve(void 0),t.log({l:"Unknown backup algorithm",algorithm:i.algorithm});this.privateKey=void 0}this.flush(t)})}flush(e){this._operationInProgress||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const i=this._runFlushOperation(t);this._operationInProgress=i,this.emit("change");try{await i.result,this._hasBackedUpAllKeys=!0}catch(s){this._stopped=!0,s.name==="HomeServerError"&&(s.errcode==="M_WRONG_ROOM_KEYS_VERSION"||s.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(s.name!=="AbortError"||s.name==="StorageError"&&s.errcode==="AbortError")&&(this._error=s),t.catch(s)}this._operationInProgress=void 0,this.emit("change")})}_runFlushOperation(e){return new Ld(async(t,i)=>{const s=await this.backupConfigDeferred.promise;if(!s)return;let n=0,o=0;for(;;){const a=this.platform.random()*this.maxDelay,l=this.platform.clock.createTimeout(a);t(l),await l.elapsed();const d=await this.storage.readTxn([H.inboundGroupSessions]);t(d),n=o+await d.inboundGroupSessions.countNonBackedUpSessions(),i(new qc(n,o));const c=(await d.inboundGroupSessions.getFirstNonBackedUpSessions(xw)).map(g=>new nu(g));if(c.length===0){e.set("total",n);return}const h=await this.encodeKeysForBackup(c,s.crypto),p=this.hsApi.uploadRoomKeysToBackup(s.info.version,h,{log:e});t(p),await p.response(),await this.markKeysAsBackedUp(c,t),o+=c.length,i(new qc(n,o))}})}async encodeKeysForBackup(e,t){const i={rooms:{}},s=i.rooms;for(const n of e){let o=s[n.roomId];o||(o=s[n.roomId]={sessions:{}}),o.sessions[n.sessionId]=await this.encodeRoomKey(n,t)}return i}async markKeysAsBackedUp(e,t){const i=await this.storage.readWriteTxn([H.inboundGroupSessions]);t(i);try{await Promise.all(e.map(s=>i.inboundGroupSessions.markAsBackedUp(s.roomId,s.senderKey,s.sessionId)))}catch(s){throw i.abort(),s}await i.complete()}async encodeRoomKey(e,t){return await this.keyLoader.useKey(e,i=>{const s=i.first_known_index(),n=i.export_session(s);return{first_message_index:s,forwarded_count:0,is_verified:!1,session_data:t.encryptRoomKey(e,n)}})}dispose(){var e,t,i;(e=this.backupInfoRequest)==null||e.abort(),(i=(t=this.backupConfigDeferred.value)==null?void 0:t.crypto)==null||i.dispose()}}class qc{constructor(e,t){this.total=e,this.finished=t}}class Cw{constructor({pickleKey:e,olm:t,account:i,keyLoader:s,storage:n,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=i,this._keyLoader=s,this._storage=n,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let i=await t.outboundGroupSessions.get(e);if(i){const s=new this._olm.OutboundGroupSession;try{return s.unpickle(this._pickleKey,i.session),this._createRoomKeyMessage(s,e)}finally{s.free()}}}createWithheldMessage(e,t,i){return{algorithm:e.algorithm,code:t,reason:i,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let i=new this._olm.OutboundGroupSession;try{const s=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let n;try{let o=await s.outboundGroupSessions.get(e);n=await this._readOrCreateSession(i,o,e,t,s),n&&this._writeSession(this._now(),i,e,s)}catch(o){throw s.abort(),o}return await s.complete(),n}finally{i.free()}}async _readOrCreateSession(e,t,i,s,n){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,s)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,i);return await new vw(i,e,this._account.identityKeys).write(this._keyLoader,n),o}}_writeSession(e,t,i,s){s.outboundGroupSessions.set({roomId:i,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,i,s){let n=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,l;try{let d=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(n,d,e,s,o),l=this._encryptContent(e,n,t,i);const c=a?this._now():d.createdAt;this._writeSession(c,n,e,o)}catch(d){throw o.abort(),d}return await o.complete(),new Mw(l,a)}finally{n&&n.free()}}_needsToRotate(e,t,i){let s=6048e5;Number.isSafeInteger(i?.rotation_period_ms)&&(s=i?.rotation_period_ms);let n=100;if(Number.isSafeInteger(i?.rotation_period_msgs)&&(n=i?.rotation_period_msgs),this._now()>t+s||e.message_index()>=n)return!0}_encryptContent(e,t,i,s){const n=JSON.stringify({room_id:e,type:i,content:s}),o=t.encrypt(n);return{algorithm:Rt,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:Rt,chain_index:e.message_index()}}}class Mw{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const zc="m.room.encrypted",Gc="m.room.history_visibility",Aw=60*1e3;class Nw{constructor({room:e,deviceTracker:t,olmEncryption:i,megolmEncryption:s,megolmDecryption:n,encryptionParams:o,storage:a,keyBackup:l,notifyMissingMegolmSession:d,clock:c}){this._room=e,this._deviceTracker=t,this._olmEncryption=i,this._megolmEncryption=s,this._megolmDecryption=n,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=l,this._notifyMissingMegolmSession=d,this._clock=c,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._historyVisibility=void 0,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const i=e.filter(c=>c.isEncrypted&&!c.isDecrypted&&c.event).map(c=>c.event),s=qo(i),n=Array.from(s.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(n.map(async c=>this._megolmDecryption.hasSession(this._room.id,c.senderKey,c.sessionId,o))),l=n.filter((c,h)=>!a[h]);if(l.length)for(var d=l.length-1;d>=0;d--){const c=l[d];await t.wrap("session",h=>this._requestMissingSessionFromBackup(c.senderKey,c.sessionId,h))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeSync(e,t,i,s){let n=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility,i);const o=[],a=[];if(await Es(e,d=>{var c;if(d.state_key===""&&d.type===Gc){const h=(c=d?.content)==null?void 0:c.history_visibility;if(h!==n)return s.wrap({l:"history_visibility changed",from:n,to:h},async p=>{n=h;const g=await this._deviceTracker.writeHistoryVisibility(this._room,n,i,p);o.push(...g.added),a.push(...g.removed)})}}),t.size){const d=await this._deviceTracker.writeMemberChanges(this._room,t,n,i);o.push(...d.added),a.push(...d.removed)}a.length&&(s.log({l:"discardOutboundSession",leftUsers:a}),this._megolmEncryption.discardOutboundSession(this._room.id,i));let l=!1;return o.length&&(l=await this._addShareRoomKeyOperationForMembers(o,i,s)),{shouldFlush:l,historyVisibility:n}}afterSync({historyVisibility:e}){this._historyVisibility=e}async _loadHistoryVisibilityIfNeeded(e,t=void 0){var i,s;if(!e){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState]));const n=await t.roomState.get(this._room.id,Gc,"");if(n)return(s=(i=n.event)==null?void 0:i.content)==null?void 0:s.history_visibility}return e}async prepareDecryptAll(e,t,i,s){var n,o,a;const l=new Map,d=[];for(const h of e)h.redacted_because||((n=h.unsigned)==null?void 0:n.redacted_because)||(((o=h.content)==null?void 0:o.algorithm)!==Rt&&l.set(h.event_id,new Error("Unsupported algorithm: "+((a=h.content)==null?void 0:a.algorithm))),d.push(h));const c=await this._megolmDecryption.prepareDecryptAll(this._room.id,d,t,s);return new Dw(c,l,i,this,e)}async _processDecryptionResults(e,t,i,s,n,o){const a=e.filter(d=>{const c=i.get(d.event_id);return c?.code==="MEGOLM_NO_SESSION"});if(!a.length)return;const l=qo(a);s===pi.Sync&&await Promise.all(Array.from(l.values()).map(async d=>{const c=d.events.map(h=>h.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,d.senderKey,d.sessionId,c,n)})),this._keyBackup&&o.wrapDetached("check key backup",async d=>{if(d.set("source",s),d.set("events",a.length),d.set("sessions",l.size),s===pi.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const c=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(l).map(async([h,p])=>{await this._megolmDecryption.hasSession(this._room.id,p.senderKey,p.sessionId,c)&&l.delete(h)}))}await Promise.all(Array.from(l.values()).map(c=>d.wrap("session",h=>this._requestMissingSessionFromBackup(c.senderKey,c.sessionId,h))))})}async _verifyDecryptionResults(e,t){await Promise.all(e.map(async i=>{let s=this._senderDeviceCache.get(i.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(i.senderCurve25519Key,t),this._senderDeviceCache.set(i.senderCurve25519Key,s)),s&&i.setDevice(s)}))}async _fetchKeyAndVerifyDecryptionResults(e,t,i){const s=e.filter(n=>n.isVerificationUnknown);return s.length?i.wrap("fetch unverified senders",async n=>{const o=Array.from(s.reduce((c,h)=>c.add(h.encryptedEvent.sender),new Set));n.set("senders",o),await this._deviceTracker.devicesForUsers(o,t,n);const a=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);await this._verifyDecryptionResults(s,a);const d=s.filter(c=>!c.isVerificationUnknown).reduce((c,h)=>(c.set(h.encryptedEvent.event_id,h),c),new Map);return new zo(d,new Map,this)}):new zo(new Map,new Map,this)}async _requestMissingSessionFromBackup(e,t,i){if(!this._keyBackup){i.set("enabled",!1),this._notifyMissingMegolmSession();return}i.set("id",t),i.set("senderKey",e);try{const s=await this._keyBackup.getRoomKey(this._room.id,t,i);if(s){if(s.senderKey!==e){i.set("wrong_sender_key",s.senderKey),i.logLevel=i.level.Warn;return}let n=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{n=await this._megolmDecryption.writeRoomKey(s,a),i.set("isBetter",n),n&&(o=s.eventIds)}catch(l){throw a.abort(),l}await a.complete(),n&&await i.wrap("retryDecryption",l=>this._room.notifyRoomKey(s,o||[],l))}}catch(s){s.name==="HomeServerError"&&s.errcode==="M_NOT_FOUND"?(i.error=s,i.logLevel=i.level.Error):i.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var i;if(!(((i=this._lastKeyPreShareTime)==null?void 0:i.measure())<Aw)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var s;const n=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);n&&((s=this._keyBackup)==null||s.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(n,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,i,s){var n;this._keySharePromise&&(s.set("waitForRunningKeyShare",!0),await this._keySharePromise);const o=await s.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return o.roomKeyMessage&&((n=this._keyBackup)==null||n.flush(s),await s.wrap("share key",a=>this._shareNewRoomKey(o.roomKeyMessage,i,a))),{type:zc,content:o.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,i){this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,i);const s=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,i),n=Array.from(s.reduce((l,d)=>l.add(d.user_id),new Set));let o=await this._storage.readWriteTxn([this._storage.storeNames.operations]),a;try{a=this._writeRoomKeyShareOperation(e,n,o)}catch(l){throw o.abort(),l}await this._processShareRoomKeyOperation(a,t,i)}async _addShareRoomKeyOperationForMembers(e,t,i){const s=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return s?(i.log({l:"share key for new members",userIds:e,id:s.session_id,chain_index:s.chain_index}),this._writeRoomKeyShareOperation(s,e,t),!0):!1}async flushPendingRoomKeyShares(e,t,i){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const s of t)s.type==="share_room_key"&&await i.wrap("operation",n=>this._processShareRoomKeyOperation(s,e,n))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,i){const n={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return i.operations.add(n),n}async _processShareRoomKeyOperation(e,t,i){i.set("id",e.id),this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,i);const s=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,i),n=await i.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,s,t,a)),o=s.filter(a=>!n.some(l=>l.device===a));await i.wrap("send",a=>this._sendMessagesToDevices(zc,n,t,a)),o.length&&await i.wrap("missingDevices",async a=>{a.set("devices",o.map(c=>c.device_id));const l=e.userIds.filter(c=>o.some(h=>h.user_id===c));a.set("unsentUserIds",l),e.userIds=l,await this._updateOperationsStore(c=>c.update(e));const d=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",d,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(i){throw t.abort(),i}await t.complete()}async _sendSharedMessageToDevices(e,t,i,s,n){const o=As(i,d=>d.user_id),a={messages:Array.from(o.entries()).reduce((d,[c,h])=>(d[c]=h.reduce((p,g)=>(p[g.device_id]=t,p),{}),d),{})},l=et();await s.sendToDevice(e,a,l,{log:n}).response()}async _sendMessagesToDevices(e,t,i,s){s.set("messages",t.length);const n=Ir(t),o=et();await i.sendToDevice(e,n,o,{log:s}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(i=>{var s,n;if(i.isEncrypted&&!i.isDecrypted){const{event:o}=i;if(o){const a=(s=o.content)==null?void 0:s.sender_key,l=(n=o.content)==null?void 0:n.session_id;return t.some(d=>a===d.senderKey&&l===d.sessionId)}}return!1})}dispose(){this._disposed=!0}}class Dw{constructor(e,t,i,s,n){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=i,this._roomEncryption=s,this._events=n}async decrypt(){return new Vw(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class Vw{constructor(e,t,i,s,n){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=i,this._roomEncryption=s,this._events=n}async write(e,t){const{results:i,errors:s}=await this._megolmDecryptionChanges.write(e);return jo(this._extraErrors,s),await this._roomEncryption._processDecryptionResults(this._events,i,s,this._source,e,t),new zo(i,s,this._roomEncryption)}}class zo{constructor(e,t,i){this.results=e,this.errors=t,this._roomEncryption=i}applyToEntries(e,t=void 0){for(const i of e){const s=this.results.get(i.id);if(s)i.setDecryptionResult(s),t?.(i);else{const n=this.errors.get(i.id);n&&(i.setDecryptionError(n),t?.(i))}}}verifyKnownSenders(e){return this._roomEncryption._verifyDecryptionResults(Array.from(this.results.values()),e)}get hasUnverifiedSenders(){for(const e of this.results.values())if(e.isVerificationUnknown)return!0;return!1}fetchAndVerifyRemainingSenders(e,t){return this._roomEncryption._fetchKeyAndVerifyDecryptionResults(Array.from(this.results.values()),e,t)}}class Uw{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new Qd,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}function cu(r,e,t=!1){for(const[i,s]of Object.entries(e)){if(r[i]instanceof Object&&s){cu(r[i],s);continue}if(s!=null||!t){r[i]=s;continue}}return r}/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var Go=(r=>(r.Video="video",r.Audio="audio",r))(Go||{});function yi(r){return r?.getAudioTracks()[0]}function $t(r){return r?.getVideoTracks()[0]}function Ho(r,e,t){return t.wrap("mute",i=>{i.set("cameraMuted",e.camera),i.set("microphoneMuted",e.microphone);const s=yi(r.userMedia);if(s){const o=!e.microphone;i.set("microphone enabled",o),s.enabled=o}const n=$t(r.userMedia);if(n){const o=!e.camera;i.set("camera enabled",o),n.enabled=o}})}class Vs{constructor(e=!1,t=!1,i=!1,s=!1){this.isMicrophoneMuted=e,this.isCameraMuted=t,this.hasMicrophoneTrack=i,this.hasCameraTrack=s}updateTrackInfo(e){this.hasMicrophoneTrack=!!yi(e),this.hasCameraTrack=!!$t(e)}get microphone(){return!this.hasMicrophoneTrack||this.isMicrophoneMuted}get camera(){return!this.hasCameraTrack||this.isCameraMuted}toggleCamera(){return new Vs(this.microphone,!this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}toggleMicrophone(){return new Vs(!this.microphone,this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}equals(e){return this.microphone===e.microphone&&this.camera===e.camera}}const Oi="call",Eo=3600*1e3;var Wo=(r=>(r[r.InviteGlare=0]="InviteGlare",r[r.Handle=1]="Handle",r[r.Ignore=2]="Ignore",r))(Wo||{});class Pw{constructor(e,t){this.userMedia=e,this.screenShare=t}}class Ow{constructor(e,t,i){this.callId=e,this.options=t,this.logItem=i,this._state=j.Fledgling,this.candidateSendQueue=[],this.remoteCandidateBuffer=new Map,this.disposables=new Ks,this.statePromiseMap=new Map,this._remoteTrackToStreamId=new Map,this._remoteStreams=new Map,this.makingOffer=!1,this.ignoreOffer=!1,this.sentEndOfCandidates=!1,this._remoteMuteSettings=new Vs,this.onIceConnectionStateChange=async(n,o)=>{var a,l;if(this._state===j.Ended)return;let d=!1;if(n=="connected")(a=this.iceDisconnectedTimeout)==null||a.abort(),this.iceDisconnectedTimeout=void 0,this.setState(j.Connected,o);else if(n=="failed")d=!0,(l=this.iceDisconnectedTimeout)==null||l.abort(),this.iceDisconnectedTimeout=void 0,await this._hangup(re.IceFailed,o);else if(n=="disconnected"){d=!0,this.iceDisconnectedTimeout=this.options.createTimeout(30*1e3);try{await this.iceDisconnectedTimeout.elapsed(),await this._hangup(re.IceFailed,o)}catch(c){if(!(c instanceof yt))throw c}}if(d){const c=await this.peerConnection.getStats(),h={};c.forEach((p,g)=>{h[g]=p}),o.set("peerConnectionStats",h)}},i.log({l:"create PeerCall",id:e}),this._remoteMedia=new Pw,this.peerConnection=t.webRTC.createPeerConnection(this.options.forceTURN,[this.options.turnServer.get()],0),this.disposables.track(this.options.turnServer.subscribe(n=>{this.logItem.log({l:"updating turn server",turnServer:n}),this.peerConnection.setConfiguration({iceServers:[n]})}));const s=(n,o,a)=>{const l=c=>{this.options.errorBoundary.try(()=>o(c))};this.peerConnection.addEventListener(n,l);const d=()=>{this.peerConnection.removeEventListener(n,l)};this.disposables.track(d)};s("iceconnectionstatechange",async()=>{const n=this.peerConnection.iceConnectionState;await i.wrap({l:"onIceConnectionStateChange",status:n},async o=>{await this.onIceConnectionStateChange(n,o)})}),s("icecandidate",async n=>{await i.wrap("onLocalIceCandidate",async o=>{n.candidate&&await this.handleLocalIceCandidate(n.candidate,o)})}),s("icegatheringstatechange",async()=>{const n=this.peerConnection.iceGatheringState;await i.wrap({l:"onIceGatheringStateChange",status:n},async o=>{await this.handleIceGatheringState(n,o)})}),s("track",n=>{i.wrap("onRemoteTrack",o=>{this.onRemoteTrack(n.track,n.streams,o)})}),s("datachannel",n=>{i.wrap("onRemoteDataChannel",o=>{this._dataChannel=n.channel,this.options.emitUpdate(this,void 0,o)})}),s("negotiationneeded",()=>{var n,o;const a=this.peerConnection.signalingState,l=()=>i.wrap({l:"onNegotiationNeeded",signalingState:a},d=>this.handleNegotiation(d));this.responsePromiseChain=(o=(n=this.responsePromiseChain)==null?void 0:n.then(l))!=null?o:l(),this.responsePromiseChain.catch(d=>this.options.errorBoundary.reportError(d))})}get dataChannel(){return this._dataChannel}get state(){return this._state}get hangupReason(){return this._hangupReason}get remoteMedia(){return this._remoteMedia}get remoteMuteSettings(){return this._remoteMuteSettings}call(e,t,i){return i.wrap("call",async s=>{var n;this._state===j.Fledgling&&(s.set("signalingState",this.peerConnection.signalingState),this.direction=mr.Outbound,this.setState(j.CreateOffer,s),this.localMuteSettings=t,await this.updateLocalMedia(e,s),(n=this.localMedia)!=null&&n.dataChannelOptions&&(this._dataChannel=this.peerConnection.createDataChannel("channel",this.localMedia.dataChannelOptions)),await this.waitForState([j.InviteSent,j.CreateAnswer]))})}answer(e,t,i){return i.wrap("answer",async s=>{if(this._state!==j.Ringing)return;this.setState(j.CreateAnswer,s),this.localMuteSettings=t,await this.updateLocalMedia(e,s);let n;try{n=await this.peerConnection.createAnswer()}catch(o){await s.wrap("Failed to create answer",a=>{a.catch(o),this.terminate(Ye.Local,re.CreateAnswer,a)});return}try{await this.peerConnection.setLocalDescription(n),this.setState(j.Connecting,s)}catch(o){await s.wrap("Error setting local description!",a=>{a.catch(o),this.terminate(Ye.Local,re.SetLocalDescription,a)});return}try{await this.delay(200)}catch{return}await this.sendAnswer(s)})}setMedia(e,t){return t.wrap("setMedia",async i=>{i.set("userMedia_audio",!!yi(e.userMedia)),i.set("userMedia_video",!!$t(e.userMedia)),i.set("screenShare_video",!!$t(e.screenShare)),i.set("datachannel",!!e.dataChannelOptions),await this.updateLocalMedia(e,i);const s={call_id:this.callId,version:1,[Et]:this.getSDPMetadata()};await this.sendSignallingMessage({type:q.SDPStreamMetadataChangedPrefix,content:s},i)})}setMuted(e,t){return t.wrap("setMuted",async i=>{if(this.localMuteSettings=e,i.set("cameraMuted",e.camera),i.set("microphoneMuted",e.microphone),this.localMedia){Ho(this.localMedia,e,i);const s={call_id:this.callId,version:1,[Et]:this.getSDPMetadata()};await this.sendSignallingMessage({type:q.SDPStreamMetadataChangedPrefix,content:s},i)}})}hangup(e,t){return t.wrap("hangup",i=>this._hangup(e,i))}async _hangup(e,t){this._state===j.Ended||this._state===j.Ending||(this.setState(j.Ending,t),await this.sendHangupWithCallId(this.callId,e,t),this.terminate(Ye.Local,e,t))}getMessageAction(e){const t=this.callId===e.content.call_id;return e.type===q.Invite&&!t?0:t?1:2}handleIncomingSignallingMessage(e,t,i){let s;return i.wrap({l:"receive signalling message",type:e.type,callId:e.content.call_id,payload:e.content},async n=>{var o;if(s=n,this.getMessageAction(e)!==1){n.set("wrongCallId",!0);return}switch(e.type){case q.Invite:await this.handleFirstInvite(e.content,t,n);break;case q.Answer:await this.handleAnswer(e.content,t,n);break;case q.Negotiate:await this.onNegotiateReceived(e.content,n);break;case q.Candidates:await this.handleRemoteIceCandidates(e.content,t,n);break;case q.SDPStreamMetadataChanged:case q.SDPStreamMetadataChangedPrefix:this.updateRemoteSDPStreamMetadata(e.content[Et],n);break;case q.Hangup:n.set("reason",e.content.reason),this.terminate(Ye.Remote,(o=e.content.reason)!=null?o:re.UserHangup,n);break;default:n.log(`Unknown event type for call: ${e.type}`);break}}),s}sendHangupWithCallId(e,t,i){const s={call_id:e,version:1};return t&&(s.reason=t),this.sendSignallingMessage({type:q.Hangup,content:s},i)}async handleNegotiation(e){this.makingOffer=!0;try{try{await this.peerConnection.setLocalDescription()}catch(i){e.log("Error setting local description!").catch(i),this.terminate(Ye.Local,re.SetLocalDescription,e);return}if(this.peerConnection.iceGatheringState==="gathering")try{await this.delay(200)}catch{return}if(this._state===j.Ended)return;const t=this.peerConnection.localDescription;if(e.set("includedCandidates",this.candidateSendQueue.length),this.candidateSendQueue=[],this._state===j.CreateOffer){const i={call_id:this.callId,offer:t,[Et]:this.getSDPMetadata(),version:1,lifetime:or};await this.sendSignallingMessage({type:q.Invite,content:i},e),this.setState(j.InviteSent,e)}else if(this._state===j.Connected||this._state===j.Connecting){const i={call_id:this.callId,description:t,[Et]:this.getSDPMetadata(),version:1,lifetime:or};await this.sendSignallingMessage({type:q.Negotiate,content:i},e)}}finally{this.makingOffer=!1}if(this.sendCandidateQueue(e),this._state===j.InviteSent){const t=this.logItem.child("invite timeout");e.refDetached(t),await t.run(async i=>{try{await this.delay(or)}catch{return}this._state===j.InviteSent&&await this._hangup(re.InviteTimeout,i)})}}handleInviteGlare(e,t,i){if(e.type!==q.Invite)return{shouldReplace:!1};const{content:s}=e,n=s.call_id,o=this.callId>n;let a;return i.wrap("handling call glare",async l=>{a=l,o?(l.log("Glare detected: answering incoming call "+n+" and canceling outgoing call "),this._state!==j.Fledgling&&this._state!==j.CreateOffer&&await this.sendHangupWithCallId(this.callId,re.Replaced,l),this.close(re.Replaced,l),this.dispose()):(l.log("Glare detected: rejecting incoming call "+n+" and keeping outgoing call "),await this.sendHangupWithCallId(n,re.Replaced,l))}),{shouldReplace:o,log:a}}handleHangupReceived(e,t){this.terminate(Ye.Remote,e.reason||re.UserHangup,t)}async handleFirstInvite(e,t,i){this._state!==j.Fledgling||this.opponentPartyId!==void 0||await this.handleInvite(e,t,i)}async handleInvite(e,t,i){var s;this.opponentPartyId=t,this.direction=mr.Inbound;const n=e[Et];n?this.updateRemoteSDPStreamMetadata(n,i):i.log("Call did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.offer),await this.addBufferedIceCandidates(i)}catch(o){await i.wrap("Call failed to set remote description",async a=>(a.catch(o),this.terminate(Ye.Local,re.SetRemoteDescription,a)));return}if(this.peerConnection.getReceivers().length===0){await i.wrap("Call no remote stream or no tracks after setting remote description!",async o=>this.terminate(Ye.Local,re.SetRemoteDescription,o));return}this.setState(j.Ringing,i);try{await this.delay((s=e.lifetime)!=null?s:or)}catch{return}this._state===j.Ringing&&(i.log("Invite has expired. Hanging up."),this.hangupParty=Ye.Remote,this.setState(j.Ended,i),this.peerConnection.signalingState!="closed"&&this.peerConnection.close())}async handleAnswer(e,t,i){if(this._state===j.Ended){i.log("Ignoring answer because call has ended");return}if(this.opponentPartyId!==void 0){i.log(`Ignoring answer: we already have an answer/reject from ${this.opponentPartyId}`);return}this.opponentPartyId=t,await this.addBufferedIceCandidates(i),this.setState(j.Connecting,i);const s=e[Et];s?this.updateRemoteSDPStreamMetadata(s,i):i.log("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.answer)}catch(n){await i.wrap("Failed to set remote description",o=>{o.catch(n),this.terminate(Ye.Local,re.SetRemoteDescription,o)});return}}async handleIceGatheringState(e,t){if(e==="complete"&&!this.sentEndOfCandidates){const i={candidate:""};await this.queueCandidate(i,t),this.sentEndOfCandidates=!0}}async handleLocalIceCandidate(e,t){t.set("sdpMid",e.sdpMid),t.set("candidate",e.candidate),this._state!==j.Ended&&(e.candidate!==""||!this.sentEndOfCandidates)&&(await this.queueCandidate(e,t),e.candidate===""&&(this.sentEndOfCandidates=!0))}async handleRemoteIceCandidates(e,t,i){if(this.state===j.Ended){i.log("Ignoring remote ICE candidate because call has ended");return}const s=e.candidates;if(!s){i.log("Ignoring candidates event with no candidates!");return}const n=e.version===0?null:t||null;if(this.opponentPartyId===void 0){i.log(`Buffering ${s.length} candidates until we pick an opponent`);const o=this.remoteCandidateBuffer.get(n)||[];o.push(...s),this.remoteCandidateBuffer.set(n,o);return}if(this.opponentPartyId!==t){i.log(`Ignoring candidates from party ID ${t}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(s,i)}async onNegotiateReceived(e,t){const i=e.description;if(!i||!i.sdp||!i.type){t.log("Ignoring invalid m.call.negotiate event");return}const s=this.direction===mr.Inbound,n=i.type==="offer"&&(this.makingOffer||this.peerConnection.signalingState!=="stable");if(this.ignoreOffer=!s&&n,this.ignoreOffer){t.log("Ignoring colliding negotiate event because we're impolite");return}const o=e[Et];o?this.updateRemoteSDPStreamMetadata(o,t):t.log("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConnection.setRemoteDescription(i),i.type==="offer"){await this.peerConnection.setLocalDescription();const a={call_id:this.callId,description:this.peerConnection.localDescription,[Et]:this.getSDPMetadata(),version:1,lifetime:or};await this.sendSignallingMessage({type:q.Negotiate,content:a},t)}}catch(a){t.log("Failed to complete negotiation").catch(a)}}async sendAnswer(e){const t=this.peerConnection.localDescription,i={call_id:this.callId,version:1,answer:{sdp:t.sdp,type:t.type},[Et]:this.getSDPMetadata()};e.log(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendSignallingMessage({type:q.Answer,content:i},e)}catch(s){throw this.terminate(Ye.Local,re.SendAnswer,e),s}this.sendCandidateQueue(e)}async queueCandidate(e,t){var i;if(this.candidateSendQueue.push(e),this._state===j.Ringing)return;this.flushCandidatesLog=(i=this.flushCandidatesLog)!=null?i:this.logItem.child("flush candidate queue"),t.refDetached(this.flushCandidatesLog);const{flushCandidatesLog:s}=this;try{await this.delay(this.direction===mr.Inbound?500:2e3)}catch{return}this.sendCandidateQueue(s),this.flushCandidatesLog=void 0}async sendCandidateQueue(e){if(this.candidateSendQueue.length===0||this._state===j.Ended)return;const t=this.candidateSendQueue;return this.candidateSendQueue=[],e.wrap({l:"send candidates",size:t.length},async i=>{try{await this.sendSignallingMessage({type:q.Candidates,content:{call_id:this.callId,version:1,candidates:t}},i),await this.sendCandidateQueue(i)}catch(s){i.catch(s),this.terminate(Ye.Local,re.SignallingFailed,i)}})}updateRemoteSDPStreamMetadata(e,t){this.remoteSDPStreamMetadata=cu(this.remoteSDPStreamMetadata||{},e,!0),this.updateRemoteMedia(t)}async addBufferedIceCandidates(e){if(this.remoteCandidateBuffer&&this.opponentPartyId){const t=this.remoteCandidateBuffer.get(this.opponentPartyId);t&&(e.log(`Adding ${t.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(t,e)),this.remoteCandidateBuffer=void 0}}async addIceCandidates(e,t){for(const i of e){let s;(i.sdpMid===null||i.sdpMid===void 0)&&(i.sdpMLineIndex===null||i.sdpMLineIndex===void 0)?s=t.log("Got remote end-of-ICE candidates"):s=t.log(`Adding remote ICE ${i.sdpMid} candidate: ${i.candidate}`);try{await this.peerConnection.addIceCandidate(i)}catch(n){this.ignoreOffer||s.catch(n)}}}setState(e,t){if(e!==this._state){t.log({l:"change state",status:e,oldState:this._state}),this._state,this._state=e;let i=this.statePromiseMap.get(e);i&&(i.resolve(),this.statePromiseMap.delete(e)),this.options.emitUpdate(this,void 0,t)}}waitForState(e){return Promise.race(e.map(t=>{let i=this.statePromiseMap.get(t);if(!i){let s;const n=new Promise(o=>{s=o});i={resolve:s,promise:n},this.statePromiseMap.set(t,i)}return i.promise}))}terminate(e,t,i){this._state!==j.Ended&&(this.hangupParty=e,this._hangupReason=t,this.setState(j.Ended,i),this.localMedia=void 0,this.peerConnection&&this.peerConnection.signalingState!=="closed"&&this.peerConnection.close())}getSDPMetadata(){var e,t,i,s,n,o;const a={};if((e=this.localMedia)!=null&&e.userMedia){const l=this.localMedia.userMedia.id;a[l]={purpose:ai.Usermedia,audio_muted:(i=(t=this.localMuteSettings)==null?void 0:t.microphone)!=null?i:!1,video_muted:(n=(s=this.localMuteSettings)==null?void 0:s.camera)!=null?n:!1}}if((o=this.localMedia)!=null&&o.screenShare){const l=this.localMedia.screenShare.id;a[l]={purpose:ai.Screenshare}}return a}findReceiverForStream(e,t){return this.peerConnection.getReceivers().find(i=>i.track.kind===e&&this._remoteTrackToStreamId.get(i.track.id)===t)}findTransceiverForTrack(e){return this.peerConnection.getTransceivers().find(t=>{var i;return((i=t.sender.track)==null?void 0:i.id)===e.id})}onRemoteTrack(e,t,i){if(i.set("kind",e.kind),i.set("id",e.id),i.set("streams",t.map(n=>n.id)),t.length===0){i.log({l:`ignoring ${e.kind} streamless track`,id:e.id});return}const s=t[0];if(this._remoteTrackToStreamId.set(e.id,s.id),!this._remoteStreams.has(s.id)){const n=a=>{this.logItem.wrap({l:"removetrack",id:a.track.id},l=>{const d=this._remoteTrackToStreamId.get(a.track.id);if(d){this._remoteTrackToStreamId.delete(a.track.id);const c=this._remoteStreams.get(d);c&&c.stream.getTracks().length===0&&(this.disposables.disposeTracked(o),this._remoteStreams.delete(s.id),this.updateRemoteMedia(l))}})};s.addEventListener("removetrack",n);const o=()=>{s.removeEventListener("removetrack",n)};this.disposables.track(o),this._remoteStreams.set(s.id,{disposeListener:o,stream:s})}this.updateRemoteMedia(i)}updateRemoteMedia(e){e.wrap("reevaluating remote media",t=>{var i,s;if(this._remoteMedia.userMedia=void 0,this._remoteMedia.screenShare=void 0,this.remoteSDPStreamMetadata)for(const n of this._remoteStreams.values()){const{stream:o}=n,a=this.remoteSDPStreamMetadata[o.id];if(a)if(a.purpose===ai.Usermedia){this._remoteMedia.userMedia=o;const l=this.findReceiverForStream(Go.Audio,o.id);l&&(l.track.enabled=!a.audio_muted);const d=this.findReceiverForStream(Go.Video,o.id);d&&(d.track.enabled=!a.video_muted),this._remoteMuteSettings=new Vs((i=a.audio_muted)!=null?i:!1,(s=a.video_muted)!=null?s:!1,!!l?.track,!!d?.track),t.log({l:"setting userMedia",micMuted:this._remoteMuteSettings.microphone,cameraMuted:this._remoteMuteSettings.camera})}else a.purpose===ai.Screenshare&&(this._remoteMedia.screenShare=o,t.log("setting screenShare"));else t.log({l:"no metadata yet for stream, ignoring for now",id:o.id})}this.options.emitUpdate(this,void 0,t)})}updateLocalMedia(e,t){return t.wrap("updateLocalMedia",async i=>{var s,n;const o=this.peerConnection.getSenders(),a=async(l,d,c)=>{const h=async(p,g)=>{const y=o.find(x=>x.track===p),w=l??d;if(w!==d&&(p&&(w.removeTrack(p),p.stop()),g&&w.addTrack(g)),g&&y)try{await i.wrap(`attempting to replace ${c} ${g.kind} track`,x=>y.replaceTrack(g));return}catch{}y&&i.wrap(`removing ${c} ${y.track.kind} track`,x=>{this.peerConnection.removeTrack(y)}),g&&i.wrap(`adding ${c} ${g.kind} track`,x=>{const M=this.peerConnection.addTrack(g,w);this.options.webRTC.prepareSenderForPurpose(this.peerConnection,M,c)})};!l&&!d||(await h(yi(l),yi(d)),await h($t(l),$t(d)))};await a((s=this.localMedia)==null?void 0:s.userMedia,e?.userMedia,ai.Usermedia),await a((n=this.localMedia)==null?void 0:n.screenShare,e?.screenShare,ai.Screenshare),this.localMedia||(this.localMedia=e)})}async delay(e){const t=this.disposables.track(this.options.createTimeout(e));try{await t.elapsed()}finally{this.disposables.untrack(t)}}sendSignallingMessage(e,t){return t.wrap({l:"send",id:e.type},async i=>this.options.sendSignallingMessage(e,i))}dispose(){var e;this.disposables.dispose(),(e=this.iceDisconnectedTimeout)==null||e.abort(),this.peerConnection.close(),this.options.emitUpdate=(t,i,s)=>{s.log("emitting update from PeerCall after disposal",this.logItem.level.Error),console.trace("emitting update from PeerCall after disposal")}}close(e,t){e===void 0&&(e=re.UserHangup),this.terminate(Ye.Local,e,t)}}var Ye=(r=>(r.Local="local",r.Remote="remote",r))(Ye||{}),j=(r=>(r.Fledgling="fledgling",r.CreateOffer="create_offer",r.InviteSent="invite_sent",r.CreateAnswer="create_answer",r.Connecting="connecting",r.Connected="connected",r.Ringing="ringing",r.Ending="ending",r.Ended="ended",r))(j||{}),mr=(r=>(r.Inbound="inbound",r.Outbound="outbound",r))(mr||{});const or=6e4;function Fw(r){return r===q.Invite||r===q.Candidates||r===q.Answer||r===q.Hangup||r===q.SDPStreamMetadataChanged||r===q.SDPStreamMetadataChangedPrefix||r===q.Negotiate}class lu{constructor(e){this.errorCallback=e}try(e,t){try{let i=e();return i instanceof Promise&&(i=i.catch(s=>(this._error=s,this.reportError(s),t))),i}catch(i){return this._error=i,this.reportError(i),t}}reportError(e){try{this.errorCallback(e)}catch(t){console.error("error in ErrorBoundary callback",t)}}get error(){return this._error}}const Lw=[re.UserHangup,re.AnsweredElsewhere,re.Replaced,re.UserBusy,re.Transfered,re.NewSession];class Bw{constructor(e,t,i,s){this.localMedia=e,this.localMuteSettings=t,this.turnServer=i,this.logItem=s,this.retryCount=0,this.queuedSignallingMessages=[],this.outboundSeqCounter=0}get canDequeueNextSignallingMessage(){if(this.queuedSignallingMessages.length===0)return!1;const t=this.queuedSignallingMessages[0].content.seq;return this.lastIgnoredSeqNr!==void 0&&t===this.lastIgnoredSeqNr+1?!0:this.lastProcessedSeqNr===void 0?t===0:t<=this.lastProcessedSeqNr+1}dispose(){var e;(e=this.peerCall)==null||e.dispose(),this.localMedia.dispose(),this.logItem.finish()}}class Kw{constructor(e,t,i,s){this.member=e,this.callDeviceMembership=t,this.options=i,this.errorBoundary=new lu(n=>{this.options.emitUpdate(this,"error"),this.connection&&this.connection.logItem.log("error at boundary").catch(n)}),this.emitUpdateFromPeerCall=async(n,o,a)=>{const l=this.connection;if(n.state===j.Ringing)l.logItem.wrap("ringing, answer peercall",d=>(a.refDetached(d),n.answer(l.localMedia,l.localMuteSettings,d)));else if(n.state===j.Ended){const d=n.hangupReason;if(n.dispose(),l.peerCall=void 0,d&&!Lw.includes(d)){l.retryCount+=1;const{retryCount:c}=l;await l.logItem.wrap({l:"retry connection",retryCount:c},async h=>{if(a.refDetached(h),c<=3)await this.callIfNeeded(h);else{const p=await this.disconnect(!1);p&&h.refDetached(p)}})}}this.options.emitUpdate(this,o)},this.sendSignallingMessage=async(n,o)=>{const a=n;a.content.seq=this.connection.outboundSeqCounter++,a.content.conf_id=this.options.confId,a.content.device_id=this.options.ownDeviceId,a.content.party_id=this.options.ownDeviceId,a.content.sender_session_id=this.options.sessionId,a.content.dest_session_id=this.sessionId;let l,d=n.type;const c=await this.options.encryptDeviceMessage(this.member.userId,this.deviceId,a,o);c?(l=Ir(c),d="m.room.encrypted"):l=Ir([{content:a.content,device:this}]),o.set("payload",a.content),await this.options.hsApi.sendToDevice(d,l,et(),{log:o}).response()},this._renewExpireTimeout(s)}get error(){return this.errorBoundary.error}get usesFoci(){const e=this.callDeviceMembership["m.foci.active"];return Array.isArray(e)&&e.length>0}_renewExpireTimeout(e){var t;(t=this.expireTimeout)==null||t.dispose(),this.expireTimeout=void 0;const i=zn(this.callDeviceMembership);if(typeof i!="number")return;const s=Math.max(0,i-this.options.clock.now());e?.set("expiresIn",s),this.expireTimeout=this.options.clock.createTimeout(s+10),this.expireTimeout.elapsed().then(()=>{this.options.emitUpdate(this,"isExpired")},n=>{})}get logItem(){var e;return(e=this.connection)==null?void 0:e.logItem}get remoteMedia(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMedia}get isExpired(){return!this.isConnected&&Yo(this.callDeviceMembership,this.options.clock.now())}get remoteMuteSettings(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMuteSettings}get isConnected(){var e,t;return((t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.state)===j.Connected}get userId(){return this.member.userId}get deviceId(){return this.callDeviceMembership.device_id}get user_id(){return this.userId}get device_id(){return this.deviceId}get sessionId(){return this.callDeviceMembership.session_id}get dataChannel(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.dataChannel}connect(e,t,i,s){return this.errorBoundary.try(async()=>{if(this.connection)return;const n=new Bw(e.clone(),t,i,s);this.connection=n;let o;return await n.logItem.wrap("connect",async a=>{o=a,await this.callIfNeeded(a)}),o})}callIfNeeded(e){return e.wrap("callIfNeeded",async t=>{let i;if(this.member.userId===this.options.ownUserId?i=this.deviceId>this.options.ownDeviceId:i=this.member.userId>this.options.ownUserId,i){const s=this.connection;s.peerCall=this._createPeerCall(Bn("c")),await s.peerCall.call(s.localMedia,s.localMuteSettings,t)}else t.set("wait_for_invite",!0)})}disconnect(e){return this.errorBoundary.try(async()=>{const{connection:t}=this;if(!t)return;let i;return await t.logItem.wrap("disconnect",async s=>{i=s,e&&t.peerCall&&await t.peerCall.hangup(re.UserHangup,s)}),t.dispose(),this.connection=void 0,i})}updateCallInfo(e,t){this.errorBoundary.try(()=>{this.callDeviceMembership=e,this._renewExpireTimeout(t),this.connection&&this.connection.logItem.refDetached(t)})}updateRoomMember(e){this.member=e,this.options.emitUpdate(this)}handleDeviceMessage(e,t){this.errorBoundary.try(()=>{var i;t.wrap({l:"Member.handleDeviceMessage",type:e.type,seq:(i=e.content)==null?void 0:i.seq},s=>{const{connection:n}=this;if(n){const o=e.content.dest_session_id;if(o!==this.options.sessionId){const d=n.logItem.log({l:"ignoring to_device event with wrong session_id",destSessionId:o,type:e.type});s.refDetached(d);return}if(n.peerCall&&n.peerCall.getMessageAction(e)===Wo.InviteGlare){const{shouldReplace:c,log:h}=n.peerCall.handleInviteGlare(e,this.deviceId,n.logItem);h&&h.refDetached(h),c&&(n.peerCall.dispose(),n.peerCall=void 0)}e.type===q.Invite&&!n.peerCall&&(n.peerCall=this._createPeerCall(e.content.call_id));const a=Gt(n.queuedSignallingMessages,e,(d,c)=>d.content.seq-c.content.seq);n.queuedSignallingMessages.splice(a,0,e);let l=!1;n.peerCall&&(l=this.dequeueSignallingMessages(n,n.peerCall,e,s)),l||s.refDetached(n.logItem.log({l:"queued message",type:e.type,seq:e.content.seq,idx:a}))}else t.log({l:"member not connected",userId:this.userId,deviceId:this.deviceId})})})}dequeueSignallingMessages(e,t,i,s){let n=!1;for(;e.canDequeueNextSignallingMessage;){const o=e.queuedSignallingMessages.shift(),a=o===i;n=n||a,s.wrap(a?"process message":"dequeue message",l=>{var d;const c=(d=o.content)==null?void 0:d.seq;if(l.set("seq",c),l.set("type",o.type),t.getMessageAction(o)===Wo.Handle){const p=t.handleIncomingSignallingMessage(o,this.deviceId,e.logItem);l.refDetached(p),e.lastProcessedSeqNr=c}else l.set("ignored",!0),e.lastIgnoredSeqNr=c})}return n}async setMedia(e,t){return this.errorBoundary.try(async()=>{var i;const{connection:s}=this;s&&(s.localMedia=e.replaceClone(s.localMedia,t),await((i=s.peerCall)==null?void 0:i.setMedia(s.localMedia,s.logItem)))})}async setMuted(e){return this.errorBoundary.try(async()=>{var t;const{connection:i}=this;i&&(i.localMuteSettings=e,await((t=i.peerCall)==null?void 0:t.setMuted(e,i.logItem)))})}_createPeerCall(e){const t=this.connection;return new Ow(e,Object.assign({},this.options,{errorBoundary:this.errorBoundary,emitUpdate:this.emitUpdateFromPeerCall,sendSignallingMessage:this.sendSignallingMessage,turnServer:t.turnServer}),t.logItem)}dispose(){var e,t;(e=this.connection)==null||e.dispose(),this.connection=void 0,(t=this.expireTimeout)==null||t.dispose(),this.expireTimeout=void 0,this.options.emitUpdate=()=>{}}}function zn(r){const e=r.expires_ts;if(Number.isSafeInteger(e))return e}function Yo(r,e,t=0){const i=zn(r);return typeof i=="number"?i+t<=e:!0}function fs(r,e){return JSON.stringify(r)+","+JSON.stringify(e)}function Hc(r,e){return r.startsWith(JSON.stringify(e)+",")}function $w(r){return JSON.parse(`[${r}]`)[1]}class jw{constructor(e,t,i,s,n,o){this.logItem=e,this.membersLogItem=t,this.localMedia=i,this.localPreviewMedia=s,this.localMuteSettings=n,this.turnServer=o}dispose(){var e;this.localMedia.dispose(),this.localPreviewMedia.dispose(),this.logItem.finish(),(e=this.renewMembershipTimeout)==null||e.dispose()}}class ko extends Mt{constructor(e,t,i,s,n,o,a){super(),this.id=e,this.isLoadedFromStorage=t,this.startTime=s,this.callContent=n,this.roomId=o,this.options=a,this._members=new Ht,this.bufferedDeviceMessages=new Map,this.errorBoundary=new lu(l=>{this.emitChange(),this.joinedData&&(this.joinedData.logItem.log("error at boundary").catch(l),console.error(l))}),this._state=i?"fledgling":"created",this._memberOptions=Object.assign({},a,{confId:this.id,emitUpdate:l=>{var d;const c=fs(l.userId,l.deviceId);if(l.isExpired&&!l.isConnected){const h=this.options.logger.log({l:"removing expired member from call",memberKey:c,callId:this.id});(d=l.logItem)==null||d.refDetached(h),l.dispose(),this._members.remove(c)}else this._members.update(c)},encryptDeviceMessage:(l,d,c,h)=>this.options.encryptDeviceMessage(this.roomId,l,d,c,h)})}get localMedia(){var e;return(e=this.joinedData)==null?void 0:e.localMedia}get localPreviewMedia(){var e;return(e=this.joinedData)==null?void 0:e.localPreviewMedia}get members(){return this._members}get isTerminated(){var e;return!!((e=this.callContent)!=null&&e["m.terminated"])}get usesFoci(){for(const e of this._members.values())if(e.usesFoci)return!0;return!1}get duration(){if(typeof this.startTime=="number")return this.options.clock.now()-this.startTime}get isRinging(){return this._state==="created"&&this.intent==="m.ring"&&!this.isMember(this.options.ownUserId)}get name(){var e;return(e=this.callContent)==null?void 0:e["m.name"]}get intent(){var e;return(e=this.callContent)==null?void 0:e["m.intent"]}get type(){var e;return(e=this.callContent)==null?void 0:e["m.type"]}get logItem(){var e;return(e=this.joinedData)==null?void 0:e.logItem}get error(){return this.errorBoundary.error}join(e,t){return this.options.logger.wrapOrRun(t,"Call.join",async i=>{if(this._state!=="created"||this.joinedData||this.usesFoci){e.dispose();return}const s=this.options.logger.child({l:"Call.connection",t:Oi,id:this.id,ownSessionId:this.options.sessionId}),n=await this.options.turnServerSource.getSettings(s),o=s.child("member connections"),a=new Vs;a.updateTrackInfo(e.userMedia);const l=e.asPreview(),d=new jw(s,o,e,l,a,n);this.joinedData=d,await d.logItem.wrap("join",async c=>{i.refDetached(c),this._state="joining",this.emitChange(),await c.wrap("update member state",async h=>{const p=await this._createMemberPayload(!0);h.set("payload",p),await this.options.hsApi.sendState(this.roomId,q.GroupCallMember,this.options.ownUserId,p,{log:h}).response(),this.emitChange()});for(const h of this._members.values())this.connectToMember(h,d,c)})})}async setMedia(e){var t;if((this._state==="joining"||this._state==="joined")&&this.joinedData){const i=this.joinedData.localMedia;this.joinedData.localMedia=e,(t=this.joinedData.localPreviewMedia)==null||t.dispose(),this.joinedData.localPreviewMedia=e.asPreview(),this.joinedData.localMuteSettings.updateTrackInfo(e.userMedia),this.emitChange(),await Promise.all(Array.from(this._members.values()).map(s=>s.setMedia(e,i))),i?.dispose()}}async setMuted(e){const{joinedData:t}=this;if(!t)return;const i=t.localMuteSettings;e.updateTrackInfo(t.localMedia.userMedia),t.localMuteSettings=e,i.equals(e)||(this.localPreviewMedia&&Ho(this.localPreviewMedia,e,this.joinedData.logItem),this.localMedia&&Ho(this.localMedia,e,this.joinedData.logItem),await Promise.all(Array.from(this._members.values()).map(s=>s.setMuted(t.localMuteSettings))),this.emitChange())}get muteSettings(){var e;return(e=this.joinedData)==null?void 0:e.localMuteSettings}get hasJoined(){return this._state==="joining"||this._state==="joined"}async leave(e){await this.options.logger.wrapOrRun(e,"Call.leave",async t=>{var i;const{joinedData:s}=this;if(!!s)try{(i=s.renewMembershipTimeout)==null||i.dispose(),s.renewMembershipTimeout=void 0;const n=await this._createMemberPayload(!1);n?(await this.options.hsApi.sendState(this.roomId,q.GroupCallMember,this.options.ownUserId,n,{log:t}).response(),(this.intent===Cr.Ring||this.intent===Cr.Prompt)&&this._members.size===0&&await this.terminate(t)):t.set("already_left",!0)}finally{if(!this.disconnect(t))throw this.errorBoundary.error}})}terminate(e){return this.options.logger.wrapOrRun(e,{l:"terminate call",t:Oi},async t=>{if(this._state==="fledgling")return;await this.options.hsApi.sendState(this.roomId,q.GroupCall,this.id,Object.assign({},this.callContent,{"m.terminated":!0}),{log:t}).response()})}create(e,t){return t.wrap({l:"create call",t:Oi},async i=>{if(this._state!=="fledgling")return;this._state="creating",this.emitChange(),this.callContent=Object.assign({"m.type":e},this.callContent),await this.options.hsApi.sendState(this.roomId,q.GroupCall,this.id,this.callContent,{log:i}).response(),this._state="created",this.emitChange()})}updateCallEvent(e,t){this.errorBoundary.try(()=>{t.wrap({l:"update call",t:Oi,id:this.id},i=>{typeof this.startTime!="number"&&(this.startTime=e.origin_server_ts),this.callContent=e.content,this._state==="creating"&&(this._state="created"),i.set("status",this._state),this.emitChange()})})}updateRoomMembers(e){this.errorBoundary.try(()=>{for(const t of e.values()){const{member:i}=t;for(const s of this._members.values())s.userId===i.userId&&s.updateRoomMember(i)}})}updateMembership(e,t,i,s){this.errorBoundary.try(async()=>{await s.wrap({l:"update call membership",t:Oi,id:this.id,userId:e},async n=>{const o=this.options.clock.now(),a=i["m.devices"],l=this.getDeviceIdsForUserId(e);for(const c of a){const h=c.device_id,p=fs(e,h);e===this.options.ownUserId&&h===this.options.ownDeviceId?n.wrap("update own membership",g=>{this.hasJoined&&(this.joinedData&&this.joinedData.logItem.refDetached(g),this._setupRenewMembershipTimeout(c,g)),this._state==="joining"&&(g.set("joined",!0),this._state="joined",this.emitChange())}):await n.wrap({l:"update device membership",id:p,sessionId:c.session_id},async g=>{if(Yo(c,o)){g.set("expired",!0);const x=this._members.get(p);x?(x.dispose(),this._members.remove(p),g.set("removed",!0)):g.discard();return}let y=this._members.get(p);const w=y&&y.sessionId!==c.session_id;if(y&&!w)g.set("update",!0),y.updateCallInfo(c,g);else{if(y&&w){g.set("removedSessionId",y.sessionId);const x=await y.disconnect(!1);x&&g.refDetached(x),y.dispose(),this._members.remove(p),y=void 0}g.set("add",!0),y=new Kw(t,c,this._memberOptions,g),this._members.add(p,y),this.joinedData&&this.connectToMember(y,this.joinedData,g)}this.flushPendingIncomingDeviceMessages(y,g)})}const d=new Set(a.map(c=>c.device_id));for(const c of l)d.has(c)||this.removeMemberDevice(e,c,n);e===this.options.ownUserId&&!d.has(this.options.ownDeviceId)&&this.removeOwnDevice(n)})})}removeMembership(e,t){this.errorBoundary.try(()=>{const i=this.getDeviceIdsForUserId(e);t.wrap({l:"remove call member",t:Oi,id:this.id,userId:e},s=>{for(const n of i)this.removeMemberDevice(e,n,s);e===this.options.ownUserId&&this.removeOwnDevice(s)})})}flushPendingIncomingDeviceMessages(e,t){const i=fs(e.userId,e.deviceId),s=this.bufferedDeviceMessages.get(i);if(s){for(const n of s)n.content.sender_session_id===e.sessionId&&(e.handleDeviceMessage(n,t),s.delete(n));s.size===0&&this.bufferedDeviceMessages.delete(i)}}getDeviceIdsForUserId(e){return Array.from(this._members.keys()).filter(t=>Hc(t,e)).map(t=>$w(t))}isMember(e){return Array.from(this._members.keys()).some(t=>Hc(t,e))}removeOwnDevice(e){e.wrap("remove own membership",t=>{this.disconnect(t)})}disconnect(e){return this.errorBoundary.try(async()=>{var t;if(this.hasJoined){for(const i of this._members.values()){const s=await i.disconnect(!0);s&&e.refDetached(s)}this._state="created"}(t=this.joinedData)==null||t.dispose(),this.joinedData=void 0,this.emitChange()},!1)||!0}async removeMemberDevice(e,t,i){const s=fs(e,t);await i.wrap({l:"remove device member",id:s},async n=>{const o=this._members.get(s);if(o){n.set("leave",!0);const a=await o.disconnect(!1);a&&n.refDetached(a),o.dispose(),this._members.remove(s)}})}handleDeviceMessage(e,t,i,s){this.errorBoundary.try(()=>{const n=fs(t,i);let o=this._members.get(n);if(o&&e.content.sender_session_id===o.sessionId)o.handleDeviceMessage(e,s);else{s.log({l:"call: buffering to_device message, member not found",t:Oi,id:this.id,userId:t,deviceId:i,sessionId:e.content.sender_session_id,type:e.type});let a=this.bufferedDeviceMessages.get(n);a||(a=new Set,this.bufferedDeviceMessages.set(n,a)),a.add(e)}})}async _createMemberPayload(e){var t,i;const{storage:s}=this.options,o=await(await s.readTxn([s.storeNames.roomState])).roomState.get(this.roomId,q.GroupCallMember,this.options.ownUserId),a=(i=(t=o?.event)==null?void 0:t.content)!=null?i:{["m.calls"]:[]};let l=a["m.calls"],d=l.find(h=>h["m.call_id"]===this.id);d||(d={["m.call_id"]:this.id,["m.devices"]:[]},l.push(d));const c=this.options.clock.now();return d["m.devices"]=d["m.devices"].filter(h=>!(h.device_id===this.options.ownDeviceId||zn(h)===void 0||Yo(h,c,Eo))),e&&d["m.devices"].push({device_id:this.options.ownDeviceId,session_id:this.options.sessionId,expires_ts:c+Eo,feeds:[{purpose:"m.usermedia"}]}),a["m.calls"]=l.filter(h=>h["m.devices"].length!==0),a}async connectToMember(e,t,i){const s=fs(e.userId,e.deviceId),n=t.membersLogItem.child({l:"member",id:s,sessionId:e.sessionId});await i.wrap({l:"connect",id:s},async o=>{const a=await e.connect(t.localMedia,t.localMuteSettings,t.turnServer,n);a&&o.refDetached(a)})}emitChange(){this.emit("change"),this.options.emitUpdate(this)}_setupRenewMembershipTimeout(e,t){var i;const{joinedData:s}=this;if(!s)return;(i=s.renewMembershipTimeout)==null||i.dispose(),s.renewMembershipTimeout=void 0;const n=zn(e);if(typeof n!="number")return;const o=n-this.options.clock.now(),a=Math.max(1e4,Math.ceil((.2+this.options.random()*.8)*(.08333*Eo))),l=Math.max(0,o-a);t.set("expiresIn",o),t.set("renewIn",l),s.renewMembershipTimeout=this.options.clock.createTimeout(l),s.renewMembershipTimeout.elapsed().then(()=>{s.logItem.wrap("renew membership",async d=>{const c=await this._createMemberPayload(!0);d.set("payload",c),await this.options.hsApi.sendState(this.roomId,q.GroupCallMember,this.options.ownUserId,c,{log:d}).response()})},()=>{})}dispose(){var e;(e=this.joinedData)==null||e.dispose();for(const t of this._members.values())t.dispose()}}const Wc=5*60,qw={urls:["stun:turn.matrix.org"],username:"",credential:""};class zw{constructor(e,t,i=qw){this.hsApi=e,this.clock=t,this.defaultSettings=i,this.isPolling=!1}getSettings(e){return e.wrap("get turn server",async t=>{if(!this.isPolling){const i=await this.doRequest(t),s=i?Yc(i):this.defaultSettings;t.set("iceServer",s),this.currentObservable?this.currentObservable.set(s):this.currentObservable=new kr(s,()=>{this.stopPollLoop()},()=>{var n;this.runLoop((n=i?.ttl)!=null?n:Wc)})}return this.currentObservable})}async runLoop(e){let t=e;for(this.isPolling=!0;this.isPolling;)try{this.pollTimeout=this.clock.createTimeout(t*1e3),await this.pollTimeout.elapsed(),this.pollTimeout=void 0;const i=await this.doRequest(void 0);if(i){const s=Yc(i);Gw(this.currentObservable,s)&&this.currentObservable.set(s),i.ttl>0?t=i.ttl:this.stopPollLoop()}else t=Wc}catch(i){i.name}}async doRequest(e){try{return this.pollRequest=this.hsApi.getTurnServer({log:e}),await this.pollRequest.response()}catch(t){if(t.name==="HomeServerError")return;throw t}finally{this.pollRequest=void 0}}stopPollLoop(){var e,t;this.isPolling=!1,this.currentObservable=void 0,(e=this.pollTimeout)==null||e.dispose(),this.pollTimeout=void 0,(t=this.pollRequest)==null||t.abort(),this.pollRequest=void 0}dispose(){this.stopPollLoop()}}function Gw(r,e){const t=r.get();if(!t)return!0;const i=Array.isArray(t.urls)?t.urls:[t.urls],s=Array.isArray(e.urls)?e.urls:[e.urls];return!(i.length===s.length&&!s.some(o=>!i.includes(o)))||e.username!==t.username||e.credential!==t.credential}function Yc(r){return{urls:r.uris,username:r.username,credential:r.password,credentialType:"password"}}function Hw(r,e){return JSON.stringify(r)+","+JSON.stringify(e)}class Ww{constructor(e){this.options=e,this._calls=new Ht,this.roomMemberToCallIds=new Map,this.sessionId=Bn("s"),this.groupCallOptions=Object.assign({},this.options,{turnServerSource:new zw(this.options.hsApi,this.options.clock),emitUpdate:(t,i)=>this._calls.update(t.id,i),createTimeout:this.options.clock.createTimeout,sessionId:this.sessionId})}loadCalls(e,t){return this.options.logger.wrapOrRun(t,"CallHandler.loadCalls",async i=>{e||(e=Cr.Ring),i.set("intent",e);const s=await this._getLoadTxn(),n=await s.calls.getByIntent(e);await this._loadCallEntries(n,s,i)})}loadCallsForRoom(e,t,i){return this.options.logger.wrapOrRun(i,"CallHandler.loadCallsForRoom",async s=>{s.set("intent",e),s.set("roomId",t);const n=await this._getLoadTxn(),o=await n.calls.getByIntentAndRoom(e,t);await this._loadCallEntries(o,n,s)})}async _getLoadTxn(){const e=this.options.storage.storeNames;return await this.options.storage.readTxn([e.calls,e.roomState])}async _loadCallEntries(e,t,i){i.set("entries",e.length),await Promise.all(e.map(async n=>{if(this._calls.get(n.callId))return;const o=await t.roomState.get(n.roomId,q.GroupCall,n.callId);if(o){const a=new ko(o.event.state_key,!0,!1,n.timestamp,o.event.content,o.roomId,this.groupCallOptions);this._calls.set(a.id,a)}}));const s=Array.from(new Set(e.map(n=>n.roomId)));await Promise.all(s.map(async n=>{const o=await t.roomState.getAllForType(n,q.GroupCallMember);await Promise.all(o.map(async a=>{const l=a.event.sender,d=await t.roomState.get(n,st,l);let c;d&&(c=Q.fromMemberEvent(d.event)),c||(c=Q.fromUserId(n,l,"join")),this.handleCallMemberEvent(a.event,c,n,i)}))})),i.set("newSize",this._calls.size)}createCall(e,t,i,s,n){return this.options.logger.wrapOrRun(n,"CallHandler.createCall",async o=>{s||(s=Cr.Ring);const a=new ko(Bn("conf-"),!1,!0,void 0,{"m.name":i,"m.intent":s},e,this.groupCallOptions);this._calls.set(a.id,a);try{await a.create(t,o);const l=await this.options.storage.readWriteTxn([this.options.storage.storeNames.calls]);l.calls.add({intent:a.intent,callId:a.id,timestamp:this.options.clock.now(),roomId:e}),await l.complete()}catch(l){throw this._calls.remove(a.id),l}return a})}get calls(){return this._calls}async handleRoomState(e,t,i,s,n){if(t.type===q.GroupCall&&this.handleCallEvent(t,e.id,s,n),t.type===q.GroupCallMember){let o=await i.lookupMemberAtEvent(t.sender,t,s);o||(o=Q.fromUserId(e.id,t.sender,"join")),this.handleCallMemberEvent(t,o,e.id,n)}}updateRoomMembers(e,t){for(const i of this._calls.values())i.roomId===e.id&&i.updateRoomMembers(t)}handlesDeviceMessageEventType(e){return Fw(e)}handleDeviceMessage(e,t,i,s){const n=this._calls.get(e.content.conf_id);n?.handleDeviceMessage(e,t,i,s)}handleCallEvent(e,t,i,s){const n=e.state_key;let o=this._calls.get(n);o?(o.updateCallEvent(e,s),o.isTerminated&&(o.disconnect(s),this._calls.remove(o.id),i.calls.remove(o.intent,t,o.id))):e.content["m.terminated"]||(o=new ko(e.state_key,!1,!1,e.origin_server_ts,e.content,t,this.groupCallOptions),this._calls.set(o.id,o),i.calls.add({intent:o.intent,callId:o.id,timestamp:e.origin_server_ts,roomId:t}))}handleCallMemberEvent(e,t,i,s){var n;const o=e.state_key,a=Hw(i,o),l=(n=e.content["m.calls"])!=null?n:[];for(const h of l){const p=h["m.call_id"],g=this._calls.get(p);g?.updateMembership(o,t,h,s)}const d=new Set(l.map(h=>h["m.call_id"]));let c=this.roomMemberToCallIds.get(a);if(c){for(const h of c)if(!d.has(h)){const p=this._calls.get(h);p?.removeMembership(o,s)}}d.size===0?this.roomMemberToCallIds.delete(a):this.roomMemberToCallIds.set(a,d)}dispose(){this.groupCallOptions.turnServerSource.dispose();for(const e of this._calls.values())e.dispose()}}class Yw extends Xn{async handleRoomState(e,t,i,s,n){const o=[];for(let a of this._handlers)o.push(a.handleRoomState(e,t,i,s,n));await Promise.all(o)}updateRoomMembers(e,t){for(let i of this._handlers)i.updateRoomMembers(e,t)}}class yr{constructor(e=0){this.flags=e}withFeature(e){return new yr(this.flags|e)}withoutFeature(e){return new yr(this.flags^e)}isFeatureEnabled(e){return(this.flags&e)!==0}get calls(){return this.isFeatureEnabled(1)}get crossSigning(){return this.isFeatureEnabled(2)}static async load(e){const t=await e.getInt("enabled_features")||0;return new yr(t)}async store(e){await e.setInt("enabled_features",this.flags)}}const Fi="DEFAULT_KEY",ar="pusher";class Jw{constructor({storage:e,hsApi:t,sessionInfo:i,olm:s,olmWorker:n,platform:o,mediaRepository:a,features:l}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._features=l,this._syncInfo=null,this._sessionInfo=i,this._rooms=new Ht,this._roomUpdateCallback=(d,c)=>this._rooms.update(d.id,c),this._activeArchivedRooms=new Map,this._invites=new Ht,this._inviteUpdateCallback=(d,c)=>this._invites.update(d.id,c),this._roomsBeingCreatedUpdateCallback=(d,c)=>{d.isCancelled?this._roomsBeingCreated.remove(d.id):this._roomsBeingCreated.update(d.id,c)},this._roomsBeingCreated=new Ht,this._user=new kv(i.userId),this._roomStateHandler=new Yw,l.calls&&this._setupCallHandler(),this._deviceMessageHandler=new Zv({storage:e,callHandler:this._callHandler}),this._olm=s,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=n,this._keyBackup=new fi(void 0),this._crossSigning=new fi(void 0),this._observedRoomStatus=new Map,s&&(this._olmUtil=new s.Utility,this._deviceTracker=new zp({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:i.userId,ownDeviceId:i.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new fi(!1),this._secretFetcher=new nf,this._secretSharing=null,this._secretStorage=null}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}get callHandler(){return this._callHandler}get features(){return this._features}_setupCallHandler(){this._callHandler=new Ww({clock:this._platform.clock,random:this._platform.random,hsApi:this._hsApi,encryptDeviceMessage:async(e,t,i,s,n)=>{if(!this._deviceTracker||!this._olmEncryption){n.set("encryption_disabled",!0);return}const o=await n.wrap("get device key",async a=>{const l=this._deviceTracker.deviceForId(t,i,this._hsApi,a);return l||a.set("not_found",!0),l});if(o)return await this._olmEncryption.encrypt(s.type,s.content,[o],this._hsApi,n)},storage:this._storage,webRTC:this._platform.webRTC,ownDeviceId:this._sessionInfo.deviceId,ownUserId:this._sessionInfo.userId,logger:this._platform.logger,forceTURN:!1}),this.observeRoomState(this._callHandler)}async _setupEncryption(){const e=new Uw,t=new nw(this._e2eeAccount,Fi,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new lw(this._e2eeAccount,Fi,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new Ew(this._olm,Fi,20),this._megolmEncryption=new Cw({account:this._e2eeAccount,pickleKey:Fi,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new Sw(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption}),this._secretSharing=new of({hsApi:this._hsApi,storage:this._storage,deviceMessageHandler:this._deviceMessageHandler,deviceTracker:this._deviceTracker,ourUserId:this.userId,olmEncryption:this._olmEncryption,crypto:this._platform.crypto,encoding:this._platform.encoding,crossSigning:this._crossSigning,logger:this._platform.logger}),await this._secretSharing.load(),this._secretFetcher.setSecretSharing(this._secretSharing)}_createRoomEncryption(e,t){var i;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==Rt?null:new Nw({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(i=this._keyBackup)==null?void 0:i.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,i=void 0){return this._platform.logger.wrapOrRun(i,"enable secret storage",async s=>{var n,o;if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(void 0));const a=await mf(e,t,this._storage,this._platform,this._olm);if(await this._tryLoadSecretStorage(a,s))return await this._writeSSSSKey(a,s),await((n=this._keyBackup.get())==null?void 0:n.start(s)),await((o=this._crossSigning.get())==null?void 0:o.start(s)),a;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const i=this._keyBackup.get();if(!i)return;const s=i.version,n=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await df(e,s,n);if(t.set("previousBackupVersion",o),t.set("backupVersion",s),!!o&&o!==s){const a=await i.markAllForBackup(n);t.set("amountMarkedForBackup",a)}}catch(o){throw n.abort(),o}await n.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{hf(e)}catch(i){throw e.abort(),i}if(await e.complete(),this._keyBackup.get()){for(const i of this._rooms.values())i.isEncrypted&&i.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(void 0)}const t=this._crossSigning.get();t&&(t.dispose(),this._crossSigning.set(void 0))}_tryLoadSecretStorage(e,t){return t.wrap("enable secret storage",async i=>{const s=new lf({key:e,platform:this._platform,storage:this._storage}),n=await s.hasValidKeyForAnyAccountData();return i.set("isValid",n),n&&(this._secretStorage=s,await this._loadSecretStorageServices(s,i),this._secretFetcher.setSecretStorage(s)),n})}async _loadSecretStorageServices(e,t){try{await t.wrap("enable key backup",async i=>{const s=new Rw(this._hsApi,this._olm,this._keyLoader,this._storage,this._platform);if(await s.load(e,i)){for(const n of this._rooms.values())n.isEncrypted&&n.enableKeyBackup(s);return this._keyBackup.set(s),!0}else i.set("no_backup",!0)})}catch(i){t.catch(i)}}get keyBackup(){return this._keyBackup}get crossSigning(){return this._crossSigning}get secretSharing(){return this._secretSharing}get secretFetcher(){return this._secretFetcher}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),await this._setupEncryption()),this._sessionInfo.isReadOnly||(await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t))),await this._createCrossSigning())}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await Ji.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:Fi,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return Ji.create({hsApi:this._hsApi,olm:this._olm,pickleKey:Fi,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async i=>{const s=await this._createNewAccount("temp-device-id");try{const n=await iw(s,this._hsApi,e,"Dehydrated device",i);return i.set("deviceId",n),n}finally{s.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents,this._storage.storeNames.accountData,this._storage.storeNames.crossSigningKeys]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await Ji.load({hsApi:this._hsApi,olm:this._olm,pickleKey:Fi,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption());const i=await this._getPendingEventsByRoom(t),s=await t.invites.getAll(),n=Promise.all(s.map(async l=>{const d=this.createInvite(l.roomId);e.wrap("invite",c=>d.load(l,c)),this._invites.add(d.id,d)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async l=>{const d=this.createJoinedRoom(l.roomId,i.get(l.roomId));await e.wrap("room",c=>d.load(l,t,c)),this._rooms.add(d.id,d)}));await Promise.all([n,a]);for(const[l,d]of this.invites){const c=this.rooms.get(l);c&&c.setInvite(d)}if(this._olm&&this._e2eeAccount){const l=await uf(t);l&&await this._tryLoadSecretStorage(l,e)}this._e2eeAccount&&await this._createCrossSigning()}async _createCrossSigning(){this._features.crossSigning&&this._platform.logger.run("enable cross-signing",async e=>{const t=new Bp({storage:this._storage,secretFetcher:this._secretFetcher,platform:this._platform,olm:this._olm,olmUtil:this._olmUtil,deviceTracker:this._deviceTracker,deviceMessageHandler:this._deviceMessageHandler,hsApi:this._hsApi,ownUserId:this.userId,e2eeAccount:this._e2eeAccount,deviceId:this.deviceId});await t.load(e),this._crossSigning.set(t)})}dispose(){var e,t,i,s,n,o;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(i=this._megolmDecryption)==null||i.dispose(),this._megolmDecryption=void 0,(s=this._e2eeAccount)==null||s.dispose(),this._e2eeAccount=void 0,(n=this._callHandler)==null||n.dispose(),this._callHandler=void 0,(o=this._crossSigning.get())==null||o.dispose();for(const a of this._rooms.values())a.dispose();this._rooms=void 0}async start(e,t,i){var s,n;if(e){const d=await this._storage.readWriteTxn([this._storage.storeNames.session]);d.session.set("serverVersions",e),await d.complete()}t&&await i.wrap("SSSSKeyFromDehydratedDeviceKey",async d=>{const c=await pf(t.key,this._storage,this._platform);c&&await this._tryLoadSecretStorage(c,d)&&(d.set("success",!0),await this._writeSSSSKey(c))}),await((s=this._keyBackup.get())==null?void 0:s.start(i)),await((n=this._crossSigning.get())==null?void 0:n.start(i));const a=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),l=As(a,d=>d.scope);for(const d of this._rooms.values()){let c;const h=l.get(d.id);h&&(c=As(h,p=>p.type)),d.start(c,i)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((i,s)=>{const n=i.get(s.roomId);return n?n.push(s):i.set(s.roomId,[s]),i},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new jv({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform,roomStateHandler:this._roomStateHandler})}_createArchivedRoom(e){const t=new qv({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new Qv({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}async createRoom(e){let t;return await this._platform.logger.run("create room",async i=>{const s=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new Xv(s,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,i),this._roomsBeingCreated.set(s,t);const n=[t.create(this._hsApi,i)];e.loadProfiles!==!1&&n.push(t.loadProfiles(this._hsApi,i)),await Promise.all(n),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,i),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,i))}),t}async obtainSyncLock(e){var t;const i=(t=e.to_device)==null?void 0:t.events;if(Array.isArray(i)&&i.length)return await this._deviceMessageHandler.obtainSyncLock(i)}async prepareSync(e,t,i,s){var n;const o=(n=e.to_device)==null?void 0:n.events;if(Array.isArray(o)&&o.length)return await s.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(o,t,i,a))}async writeSync(e,t,i,s,n){const o={syncInfo:null,e2eeAccountChanges:null,hasNewRoomKeys:!1,deviceMessageDecryptionResults:null,changedDevices:null},a=e.next_batch;if(a!==this.syncToken){const h={token:a,filterId:t};s.session.set("sync",h),o.syncInfo=h}const l=e.device_one_time_keys_count;this._e2eeAccount&&l&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(l,s,n));const d=e.device_lists;if(this._deviceTracker&&Array.isArray(d?.changed)&&d.changed.length&&(await n.wrap("deviceLists",h=>this._deviceTracker.writeDeviceChanges(d.changed,s,h)),o.changedDevices=d.changed),i){const{hasNewRoomKeys:h,decryptionResults:p}=await n.wrap("deviceMsgs",g=>this._deviceMessageHandler.writeSync(i,s,g));o.hasNewRoomKeys=h,o.deviceMessageDecryptionResults=p}const c=e.account_data;if(Array.isArray(c?.events))for(const h of c.events)typeof h.type=="string"&&s.accountData.set(h);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,i){var s,n,o;this._e2eeAccount&&!t&&!this._sessionInfo.isReadOnly&&await this._e2eeAccount.generateOTKsIfNeeded(this._storage,i)&&await i.wrap("uploadKeys",l=>this._e2eeAccount.uploadKeys(this._storage,!1,l)),e.hasNewRoomKeys&&((s=this._keyBackup.get())==null||s.flush(i)),e.deviceMessageDecryptionResults&&await this._deviceMessageHandler.afterSyncCompleted(e.deviceMessageDecryptionResults,this._deviceTracker,this._hsApi,i),(n=e.changedDevices)!=null&&n.includes(this.userId)&&((o=this._secretSharing)==null||o.checkSecretValidity())}_tryReplaceRoomBeingCreated(e,t){for(const[,i]of this._roomsBeingCreated)if(i.roomId===e){const s=this._observedRoomStatus.get(i.id);s&&(t.log("replacing room being created").set("localId",i.id).set("roomId",i.roomId),s.set(s.get()|we.Replaced)),i.dispose(),this._roomsBeingCreated.remove(i.id);return}}async applyRoomCollectionChangesAfterSync(e,t,i,s){var n,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,s)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of i)a.shouldAdd&&((n=this._observedRoomStatus.get(a.id))==null||n.set(we.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(we.Joined));for(const a of e){const l=this._observedRoomStatus.get(a.id);if(l){const d=l.get()|we.Invited;if(a.shouldAdd)l.set(d);else if(a.shouldRemove){const c=d^we.Invited;l.set(c)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|we.Archived)^we.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=$i.createDefaultPayload(this._sessionInfo.id),i=await this._platform.notificationService.enablePush($i,t);if(!i)return e.set("no_pusher",!0),!1;await i.enable(this._hsApi,e);const s=await this._storage.readWriteTxn([this._storage.storeNames.session]);return s.session.set(ar,i.serialize()),await s.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const i=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ar);if(!i)return!0;await new $i(i).disable(this._hsApi,e);const n=await this._storage.readWriteTxn([this._storage.storeNames.session]);return n.session.remove(ar),await n.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ar):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(ar);if(!t)return!1;const i=new $i(t),s=await this._hsApi.getPushers().response();return(s?.pushers||[]).map(o=>new $i(o)).some(o=>o.equals(i))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return we.BeingCreated;if(!!this._rooms.get(e))return we.Joined;{const s=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return s&&o?we.Invited|we.Archived:s?we.Invited:o?we.Archived:we.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){let i;t=new kr(i,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t),i=await this.getRoomStatus(e),t.get()===void 0&&t.set(i)}return t}observeRoomState(e){return this._roomStateHandler.subscribe(e)}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async i=>{i.set("id",e);const s=this._activeArchivedRooms.get(e);if(s)return s.retain(),s;const n=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await n.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,n,i),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async i=>(await this._hsApi.joinIdOrAlias(e,{log:i}).response()).room_id)}}class Xw{constructor({username:e,password:t,homeserver:i}){this._username=e,this._password=t,this.homeserver=i}async login(e,t,i){return await e.passwordLogin(this._username,this._password,t,{log:i}).response()}}class Qw{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,i){return await e.tokenLogin(this._loginToken,et(),t,{log:i}).response()}}class Zw{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${encodeURIComponent(e)}`}}class Ca{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class eb extends Ca{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class tb extends Ca{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class ib extends Ca{constructor(e,t,i){super(e,t),this._type=i}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class sb{constructor(e,t,i,s){this.homeserver=e,this._hsApi=t,this._accountDetails=i,this._flowSelector=s??(n=>n[0])}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:i,password:s,initialDeviceDisplayName:n,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(i,s,n,t,o),l=await a.response(),d=await a.responseCode(),c=Pl(Ms({},l),{status:d});return this.parseRegistrationResponse(c,e)}parseStagesFromResponse(e){const{session:t,params:i}=e,s=this._flowSelector(e.flows);if(!s)throw new Error("flowSelector did not return any flow!");let n,o;for(const a of s.stages){const l=this._createRegistrationStage(a,t,i);n?(o.setNextStage(l),o=l):(n=l,o=l)}return n}async parseRegistrationResponse(e,t){var i;switch(e.status){case 200:this._registerResponse=e;return;case 401:if((i=e.completed)!=null&&i.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,i){switch(e){case"m.login.dummy":return new eb(t,i?.[e]);case"m.login.terms":return new tb(t,i?.[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new ib(t,i?.[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get authData(){if(this._registerResponse)return{accessToken:this._registerResponse.access_token,homeserver:this.homeserver,userId:this._registerResponse.user_id,deviceId:this._registerResponse.device_id}}}const de=js("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Io=js("Connection","Credentials","Unknown");class rb{constructor(e,t=new yr(0)){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new fi(de.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0,this._features=t}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===de.NotLoading&&(this._status.set(de.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const i=await this._platform.sessionInfoStorage.get(e);if(!i)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(i,null,t),t.set("status",this._status.get())}catch(i){t.catch(i),this._error=i,this._status.set(de.Error)}}))}_parseLoginOptions(e,t){const i=e.flows,s={homeserver:t};for(const n of i)n.type==="m.login.password"?s.password=(o,a)=>new Xw({homeserver:t,username:o,password:a}):n.type==="m.login.sso"&&i.find(o=>o.type==="m.login.token")?s.sso=new Zw(t):n.type==="m.login.token"&&(s.token=o=>new Qw({homeserver:t,loginToken:o}));return s}queryLogin(e){return new Ld(async t=>{e=await Fy(e,(n,o)=>t(this._platform.request(n,o)));const i=new Bi({homeserver:e,request:this._platform.request}),s=await t(i.getLoginFlows()).response();return this._parseLoginOptions(s,e)})}async startRegistration(e,t,i,s,n){const o=this._platform.request,a=new Bi({homeserver:e,request:o});return new sb(e,a,{username:t,password:i,initialDeviceDisplayName:s},n)}async startWithAuthData({accessToken:e,deviceId:t,userId:i,homeserver:s,isReadOnly:n=!1}){await this._platform.logger.run("startWithAuthData",async o=>{n&&o.set("isReadonly (Disabled OTK Upload)",!0),await this._createSessionAfterAuth({accessToken:e,deviceId:t,userId:i,homeserver:s},!0,n,o)})}async startWithLogin(e,{inspectAccountSetup:t}={}){const i=this._status.get();i!==de.LoginFailed&&i!==de.NotLoading&&i!==de.Error||(this._resetStatus(),await this._platform.logger.run("login",async s=>{this._status.set(de.Login);let n;try{const o=this._platform.request,a=new Bi({homeserver:e.homeserver,request:o}),l=await e.login(a,"Hydrogen",s);n={deviceId:l.device_id,userId:l.user_id,homeserver:e.homeserver,accessToken:l.access_token}}catch(o){this._error=o,o.name==="HomeServerError"?(o.errcode==="M_FORBIDDEN"?this._loginFailure=Io.Credentials:this._loginFailure=Io.Unknown,s.set("loginFailure",this._loginFailure),this._status.set(de.LoginFailed)):o.name==="ConnectionError"?(this._loginFailure=Io.Connection,this._status.set(de.LoginFailed)):this._status.set(de.Error);return}await this._createSessionAfterAuth(n,t,!1,s)}))}async _createSessionAfterAuth({deviceId:e,userId:t,accessToken:i,homeserver:s},n,o,a){const l=this.createNewSessionId(),d=this._platform.clock.now(),c={id:l,deviceId:e,userId:t,homeServer:s,homeserver:s,accessToken:i,lastUsed:d,isReadOnly:o};let h;n&&(h=await this._inspectAccountAfterLogin(c,a),h&&(c.deviceId=h.deviceId)),await this._platform.sessionInfoStorage.add(c);try{await this._loadSessionInfo(c,h,a),a.set("status",this._status.get())}catch(p){a.catch(p),h?.dispose(),this._error=p,this._status.set(de.Error)}}async _loadSessionInfo(e,t,i){i.set("appVersion",this._platform.version);const s=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(de.Loading),this._reconnector=new $y({onlineStatus:this._platform.onlineStatus,retryDelay:new Kd(s.createTimeout),createMeasure:s.createMeasure});const n=new Bi({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,i);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer,isReadOnly:e.isReadOnly},a=await this._olmPromise;let l=null;this._workerPromise&&(l=await this._workerPromise),this._requestScheduler=new Hy({hsApi:n,clock:s}),this._requestScheduler.start();const d=new zy({homeserver:e.homeServer,platform:this._platform});if(this._session=new Jw({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:l,mediaRepository:d,platform:this._platform,features:this._features}),await this._session.load(i),t?(await i.wrap("dehydrateIdentity",c=>this._session.dehydrateIdentity(t,c)),await this._session.setupDehydratedDevice(t.key,i)):this._session.hasIdentity||(this._status.set(de.SessionSetup),await i.wrap("createIdentity",c=>this._session.createIdentity(c))),this._sync=new Jy({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(c=>{c===Sa.Online&&this._platform.logger.runDetached("reconnect",async h=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const p=t;t=void 0,await h.wrap("session start",g=>this._session.start(this._reconnector.lastVersionsResponse,p,g))})}),await i.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(de.Ready),!this._sessionStartedByReconnector)){const c=await n.versions({timeout:1e4,log:i}).response();if(this._isDisposed)return;const h=t;t=void 0,await i.wrap("session start",p=>this._session.start(c,h,p))}}async _waitForFirstSync(){this._sync.start(),this._status.set(de.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===ve.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===ve.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===ve.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async i=>{var s;this._status.set(de.QueryAccount);const n=new Bi({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),o=await this._olmPromise;let a;try{a=await tw(n,o,this._platform,i)}catch(l){if(l.name==="HomeServerError")i.set("not_supported",!0);else throw l}if(a){let l;const d=new Promise(h=>l=h);this._accountSetup=new nb(a,l),this._status.set(de.AccountSetup),await d;const c=(s=this._accountSetup)==null?void 0:s._dehydratedDevice;return this._accountSetup=null,c}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const i=await this._platform.sessionInfoStorage.get(this._sessionId);if(!i)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new Bi({homeserver:i.homeServer,accessToken:i.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}startForcedLogout(e){return this._platform.logger.run("forced-logout",async t=>{this._sessionId=e,t.set("id",this._sessionId),await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(de.NotLoading),this._error=null,this._loginFailure=null}}class nb{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class ob{constructor(e){this._observables=new Map,this._allowsChild=e,this._path=new Kt([],e),this._pathObservable=new fi(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,...t){const i=this.path.with(new nt(e,...t));i&&this.applyPath(i)}applyPath(e){const t=this._path;this._path=e;for(let i=t.segments.length-1;i>=0;i-=1){const s=t.segments[i];if(!this._path.get(s.type)){const n=this._observables.get(s.type);n?.emitIfChanged()}}for(const i of this._path.segments){const s=this._observables.get(i.type);s?.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new cb(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,i;for(i=0;i<e.length;i+=1){if(!this._allowsChild(t,e[i]))return new Kt(e.slice(0,i),this._allowsChild);t=e[i]}return new Kt(e,this._allowsChild)}segment(e,...t){return new nt(e,...t)}}function ab(r,e){if(r===e)return!0;if(Array.isArray(r)&&Array.isArray(e)){const t=Math.max(r.length,e.length);for(let i=0;i<t;i+=1)if(r[i]!==e[i])return!1;return!0}return!1}class nt{constructor(e,...t){this.type=e,this.value=t[0]===void 0?!0:t[0]}}class Kt{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new Kt(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const i=this._segments.slice(0,t+1);return i.push(e),new Kt(i,this._allowsChild)}t-=1}while(t>=-1)}until(e){const t=this._segments.findIndex(i=>i.type===e);return t!==-1?new Kt(this._segments.slice(0,t+1),this._allowsChild):new Kt([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(i=>i.type===e.type);if(t!==-1){const i=this._segments[t-1];if(this._allowsChild(i,e)){const s=this._segments[t+1];if(!s||this._allowsChild(e,s)){const n=this._segments.slice();return n[t]=e,new Kt(n,this._allowsChild)}}}}get segments(){return this._segments}}class cb extends Ct{constructor(e,t){var i;super(),this._navigation=e,this._type=t,this._lastSetValue=(i=e.path.get(t))==null?void 0:i.value}get(){const t=this._navigation.path.get(this._type);return t?.value}emitIfChanged(){const e=this.get();ab(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class lb{constructor(e,t,i,s){this._isApplyingUrl=!1,this._history=e,this._navigation=t,this._parseUrlPath=i,this._stringifyPath=s,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var e;const i=(e=this._urlAsNavPath(this._history.getLastSessionUrl()||"").get("session"))==null?void 0:e.value;if(typeof i=="string")return i}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription&&(this._subscription=this._subscription()),this._pathSubscription&&(this._pathSubscription=this._pathSubscription())}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastSessionUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const i of e)if(t=t.with(i),!t)return;return this.urlForPath(t)}urlForSegment(e,...t){return this.urlForSegments([this._navigation.segment(e,...t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${encodeURIComponent(e)}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.href}normalizeUrl(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),this._history.replaceUrlSilently(e.toString())}}function db({history:r,navigation:e}){return new lb(r,e,hb,mb)}function ub(r,e,t){if(r.value.includes(e))return r;{const i=t.get("empty-grid-tile"),s=t.get("room");let n=0;i?n=i.value:s&&(n=r.value.indexOf(s.value));const o=r.value.slice();return o[n]=e,new nt("rooms",o)}}function Jc(r,e,...t){r.push(new nt("right-panel")),r.push(new nt(e,...t))}function hb(r,e,t){const i=r.substring(1).split("/"),s=i[Symbol.iterator](),n=[];let o;for(;!(o=s.next()).done;){const a=o.value;if(a==="rooms"){const l=s.next().value;if(l===void 0)break;const d=l.split(",").map(p=>decodeURIComponent(p));n.push(new nt(a,d));const c=parseInt(s.next().value||"0",10),h=d[c];h?n.push(new nt("room",h)):n.push(new nt("empty-grid-tile",c))}else if(a==="open-room"){let l=s.next().value;if(!l)break;l=decodeURIComponent(l);const d=e.get("rooms");if(d&&n.push(ub(d,l,e)),n.push(new nt("room",l)),i.findIndex(p=>p==="open-room")>=i.length-2){const p=e.segments,g=p.findIndex(y=>y.type==="right-panel");g!==-1&&n.push(...p.slice(g))}}else if(a==="last-session"){let l=e.get("session");typeof l?.value!="string"&&t&&(l=new nt("session",t)),l&&n.push(l)}else if(a==="details"||a==="members"||a==="verification"||a==="invite")Jc(n,a);else if(a==="member"){let l=s.next().value;if(!l)break;l=decodeURIComponent(l),Jc(n,a,l)}else if(a.includes("loginToken")){const l=a.split("=").pop();n.push(new nt("sso",l))}else{let l=s.next().value;l&&(l=decodeURIComponent(l)),n.push(new nt(a,l))}}return n}function mb(r){let e="",t;for(const i of r.segments){const s=pb(i.value);switch(i.type){case"rooms":e+=`/rooms/${s}`;break;case"empty-grid-tile":e+=`/${s}`;break;case"room":t?.type==="rooms"?e+=`/${t.value.indexOf(i.value)}`:e+=`/${i.type}/${s}`;break;case"right-panel":case"sso":continue;default:e+=`/${i.type}`,s&&(e+=`/${s}`)}t=i}return e}function pb(r){return r===!0?"":Array.isArray(r)?r.map(e=>encodeURIComponent(e)).join(","):encodeURIComponent(r)}function qs(r){let e=r.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=r.charAt(1)),e.toUpperCase()}function _b(r){let e=0,t,i;if(r.length===0)return e;for(t=0;t<r.length;t++)i=r.charCodeAt(t),e=(e<<5)-e+i,e|=0;return Math.abs(e)}function zs(r){return _b(r)%8+1}function qr(r,e,t,i){if(r){const s=e*t.devicePixelRatio;return i.mxcUrlThumbnail(r,s,s,"crop")}}class fb extends Bs{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const i=e.lowerEntry,s=this._findTileIdx(i);this.emitUpdate(s,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._silent=!0,this._tiles=[];let e=null;for(let i of this._entries)(!e||!e.tryIncludeEntry(i))&&(e=this._createTile(i),e&&this._tiles.push(e));let t=null;for(let i of this._tiles)t&&t.updateNextSibling(i),i.updatePreviousSibling(t),t=i;t&&t.updateNextSibling(null);for(let i=0;i<this._tiles.length;i+=1){const s=this._tiles[i];s.needsDateSeparator&&(this._addTileAt(i,s.createDateSeparator(),!0),i+=1)}for(const i of this._tiles)i.setUpdateEmit(this._emitSpontanousUpdate);this._silent=!1}_findTileIdx(e){return Gt(this._tiles,e,(t,i)=>-i.compareEntry(t))}_findTileAtIdx(e,t){const i=this._getTileAtIdx(t);if(i&&i.compareEntry(e)===0)return i}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const i=this._findTileIdx(t),s=this._getTileAtIdx(i-1);if(s&&s.tryIncludeEntry(t)){this.emitUpdate(i-1,s);return}const n=this._getTileAtIdx(i);if(n&&n.tryIncludeEntry(t)){this.emitUpdate(i,n);return}const o=this._createTile(t);o&&(this._addTileAt(i,o),this._evaluateDateHeaderAtIdx(i))}_evaluateDateHeaderAtIdx(e){for(let t=0;t<3;t+=1){const i=e+t;if(i>=this._tiles.length)break;const s=this._tiles[i],n=i>0?this._tiles[i-1]:void 0,o=n?.shape===be.DateHeader;s.needsDateSeparator&&!o?(e+=1,this._addTileAt(i,s.createDateSeparator())):!s.needsDateSeparator&&o&&this._removeTile(i-1,n)}}_addTileAt(e,t,i=!1){const s=e>0?this._tiles[e-1]:void 0,n=this._tiles[e];s?.updateNextSibling(t),t.updatePreviousSibling(s),t.updateNextSibling(n),n?.updatePreviousSibling(t),this._tiles.splice(e,0,t),i||this.emitAdd(e,t),t.setUpdateEmit(this._emitSpontanousUpdate)}onUpdate(e,t,i){if(!this._tiles)return;const s=this._findTileIdx(t),n=this._findTileAtIdx(t,s);if(n){const o=n.updateEntry(t,i);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(s,n,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(s,n)}o.shouldRemove&&this._removeTile(s,n),o.shouldUpdate&&this.emitUpdate(s,n,o.updateParams)}}_replaceTile(e,t,i,s){t.dispose();const n=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=i,n?.updateNextSibling(i),i.updatePreviousSibling(n),i.updateNextSibling(o),o?.updatePreviousSibling(i),this.emitUpdate(e,i,s)}_removeTile(e,t){const i=this._getTileAtIdx(e-1),s=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),i?.updateNextSibling(s),s?.updatePreviousSibling(i),i&&i.shape===be.DateHeader&&(!s||!s.needsDateSeparator)&&this._removeTile(e-1,i)}onRemove(e,t){const i=this._findTileIdx(t),s=this._findTileAtIdx(t,i);s&&(s.removeEntry(t)?this._removeTile(i,s):this.emitUpdate(i,s))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=Gt(this._tiles,e,(s,n)=>s.compare(n)),i=this._tiles[t];return i?.compare(e)===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class gb extends lt{constructor(e){super(e);const{timeline:t,tileOptions:i}=e;this._timeline=this.track(t),this._tiles=new fb(t.entries,i),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let i;if(e&&t){this._startTile=e,this._endTile=t;const s=this._tiles.getTileIndex(this._startTile),n=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(s,n+1))o.notifyVisible();i=s<10,this._setShowJumpDown(n<this._tiles.length-1)}else i=!0,this._setShowJumpDown(!1);i&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(s=>{this._topLoadingPromise=null,s||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class yb extends lt{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var t;(new Boolean(e)!==new Boolean(this._replyVM)||!((t=this._replyVM)!=null&&t.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}class Xc extends jr{constructor(e){super(e);const t=new om(this.call,"change");this.track(t.subscribe(()=>this.onUpdate()));const i=new Am("self",t).mapValues((n,o)=>new vb(this.childOptions({call:n,emitChange:o})),()=>{}),s=this.call.members.filterValues(n=>n.isConnected).mapValues((n,o)=>new Ma(this.childOptions({member:n,emitChange:o,mediaRepository:this.getOption("room").mediaRepository})),(n,o)=>o?.onUpdate());this.memberViewModels=s.join(i).sortValues((n,o)=>n.compare(o)),this.track(this.memberViewModels.subscribe({onRemove:()=>{this.emitChange()},onAdd:()=>{this.emitChange()},onUpdate:()=>{},onReset:()=>{},onMove:()=>{}}))}get isCameraMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.microphone)!=null?t:!0}get memberCount(){return this.memberViewModels.length}get name(){return this.call.name}get id(){return this.call.id}get call(){return this.getOption("call")}onUpdate(){this.call.error&&this.reportError(this.call.error)}async hangup(){this.logAndCatch("CallViewModel.hangup",async e=>{this.call.hasJoined&&await this.call.leave(e)})}async toggleCamera(){this.logAndCatch("Call.toggleCamera",async e=>{const{localMedia:t,muteSettings:i}=this.call;if(i&&t){if(i.camera&&!$t(t.userMedia)){const s=await this.platform.mediaDevices.getMediaTracks(!i.microphone,!0);await this.call.setMedia(t.withUserMedia(s))}else await this.call.setMuted(i.toggleCamera());this.emitChange()}})}async toggleMicrophone(){this.logAndCatch("Call.toggleMicrophone",async e=>{const{localMedia:t,muteSettings:i}=this.call;if(i&&t){if(i.microphone&&!yi(t.userMedia)){const s=await this.platform.mediaDevices.getMediaTracks(!0,!i.camera);await this.call.setMedia(t.withUserMedia(s))}else await this.call.setMuted(i.toggleMicrophone());this.emitChange()}})}}class vb extends jr{constructor(e){super(e),this.init()}async init(){const e=this.getOption("room");this.memberObservable=await e.observeMember(e.user.id),this.track(this.memberObservable.subscribe(()=>{this.emitChange(void 0)}))}get errorViewModel(){}get stream(){var e;return(e=this.call.localPreviewMedia)==null?void 0:e.userMedia}get call(){return this.getOption("call")}get isCameraMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.microphone)!=null?t:!0}get avatarLetter(){var e;const t=(e=this.memberObservable)==null?void 0:e.get();return t?qs(t.name):this.getOption("room").user.id}get avatarColorNumber(){return zs(this.getOption("room").user.id)}avatarUrl(e){var t;const i=(t=this.memberObservable)==null?void 0:t.get();if(i)return qr(i.avatarUrl,e,this.platform,this.getOption("room").mediaRepository)}get avatarTitle(){var e;const t=(e=this.memberObservable)==null?void 0:e.get();return t?t.name:this.getOption("room").user.id}compare(e){return-1}}class Ma extends jr{get stream(){var e;return(e=this.member.remoteMedia)==null?void 0:e.userMedia}get member(){return this.getOption("member")}get isCameraMuted(){var e,t;return(t=(e=this.member.remoteMuteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.member.remoteMuteSettings)==null?void 0:e.microphone)!=null?t:!0}get avatarLetter(){return qs(this.member.member.name)}get avatarColorNumber(){return zs(this.member.userId)}avatarUrl(e){const{avatarUrl:t}=this.member.member,i=this.getOption("mediaRepository");return qr(t,e,this.platform,i)}get avatarTitle(){return this.member.member.name}onUpdate(){this.mapMemberSyncErrorIfNeeded()}mapMemberSyncErrorIfNeeded(){this.member.error&&this.reportError(this.member.error)}compare(e){if(e instanceof Ma){const t=this.member.member.userId,i=e.member.member.userId;return t===i?0:t<i?-1:1}else return-e.compare(this)}}function Nn(r){return{w:r.width,h:r.height,mimetype:r.blob.mimeType,size:r.blob.size}}class ui{constructor(e,t,i){this.userMedia=e,this.screenShare=t,this.dataChannelOptions=i}withUserMedia(e){var t;return new ui(e,(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}withScreenShare(e){var t;return new ui((t=this.userMedia)==null?void 0:t.clone(),e,this.dataChannelOptions)}withDataChannel(e){var t,i;return new ui((t=this.userMedia)==null?void 0:t.clone(),(i=this.screenShare)==null?void 0:i.clone(),e)}asPreview(){const e=this.clone(),t=e.userMedia;if(t&&t.getVideoTracks().length>0){const i=yi(t);i&&(i.stop(),t.removeTrack(i))}return e}replaceClone(e,t){const i=(s,n,o)=>s?.id===o?.id?n:o?.clone();return new ui(i(t?.userMedia,e?.userMedia,this.userMedia),i(t?.screenShare,e?.screenShare,this.screenShare),this.dataChannelOptions)}clone(){var e,t;return new ui((e=this.userMedia)==null?void 0:e.clone(),(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}dispose(){var e,t,i;(e=yi(this.userMedia))==null||e.stop(),(t=$t(this.userMedia))==null||t.stop(),(i=$t(this.screenShare))==null||i.stop()}}class wb extends is{constructor(e,t){super(e,t),this._loading=!1,this._waitingForConnection=!1,this._isAtTop=!0,this._siblingChanged=!1}get needsDateSeparator(){return!1}async fill(e=!1){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(t){return t instanceof zt?(await this._waitForReconnection(),e?!1:await this.fill(!0)):(this.reportError(t),!1)}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){if(this.errorViewModel)return;let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?it.Nothing():it.Remove()}async _waitForReconnection(){this._waitingForConnection=!0,this.emitUpdate("status"),await this.options.client.reconnector.connectionStatus.waitFor(e=>e===Sa.Online).promise,this._waitingForConnection=!1,this.emitUpdate("status")}get shape(){return"gap"}get isLoading(){return this._loading}get showSpinner(){return this.isLoading||this._waitingForConnection}get status(){const e=this._entry.prev_batch?"previous":"next";return this._waitingForConnection?"Waiting for connection\u2026":this.errorViewModel?`Could not load ${e} messages`:this.isLoading?"Loading more messages\u2026":"Gave up loading more messages"}}class bb{constructor(e){this._parentTile=e,this._map=new Ht,this._reactions=this._map.sortValues((t,i)=>t._compare(i))}update(e,t){if(e){for(const i in e)if(e.hasOwnProperty(i)){const s=e[i],n=this._map.get(i);n?n._tryUpdate(s)&&this._map.update(i):this._map.add(i,new Qc(i,s,null,this._parentTile))}}if(t)for(const[i,s]of t.entries()){const n=this._map.get(i);n?(n._tryUpdatePending(s),this._map.update(i)):this._map.add(i,new Qc(i,null,s,this._parentTile))}for(const i of this._map.keys()){const s=t?.has(i),n=e?.hasOwnProperty(i);!n&&!s?this._map.remove(i):n?s||this._map.get(i)._tryUpdatePending(null)&&this._map.update(i):this._map.get(i)._tryUpdate(null)&&this._map.update(i)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class Qc{constructor(e,t,i,s){this._key=e,this._annotation=t,this._pending=i,this._parentTile=s,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,s=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||s?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class Ti extends is{constructor(e,t){super(e,t),this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}copyPermalink(){this.platform.copyPlaintext(this.permaLink)}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get memberPanelLink(){return`${this.urlRouter.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return zs(this._entry.sender)}avatarUrl(e){return qr(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return qs(this.sender)}get avatarTitle(){return this.sender}get time(){return this._date&&this.timeFormatter.formatTime(this._date)}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof Ti&&e.sender===this.sender){const i=this._entry.timestamp,s=e._entry.timestamp;t=i-s<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const i=super.updateEntry(e,t);return i.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),i}_updateReplyTileIfNeeded(e){var t,i;const s=this._entry.contextEntry;if(s){const n=(t=this._replyTile)==null?void 0:t.updateEntry(s,e);if(n?.shouldReplace||!this._replyTile){this.disposeTracked(this._replyTile);const o=this._options.tileClassForEntry,a=o(s,this._options);a&&(this._replyTile=new a(s,this._options))}n?.shouldUpdate&&((i=this._replyTile)==null||i.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}createReplyContent(e,t){return this._entry.createReplyContent(e,t)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async i=>{var s,n;if(!this.canReact){i.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){i.set("already_reacted",!0);return}const o=(n=(s=this._entry.pendingAnnotations)==null?void 0:s.get(e))==null?void 0:n.redactionEntry;o&&!o.pendingEvent.hasStartedSending?(i.set("abort_redaction",!0),await o.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,i)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async i=>{var s,n;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){i.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){i.set("not_yet_reacted",!0);return}let o=(n=(s=this._entry.pendingAnnotations)==null?void 0:s.get(e))==null?void 0:n.annotationEntry;o||(o=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),o?await this._room.sendRedaction(o.id,null,i):i.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async i=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,i):await this.react(e,i)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new bb(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const Sb="(?:https|http|ftp):\\/\\/",du="[^\\s.,?!)]",Zc="[a-zA-Z0-9:.\\[\\]-]",Eb=`${Zc}*(?=${Zc})${du}`,kb=`(?:[\\/#](?:[^\\s]*${du})?)`,Ib=`${Sb}${Eb}${kb}?`,xb=new RegExp(Ib,"gi");function uu(r,e){const t=r.matchAll(xb);let i=0;for(let n of t){const o=r.slice(i,n.index);e(o,!1),e(n[0],!0);const a=n[0].length;i=n.index+a}const s=r.slice(i);e(s,!1)}function Tb(r){const e=[],t=r.split(`
`),i=(s,n)=>{n?e.push(new Jo(s,[new Us(s)])):e.push(new Us(s))};for(let s=0;s<t.length;s+=1){const n=t[s];n.length&&uu(n,i),s>=t.length-1||e.push(new hu)}return new Aa(r,e)}function Rb(r){return new Aa(r,[new Us(r)])}class Cb{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class el{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class Mb{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class Ab{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class Nb{get type(){return"rule"}}class hu{get type(){return"newline"}}class gn{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class Db{constructor(e,t,i,s,n){this.src=e,this.width=t,this.height=i,this.alt=s,this.title=n}get type(){return"image"}}class Vb{constructor(e,t,i){this.id=e,this.href=t,this.children=i}get type(){return"pill"}get avatarColorNumber(){return zs(this.id)}get avatarInitials(){return qs(this.id)}}class Jo{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class Us{constructor(e){this.text=e}get type(){return"text"}}function Ub(r){return r.type==="format"&&r.format==="blockquote"}class Aa{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&Ub(this.parts[t]);t++);this.parts.splice(t,0,new Us(e))}}const pr=js("Plain","Html");class mu extends Ti{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return Rb(e)}_getBodyFormat(){return pr.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const Pb=["EM","STRONG","CODE","DEL","SPAN"],Ob=["DIV","BLOCKQUOTE"],Fb=["https","http","ftp","mailto","magnet"].map(r=>`${r}://`),Lb="https://matrix.to",tl=`${Lb}/#/`;class Bb{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(tl))return null;const t=e.substring(tl.length);return t[0]==="@"?t:null}parseLink(e,t){const i=this.result.getAttributeValue(e,"href"),s=i?.toLowerCase();if(!s||!Fb.some(o=>s.startsWith(o)))return new gn("span",t);const n=this.parsePillLink(i);return n?new Vb(n,i,t):new Jo(i,t)}parseList(e){const t=this.result;let i=null;t.getNodeElementName(e)==="OL"&&(i=parseInt(t.getAttributeValue(e,"start"))||1);const s=[];for(const n of t.getChildNodes(e)){if(t.getNodeElementName(n)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(n));s.push(o)}return new Mb(i,s)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let i;for(const o of t.getChildNodes(e)){i=o;break}let s=null;if(!this._ensureElement(i,"CODE"))return new el(s,this.result.getNodeText(e));const n=t.getAttributeValue(i,"class")||"";for(const o of n.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){s=o.substring(9);break}return new el(s,this.result.getNodeText(i))}parseImage(e){const t=this.result,i=t.getAttributeValue(e,"src")||"",s=this.mediaRepository.mxcUrl(i);if(!s)return null;const n=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),l=t.getAttributeValue(e,"title");return new Db(s,n,o,a,l)}parseTableRow(e,t){const i=[];for(const s of this.result.getChildNodes(e)){if(!this._ensureElement(s,t))continue;const n=this.result.getChildNodes(s),o=this.parseInlineNodes(n);i.push(o)}return i}parseTableHead(e){let t=null;for(const i of this.result.getChildNodes(e)){t=i;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const i of this.result.getChildNodes(e))!this._ensureElement(i,"TR")||t.push(this.parseTableRow(i,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let i,s;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(i=this.parseTableHead(t[0]),s=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(i=null,s=this.parseTableBody(t[0])),new Ab(i,s)}parseInlineElement(e){const t=this.result,i=t.getNodeElementName(e),s=t.getChildNodes(e);switch(i){case"A":{const n=this.parseInlineNodes(s);return this.parseLink(e,n)}case"BR":return new hu;default:{if(!Pb.includes(i))return null;const n=this.parseInlineNodes(s);return new gn(i,n)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,i=t.getNodeElementName(e),s=t.getChildNodes(e);switch(i){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const n=this.parseInlineNodes(s);return new Cb(parseInt(i[1]),n)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Nb;case"IMG":return this.parseImage(e);case"P":{const n=this.parseInlineNodes(s);return new gn(i,n)}case"TABLE":return this.parseTable(e);default:{if(!Ob.includes(i))return null;const n=this.parseAnyNodes(s);return new gn(i,n)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const i=(s,n)=>{n?t.push(new Jo(s,[new Us(s)])):t.push(new Us(s))};return uu(this.result.getNodeText(e),i),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const i of e){if(this._parseTextParts(i,t))continue;const s=this.parseInlineNode(i);if(s){t.push(s);continue}this._isAllowedNode(i)&&this._parseInlineNodes(this.result.getChildNodes(i),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const i of e){if(this._parseTextParts(i,t))continue;const s=this.parseInlineNode(i)||this.parseBlockNode(i);if(s){t.push(s);continue}this._isAllowedNode(i)&&this._parseAnyNodes(this.result.getChildNodes(i),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function Kb(r,e,t){const i=r.parseHTML(t),n=new Bb(i,e).parseAnyNodes(i.rootNodes);return new Aa(t,n)}class pu extends mu{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===pr.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?pr.Html:pr.Plain}_parseBody(e,t){var i;let s;return t===pr.Html?s=Kb(this.platform,this._mediaRepository,e):s=Tb(e),((i=this._getContent())==null?void 0:i.msgtype)==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class Xo extends Ti{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})`:this.i18n`This message is being deleted`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const $b=300,jb=400;class _u extends Ti{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let i;try{i=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(i,t)}catch(s){this._downloadError=s}finally{i?.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===te.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e?.status){case te.Waiting:return this.i18n`Waiting`;case te.EncryptingAttachments:case te.Encrypting:return this.i18n`Encrypting`;case te.UploadingAttachments:return this.i18n`Uploading`;case te.Sending:return this.i18n`Sending`;case te.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading`:""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const i=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(i)return this._mediaRepository.mxcUrlThumbnail(i,this.width,this.height,"scale")}if(this._entry.isPending){const i=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return i&&i.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const i=(t=this._getContent())==null?void 0:t.url;if(typeof i=="string")return this._mediaRepository.mxcUrlThumbnail(i,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round(t?.w*this._scaleFactor())}get height(){var e;const t=(e=this._getContent())==null?void 0:e.info;return Math.round(t?.h*this._scaleFactor())}get mimeType(){var e;const t=(e=this._getContent())==null?void 0:e.info;return t?.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,i=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):i&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(i),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var e;const t=(e=this._getContent())==null?void 0:e.info,i=$b/t?.h,s=jb/t?.w;return Math.min(s,i,1)}_isMainResourceImage(){return!0}}class fu extends _u{constructor(e,t){super(e,t),this._lightboxUrl=this.urlRouter.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class gu extends _u{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var e;if(this._decryptedFile)return this._decryptedFile.url;const t=(e=this._getContent())==null?void 0:e.url;return typeof t=="string"?this._mediaRepository.mxcUrl(t):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function qb(r,e=2){if(Number.isSafeInteger(r)){const t=Math.min(3,Math.floor(Math.log(r)/Math.log(1024))),i=Math.round(r/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${i} bytes`;case 1:return`${i} KB`;case 2:return`${i} MB`;case 3:return`${i} GB`}}return""}class yu extends Ti{constructor(e,t){super(e,t),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let i;try{i=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(i,t)}catch(s){this._downloadError=s}finally{i?.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var e;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const i=this._getContent().body;if(this._entry.isPending){const{pendingEvent:s}=this._entry;switch(s?.status){case te.Waiting:return this.i18n`Waiting to send ${i}`;case te.EncryptingAttachments:case te.Encrypting:return this.i18n`Encrypting ${i}`;case te.UploadingAttachments:{const n=Math.round(s.attachmentsSentBytes/s.attachmentsTotalBytes*100);return this.i18n`Uploading ${i}: ${n}%`}case te.Sending:case te.Sent:return this.i18n`Sending ${i}`;case te.Error:return this.i18n`Error: could not send ${i}: ${s.error.message}`;default:return`Unknown send status for ${i}`}}else{const s=qb((e=this._getContent().info)==null?void 0:e.size);return this._downloading?this.i18n`Downloading ${i} (${s})`:this.i18n`Download ${i} (${s})`}}get shape(){return"file"}}class vu extends Ti{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...i]=e.pathname.split(";"),[s,n]=t.split(","),o=parseFloat(s),a=parseFloat(n);let l;for(const d of i){const[c,h]=d.split("=");c==="u"&&(l=parseFloat(h))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let d=`geo:${o},${a}`;return l&&(d=d+`;u=${l}`),d}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class zb extends is{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e?.name}"`}}class Gb extends is{get shape(){return"announcement"}get announcement(){var e,t;const{sender:i,content:s,prevContent:n,stateKey:o}=this._entry,a=this._entry.displayName||i,l=i===o?a:((e=this._entry.content)==null?void 0:e.displayname)||o,d=s&&s.membership,c=n&&n.membership;if(c==="join"&&d==="join"){if(s.avatar_url!==n.avatar_url)return`${a} changed their avatar`;if(s.displayname!==n.displayname)return s.displayname?`${(t=n.displayname)!=null?t:o} changed their name to ${s.displayname}`:`${o} removed their name (${n.displayname})`}else{if(d==="join")return`${l} joined the room`;if(d==="invite")return`${l} was invited to the room by ${a}`;if(c==="invite"){if(d==="join")return`${l} accepted the invitation to join the room`;if(d==="leave")return`${l} declined the invitation to join the room`}else if(d==="leave"){if(o===i)return`${l} left the room`;{const h=s.reason;return`${l} was kicked from the room by ${a}${h?`: ${h}`:""}`}}else if(d==="ban")return`${l} was banned from the room by ${a}`}return`${i} membership changed to ${s.membership}`}}class Hb extends mu{updateEntry(e,t){const i=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?it.Replace("shape"):i}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e?.code;let i;return t==="MEGOLM_NO_SESSION"?i=this.i18n`The sender hasn't sent us the key for this message yet.`:i=e?.message||this.i18n`Could not decrypt message because of unknown reason.`,i}}class wu extends is{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class Wb extends Ti{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}class Yb extends is{constructor(e,t){super(e,t);const i=this.getOption("session").callHandler.calls;this._callSubscription=void 0,this._memberSizeSubscription=void 0;const s=i.get(this._entry.stateKey);s&&!s.isTerminated&&(this._call=s,this.memberViewModels=this._setupMembersList(this._call),this._callSubscription=this.track(this._call.disposableOn("change",()=>{this._onCallUpdate()})),this._memberSizeSubscription=this.track(this._call.members.observeSize().subscribe(()=>{this.emitChange("memberCount")})),this._onCallUpdate())}_onCallUpdate(){this._call.isTerminated?(this._durationInterval=this.disposeTracked(this._durationInterval),this._callSubscription=this.disposeTracked(this._callSubscription),this._call=void 0):this._durationInterval||(this._durationInterval=this.track(this.platform.clock.createInterval(()=>{this.emitChange("duration")},1e3))),this.emitChange()}_setupMembersList(e){return e.members.mapValues((t,i)=>new Jb(this.childOptions({member:t,emitChange:i,mediaRepository:this.getOption("room").mediaRepository}))).sortValues((t,i)=>t.userId.localeCompare(i.userId))}get memberCount(){return this._call?this._call.members.size:0}get confId(){return this._entry.stateKey}get duration(){return this._call&&this._call.duration?this.timeFormatter.formatDuration(this._call.duration):""}get shape(){return"call"}get canJoin(){return this._call&&!this._call.hasJoined&&!this._call.usesFoci}get canLeave(){return this._call&&this._call.hasJoined}get title(){return this._call?this.type===Cn.Video?`${this.displayName} started a video call`:`${this.displayName} started a voice call`:this.type===Cn.Video?"Video call ended":"Voice call ended"}get typeLabel(){return this._call&&this._call.usesFoci?"This call uses a stream-forwarding unit, which isn't supported yet, so you can't join this call.":this.type===Cn.Video?"Video call":"Voice call"}get type(){return this._entry.event.content["m.type"]}async join(){await this.logAndCatch("CallTile.join",async e=>{if(this.canJoin){const t=await this.platform.mediaDevices.getMediaTracks(!1,!0),i=new ui().withUserMedia(t);await this._call.join(i,e)}})}async leave(){await this.logAndCatch("CallTile.leave",async e=>{this.canLeave&&await this._call.leave(e)})}}class Jb extends lt{get _member(){return this.getOption("member")}get userId(){return this._member.userId}get avatarLetter(){return qs(this._member.member.name)}get avatarColorNumber(){return zs(this._member.userId)}avatarUrl(e){const{avatarUrl:t}=this._member.member,i=this.getOption("mediaRepository");return qr(t,e,this.platform,i)}get avatarTitle(){return this._member.member.name}}function Qo(r,e){if(r.isGap)return wb;if(r.isPending&&r.pendingEvent.isMissingAttachments)return Wb;if(r.eventType)switch(r.eventType){case"m.room.message":{if(r.isRedacted)return Xo;const t=r.content;switch(t&&t.msgtype){case"m.text":case"m.notice":case"m.emote":return pu;case"m.image":return fu;case"m.video":return gu;case"m.file":return yu;case"m.location":return vu;case"m.key.verification.request":const s=!e.session.features.crossSigning,n=e.session.userId;return s||r.sender===n?void 0:bg;default:return}}case"m.room.name":return zb;case"m.room.member":return Gb;case"m.room.encrypted":return r.isRedacted?Xo:Hb;case"m.room.encryption":return wu;case"org.matrix.msc3401.call":return e.features.calls&&r.stateKey&&!r.prevContent?Yb:void 0;default:return}}async function Xb(r,e){var t,i,s,n;try{const o=await e.joinRoom(r);return await(await e.observeRoomStatus(o)).waitFor(l=>l===we.Joined),o}catch(o){throw((t=o.statusCode)!=null?t:o.status)===400?new Error(`'${r}' is not a legal room ID or alias`):((i=o.statusCode)!=null?i:o.status)===404||((s=o.statusCode)!=null?s:o.status)===502||o.message=="Internal Server eor"?new Error(`Room '${r}' could not be found`):((n=o.statusCode)!=null?n:o.status)===403?new Error(`You are not invited to join '${r}'`):o}}class Qb extends jr{constructor(e){var t;super(e);const{room:i,tileClassForEntry:s}=e;this._sendReadReceipt=(t=e.sendReadReceipt)!=null?t:!0,this._room=i,this._timelineVM=null,this._tileClassForEntry=s??Qo,this._tileOptions=void 0,this._onRoomChange=this._onRoomChange.bind(this),this._composerVM=null,i.isArchived?this._composerVM=this.track(new eS(this.childOptions({archivedRoom:i}))):this._recreateComposerOnPowerLevelChange(),this._clearUnreadTimout=null,this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._setupCallViewModel()}_setupCallViewModel(){if(!this.features.calls)return;const e=this.getOption("session").callHandler.calls;this._callObservable=new lm(e.filterValues(i=>i.roomId===this._room.id&&i.hasJoined)),this._callViewModel=void 0,this.track(this._callObservable.subscribe(i=>{i&&this._callViewModel&&i.id===this._callViewModel.id||(this._callViewModel=this.disposeTracked(this._callViewModel),i&&(this._callViewModel=this.track(new Xc(this.childOptions({call:i,room:this._room})))),this.emitChange("callViewModel"))}));const t=this._callObservable.get();t&&(this._callViewModel=this.track(new Xc(this.childOptions({call:t,room:this._room}))))}async load(){await this.logAndCatch("RoomViewModel.load",async e=>{this._room.on("change",this._onRoomChange);const t=await this._room.openTimeline(e);this.track(()=>t.release()),this._tileOptions=this.childOptions({session:this.getOption("session"),roomVM:this,timeline:t,tileClassForEntry:this._tileClassForEntry}),this._timelineVM=this.track(new gb(this.childOptions({tileOptions:this._tileOptions,timeline:t}))),this.emitChange("timelineViewModel"),await this._clearUnreadAfterDelay(e)})}async _recreateComposerOnPowerLevelChange(){const e=await this._room.observePowerLevels(),t=()=>e.get().canSendType("m.room.message");let i=t();const s=n=>{this._composerVM=this.disposeTracked(this._composerVM),n?this._composerVM=this.track(new yb(this)):this._composerVM=this.track(new tS(this.childOptions())),this.emitChange("powerLevelObservable")};this.track(e.subscribe(()=>{const n=t();i!==n&&(s(n),i=n)})),s(i)}async _clearUnreadAfterDelay(e){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(e,this._sendReadReceipt),this._clearUnreadTimout=null}catch(t){if(t.name==="AbortError")e.set("clearUnreadCancelled",!0);else throw t}}}focus(){this.logAndCatch("RoomViewModel.focus",async e=>{this._clearUnreadAfterDelay(e)})}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){var e;(e=this._composerVM)==null||e.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get avatarLetter(){return qs(this.name)}get avatarColorNumber(){return zs(this._room.avatarColorId)}avatarUrl(e){return qr(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){if(this._tileOptions){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}}_sendMessage(e,t){return this.logAndCatch("RoomViewModel.sendMessage",async i=>{let s=!1;if(!this._room.isArchived&&e){let n="m.text";if(e.startsWith("//"))e=e.substring(1).trim();else if(e.startsWith("/")){const a=await this._processCommand(e);n=a.msgtype,e=a.message}let o;t?(i.set("replyingTo",t.eventId),o=await t.createReplyContent(n,e)):o={msgtype:n,body:e},await this._room.sendEvent("m.room.message",o,void 0,i),s=!0}return i.set("success",s),s},!1)}async _processCommandJoin(e){try{const t=this._options.client.session,i=await Xb(e,t);this.navigation.push("room",i)}catch(t){this.reportError(t)}}async _processCommand(e){let t;const[i,...s]=e.substring(1).split(" ");switch(i){case"me":e=s.join(" "),t="m.emote";break;case"join":if(s.length===1){const n=s[0];await this._processCommandJoin(n)}else this.reportError(new Error("join syntax: /join <room-id>"));break;case"invite":if(s.length===1){const n=s[0];await this._room.inviteUser(n)}else this.reportError(new Error("invite syntax: /invite <user-id>"));break;case"shrug":e="\xAF\\_(\u30C4)_/\xAF "+s.join(" "),t="m.text";break;case"tableflip":e="(\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B "+s.join(" "),t="m.text";break;case"unflip":e="\u252C\u2500\u2500\u252C \u30CE( \u309C-\u309C\u30CE) "+s.join(" "),t="m.text";break;case"lenny":e="( \u0361\xB0 \u035C\u0296 \u0361\xB0) "+s.join(" "),t="m.text";break;default:this.reportError(new Error(`no command name "${i}". To send the message instead of executing, please type "/${e}"`)),e=void 0}return{msgtype:t,message:e}}_pickAndSendFile(){return this.logAndCatch("RoomViewModel.sendFile",async e=>{const t=await this.platform.openFile();if(!t){e.set("cancelled",!0);return}return this._sendFile(t,e)})}async _sendFile(e,t){const i={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",i,{url:this._room.createAttachment(e.blob,e.name)},t)}_pickAndSendVideo(){return this.logAndCatch("RoomViewModel.sendVideo",async e=>{if(!this.platform.hasReadPixelPermission())throw new Error("Please allow canvas image data access, so we can scale your images down.");const t=await this.platform.openFile("video/*");if(!t)return;if(!t.blob.mimeType.startsWith("video/"))return this._sendFile(t,e);let i;try{i=await this.platform.loadVideo(t.blob)}catch(d){throw d instanceof window.MediaError&&d.code===4?new Error(`this browser does not support videos of type ${t?.blob.mimeType}.`):d}const s={body:t.name,msgtype:"m.video",info:Zb(i)},n={url:this._room.createAttachment(i.blob,t.name)},a=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(i.maxDimension,800),l=await i.scale(a);s.info.thumbnail_info=Nn(l),n["info.thumbnail_url"]=this._room.createAttachment(l.blob,t.name),await this._room.sendEvent("m.room.message",s,n,e)})}async _pickAndSendPicture(){this.logAndCatch("RoomViewModel.sendPicture",async e=>{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const t=await this.platform.openFile("image/*");if(!t){e.set("cancelled",!0);return}if(!t.blob.mimeType.startsWith("image/"))return this._sendFile(t,e);let i=await this.platform.loadImage(t.blob);const s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(s&&i.maxDimension>s){const a=await i.scale(s);i.dispose(),i=a}const n={body:t.name,msgtype:"m.image",info:Nn(i)},o={url:this._room.createAttachment(i.blob,t.name)};if(i.maxDimension>600){const a=await i.scale(400);n.info.thumbnail_info=Nn(a),o["info.thumbnail_url"]=this._room.createAttachment(a.blob,t.name)}await this._room.sendEvent("m.room.message",n,o,e)})}get room(){return this._room}get composerViewModel(){return this._composerVM}get callViewModel(){return this._callViewModel}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}startCall(){return this.logAndCatch("RoomViewModel.startCall",async e=>{if(!this.features.calls){e.set("feature_disbled",!0);return}e.set("roomId",this._room.id);let t;try{const n=await this.platform.mediaDevices.getMediaTracks(!1,!0);t=new ui().withUserMedia(n)}catch(n){throw new Error(`Could not get local audio and/or video stream: ${n.message}`)}const i=this.getOption("session");let s;try{s=await i.callHandler.createCall(this._room.id,"m.video","A call "+Math.round(this.platform.random()*100),void 0,e)}catch(n){throw new Error(`Could not create call: ${n.message}`)}try{await s.join(t,e)}catch(n){throw new Error(`Could not join call: ${n.message}`)}})}}function Zb(r){const e=Nn(r);return e.duration=r.duration,e}class eS extends lt{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"disabled"}}class tS extends lt{get description(){return this.i18n`You do not have the powerlevel necessary to send messages`}get kind(){return"disabled"}}js("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class iS extends pu{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class sS extends fu{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class rS extends gu{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class nS extends yu{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class oS extends vu{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class aS extends Xo{get displayName(){return this.isOwn?"me":super.displayName}get avatarLetter(){return""}avatarUrl(e){return this.isOwn?this._options.config.avatar??null:super.avatarUrl(e)}}class cS extends wu{get announcement(){return this.i18n`This room is end-to-end encrypted `}}function lS(r){return function(t){switch(t.eventType){case"m.room.message":if(t.isRedacted)return aS;const i=t.content;switch(i&&i.msgtype){case"m.text":case"m.notice":case"m.emote":return iS;case"m.image":return sS;case"m.video":return rS;case"m.file":return nS;case"m.location":return oS;default:return}case"m.room.member":return(t.content?.membership==="join"||t.content?.membership==="leave")&&t.sender!==r?Qo(t):void 0;case"m.room.encryption":return cS;default:return Qo(t)}}}class dS extends lt{_roomViewModel;_loginPromise;constructor(e){super(e),this._client=e.client,this._loginPromise=e.loginPromise,this.emitOnRoomViewModelChange=this.emitOnRoomViewModelChange.bind(this)}async load(){await this._loginPromise;let e;if(this._options.config.invite_user)e=await this.createRoomWithUserSpecifiedInConfig();else if(this._options.config.auto_join_room)e=await this.joinRoomSpecifiedInConfig();else throw new Error("ConfigError: You must either specify 'invite_user' or 'auto_join_room'");this._roomViewModel=this.track(new Qb(this.childOptions({room:e,ownUserId:this._session.userId,platform:this.platform,urlCreator:this.urlCreator,navigation:this.navigation,tileClassForEntry:lS(this._session.userId)}))),console.log(this._roomViewModel),await this._roomViewModel.load(),this._roomViewModel.on("change",this.emitOnRoomViewModelChange),this.emitChange("roomViewModel")}emitOnRoomViewModelChange(){this.emitChange("roomViewModel")}async createRoomWithUserSpecifiedInConfig(){const e=this._options.config.invite_user,t=this._session.userId;let i=await this.findPreviouslyCreatedRoom();if(i)return i;const s=this._options.config.disable_composer_until_operator_join?{users:{[e]:100,[t]:60},events:{"m.room.message":80},redact:90}:null,n=this._session.createRoom({type:1,name:void 0,topic:void 0,isEncrypted:this._options.config.encrypt_room??!1,isFederationDisabled:!1,alias:void 0,avatar:void 0,invites:[e],powerLevelContentOverride:s});await(await this._session.observeRoomStatus(n.id)).waitFor(l=>l===(we.BeingCreated|we.Replaced)).promise;const a=n.roomId;return await this.platform.settingsStorage.setString("created-room-id",a),await this.platform.settingsStorage.setString("invite-user",e),i=this._session.rooms.get(a),i}async joinRoomSpecifiedInConfig(){const e=this._options.config.auto_join_room;let t=this._session.rooms.get(e);return t||(await this._session.joinRoom(e),await this._waitForRoomFromSync(e),t=this._session.rooms.get(e)),t}_waitForRoomFromSync(e){let t;const i=new Promise(n=>{t=n}),s={onAdd:(n,o)=>{o.id===e&&(this._session.rooms.unsubscribe(s),t())},onUpdate:()=>{},onRemove:()=>{}};return this._session.rooms.subscribe(s),i}async findPreviouslyCreatedRoom(){const e=await this.platform.settingsStorage.getString("created-room-id"),t=await this.platform.settingsStorage.getString("invite-user"),i=this._options.config.invite_user;return e&&t===i?this._session.rooms.get(e):null}dispose(){super.dispose(),this._roomViewModel.off("change",this.emitOnRoomViewModelChange)}minimize(){window.sendMinimizeToParent(),this.navigation.push("minimize")}get timelineViewModel(){return this._roomViewModel?.timelineViewModel}get messageComposerViewModel(){return this._roomViewModel?.composerViewModel}get roomViewModel(){return this._roomViewModel}get roomName(){return this._options.config.header?.title??""}get customAvatarURL(){return this._options.config.header?.avatar}get _session(){return this._client.session}get footerViewModel(){return this.options.footerVM}}function bu(r,e){let t="";const i=e.length;for(let s=0;s<r;s++)t+=e.charAt(Math.floor(Math.random()*i));return t}function uS(r){return bu(r," !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~")}function hS(r){return bu(r,"abcdefghijklmnopqrstuvwxyz0123456789_-.=/")}class mS extends lt{_config;_client;_startStage;_registration;_privacyPolicyLink;_showButtonSpinner=!1;constructor(e){super(e),this._client=e.client,this._config=e.config,this._startRegistration()}async _startRegistration(){const e=uS(10),t=10;for(let i=0;i<t;++i)try{const s=`${this._config.username_prefix}-${hS(10)}`,n=a=>{const l=["m.login.registration_token","org.matrix.msc3231.login.registration_token","m.login.terms","m.login.dummy"];for(const d of a){const c=d.stages.some(p=>!l.includes(p)),h=d.stages.includes("m.login.registration_token")||d.stages.includes("org.matrix.msc3231.login.registration_token");if(!c&&h)return d}};this._registration=await this._client.startRegistration(this._homeserver,s,e,"Chatterbox",n),this._startStage=await this._registration.start();let o=this._startStage;for(;o&&o.type!=="m.login.terms";)o=o.nextStage;if(!o){this.completeRegistration();return}this._privacyPolicyLink=o.privacyPolicy.en?.url,this.emitChange("privacyPolicyLink");break}catch(s){if(s.errcode!=="M_USER_IN_USE")throw s}}async completeRegistration(){this._showButtonSpinner=!0,this.emitChange("showButtonSpinner");let e=this._startStage;for(;e;)(e.type==="m.login.registration_token"||e.type==="org.matrix.msc3231.login.registration_token")&&e.setToken(this._config.token),e=await this._registration.submitStage(e);const t=this.setupSession();this.navigation.push("timeline",t)}async setupSession(){if(this._client.startWithAuthData(this._registration.authData),await this._client.loadStatus.waitFor(e=>e===de.Ready||e===de.Error||e===de.LoginFailed).promise,this._client.loginFailure)throw new Error("login failed: "+this._client.loginFailure);if(this._client.loadError)throw new Error("load failed: "+this._client.loadError.message)}minimize(){window.sendMinimizeToParent(),this.navigation.push("minimize")}get _homeserver(){return this._config.homeserver}get privacyPolicyLink(){return this._privacyPolicyLink}get footerViewModel(){return this.options.footerVM}get showButtonSpinner(){return this._showButtonSpinner}}class pS extends lt{_config;constructor(e){super(e),this._config=e.config}get chatterboxLink(){return this._config.footer?.chatterbox_link??null}get matrixLink(){return this._config.footer?.matrix_link??null}}class _S extends Mt{constructor(){super(),window.addEventListener("message",e=>{const{action:t}=e.data;this.emit(t,e.data)})}}class fS extends lt{_config;_client;_chatterBoxViewModel;_accountSetupViewModel;_activeSection;_messageFromParent=new _S;_startMinimized;_isWatchingNotificationCount;_footerViewModel;constructor(e,t){super(t),this._startMinimized=t.startMinimized,this._config=e,this._client=new rb(this.platform),this._footerViewModel=new pS(this.childOptions({config:this._config})),this._setupNavigation(),this._messageFromParent.on("maximize",()=>this.start()),this._messageFromParent.on("minimize",()=>this.navigation.push("minimize"))}_setupNavigation(){this.navigation.observe("account-setup").subscribe(()=>this._showAccountSetup()),this.navigation.observe("timeline").subscribe(e=>this._showTimeline(e)),this.navigation.observe("minimize").subscribe(()=>this.minimizeChatterbox())}async start(){if(await this.attemptStartWithExistingSession()){if(this._isWatchingNotificationCount||this._watchNotificationCount(),this._startMinimized){this._startMinimized=!1;return}this.navigation.push("timeline");return}this.navigation.push("account-setup")}async _showTimeline(e){this._activeSection="timeline",this._chatterBoxViewModel||(this._chatterBoxViewModel=this.track(new dS(this.childOptions({client:this._client,config:this._config,state:this._state,footerVM:this._footerViewModel,loginPromise:e}))),await this._chatterBoxViewModel.load(),this._isWatchingNotificationCount||this._watchNotificationCount()),this.emitChange("activeSection")}_showAccountSetup(){this._activeSection="account-setup",this._accountSetupViewModel=this.track(new mS(this.childOptions({client:this._client,config:this._config,state:this._state,footerVM:this._footerViewModel}))),this.emitChange("activeSection")}async attemptStartWithExistingSession(){const t=(await this.platform.sessionInfoStorage.getAll()).pop();if(t){const{id:i}=t;return await this._client.startWithExistingSession(i),!0}return!1}async _watchNotificationCount(){await this._client.loadStatus.waitFor(o=>o===de.Ready).promise,console.log(this);const e=await this.platform.settingsStorage.getString("created-room-id")??this._config.auto_join_room;await(await this._client.session.observeRoomStatus(e)).waitFor(o=>o===we.Joined).promise;let s=this._client.session.rooms.get(e).notificationCount;window.sendNotificationCount(s);const n={onUpdate(o,a){const l=a.notificationCount;if(l!==s){if(!a.isUnread&&l!==0){a.clearUnread();return}window.sendNotificationCount(l),s=l}}};this.track(this._client.session.rooms.subscribe(n)),this._isWatchingNotificationCount=!0}minimizeChatterbox(){this._chatterBoxViewModel=this.disposeTracked(this._chatterBoxViewModel),this._accountSetupViewModel=this.disposeTracked(this._chatterBoxViewModel),this._activeSection="",this.emitChange("chatterboxViewModel")}get chatterboxViewModel(){return this._chatterBoxViewModel}get accountSetupViewModel(){return this._accountSetupViewModel}get activeSection(){return this._activeSection}}class Su extends T{render(e){return e.div({className:"ChatterboxLoadingView"},[e.div({className:"chatterbox-spinner"},[e.div({className:"loader"})]),e.span({className:"LoadingText"},"Loading")])}}var gS="/assets/chat-bubbles.be66ba17.svg";class Eu extends T{constructor(e){super(e)}render(e,t){return e.div({className:"FooterView"},[e.div([e.img({src:gS,className:"FooterView_logo"}),e.a({className:"FooterView_chatterbox-branding",href:t.chatterboxLink,target:"_top",rel:"noopener"},"Chatterbox")]),e.a({className:"FooterView_matrix-branding",href:t.matrixLink,target:"_top",rel:"noopener"},"Powered by Tronic")])}}class yS extends T{constructor(e){super(e)}render(e,t){return e.div({className:"AccountSetupView"},[e.mapView(i=>i.privacyPolicyLink,i=>i?new vS(t):new Su),e.view(new Eu(t.footerViewModel))])}}class vS extends T{constructor(e){super(e)}render(e,t){return e.div({className:"PolicyAgreementView"},[e.div({className:"PolicyAgreementView_title"},"Your privacy comes first"),e.div({className:"PolicyAgreementView_text"},["Please accept our ",e.a({href:t.privacyPolicyLink},"Privacy Policy")," before proceeding to the chat."]),e.div({className:"PolicyAgreementView_btn-collection"},[e.button({onClick:()=>t.completeRegistration(),className:"PolicyAgreementView_next",disabled:i=>i.showButtonSpinner},e.map(i=>i.showButtonSpinner,(i,s)=>i?s.div({className:"loader"}):s.span("Accept and continue to chat"))),e.button({onClick:()=>t.minimize(),className:"button-action PolicyAgreementView_cancel"},"Cancel")])])}}class wS extends T{constructor(e){super(e)}render(e,t){return e.div({className:"ChatterboxView"},[e.mapView(i=>i.roomViewModel?i:null,i=>i?new bS(i):null),e.mapView(i=>i.timelineViewModel,i=>i?new wd(i,Bo):new Su),e.mapView(i=>i.messageComposerViewModel,i=>i?.kind==="composer"?new bd(i):new SS),e.view(new Eu(t.footerViewModel))])}}class bS extends T{constructor(e){super(e)}render(e,t){const i=t.customAvatarURL?e.img({className:"avatar",src:t.customAvatarURL}):e.view(new vt(t.roomViewModel,30));return e.div({className:"RoomHeaderView"},[i,e.div({className:"RoomHeaderView_name"},s=>s.roomName),e.div({className:"RoomHeaderView_menu"},[e.button({className:"RoomHeaderView_menu_minimize",onClick:()=>{t.minimize()}})])])}}class SS extends T{render(e){return e.div({className:"WaitingForOperatorJoinView"},[e.div({className:"FakeComposerContainer"},[e.span("Waiting for operator to join "),e.div({className:"loader"})])])}}class ES extends T{constructor(e){super(e)}render(e,t){return e.mapView(i=>i.activeSection,i=>{switch(window.sendViewChangeToParent(i),i){case"account-setup":return new yS(t.accountSetupViewModel);case"timeline":return new wS(t.chatterboxViewModel)}return null})}}var kS="/assets/download-sandbox.48a866e9.html",IS="/assets/main.bdb9a925.js",xS="/assets/olm.82e831ad.wasm",TS="/assets/olm.bed41b9d.js",RS="/assets/olm_legacy.086c8bde.js";function CS(){return typeof __SENTRY_BROWSER_BUNDLE__<"u"&&!!__SENTRY_BROWSER_BUNDLE__}function to(){return!CS()&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"}function _i(r,e){return r.require(e)}function MS(r){let e;try{e=_i(jt,r)}catch{}try{const{cwd:t}=_i(jt,"process");e=_i(jt,`${t()}/node_modules/${r}`)}catch{}return e}var AS={};function W(){return to()?global:typeof window<"u"?window:typeof self<"u"?self:AS}function Na(r,e,t){var i=t||W(),s=i.__SENTRY__=i.__SENTRY__||{},n=s[r]||(s[r]=e());return n}var ku=Object.prototype.toString;function Iu(r){switch(ku.call(r)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return ei(r,Error)}}function Gs(r,e){return ku.call(r)===`[object ${e}]`}function xu(r){return Gs(r,"ErrorEvent")}function il(r){return Gs(r,"DOMError")}function NS(r){return Gs(r,"DOMException")}function ki(r){return Gs(r,"String")}function Tu(r){return r===null||typeof r!="object"&&typeof r!="function"}function Ps(r){return Gs(r,"Object")}function Da(r){return typeof Event<"u"&&ei(r,Event)}function DS(r){return typeof Element<"u"&&ei(r,Element)}function VS(r){return Gs(r,"RegExp")}function Va(r){return Boolean(r&&r.then&&typeof r.then=="function")}function US(r){return Ps(r)&&"nativeEvent"in r&&"preventDefault"in r&&"stopPropagation"in r}function Ru(r){return typeof r=="number"&&r!==r}function ei(r,e){try{return r instanceof e}catch{return!1}}function Ar(r,e){try{let a=r;var t=5,i=80,s=[];let l=0,d=0;var n=" > ",o=n.length;let c;for(;a&&l++<t&&(c=PS(a,e),!(c==="html"||l>1&&d+s.length*o+c.length>=i));)s.push(c),d+=c.length,a=a.parentNode;return s.reverse().join(n)}catch{return"<unknown>"}}function PS(r,e){var t=r,i=[];let s,n,o,a,l;if(!t||!t.tagName)return"";i.push(t.tagName.toLowerCase());var d=e&&e.length?e.filter(h=>t.getAttribute(h)).map(h=>[h,t.getAttribute(h)]):null;if(d&&d.length)d.forEach(h=>{i.push(`[${h[0]}="${h[1]}"]`)});else if(t.id&&i.push(`#${t.id}`),s=t.className,s&&ki(s))for(n=s.split(/\s+/),l=0;l<n.length;l++)i.push(`.${n[l]}`);var c=["type","name","title","alt"];for(l=0;l<c.length;l++)o=c[l],a=t.getAttribute(o),a&&i.push(`[${o}="${a}"]`);return i.join("")}function OS(){var r=W();try{return r.document.location.href}catch{return""}}class Ve extends Error{constructor(e){super(e),this.message=e,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype)}}var FS=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+))?@)([\w.-]+)(?::(\d+))?\/(.+)/;function LS(r){return r==="http"||r==="https"}function Ua(r,e=!1){const{host:t,path:i,pass:s,port:n,projectId:o,protocol:a,publicKey:l}=r;return`${a}://${l}${e&&s?`:${s}`:""}@${t}${n?`:${n}`:""}/${i&&`${i}/`}${o}`}function BS(r){var e=FS.exec(r);if(!e)throw new Ve(`Invalid Sentry Dsn: ${r}`);const[t,i,s="",n,o="",a]=e.slice(1);let l="",d=a;var c=d.split("/");if(c.length>1&&(l=c.slice(0,-1).join("/"),d=c.pop()),d){var h=d.match(/^\d+/);h&&(d=h[0])}return Cu({host:n,pass:s,path:l,projectId:d,port:o,protocol:t,publicKey:i})}function Cu(r){return{protocol:r.protocol,publicKey:r.publicKey||"",pass:r.pass||"",host:r.host,port:r.port||"",path:r.path||"",projectId:r.projectId}}function KS(r){if(!(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__))return;const{port:e,projectId:t,protocol:i}=r;var s=["protocol","publicKey","host","projectId"];if(s.forEach(n=>{if(!r[n])throw new Ve(`Invalid Sentry Dsn: ${n} missing`)}),!t.match(/^\d+$/))throw new Ve(`Invalid Sentry Dsn: Invalid projectId ${t}`);if(!LS(i))throw new Ve(`Invalid Sentry Dsn: Invalid protocol ${i}`);if(e&&isNaN(parseInt(e,10)))throw new Ve(`Invalid Sentry Dsn: Invalid port ${e}`);return!0}function $S(r){var e=typeof r=="string"?BS(r):Cu(r);return KS(e),e}var jS=W(),qS="Sentry Logger ",Gn=["debug","info","warn","error","log","assert","trace"];function Mu(r){var e=W();if(!("console"in e))return r();var t=e.console,i={};Gn.forEach(s=>{var n=t[s]&&t[s].__sentry_original__;s in e.console&&n&&(i[s]=t[s],t[s]=n)});try{return r()}finally{Object.keys(i).forEach(s=>{t[s]=i[s]})}}function sl(){let r=!1;var e={enable:()=>{r=!0},disable:()=>{r=!1}};return typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?Gn.forEach(t=>{e[t]=(...i)=>{r&&Mu(()=>{jS.console[t](`${qS}[${t}]:`,...i)})}}):Gn.forEach(t=>{e[t]=()=>{}}),e}let k;typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?k=Na("logger",sl):k=sl();function vr(r,e=0){return typeof r!="string"||e===0||r.length<=e?r:`${r.substr(0,e)}...`}function rl(r,e){if(!Array.isArray(r))return"";var t=[];for(let s=0;s<r.length;s++){var i=r[s];try{t.push(String(i))}catch{t.push("[value cannot be serialized]")}}return t.join(e)}function Nr(r,e){return ki(r)?VS(e)?e.test(r):typeof e=="string"?r.indexOf(e)!==-1:!1:!1}function Ue(r,e,t){if(e in r){var i=r[e],s=t(i);if(typeof s=="function")try{Au(s,i)}catch{}r[e]=s}}function Pa(r,e,t){Object.defineProperty(r,e,{value:t,writable:!0,configurable:!0})}function Au(r,e){var t=e.prototype||{};r.prototype=e.prototype=t,Pa(r,"__sentry_original__",e)}function Oa(r){return r.__sentry_original__}function zS(r){return Object.keys(r).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(r[e])}`).join("&")}function Nu(r){if(Iu(r))return{message:r.message,name:r.name,stack:r.stack,...ol(r)};if(Da(r)){var e={type:r.type,target:nl(r.target),currentTarget:nl(r.currentTarget),...ol(r)};return typeof CustomEvent<"u"&&ei(r,CustomEvent)&&(e.detail=r.detail),e}else return r}function nl(r){try{return DS(r)?Ar(r):Object.prototype.toString.call(r)}catch{return"<unknown>"}}function ol(r){if(typeof r=="object"&&r!==null){var e={};for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t]);return e}else return{}}function GS(r,e=40){var t=Object.keys(Nu(r));if(t.sort(),!t.length)return"[object has no keys]";if(t[0].length>=e)return vr(t[0],e);for(let s=t.length;s>0;s--){var i=t.slice(0,s).join(", ");if(!(i.length>e))return s===t.length?i:vr(i,e)}return""}function vi(r){var e=new Map;return Zo(r,e)}function Zo(r,e){if(Ps(r)){var t=e.get(r);if(t!==void 0)return t;var i={};e.set(r,i);for(var s of Object.keys(r))typeof r[s]<"u"&&(i[s]=Zo(r[s],e));return i}if(Array.isArray(r)){var t=e.get(r);if(t!==void 0)return t;var i=[];return e.set(r,i),r.forEach(a=>{i.push(Zo(a,e))}),i}return r}function hi(r,e){return r??e()}var HS=50;function Du(...r){var e=r.sort((t,i)=>t[0]-i[0]).map(t=>t[1]);return(t,i=0)=>{var s=[];for(var n of t.split(`
`).slice(i))for(var o of e){var a=o(n);if(a){s.push(a);break}}return YS(s)}}function WS(r){return Array.isArray(r)?Du(...r):r}function YS(r){if(!r.length)return[];let e=r;var t=e[0].function||"",i=e[e.length-1].function||"";return(t.indexOf("captureMessage")!==-1||t.indexOf("captureException")!==-1)&&(e=e.slice(1)),i.indexOf("sentryWrapped")!==-1&&(e=e.slice(0,-1)),e.slice(0,HS).map(s=>({...s,filename:s.filename||e[0].filename,function:s.function||"?"})).reverse()}var xo="<anonymous>";function Ii(r){try{return!r||typeof r!="function"?xo:r.name||xo}catch{return xo}}function Fa(){if(!("fetch"in W()))return!1;try{return new Headers,new Request(""),new Response,!0}catch{return!1}}function ea(r){return r&&/^function fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(r.toString())}function JS(){if(!Fa())return!1;var r=W();if(ea(r.fetch))return!0;let e=!1;var t=r.document;if(t&&typeof t.createElement=="function")try{var i=t.createElement("iframe");i.hidden=!0,t.head.appendChild(i),i.contentWindow&&i.contentWindow.fetch&&(e=ea(i.contentWindow.fetch)),t.head.removeChild(i)}catch(s){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",s)}return e}function XS(){var r=W(),e=r.chrome,t=e&&e.app&&e.app.runtime,i="history"in r&&!!r.history.pushState&&!!r.history.replaceState;return!t&&i}var ce=W(),wr={},al={};function QS(r){if(!al[r])switch(al[r]=!0,r){case"console":ZS();break;case"dom":cE();break;case"xhr":sE();break;case"fetch":eE();break;case"history":rE();break;case"error":lE();break;case"unhandledrejection":dE();break;default:(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("unknown instrumentation type:",r);return}}function tt(r,e){wr[r]=wr[r]||[],wr[r].push(e),QS(r)}function ft(r,e){if(!(!r||!wr[r]))for(var t of wr[r]||[])try{t(e)}catch(i){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error(`Error while triggering instrumentation handler.
Type: ${r}
Name: ${Ii(t)}
Error:`,i)}}function ZS(){"console"in ce&&Gn.forEach(function(r){r in ce.console&&Ue(ce.console,r,function(e){return function(...t){ft("console",{args:t,level:r}),e&&e.apply(ce.console,t)}})})}function eE(){!JS()||Ue(ce,"fetch",function(r){return function(...e){var t={args:e,fetchData:{method:tE(e),url:iE(e)},startTimestamp:Date.now()};return ft("fetch",{...t}),r.apply(ce,e).then(i=>(ft("fetch",{...t,endTimestamp:Date.now(),response:i}),i),i=>{throw ft("fetch",{...t,endTimestamp:Date.now(),error:i}),i})}})}function tE(r=[]){return"Request"in ce&&ei(r[0],Request)&&r[0].method?String(r[0].method).toUpperCase():r[1]&&r[1].method?String(r[1].method).toUpperCase():"GET"}function iE(r=[]){return typeof r[0]=="string"?r[0]:"Request"in ce&&ei(r[0],Request)?r[0].url:String(r[0])}function sE(){if("XMLHttpRequest"in ce){var r=XMLHttpRequest.prototype;Ue(r,"open",function(e){return function(...t){var i=this,s=t[1],n=i.__sentry_xhr__={method:ki(t[0])?t[0].toUpperCase():t[0],url:t[1]};ki(s)&&n.method==="POST"&&s.match(/sentry_key/)&&(i.__sentry_own_request__=!0);var o=function(){if(i.readyState===4){try{n.status_code=i.status}catch{}ft("xhr",{args:t,endTimestamp:Date.now(),startTimestamp:Date.now(),xhr:i})}};return"onreadystatechange"in i&&typeof i.onreadystatechange=="function"?Ue(i,"onreadystatechange",function(a){return function(...l){return o(),a.apply(i,l)}}):i.addEventListener("readystatechange",o),e.apply(i,t)}}),Ue(r,"send",function(e){return function(...t){return this.__sentry_xhr__&&t[0]!==void 0&&(this.__sentry_xhr__.body=t[0]),ft("xhr",{args:t,startTimestamp:Date.now(),xhr:this}),e.apply(this,t)}})}}let yn;function rE(){if(!XS())return;var r=ce.onpopstate;ce.onpopstate=function(...t){var i=ce.location.href,s=yn;if(yn=i,ft("history",{from:s,to:i}),r)try{return r.apply(this,t)}catch{}};function e(t){return function(...i){var s=i.length>2?i[2]:void 0;if(s){var n=yn,o=String(s);yn=o,ft("history",{from:n,to:o})}return t.apply(this,i)}}Ue(ce.history,"pushState",e),Ue(ce.history,"replaceState",e)}var nE=1e3;let vn,wn;function oE(r,e){if(!r||r.type!==e.type)return!0;try{if(r.target!==e.target)return!0}catch{}return!1}function aE(r){if(r.type!=="keypress")return!1;try{var e=r.target;if(!e||!e.tagName)return!0;if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable)return!1}catch{}return!0}function cl(r,e=!1){return t=>{if(!(!t||wn===t)&&!aE(t)){var i=t.type==="keypress"?"input":t.type;vn===void 0?(r({event:t,name:i,global:e}),wn=t):oE(wn,t)&&(r({event:t,name:i,global:e}),wn=t),clearTimeout(vn),vn=ce.setTimeout(()=>{vn=void 0},nE)}}}function cE(){if("document"in ce){var r=ft.bind(null,"dom"),e=cl(r,!0);ce.document.addEventListener("click",e,!1),ce.document.addEventListener("keypress",e,!1),["EventTarget","Node"].forEach(t=>{var i=ce[t]&&ce[t].prototype;!i||!i.hasOwnProperty||!i.hasOwnProperty("addEventListener")||(Ue(i,"addEventListener",function(s){return function(n,o,a){if(n==="click"||n=="keypress")try{var l=this,d=l.__sentry_instrumentation_handlers__=l.__sentry_instrumentation_handlers__||{},c=d[n]=d[n]||{refCount:0};if(!c.handler){var h=cl(r);c.handler=h,s.call(this,n,h,a)}c.refCount+=1}catch{}return s.call(this,n,o,a)}}),Ue(i,"removeEventListener",function(s){return function(n,o,a){if(n==="click"||n=="keypress")try{var l=this,d=l.__sentry_instrumentation_handlers__||{},c=d[n];c&&(c.refCount-=1,c.refCount<=0&&(s.call(this,n,c.handler,a),c.handler=void 0,delete d[n]),Object.keys(d).length===0&&delete l.__sentry_instrumentation_handlers__)}catch{}return s.call(this,n,o,a)}}))})}}let To=null;function lE(){To=ce.onerror,ce.onerror=function(r,e,t,i,s){return ft("error",{column:i,error:s,line:t,msg:r,url:e}),To?To.apply(this,arguments):!1}}let Ro=null;function dE(){Ro=ce.onunhandledrejection,ce.onunhandledrejection=function(r){return ft("unhandledrejection",r),Ro?Ro.apply(this,arguments):!0}}function uE(){var r=typeof WeakSet=="function",e=r?new WeakSet:[];function t(s){if(r)return e.has(s)?!0:(e.add(s),!1);for(let o=0;o<e.length;o++){var n=e[o];if(n===s)return!0}return e.push(s),!1}function i(s){if(r)e.delete(s);else for(let n=0;n<e.length;n++)if(e[n]===s){e.splice(n,1);break}}return[t,i]}function wi(){var r=W(),e=r.crypto||r.msCrypto;if(e!==void 0&&e.getRandomValues){var t=new Uint16Array(8);e.getRandomValues(t),t[3]=t[3]&4095|16384,t[4]=t[4]&16383|32768;var i=s=>{let n=s.toString(16);for(;n.length<4;)n=`0${n}`;return n};return i(t[0])+i(t[1])+i(t[2])+i(t[3])+i(t[4])+i(t[5])+i(t[6])+i(t[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,s=>{var n=Math.random()*16|0,o=s==="x"?n:n&3|8;return o.toString(16)})}function Co(r){if(!r)return{};var e=r.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};var t=e[6]||"",i=e[8]||"";return{host:e[4],path:e[5],protocol:e[2],relative:e[5]+t+i}}function Vu(r){return r.exception&&r.exception.values?r.exception.values[0]:void 0}function qi(r){const{message:e,event_id:t}=r;if(e)return e;var i=Vu(r);return i?i.type&&i.value?`${i.type}: ${i.value}`:i.type||i.value||t||"<unknown>":t||"<unknown>"}function ta(r,e,t){var i=r.exception=r.exception||{},s=i.values=i.values||[],n=s[0]=s[0]||{};n.value||(n.value=e||""),n.type||(n.type=t||"Error")}function Dr(r,e){var t=Vu(r);if(!!t){var i={type:"generic",handled:!0},s=t.mechanism;if(t.mechanism={...i,...s,...e},e&&"data"in e){var n={...s&&s.data,...e.data};t.mechanism.data=n}}}function ll(r){if(r&&r.__sentry_captured__)return!0;try{Pa(r,"__sentry_captured__",!0)}catch{}return!1}function Ki(r,e=1/0,t=1/0){try{return ia("",r,e,t)}catch(i){return{ERROR:`**non-serializable** (${i})`}}}function Uu(r,e=3,t=100*1024){var i=Ki(r,e);return pE(i)>t?Uu(r,e-1,t):i}function ia(r,e,t=1/0,i=1/0,s=uE()){const[n,o]=s;if(e===null||["number","boolean","string"].includes(typeof e)&&!Ru(e))return e;var a=hE(r,e);if(!a.startsWith("[object "))return a;if(e.__sentry_skip_normalization__)return e;if(t===0)return a.replace("object ","");if(n(e))return"[Circular ~]";var l=e;if(l&&typeof l.toJSON=="function")try{var d=l.toJSON();return ia("",d,t-1,i,s)}catch{}var c=Array.isArray(e)?[]:{};let h=0;var p=Nu(e);for(var g in p)if(!!Object.prototype.hasOwnProperty.call(p,g)){if(h>=i){c[g]="[MaxProperties ~]";break}var y=p[g];c[g]=ia(g,y,t-1,i,s),h+=1}return o(e),c}function hE(r,e){try{return r==="domain"&&e&&typeof e=="object"&&e._events?"[Domain]":r==="domainEmitter"?"[DomainEmitter]":typeof global<"u"&&e===global?"[Global]":typeof window<"u"&&e===window?"[Window]":typeof document<"u"&&e===document?"[Document]":US(e)?"[SyntheticEvent]":typeof e=="number"&&e!==e?"[NaN]":e===void 0?"[undefined]":typeof e=="function"?`[Function: ${Ii(e)}]`:typeof e=="symbol"?`[${String(e)}]`:typeof e=="bigint"?`[BigInt: ${String(e)}]`:`[object ${Object.getPrototypeOf(e).constructor.name}]`}catch(t){return`**non-serializable** (${t})`}}function mE(r){return~-encodeURI(r).split(/%..|./).length}function pE(r){return mE(JSON.stringify(r))}var Ft;(function(r){var e=0;r[r.PENDING=e]="PENDING";var t=1;r[r.RESOLVED=t]="RESOLVED";var i=2;r[r.REJECTED=i]="REJECTED"})(Ft||(Ft={}));function es(r){return new Be(e=>{e(r)})}function sa(r){return new Be((e,t)=>{t(r)})}class Be{__init(){this._state=Ft.PENDING}__init2(){this._handlers=[]}constructor(e){Be.prototype.__init.call(this),Be.prototype.__init2.call(this),Be.prototype.__init3.call(this),Be.prototype.__init4.call(this),Be.prototype.__init5.call(this),Be.prototype.__init6.call(this);try{e(this._resolve,this._reject)}catch(t){this._reject(t)}}then(e,t){return new Be((i,s)=>{this._handlers.push([!1,n=>{if(!e)i(n);else try{i(e(n))}catch(o){s(o)}},n=>{if(!t)s(n);else try{i(t(n))}catch(o){s(o)}}]),this._executeHandlers()})}catch(e){return this.then(t=>t,e)}finally(e){return new Be((t,i)=>{let s,n;return this.then(o=>{n=!1,s=o,e&&e()},o=>{n=!0,s=o,e&&e()}).then(()=>{if(n){i(s);return}t(s)})})}__init3(){this._resolve=e=>{this._setResult(Ft.RESOLVED,e)}}__init4(){this._reject=e=>{this._setResult(Ft.REJECTED,e)}}__init5(){this._setResult=(e,t)=>{if(this._state===Ft.PENDING){if(Va(t)){t.then(this._resolve,this._reject);return}this._state=e,this._value=t,this._executeHandlers()}}}__init6(){this._executeHandlers=()=>{if(this._state!==Ft.PENDING){var e=this._handlers.slice();this._handlers=[],e.forEach(t=>{t[0]||(this._state===Ft.RESOLVED&&t[1](this._value),this._state===Ft.REJECTED&&t[2](this._value),t[0]=!0)})}}}}function _E(r){var e=[];function t(){return r===void 0||e.length<r}function i(o){return e.splice(e.indexOf(o),1)[0]}function s(o){if(!t())return sa(new Ve("Not adding Promise due to buffer limit reached."));var a=o();return e.indexOf(a)===-1&&e.push(a),a.then(()=>i(a)).then(null,()=>i(a).then(null,()=>{})),a}function n(o){return new Be((a,l)=>{let d=e.length;if(!d)return a(!0);var c=setTimeout(()=>{o&&o>0&&a(!1)},o);e.forEach(h=>{es(h).then(()=>{--d||(clearTimeout(c),a(!0))},l)})})}return{$:e,add:s,drain:n}}var fE=["fatal","error","warning","log","info","debug"];function gE(r){return r==="warn"?"warning":fE.includes(r)?r:"log"}var ra={nowSeconds:()=>Date.now()/1e3};function yE(){const{performance:r}=W();if(!(!r||!r.now)){var e=Date.now()-r.now();return{now:()=>r.now(),timeOrigin:e}}}function vE(){try{var r=_i(jt,"perf_hooks");return r.performance}catch{return}}var Mo=to()?vE():yE(),dl=Mo===void 0?ra:{nowSeconds:()=>(Mo.timeOrigin+Mo.now())/1e3},io=ra.nowSeconds.bind(ra),La=dl.nowSeconds.bind(dl),Vr=La,Ur=(()=>{const{performance:r}=W();if(!(!r||!r.now)){var e=3600*1e3,t=r.now(),i=Date.now(),s=r.timeOrigin?Math.abs(r.timeOrigin+t-i):e,n=s<e,o=r.timing&&r.timing.navigationStart,a=typeof o=="number",l=a?Math.abs(o+t-i):e,d=l<e;return n||d?s<=l?r.timeOrigin:o:i}})(),wE=new RegExp("^[ \\t]*([0-9a-f]{32})?-?([0-9a-f]{16})?-?([01])?[ \\t]*$");function bE(r){var e=r.match(wE);if(e){let t;return e[3]==="1"?t=!0:e[3]==="0"&&(t=!1),{traceId:e[1],parentSampled:t,parentSpanId:e[2]}}}function so(r,e=[]){return[r,e]}function SE(r,e){const[t,i]=r;return[t,[...i,e]]}function ul(r,e){var t=r[1];t.forEach(i=>{var s=i[0].type;e(i,s)})}function na(r,e){var t=e||new TextEncoder;return t.encode(r)}function Pu(r,e){const[t,i]=r;let s=JSON.stringify(t);function n(a){typeof s=="string"?s=typeof a=="string"?s+a:[na(s,e),a]:s.push(typeof a=="string"?na(a,e):a)}for(var o of i){const[a,l]=o;n(`
${JSON.stringify(a)}
`),n(typeof l=="string"||l instanceof Uint8Array?l:JSON.stringify(l))}return typeof s=="string"?s:EE(s)}function EE(r){var e=r.reduce((n,o)=>n+o.length,0),t=new Uint8Array(e);let i=0;for(var s of r)t.set(s,i),i+=s.length;return t}function kE(r,e){var t=typeof r.data=="string"?na(r.data,e):r.data;return[vi({type:"attachment",length:t.length,filename:r.filename,content_type:r.contentType,attachment_type:r.attachmentType}),t]}var IE={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default"};function hl(r){return IE[r]}function xE(r,e,t){var i=[{type:"client_report"},{timestamp:t||io(),discarded_events:r}];return so(e?{dsn:e}:{},[i])}var TE=60*1e3;function RE(r,e=Date.now()){var t=parseInt(`${r}`,10);if(!isNaN(t))return t*1e3;var i=Date.parse(`${r}`);return isNaN(i)?TE:i-e}function CE(r,e){return r[e]||r.all||0}function ME(r,e,t=Date.now()){return CE(r,e)>t}function AE(r,{statusCode:e,headers:t},i=Date.now()){var s={...r},n=t&&t["x-sentry-rate-limits"],o=t&&t["retry-after"];if(n)for(var a of n.trim().split(",")){const[h,p]=a.split(":",2);var l=parseInt(h,10),d=(isNaN(l)?60:l)*1e3;if(!p)s.all=i+d;else for(var c of p.split(";"))s[c]=i+d}else o?s.all=i+RE(o,i):e===429&&(s.all=i+60*1e3);return s}var vs="baggage",NE="sentry-",ml=/^sentry-/,DE=8192;function Hn(r,e="",t=!0){return[{...r},e,t]}function VE(r){return Object.keys(r[0]).length===0}function Ou(r){return r[0]}function UE(r){return r[1]}function PE(r){return r[2]}function OE(r){r[2]=!1}function FE(r){return Object.keys(r[0]).reduce((e,t)=>{var i=r[0][t],s=`${NE}${encodeURIComponent(t)}=${encodeURIComponent(i)}`,n=e===""?s:`${e},${s}`;return n.length>DE?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Not adding key: ${t} with val: ${i} to baggage due to exceeding baggage size limits.`),e):n},r[1])}function Fu(r,e=!1){if(!Array.isArray(r)&&!ki(r)||typeof r=="number")return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("[parseBaggageHeader] Received input value of incompatible type: ",typeof r,r),Hn({},"");var t=(ki(r)?r:r.join(",")).split(",").map(i=>i.trim()).filter(i=>i!==""&&(e||ml.test(i)));return t.reduce(([i,s],n)=>{const[o,a]=n.split("=");if(ml.test(o)){var l=decodeURIComponent(o.split("-")[1]);return[{...i,[l]:decodeURIComponent(a)},s,!0]}else return[i,s===""?n:`${s},${n}`,!0]},[{},"",!0])}function _r(r,e){if(!r&&!e)return"";var t=e&&Fu(e,!0)||void 0,i=t&&UE(t),s=Hn(r&&r[0]||{},i||"");return FE(s)}function LE(r,e){var t=Fu(r||"");return(e||!VE(t))&&OE(t),t}function BE(r){var e=La(),t={sid:wi(),init:!0,timestamp:e,started:e,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>$E(t)};return r&&Os(t,r),t}function Os(r,e={}){if(e.user&&(!r.ipAddress&&e.user.ip_address&&(r.ipAddress=e.user.ip_address),!r.did&&!e.did&&(r.did=e.user.id||e.user.email||e.user.username)),r.timestamp=e.timestamp||La(),e.ignoreDuration&&(r.ignoreDuration=e.ignoreDuration),e.sid&&(r.sid=e.sid.length===32?e.sid:wi()),e.init!==void 0&&(r.init=e.init),!r.did&&e.did&&(r.did=`${e.did}`),typeof e.started=="number"&&(r.started=e.started),r.ignoreDuration)r.duration=void 0;else if(typeof e.duration=="number")r.duration=e.duration;else{var t=r.timestamp-r.started;r.duration=t>=0?t:0}e.release&&(r.release=e.release),e.environment&&(r.environment=e.environment),!r.ipAddress&&e.ipAddress&&(r.ipAddress=e.ipAddress),!r.userAgent&&e.userAgent&&(r.userAgent=e.userAgent),typeof e.errors=="number"&&(r.errors=e.errors),e.status&&(r.status=e.status)}function KE(r,e){let t={};e?t={status:e}:r.status==="ok"&&(t={status:"exited"}),Os(r,t)}function $E(r){return vi({sid:`${r.sid}`,init:r.init,started:new Date(r.started*1e3).toISOString(),timestamp:new Date(r.timestamp*1e3).toISOString(),status:r.status,errors:r.errors,did:typeof r.did=="number"||typeof r.did=="string"?`${r.did}`:void 0,duration:r.duration,attrs:{release:r.release,environment:r.environment,ip_address:r.ipAddress,user_agent:r.userAgent}})}var pl=100;class bi{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={}}static clone(e){var t=new bi;return e&&(t._breadcrumbs=[...e._breadcrumbs],t._tags={...e._tags},t._extra={...e._extra},t._contexts={...e._contexts},t._user=e._user,t._level=e._level,t._span=e._span,t._session=e._session,t._transactionName=e._transactionName,t._fingerprint=e._fingerprint,t._eventProcessors=[...e._eventProcessors],t._requestSession=e._requestSession,t._attachments=[...e._attachments]),t}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{},this._session&&Os(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}getRequestSession(){return this._requestSession}setRequestSession(e){return this._requestSession=e,this}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts={...this._contexts,[e]:t},this._notifyScopeListeners(),this}setSpan(e){return this._span=e,this._notifyScopeListeners(),this}getSpan(){return this._span}getTransaction(){var e=this.getSpan();return e&&e.transaction}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;if(typeof e=="function"){var t=e(this);return t instanceof bi?t:this}return e instanceof bi?(this._tags={...this._tags,...e._tags},this._extra={...this._extra,...e._extra},this._contexts={...this._contexts,...e._contexts},e._user&&Object.keys(e._user).length&&(this._user=e._user),e._level&&(this._level=e._level),e._fingerprint&&(this._fingerprint=e._fingerprint),e._requestSession&&(this._requestSession=e._requestSession)):Ps(e)&&(e=e,this._tags={...this._tags,...e.tags},this._extra={...this._extra,...e.extra},this._contexts={...this._contexts,...e.contexts},e.user&&(this._user=e.user),e.level&&(this._level=e.level),e.fingerprint&&(this._fingerprint=e.fingerprint),e.requestSession&&(this._requestSession=e.requestSession)),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._span=void 0,this._session=void 0,this._notifyScopeListeners(),this._attachments=[],this}addBreadcrumb(e,t){var i=typeof t=="number"?Math.min(t,pl):pl;if(i<=0)return this;var s={timestamp:io(),...e};return this._breadcrumbs=[...this._breadcrumbs,s].slice(-i),this._notifyScopeListeners(),this}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}getAttachments(){return this._attachments}clearAttachments(){return this._attachments=[],this}applyToEvent(e,t={}){if(this._extra&&Object.keys(this._extra).length&&(e.extra={...this._extra,...e.extra}),this._tags&&Object.keys(this._tags).length&&(e.tags={...this._tags,...e.tags}),this._user&&Object.keys(this._user).length&&(e.user={...this._user,...e.user}),this._contexts&&Object.keys(this._contexts).length&&(e.contexts={...this._contexts,...e.contexts}),this._level&&(e.level=this._level),this._transactionName&&(e.transaction=this._transactionName),this._span){e.contexts={trace:this._span.getTraceContext(),...e.contexts};var i=this._span.transaction&&this._span.transaction.name;i&&(e.tags={transaction:i,...e.tags})}return this._applyFingerprint(e),e.breadcrumbs=[...e.breadcrumbs||[],...this._breadcrumbs],e.breadcrumbs=e.breadcrumbs.length>0?e.breadcrumbs:void 0,e.sdkProcessingMetadata={...e.sdkProcessingMetadata,...this._sdkProcessingMetadata},this._notifyEventProcessors([...Lu(),...this._eventProcessors],e,t)}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata={...this._sdkProcessingMetadata,...e},this}_notifyEventProcessors(e,t,i,s=0){return new Be((n,o)=>{var a=e[s];if(t===null||typeof a!="function")n(t);else{var l=a({...t},i);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&a.id&&l===null&&k.log(`Event processor "${a.id}" dropped event`),Va(l)?l.then(d=>this._notifyEventProcessors(e,d,i,s+1).then(n)).then(null,o):this._notifyEventProcessors(e,l,i,s+1).then(n).then(null,o)}})}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}_applyFingerprint(e){e.fingerprint=e.fingerprint?Array.isArray(e.fingerprint)?e.fingerprint:[e.fingerprint]:[],this._fingerprint&&(e.fingerprint=e.fingerprint.concat(this._fingerprint)),e.fingerprint&&!e.fingerprint.length&&delete e.fingerprint}}function Lu(){return Na("globalEventProcessors",()=>[])}function Ba(r){Lu().push(r)}var Ka=4,jE=100;class zr{__init(){this._stack=[{}]}constructor(e,t=new bi,i=Ka){this._version=i,zr.prototype.__init.call(this),this.getStackTop().scope=t,e&&this.bindClient(e)}isOlderThan(e){return this._version<e}bindClient(e){var t=this.getStackTop();t.client=e,e&&e.setupIntegrations&&e.setupIntegrations()}pushScope(){var e=bi.clone(this.getScope());return this.getStack().push({client:this.getClient(),scope:e}),e}popScope(){return this.getStack().length<=1?!1:!!this.getStack().pop()}withScope(e){var t=this.pushScope();try{e(t)}finally{this.popScope()}}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getStack(){return this._stack}getStackTop(){return this._stack[this._stack.length-1]}captureException(e,t){var i=this._lastEventId=t&&t.event_id?t.event_id:wi(),s=new Error("Sentry syntheticException");return this._withClient((n,o)=>{n.captureException(e,{originalException:e,syntheticException:s,...t,event_id:i},o)}),i}captureMessage(e,t,i){var s=this._lastEventId=i&&i.event_id?i.event_id:wi(),n=new Error(e);return this._withClient((o,a)=>{o.captureMessage(e,t,{originalException:e,syntheticException:n,...i,event_id:s},a)}),s}captureEvent(e,t){var i=t&&t.event_id?t.event_id:wi();return e.type!=="transaction"&&(this._lastEventId=i),this._withClient((s,n)=>{s.captureEvent(e,{...t,event_id:i},n)}),i}lastEventId(){return this._lastEventId}addBreadcrumb(e,t){const{scope:i,client:s}=this.getStackTop();if(!i||!s)return;const{beforeBreadcrumb:n=null,maxBreadcrumbs:o=jE}=s.getOptions&&s.getOptions()||{};if(!(o<=0)){var a=io(),l={timestamp:a,...e},d=n?Mu(()=>n(l,t)):l;d!==null&&i.addBreadcrumb(d,o)}}setUser(e){var t=this.getScope();t&&t.setUser(e)}setTags(e){var t=this.getScope();t&&t.setTags(e)}setExtras(e){var t=this.getScope();t&&t.setExtras(e)}setTag(e,t){var i=this.getScope();i&&i.setTag(e,t)}setExtra(e,t){var i=this.getScope();i&&i.setExtra(e,t)}setContext(e,t){var i=this.getScope();i&&i.setContext(e,t)}configureScope(e){const{scope:t,client:i}=this.getStackTop();t&&i&&e(t)}run(e){var t=_l(this);try{e(this)}finally{_l(t)}}getIntegration(e){var t=this.getClient();if(!t)return null;try{return t.getIntegration(e)}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Cannot retrieve integration ${e.id} from the current Hub`),null}}startTransaction(e,t){return this._callExtensionMethod("startTransaction",e,t)}traceHeaders(){return this._callExtensionMethod("traceHeaders")}captureSession(e=!1){if(e)return this.endSession();this._sendSessionUpdate()}endSession(){var e=this.getStackTop(),t=e&&e.scope,i=t&&t.getSession();i&&KE(i),this._sendSessionUpdate(),t&&t.setSession()}startSession(e){const{scope:t,client:i}=this.getStackTop(),{release:s,environment:n}=i&&i.getOptions()||{};var o=W();const{userAgent:a}=o.navigator||{};var l=BE({release:s,environment:n,...t&&{user:t.getUser()},...a&&{userAgent:a},...e});if(t){var d=t.getSession&&t.getSession();d&&d.status==="ok"&&Os(d,{status:"exited"}),this.endSession(),t.setSession(l)}return l}shouldSendDefaultPii(){var e=this.getClient(),t=e&&e.getOptions();return Boolean(t&&t.sendDefaultPii)}_sendSessionUpdate(){const{scope:e,client:t}=this.getStackTop();if(!!e){var i=e.getSession();i&&t&&t.captureSession&&t.captureSession(i)}}_withClient(e){const{scope:t,client:i}=this.getStackTop();i&&e(i,t)}_callExtensionMethod(e,...t){var i=Hs(),s=i.__SENTRY__;if(s&&s.extensions&&typeof s.extensions[e]=="function")return s.extensions[e].apply(this,t);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Extension method ${e} couldn't be found, doing nothing.`)}}function Hs(){var r=W();return r.__SENTRY__=r.__SENTRY__||{extensions:{},hub:void 0},r}function _l(r){var e=Hs(),t=mi(e);return $a(e,r),t}function me(){var r=Hs();return(!Bu(r)||mi(r).isOlderThan(Ka))&&$a(r,new zr),to()?qE(r):mi(r)}function qE(r){try{var e=Hs().__SENTRY__,t=e&&e.extensions&&e.extensions.domain&&e.extensions.domain.active;if(!t)return mi(r);if(!Bu(t)||mi(t).isOlderThan(Ka)){var i=mi(r).getStackTop();$a(t,new zr(i.client,bi.clone(i.scope)))}return mi(t)}catch{return mi(r)}}function Bu(r){return!!(r&&r.__SENTRY__&&r.__SENTRY__.hub)}function mi(r){return Na("hub",()=>new zr,r)}function $a(r,e){if(!r)return!1;var t=r.__SENTRY__=r.__SENTRY__||{};return t.hub=e,!0}function Ku(r,e){return me().captureException(r,{captureContext:e})}function cr(r,e){me().setTag(r,e)}function zE(r){me().withScope(r)}var GE="7";function HE(r){var e=r.protocol?`${r.protocol}:`:"",t=r.port?`:${r.port}`:"";return`${e}//${r.host}${t}${r.path?`/${r.path}`:""}/api/`}function WE(r){return`${HE(r)}${r.projectId}/envelope/`}function YE(r){return zS({sentry_key:r.publicKey,sentry_version:GE})}function $u(r,e){return e||`${WE(r)}?${YE(r)}`}function ju(r){if(!r||!r.sdk)return;const{name:e,version:t}=r.sdk;return{name:e,version:t}}function JE(r,e){return e&&(r.sdk=r.sdk||{},r.sdk.name=r.sdk.name||e.name,r.sdk.version=r.sdk.version||e.version,r.sdk.integrations=[...r.sdk.integrations||[],...e.integrations||[]],r.sdk.packages=[...r.sdk.packages||[],...e.packages||[]]),r}function XE(r,e,t,i){var s=ju(t),n={sent_at:new Date().toISOString(),...s&&{sdk:s},...!!i&&{dsn:Ua(e)}},o="aggregates"in r?[{type:"sessions"},r]:[{type:"session"},r];return so(n,[o])}function QE(r,e,t,i){var s=ju(t),n=r.type||"event";const{transactionSampling:o}=r.sdkProcessingMetadata||{},{method:a,rate:l}=o||{};JE(r,t&&t.sdk);var d=ZE(r,s,i,e);delete r.sdkProcessingMetadata;var c=[{type:n,sample_rates:[{id:a,rate:l}]},r];return so(d,[c])}function ZE(r,e,t,i){var s=r.sdkProcessingMetadata&&r.sdkProcessingMetadata.baggage,n=s&&Ou(s);return{event_id:r.event_id,sent_at:new Date().toISOString(),...e&&{sdk:e},...!!t&&{dsn:Ua(i)},...r.type==="transaction"&&n&&{trace:vi({...n})}}}var fl=[];function gl(r){return r.reduce((e,t)=>(e.every(i=>t.name!==i.name)&&e.push(t),e),[])}function ek(r){var e=r.defaultIntegrations&&[...r.defaultIntegrations]||[],t=r.integrations;let i=[...gl(e)];Array.isArray(t)?i=[...i.filter(o=>t.every(a=>a.name!==o.name)),...gl(t)]:typeof t=="function"&&(i=t(i),i=Array.isArray(i)?i:[i]);var s=i.map(o=>o.name),n="Debug";return s.indexOf(n)!==-1&&i.push(...i.splice(s.indexOf(n),1)),i}function tk(r){var e={};return r.forEach(t=>{e[t.name]=t,fl.indexOf(t.name)===-1&&(t.setupOnce(Ba,me),fl.push(t.name),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`Integration installed: ${t.name}`))}),e}var yl="Not capturing exception because it's already been captured.";class ws{__init(){this._integrations={}}__init2(){this._integrationsInitialized=!1}__init3(){this._numProcessing=0}__init4(){this._outcomes={}}constructor(e){if(ws.prototype.__init.call(this),ws.prototype.__init2.call(this),ws.prototype.__init3.call(this),ws.prototype.__init4.call(this),this._options=e,e.dsn){this._dsn=$S(e.dsn);var t=$u(this._dsn,e.tunnel);this._transport=e.transport({recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:t})}else(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("No DSN provided, client will not do anything.")}captureException(e,t,i){if(ll(e)){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(yl);return}let s=t&&t.event_id;return this._process(this.eventFromException(e,t).then(n=>this._captureEvent(n,t,i)).then(n=>{s=n})),s}captureMessage(e,t,i,s){let n=i&&i.event_id;var o=Tu(e)?this.eventFromMessage(String(e),t,i):this.eventFromException(e,i);return this._process(o.then(a=>this._captureEvent(a,i,s)).then(a=>{n=a})),n}captureEvent(e,t,i){if(t&&t.originalException&&ll(t.originalException)){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(yl);return}let s=t&&t.event_id;return this._process(this._captureEvent(e,t,i).then(n=>{s=n})),s}captureSession(e){if(!this._isEnabled()){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("SDK not enabled, will not capture session.");return}typeof e.release!="string"?(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Discarded session because of missing or non-string release"):(this.sendSession(e),Os(e,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getTransport(){return this._transport}flush(e){var t=this._transport;return t?this._isClientDoneProcessing(e).then(i=>t.flush(e).then(s=>i&&s)):es(!0)}close(e){return this.flush(e).then(t=>(this.getOptions().enabled=!1,t))}setupIntegrations(){this._isEnabled()&&!this._integrationsInitialized&&(this._integrations=tk(this._options.integrations),this._integrationsInitialized=!0)}getIntegrationById(e){return this._integrations[e]}getIntegration(e){try{return this._integrations[e.id]||null}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Cannot retrieve integration ${e.id} from the current Client`),null}}sendEvent(e,t={}){if(this._dsn){let s=QE(e,this._dsn,this._options._metadata,this._options.tunnel);for(var i of t.attachments||[])s=SE(s,kE(i,this._options.transportOptions&&this._options.transportOptions.textEncoder));this._sendEnvelope(s)}}sendSession(e){if(this._dsn){var t=XE(e,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(t)}}recordDroppedEvent(e,t){if(this._options.sendClientReports){var i=`${e}:${t}`;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`Adding outcome: "${i}"`),this._outcomes[i]=this._outcomes[i]+1||1}}_updateSessionFromEvent(e,t){let i=!1,s=!1;var n=t.exception&&t.exception.values;if(n){s=!0;for(var o of n){var a=o.mechanism;if(a&&a.handled===!1){i=!0;break}}}var l=e.status==="ok",d=l&&e.errors===0||l&&i;d&&(Os(e,{...i&&{status:"crashed"},errors:e.errors||Number(s||i)}),this.captureSession(e))}_isClientDoneProcessing(e){return new Be(t=>{let i=0;var s=1,n=setInterval(()=>{this._numProcessing==0?(clearInterval(n),t(!0)):(i+=s,e&&i>=e&&(clearInterval(n),t(!1)))},s)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._dsn!==void 0}_prepareEvent(e,t,i){const{normalizeDepth:s=3,normalizeMaxBreadth:n=1e3}=this.getOptions();var o={...e,event_id:e.event_id||t.event_id||wi(),timestamp:e.timestamp||io()};this._applyClientOptions(o),this._applyIntegrationsMetadata(o);let a=i;t.captureContext&&(a=bi.clone(a).update(t.captureContext));let l=es(o);if(a){var d=[...t.attachments||[],...a.getAttachments()];d.length&&(t.attachments=d),l=a.applyToEvent(o,t)}return l.then(c=>typeof s=="number"&&s>0?this._normalizeEvent(c,s,n):c)}_normalizeEvent(e,t,i){if(!e)return null;var s={...e,...e.breadcrumbs&&{breadcrumbs:e.breadcrumbs.map(n=>({...n,...n.data&&{data:Ki(n.data,t,i)}}))},...e.user&&{user:Ki(e.user,t,i)},...e.contexts&&{contexts:Ki(e.contexts,t,i)},...e.extra&&{extra:Ki(e.extra,t,i)}};return e.contexts&&e.contexts.trace&&s.contexts&&(s.contexts.trace=e.contexts.trace,e.contexts.trace.data&&(s.contexts.trace.data=Ki(e.contexts.trace.data,t,i))),e.spans&&(s.spans=e.spans.map(n=>(n.data&&(n.data=Ki(n.data,t,i)),n))),s}_applyClientOptions(e){var t=this.getOptions();const{environment:i,release:s,dist:n,maxValueLength:o=250}=t;"environment"in e||(e.environment="environment"in t?i:"production"),e.release===void 0&&s!==void 0&&(e.release=s),e.dist===void 0&&n!==void 0&&(e.dist=n),e.message&&(e.message=vr(e.message,o));var a=e.exception&&e.exception.values&&e.exception.values[0];a&&a.value&&(a.value=vr(a.value,o));var l=e.request;l&&l.url&&(l.url=vr(l.url,o))}_applyIntegrationsMetadata(e){var t=Object.keys(this._integrations);t.length>0&&(e.sdk=e.sdk||{},e.sdk.integrations=[...e.sdk.integrations||[],...t])}_captureEvent(e,t={},i){return this._processEvent(e,t,i).then(s=>s.event_id,s=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(s)})}_processEvent(e,t,i){const{beforeSend:s,sampleRate:n}=this.getOptions();if(!this._isEnabled())return sa(new Ve("SDK not enabled, will not capture event."));var o=e.type==="transaction";return!o&&typeof n=="number"&&Math.random()>n?(this.recordDroppedEvent("sample_rate","error"),sa(new Ve(`Discarding event because it's not included in the random sample (sampling rate = ${n})`))):this._prepareEvent(e,t,i).then(a=>{if(a===null)throw this.recordDroppedEvent("event_processor",e.type||"error"),new Ve("An event processor returned null, will not send event.");var l=t.data&&t.data.__sentry__===!0;if(l||o||!s)return a;var d=s(a,t);return ik(d)}).then(a=>{if(a===null)throw this.recordDroppedEvent("before_send",e.type||"error"),new Ve("`beforeSend` returned `null`, will not send event.");var l=i&&i.getSession();return!o&&l&&this._updateSessionFromEvent(l,a),this.sendEvent(a,t),a}).then(null,a=>{throw a instanceof Ve?a:(this.captureException(a,{data:{__sentry__:!0},originalException:a}),new Ve(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${a}`))})}_process(e){this._numProcessing+=1,e.then(t=>(this._numProcessing-=1,t),t=>(this._numProcessing-=1,t))}_sendEnvelope(e){this._transport&&this._dsn?this._transport.send(e).then(null,t=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error("Error while sending event:",t)}):(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error("Transport disabled")}_clearOutcomes(){var e=this._outcomes;return this._outcomes={},Object.keys(e).map(t=>{const[i,s]=t.split(":");return{reason:i,category:s,quantity:e[t]}})}}function ik(r){var e="`beforeSend` method has to return `null` or a valid event.";if(Va(r))return r.then(t=>{if(!(Ps(t)||t===null))throw new Ve(e);return t},t=>{throw new Ve(`beforeSend rejected with ${t}`)});if(!(Ps(r)||r===null))throw new Ve(e);return r}function sk(r,e){e.debug===!0&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__?k.enable():console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle."));var t=me(),i=t.getScope();i&&i.update(e.initialScope);var s=new r(e);t.bindClient(s)}var rk=30;function qu(r,e,t=_E(r.bufferSize||rk)){let i={};var s=o=>t.drain(o);function n(o){var a=[];if(ul(o,(h,p)=>{var g=hl(p);ME(i,g)?r.recordDroppedEvent("ratelimit_backoff",g):a.push(h)}),a.length===0)return es();var l=so(o[0],a),d=h=>{ul(l,(p,g)=>{r.recordDroppedEvent(h,hl(g))})},c=()=>e({body:Pu(l,r.textEncoder)}).then(h=>{h.statusCode!==void 0&&(h.statusCode<200||h.statusCode>=300)&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Sentry responded with status code ${h.statusCode} to sent event.`),i=AE(i,h)},h=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error("Failed while sending event:",h),d("network_error")});return t.add(c).then(h=>h,h=>{if(h instanceof Ve)return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error("Skipped sending event due to full buffer"),d("queue_overflow"),es();throw h})}return{send:n,flush:s}}var vl="7.5.0";let wl;class Pr{constructor(){Pr.prototype.__init.call(this)}static __initStatic(){this.id="FunctionToString"}__init(){this.name=Pr.id}setupOnce(){wl=Function.prototype.toString,Function.prototype.toString=function(...e){var t=Oa(this)||this;return wl.apply(t,e)}}}Pr.__initStatic();var nk=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/];class xs{static __initStatic(){this.id="InboundFilters"}__init(){this.name=xs.id}constructor(e={}){this._options=e,xs.prototype.__init.call(this)}setupOnce(e,t){var i=s=>{var n=t();if(n){var o=n.getIntegration(xs);if(o){var a=n.getClient(),l=a?a.getOptions():{},d=ok(o._options,l);return ak(s,d)?null:s}}return s};i.id=this.name,e(i)}}xs.__initStatic();function ok(r={},e={}){return{allowUrls:[...r.allowUrls||[],...e.allowUrls||[]],denyUrls:[...r.denyUrls||[],...e.denyUrls||[]],ignoreErrors:[...r.ignoreErrors||[],...e.ignoreErrors||[],...nk],ignoreInternal:r.ignoreInternal!==void 0?r.ignoreInternal:!0}}function ak(r,e){return e.ignoreInternal&&hk(r)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Event dropped due to being internal Sentry Error.
Event: ${qi(r)}`),!0):ck(r,e.ignoreErrors)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${qi(r)}`),!0):lk(r,e.denyUrls)?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${qi(r)}.
Url: ${Wn(r)}`),!0):dk(r,e.allowUrls)?!1:((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${qi(r)}.
Url: ${Wn(r)}`),!0)}function ck(r,e){return!e||!e.length?!1:uk(r).some(t=>e.some(i=>Nr(t,i)))}function lk(r,e){if(!e||!e.length)return!1;var t=Wn(r);return t?e.some(i=>Nr(t,i)):!1}function dk(r,e){if(!e||!e.length)return!0;var t=Wn(r);return t?e.some(i=>Nr(t,i)):!0}function uk(r){if(r.message)return[r.message];if(r.exception)try{const{type:e="",value:t=""}=r.exception.values&&r.exception.values[0]||{};return[`${t}`,`${e}: ${t}`]}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error(`Cannot extract message for event ${qi(r)}`),[]}return[]}function hk(r){try{return r.exception.values[0].type==="SentryError"}catch{}return!1}function mk(r=[]){for(let t=r.length-1;t>=0;t--){var e=r[t];if(e&&e.filename!=="<anonymous>"&&e.filename!=="[native code]")return e.filename||null}return null}function Wn(r){try{let e;try{e=r.exception.values[0].stacktrace.frames}catch{}return e?mk(e):null}catch{return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error(`Cannot extract url for event ${qi(r)}`),null}}function zu(r,e){var t=ja(r,e),i={type:e&&e.name,value:gk(e)};return t.length&&(i.stacktrace={frames:t}),i.type===void 0&&i.value===""&&(i.value="Unrecoverable error caught"),i}function pk(r,e,t,i){var s={exception:{values:[{type:Da(e)?e.constructor.name:i?"UnhandledRejection":"Error",value:`Non-Error ${i?"promise rejection":"exception"} captured with keys: ${GS(e)}`}]},extra:{__serialized__:Uu(e)}};if(t){var n=ja(r,t);n.length&&(s.exception.values[0].stacktrace={frames:n})}return s}function Ao(r,e){return{exception:{values:[zu(r,e)]}}}function ja(r,e){var t=e.stacktrace||e.stack||"",i=fk(e);try{return r(t,i)}catch{}return[]}var _k=/Minified React error #\d+;/i;function fk(r){if(r){if(typeof r.framesToPop=="number")return r.framesToPop;if(_k.test(r.message))return 1}return 0}function gk(r){var e=r&&r.message;return e?e.error&&typeof e.error.message=="string"?e.error.message:e:"No error message"}function yk(r,e,t,i){var s=t&&t.syntheticException||void 0,n=qa(r,e,s,i);return Dr(n),n.level="error",t&&t.event_id&&(n.event_id=t.event_id),es(n)}function vk(r,e,t="info",i,s){var n=i&&i.syntheticException||void 0,o=oa(r,e,n,s);return o.level=t,i&&i.event_id&&(o.event_id=i.event_id),es(o)}function qa(r,e,t,i,s){let n;if(xu(e)&&e.error){var o=e;return Ao(r,o.error)}if(il(e)||NS(e)){var a=e;if("stack"in e)n=Ao(r,e);else{var l=a.name||(il(a)?"DOMError":"DOMException"),d=a.message?`${l}: ${a.message}`:l;n=oa(r,d,t,i),ta(n,d)}return"code"in a&&(n.tags={...n.tags,"DOMException.code":`${a.code}`}),n}if(Iu(e))return Ao(r,e);if(Ps(e)||Da(e)){var c=e;return n=pk(r,c,t,s),Dr(n,{synthetic:!0}),n}return n=oa(r,e,t,i),ta(n,`${e}`,void 0),Dr(n,{synthetic:!0}),n}function oa(r,e,t,i){var s={message:e};if(i&&t){var n=ja(r,t);n.length&&(s.exception={values:[{value:e,stacktrace:{frames:n}}]})}return s}var Gu="Breadcrumbs";class Or{static __initStatic(){this.id=Gu}__init(){this.name=Or.id}constructor(e){Or.prototype.__init.call(this),this.options={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e}}setupOnce(){this.options.console&&tt("console",bk),this.options.dom&&tt("dom",wk(this.options.dom)),this.options.xhr&&tt("xhr",Sk),this.options.fetch&&tt("fetch",Ek),this.options.history&&tt("history",kk)}}Or.__initStatic();function wk(r){function e(t){let i,s=typeof r=="object"?r.serializeAttribute:void 0;typeof s=="string"&&(s=[s]);try{i=t.event.target?Ar(t.event.target,s):Ar(t.event,s)}catch{i="<unknown>"}i.length!==0&&me().addBreadcrumb({category:`ui.${t.name}`,message:i},{event:t.event,name:t.name,global:t.global})}return e}function bk(r){var e={category:"console",data:{arguments:r.args,logger:"console"},level:gE(r.level),message:rl(r.args," ")};if(r.level==="assert")if(r.args[0]===!1)e.message=`Assertion failed: ${rl(r.args.slice(1)," ")||"console.assert"}`,e.data.arguments=r.args.slice(1);else return;me().addBreadcrumb(e,{input:r.args,level:r.level})}function Sk(r){if(r.endTimestamp){if(r.xhr.__sentry_own_request__)return;const{method:e,url:t,status_code:i,body:s}=r.xhr.__sentry_xhr__||{};me().addBreadcrumb({category:"xhr",data:{method:e,url:t,status_code:i},type:"http"},{xhr:r.xhr,input:s});return}}function Ek(r){!r.endTimestamp||r.fetchData.url.match(/sentry_key/)&&r.fetchData.method==="POST"||(r.error?me().addBreadcrumb({category:"fetch",data:r.fetchData,level:"error",type:"http"},{data:r.error,input:r.args}):me().addBreadcrumb({category:"fetch",data:{...r.fetchData,status_code:r.response.status},type:"http"},{input:r.args,response:r.response}))}function kk(r){var e=W();let t=r.from,i=r.to;var s=Co(e.location.href);let n=Co(t);var o=Co(i);n.path||(n=s),s.protocol===o.protocol&&s.host===o.host&&(i=o.relative),s.protocol===n.protocol&&s.host===n.host&&(t=n.relative),me().addBreadcrumb({category:"navigation",data:{from:t,to:i}})}var pt=W();let bn;function Hu(){if(bn)return bn;if(ea(pt.fetch))return bn=pt.fetch.bind(pt);var r=pt.document;let e=pt.fetch;if(r&&typeof r.createElement=="function")try{var t=r.createElement("iframe");t.hidden=!0,r.head.appendChild(t);var i=t.contentWindow;i&&i.fetch&&(e=i.fetch),r.head.removeChild(t)}catch(s){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",s)}return bn=e.bind(pt)}function Ik(r,e){var t=Object.prototype.toString.call(pt&&pt.navigator)==="[object Navigator]",i=t&&typeof pt.navigator.sendBeacon=="function";if(i){var s=pt.navigator.sendBeacon.bind(pt.navigator);s(r,e)}else if(Fa()){var n=Hu();n(r,{body:e,method:"POST",credentials:"omit",keepalive:!0}).then(null,o=>{(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error(o)})}}var No=W();class xk extends ws{constructor(e){e._metadata=e._metadata||{},e._metadata.sdk=e._metadata.sdk||{name:"sentry.javascript.browser",packages:[{name:"npm:@sentry/browser",version:vl}],version:vl},super(e),e.sendClientReports&&No.document&&No.document.addEventListener("visibilitychange",()=>{No.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(e,t){return yk(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",i){return vk(this._options.stackParser,e,t,i,this._options.attachStacktrace)}sendEvent(e,t){var i=this.getIntegrationById(Gu);i&&i.options&&i.options.sentry&&me().addBreadcrumb({category:`sentry.${e.type==="transaction"?"transaction":"event"}`,event_id:e.event_id,level:e.level,message:qi(e)},{event:e}),super.sendEvent(e,t)}_prepareEvent(e,t,i){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,i)}_flushOutcomes(){var e=this._clearOutcomes();if(e.length===0){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("No outcomes to send");return}if(!this._dsn){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("No dsn provided, will not send outcomes");return}(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("Sending outcomes:",e);var t=$u(this._dsn,this._options.tunnel),i=xE(e,this._options.tunnel&&Ua(this._dsn));try{Ik(t,Pu(i))}catch(s){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.error(s)}}}function Tk(r,e=Hu()){function t(i){var s={body:i.body,method:"POST",referrerPolicy:"origin",headers:r.headers,...r.fetchOptions};return e(r.url,s).then(n=>({statusCode:n.status,headers:{"x-sentry-rate-limits":n.headers.get("X-Sentry-Rate-Limits"),"retry-after":n.headers.get("Retry-After")}}))}return qu(r,t)}var Rk=4;function Ck(r){function e(t){return new Be((i,s)=>{var n=new XMLHttpRequest;n.onerror=s,n.onreadystatechange=()=>{n.readyState===Rk&&i({statusCode:n.status,headers:{"x-sentry-rate-limits":n.getResponseHeader("X-Sentry-Rate-Limits"),"retry-after":n.getResponseHeader("Retry-After")}})},n.open("POST",r.url);for(var o in r.headers)Object.prototype.hasOwnProperty.call(r.headers,o)&&n.setRequestHeader(o,r.headers[o]);n.send(t.body)})}return qu(r,e)}var ro="?",Mk=30,Ak=40,Nk=50;function za(r,e,t,i){var s={filename:r,function:e,in_app:!0};return t!==void 0&&(s.lineno=t),i!==void 0&&(s.colno=i),s}var Dk=/^\s*at (?:(.*?) ?\((?:address at )?)?((?:file|https?|blob|chrome-extension|address|native|eval|webpack|<anonymous>|[-a-z]+:|.*bundle|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,Vk=/\((\S*)(?::(\d+))(?::(\d+))\)/,Uk=r=>{var e=Dk.exec(r);if(e){var t=e[2]&&e[2].indexOf("eval")===0;if(t){var i=Vk.exec(e[2]);i&&(e[2]=i[1],e[3]=i[2],e[4]=i[3])}const[s,n]=Wu(e[1]||ro,e[2]);return za(n,s,e[3]?+e[3]:void 0,e[4]?+e[4]:void 0)}},Pk=[Mk,Uk],Ok=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:file|https?|blob|chrome|webpack|resource|moz-extension|capacitor).*?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,Fk=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Lk=r=>{var e=Ok.exec(r);if(e){var t=e[3]&&e[3].indexOf(" > eval")>-1;if(t){var i=Fk.exec(e[3]);i&&(e[1]=e[1]||"eval",e[3]=i[1],e[4]=i[2],e[5]="")}let s=e[3],n=e[1]||ro;return[n,s]=Wu(n,s),za(s,n,e[4]?+e[4]:void 0,e[5]?+e[5]:void 0)}},Bk=[Nk,Lk],Kk=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,$k=r=>{var e=Kk.exec(r);return e?za(e[2],e[1]||ro,+e[3],e[4]?+e[4]:void 0):void 0},jk=[Ak,$k],qk=[Pk,Bk,jk],zk=Du(...qk),Wu=(r,e)=>{var t=r.indexOf("safari-extension")!==-1,i=r.indexOf("safari-web-extension")!==-1;return t||i?[r.indexOf("@")!==-1?r.split("@")[0]:ro,t?`safari-extension:${e}`:`safari-web-extension:${e}`]:[r,e]};let aa=0;function Yu(){return aa>0}function Gk(){aa+=1,setTimeout(()=>{aa-=1})}function Fs(r,e={},t){if(typeof r!="function")return r;try{var i=r.__sentry_wrapped__;if(i)return i;if(Oa(r))return r}catch{return r}var s=function(){var a=Array.prototype.slice.call(arguments);try{t&&typeof t=="function"&&t.apply(this,arguments);var l=a.map(d=>Fs(d,e));return r.apply(this,l)}catch(d){throw Gk(),zE(c=>{c.addEventProcessor(h=>(e.mechanism&&(ta(h,void 0,void 0),Dr(h,e.mechanism)),h.extra={...h.extra,arguments:a},h)),Ku(d)}),d}};try{for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(s[n]=r[n])}catch{}Au(s,r),Pa(r,"__sentry_wrapped__",s);try{var o=Object.getOwnPropertyDescriptor(s,"name");o.configurable&&Object.defineProperty(s,"name",{get(){return r.name}})}catch{}return s}class Si{static __initStatic(){this.id="GlobalHandlers"}__init(){this.name=Si.id}__init2(){this._installFunc={onerror:Hk,onunhandledrejection:Wk}}constructor(e){Si.prototype.__init.call(this),Si.prototype.__init2.call(this),this._options={onerror:!0,onunhandledrejection:!0,...e}}setupOnce(){Error.stackTraceLimit=50;var e=this._options;for(var t in e){var i=this._installFunc[t];i&&e[t]&&(Xk(t),i(),this._installFunc[t]=void 0)}}}Si.__initStatic();function Hk(){tt("error",r=>{const[e,t,i]=Qu();if(!e.getIntegration(Si))return;const{msg:s,url:n,line:o,column:a,error:l}=r;if(!(Yu()||l&&l.__sentry_own_request__)){var d=l===void 0&&ki(s)?Jk(s,n,o,a):Ju(qa(t,l||s,void 0,i,!1),n,o,a);d.level="error",Xu(e,l,d,"onerror")}})}function Wk(){tt("unhandledrejection",r=>{const[e,t,i]=Qu();if(!e.getIntegration(Si))return;let s=r;try{"reason"in r?s=r.reason:"detail"in r&&"reason"in r.detail&&(s=r.detail.reason)}catch{}if(Yu()||s&&s.__sentry_own_request__)return!0;var n=Tu(s)?Yk(s):qa(t,s,void 0,i,!0);n.level="error",Xu(e,s,n,"onunhandledrejection")})}function Yk(r){return{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(r)}`}]}}}function Jk(r,e,t,i){var s=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;let n=xu(r)?r.message:r,o="Error";var a=n.match(s);a&&(o=a[1],n=a[2]);var l={exception:{values:[{type:o,value:n}]}};return Ju(l,e,t,i)}function Ju(r,e,t,i){var s=r.exception=r.exception||{},n=s.values=s.values||[],o=n[0]=n[0]||{},a=o.stacktrace=o.stacktrace||{},l=a.frames=a.frames||[],d=isNaN(parseInt(i,10))?void 0:i,c=isNaN(parseInt(t,10))?void 0:t,h=ki(e)&&e.length>0?e:OS();return l.length===0&&l.push({colno:d,filename:h,function:"?",in_app:!0,lineno:c}),r}function Xk(r){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`Global Handler attached: ${r}`)}function Xu(r,e,t,i){Dr(t,{handled:!1,type:i}),r.captureEvent(t,{originalException:e})}function Qu(){var r=me(),e=r.getClient(),t=e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1};return[r,t.stackParser,t.attachStacktrace]}var Qk=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"];class Fr{static __initStatic(){this.id="TryCatch"}__init(){this.name=Fr.id}constructor(e){Fr.prototype.__init.call(this),this._options={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e}}setupOnce(){var e=W();this._options.setTimeout&&Ue(e,"setTimeout",bl),this._options.setInterval&&Ue(e,"setInterval",bl),this._options.requestAnimationFrame&&Ue(e,"requestAnimationFrame",Zk),this._options.XMLHttpRequest&&"XMLHttpRequest"in e&&Ue(XMLHttpRequest.prototype,"send",eI);var t=this._options.eventTarget;if(t){var i=Array.isArray(t)?t:Qk;i.forEach(tI)}}}Fr.__initStatic();function bl(r){return function(...e){var t=e[0];return e[0]=Fs(t,{mechanism:{data:{function:Ii(r)},handled:!0,type:"instrument"}}),r.apply(this,e)}}function Zk(r){return function(e){return r.apply(this,[Fs(e,{mechanism:{data:{function:"requestAnimationFrame",handler:Ii(r)},handled:!0,type:"instrument"}})])}}function eI(r){return function(...e){var t=this,i=["onload","onerror","onprogress","onreadystatechange"];return i.forEach(s=>{s in t&&typeof t[s]=="function"&&Ue(t,s,function(n){var o={mechanism:{data:{function:s,handler:Ii(n)},handled:!0,type:"instrument"}},a=Oa(n);return a&&(o.mechanism.data.handler=Ii(a)),Fs(n,o)})}),r.apply(this,e)}}function tI(r){var e=W(),t=e[r]&&e[r].prototype;!t||!t.hasOwnProperty||!t.hasOwnProperty("addEventListener")||(Ue(t,"addEventListener",function(i){return function(s,n,o){try{typeof n.handleEvent=="function"&&(n.handleEvent=Fs(n.handleEvent,{mechanism:{data:{function:"handleEvent",handler:Ii(n),target:r},handled:!0,type:"instrument"}}))}catch{}return i.apply(this,[s,Fs(n,{mechanism:{data:{function:"addEventListener",handler:Ii(n),target:r},handled:!0,type:"instrument"}}),o])}}),Ue(t,"removeEventListener",function(i){return function(s,n,o){var a=n;try{var l=a&&a.__sentry_wrapped__;l&&i.call(this,s,l,o)}catch{}return i.call(this,s,a,o)}}))}var iI="cause",sI=5;class Ts{static __initStatic(){this.id="LinkedErrors"}__init(){this.name=Ts.id}constructor(e={}){Ts.prototype.__init.call(this),this._key=e.key||iI,this._limit=e.limit||sI}setupOnce(){var e=me().getClient();!e||Ba((t,i)=>{var s=me().getIntegration(Ts);return s?rI(e.getOptions().stackParser,s._key,s._limit,t,i):t})}}Ts.__initStatic();function rI(r,e,t,i,s){if(!i.exception||!i.exception.values||!s||!ei(s.originalException,Error))return i;var n=Zu(r,t,s.originalException,e);return i.exception.values=[...n,...i.exception.values],i}function Zu(r,e,t,i,s=[]){if(!ei(t[i],Error)||s.length+1>=e)return s;var n=zu(r,t[i]);return Zu(r,e,t[i],i,[n,...s])}var Li=W();class Rs{constructor(){Rs.prototype.__init.call(this)}static __initStatic(){this.id="HttpContext"}__init(){this.name=Rs.id}setupOnce(){Ba(e=>{if(me().getIntegration(Rs)){if(!Li.navigator&&!Li.location&&!Li.document)return e;var t=e.request&&e.request.url||Li.location&&Li.location.href;const{referrer:n}=Li.document||{},{userAgent:o}=Li.navigator||{};var i={...e.request&&e.request.headers,...n&&{Referer:n},...o&&{"User-Agent":o}},s={...t&&{url:t},headers:i};return{...e,request:s}}return e})}}Rs.__initStatic();class Cs{constructor(){Cs.prototype.__init.call(this)}static __initStatic(){this.id="Dedupe"}__init(){this.name=Cs.id}setupOnce(e,t){var i=s=>{var n=t().getIntegration(Cs);if(n){try{if(nI(s,n._previousEvent))return(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{return n._previousEvent=s}return n._previousEvent=s}return s};i.id=this.name,e(i)}}Cs.__initStatic();function nI(r,e){return e?!!(oI(r,e)||aI(r,e)):!1}function oI(r,e){var t=r.message,i=e.message;return!(!t&&!i||t&&!i||!t&&i||t!==i||!th(r,e)||!eh(r,e))}function aI(r,e){var t=Sl(e),i=Sl(r);return!(!t||!i||t.type!==i.type||t.value!==i.value||!th(r,e)||!eh(r,e))}function eh(r,e){let t=El(r),i=El(e);if(!t&&!i)return!0;if(t&&!i||!t&&i||(t=t,i=i,i.length!==t.length))return!1;for(let o=0;o<i.length;o++){var s=i[o],n=t[o];if(s.filename!==n.filename||s.lineno!==n.lineno||s.colno!==n.colno||s.function!==n.function)return!1}return!0}function th(r,e){let t=r.fingerprint,i=e.fingerprint;if(!t&&!i)return!0;if(t&&!i||!t&&i)return!1;t=t,i=i;try{return t.join("")===i.join("")}catch{return!1}}function Sl(r){return r.exception&&r.exception.values&&r.exception.values[0]}function El(r){var e=r.exception;if(e)try{return e.values[0].stacktrace.frames}catch{return}}var cI=[new xs,new Pr,new Fr,new Or,new Si,new Ts,new Cs,new Rs];function lI(r={}){if(r.defaultIntegrations===void 0&&(r.defaultIntegrations=cI),r.release===void 0){var e=W();e.SENTRY_RELEASE&&e.SENTRY_RELEASE.id&&(r.release=e.SENTRY_RELEASE.id)}r.autoSessionTracking===void 0&&(r.autoSessionTracking=!0),r.sendClientReports===void 0&&(r.sendClientReports=!0);var t={...r,stackParser:WS(r.stackParser||zk),integrations:ek(r),transport:r.transport||(Fa()?Tk:Ck)};sk(xk,t),r.autoSessionTracking&&dI()}function kl(r){r.startSession({ignoreDuration:!0}),r.captureSession()}function dI(){var r=W(),e=r.document;if(typeof e>"u"){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Session tracking in non-browser environment with @sentry/browser is not supported.");return}var t=me();!t.captureSession||(kl(t),tt("history",({from:i,to:s})=>{i===void 0||i===s||kl(me())}))}function Ga(r){var e=me().getClient(),t=r||e&&e.getOptions();return!!t&&("tracesSampleRate"in t||"tracesSampler"in t)}function no(r){var e=r||me(),t=e.getScope();return t&&t.getTransaction()}function Ce(r){return r/1e3}function uI(){tt("error",Il),tt("unhandledrejection",Il)}function Il(){var r=no();if(r){var e="internal_error";(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Transaction: ${e} -> Global error occured`),r.setStatus(e)}}class oo{__init(){this.spans=[]}constructor(e=1e3){oo.prototype.__init.call(this),this._maxlen=e}add(e){this.spans.length>this._maxlen?e.spanRecorder=void 0:this.spans.push(e)}}class ci{__init2(){this.traceId=wi()}__init3(){this.spanId=wi().substring(16)}__init4(){this.startTimestamp=Vr()}__init5(){this.tags={}}__init6(){this.data={}}constructor(e){if(ci.prototype.__init2.call(this),ci.prototype.__init3.call(this),ci.prototype.__init4.call(this),ci.prototype.__init5.call(this),ci.prototype.__init6.call(this),!e)return this;e.traceId&&(this.traceId=e.traceId),e.spanId&&(this.spanId=e.spanId),e.parentSpanId&&(this.parentSpanId=e.parentSpanId),"sampled"in e&&(this.sampled=e.sampled),e.op&&(this.op=e.op),e.description&&(this.description=e.description),e.data&&(this.data=e.data),e.tags&&(this.tags=e.tags),e.status&&(this.status=e.status),e.startTimestamp&&(this.startTimestamp=e.startTimestamp),e.endTimestamp&&(this.endTimestamp=e.endTimestamp)}startChild(e){var t=new ci({...e,parentSpanId:this.spanId,sampled:this.sampled,traceId:this.traceId});return t.spanRecorder=this.spanRecorder,t.spanRecorder&&t.spanRecorder.add(t),t.transaction=this.transaction,t}setTag(e,t){return this.tags={...this.tags,[e]:t},this}setData(e,t){return this.data={...this.data,[e]:t},this}setStatus(e){return this.status=e,this}setHttpStatus(e){this.setTag("http.status_code",String(e));var t=hI(e);return t!=="unknown_error"&&this.setStatus(t),this}isSuccess(){return this.status==="ok"}finish(e){this.endTimestamp=typeof e=="number"?e:Vr()}toTraceparent(){let e="";return this.sampled!==void 0&&(e=this.sampled?"-1":"-0"),`${this.traceId}-${this.spanId}${e}`}toContext(){return vi({data:this.data,description:this.description,endTimestamp:this.endTimestamp,op:this.op,parentSpanId:this.parentSpanId,sampled:this.sampled,spanId:this.spanId,startTimestamp:this.startTimestamp,status:this.status,tags:this.tags,traceId:this.traceId})}updateWithContext(e){return this.data=hi(e.data,()=>({})),this.description=e.description,this.endTimestamp=e.endTimestamp,this.op=e.op,this.parentSpanId=e.parentSpanId,this.sampled=e.sampled,this.spanId=hi(e.spanId,()=>this.spanId),this.startTimestamp=hi(e.startTimestamp,()=>this.startTimestamp),this.status=e.status,this.tags=hi(e.tags,()=>({})),this.traceId=hi(e.traceId,()=>this.traceId),this}getTraceContext(){return vi({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,trace_id:this.traceId})}toJSON(){return vi({data:Object.keys(this.data).length>0?this.data:void 0,description:this.description,op:this.op,parent_span_id:this.parentSpanId,span_id:this.spanId,start_timestamp:this.startTimestamp,status:this.status,tags:Object.keys(this.tags).length>0?this.tags:void 0,timestamp:this.endTimestamp,trace_id:this.traceId})}}function hI(r){if(r<400&&r>=100)return"ok";if(r>=400&&r<500)switch(r){case 401:return"unauthenticated";case 403:return"permission_denied";case 404:return"not_found";case 409:return"already_exists";case 413:return"failed_precondition";case 429:return"resource_exhausted";default:return"invalid_argument"}if(r>=500&&r<600)switch(r){case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline_exceeded";default:return"internal_error"}return"unknown_error"}class ao extends ci{__init(){this._measurements={}}constructor(e,t){super(e),ao.prototype.__init.call(this),this._hub=t||me(),this.name=e.name||"",this.metadata=e.metadata||{},this._trimEnd=e.trimEnd,this.transaction=this}setName(e){this.name=e}initSpanRecorder(e=1e3){this.spanRecorder||(this.spanRecorder=new oo(e)),this.spanRecorder.add(this)}setMeasurement(e,t,i=""){this._measurements[e]={value:t,unit:i}}setMetadata(e){this.metadata={...this.metadata,...e}}finish(e){if(this.endTimestamp===void 0){if(this.name||((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Transaction has no name, falling back to `<unlabeled transaction>`."),this.name="<unlabeled transaction>"),super.finish(e),this.sampled!==!0){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] Discarding transaction because its trace was not chosen to be sampled.");var t=this._hub.getClient();t&&t.recordDroppedEvent("sample_rate","transaction");return}var i=this.spanRecorder?this.spanRecorder.spans.filter(o=>o!==this&&o.endTimestamp):[];this._trimEnd&&i.length>0&&(this.endTimestamp=i.reduce((o,a)=>o.endTimestamp&&a.endTimestamp?o.endTimestamp>a.endTimestamp?o:a:o).endTimestamp);var s={contexts:{trace:this.getTraceContext()},spans:i,start_timestamp:this.startTimestamp,tags:this.tags,timestamp:this.endTimestamp,transaction:this.name,type:"transaction",sdkProcessingMetadata:{...this.metadata,baggage:this.getBaggage()}},n=Object.keys(this._measurements).length>0;return n&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding measurements to transaction",JSON.stringify(this._measurements,void 0,2)),s.measurements=this._measurements),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Finishing ${this.op} transaction: ${this.name}.`),this._hub.captureEvent(s)}}toContext(){var e=super.toContext();return vi({...e,name:this.name,trimEnd:this._trimEnd})}updateWithContext(e){return super.updateWithContext(e),this.name=hi(e.name,()=>""),this._trimEnd=e.trimEnd,this}getBaggage(){var e=this.metadata.baggage,t=!e||PE(e)?this._populateBaggageWithSentryValues(e):e;return this.metadata.baggage=t,t}_populateBaggageWithSentryValues(e=Hn({})){var t=this._hub||me(),i=t&&t.getClient();if(!i)return e;const{environment:s,release:n}=i.getOptions()||{},{publicKey:o}=i.getDsn()||{};var a=this.metadata&&this.metadata.transactionSampling&&this.metadata.transactionSampling.rate,l=a!==void 0?a.toLocaleString("fullwide",{useGrouping:!1,maximumFractionDigits:16}):void 0,d=t.getScope();const{id:c,segment:h}=d&&d.getUser()||{};return Hn(vi({environment:s,release:n,transaction:this.name,...t.shouldSendDefaultPii()&&{user_id:c},user_segment:h,public_key:o,trace_id:this.traceId,sample_rate:l,...Ou(e)}),"",!1)}}var ih=1e3,sh=3e4,mI=5e3;class pI extends oo{constructor(e,t,i,s){super(s),this._pushActivity=e,this._popActivity=t,this.transactionSpanId=i}add(e){e.spanId!==this.transactionSpanId&&(e.finish=t=>{e.endTimestamp=typeof t=="number"?t:Vr(),this._popActivity(e.spanId)},e.endTimestamp===void 0&&this._pushActivity(e.spanId)),super.add(e)}}class bs extends ao{__init(){this.activities={}}__init2(){this._heartbeatCounter=0}__init3(){this._finished=!1}__init4(){this._beforeFinishCallbacks=[]}constructor(e,t,i=ih,s=sh,n=!1){super(e,t),this._idleHub=t,this._idleTimeout=i,this._finalTimeout=s,this._onScope=n,bs.prototype.__init.call(this),bs.prototype.__init2.call(this),bs.prototype.__init3.call(this),bs.prototype.__init4.call(this),n&&(xl(t),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`Setting idle transaction on scope. Span ID: ${this.spanId}`),t.configureScope(o=>o.setSpan(this))),this._startIdleTimeout(),setTimeout(()=>{this._finished||(this.setStatus("deadline_exceeded"),this.finish())},this._finalTimeout)}finish(e=Vr()){if(this._finished=!0,this.activities={},this.spanRecorder){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] finishing IdleTransaction",new Date(e*1e3).toISOString(),this.op);for(var t of this._beforeFinishCallbacks)t(this,e);this.spanRecorder.spans=this.spanRecorder.spans.filter(i=>{if(i.spanId===this.spanId)return!0;i.endTimestamp||(i.endTimestamp=e,i.setStatus("cancelled"),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] cancelling span since transaction ended early",JSON.stringify(i,void 0,2)));var s=i.startTimestamp<e;return s||(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] discarding Span since it happened after Transaction was finished",JSON.stringify(i,void 0,2)),s}),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] flushing IdleTransaction")}else(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] No active IdleTransaction");return this._onScope&&xl(this._idleHub),super.finish(e)}registerBeforeFinishCallback(e){this._beforeFinishCallbacks.push(e)}initSpanRecorder(e){if(!this.spanRecorder){var t=s=>{this._finished||this._pushActivity(s)},i=s=>{this._finished||this._popActivity(s)};this.spanRecorder=new pI(t,i,this.spanId,e),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("Starting heartbeat"),this._pingHeartbeat()}this.spanRecorder.add(this)}_cancelIdleTimeout(){this._idleTimeoutID&&(clearTimeout(this._idleTimeoutID),this._idleTimeoutID=void 0)}_startIdleTimeout(e){this._cancelIdleTimeout(),this._idleTimeoutID=setTimeout(()=>{!this._finished&&Object.keys(this.activities).length===0&&this.finish(e)},this._idleTimeout)}_pushActivity(e){this._cancelIdleTimeout(),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] pushActivity: ${e}`),this.activities[e]=!0,(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] new activities count",Object.keys(this.activities).length)}_popActivity(e){if(this.activities[e]&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] popActivity ${e}`),delete this.activities[e],(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] new activities count",Object.keys(this.activities).length)),Object.keys(this.activities).length===0){var t=Vr()+this._idleTimeout/1e3;this._startIdleTimeout(t)}}_beat(){if(!this._finished){var e=Object.keys(this.activities).join("");e===this._prevHeartbeatString?this._heartbeatCounter+=1:this._heartbeatCounter=1,this._prevHeartbeatString=e,this._heartbeatCounter>=3?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] Transaction finished because of no change for 3 heart beats"),this.setStatus("deadline_exceeded"),this.finish()):this._pingHeartbeat()}}_pingHeartbeat(){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`pinging Heartbeat -> current counter: ${this._heartbeatCounter}`),setTimeout(()=>{this._beat()},mI)}}function xl(r){var e=r.getScope();if(e){var t=e.getTransaction();t&&e.setSpan(void 0)}}function _I(){var r=this.getScope();if(r){var e=r.getSpan();if(e)return{"sentry-trace":e.toTraceparent()}}return{}}function rh(r,e,t){if(!Ga(e))return r.sampled=!1,r;if(r.sampled!==void 0)return r.setMetadata({transactionSampling:{method:"explicitly_set"}}),r;let i;return typeof e.tracesSampler=="function"?(i=e.tracesSampler(t),r.setMetadata({transactionSampling:{method:"client_sampler",rate:Number(i)}})):t.parentSampled!==void 0?(i=t.parentSampled,r.setMetadata({transactionSampling:{method:"inheritance"}})):(i=e.tracesSampleRate,r.setMetadata({transactionSampling:{method:"client_rate",rate:Number(i)}})),fI(i)?i?(r.sampled=Math.random()<i,r.sampled?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] starting ${r.op} transaction - ${r.name}`),r):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Discarding transaction because it's not included in the random sample (sampling rate = ${Number(i)})`),r)):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Discarding transaction because ${typeof e.tracesSampler=="function"?"tracesSampler returned 0 or false":"a negative sampling decision was inherited or tracesSampleRate is set to 0"}`),r.sampled=!1,r):((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("[Tracing] Discarding transaction because of invalid sample rate."),r.sampled=!1,r)}function fI(r){return Ru(r)||!(typeof r=="number"||typeof r=="boolean")?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(r)} of type ${JSON.stringify(typeof r)}.`),!1):r<0||r>1?((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`[Tracing] Given sample rate is invalid. Sample rate must be between 0 and 1. Got ${r}.`),!1):!0}function gI(r,e){var t=this.getClient(),i=t&&t.getOptions()||{};let s=new ao(r,this);return s=rh(s,i,{parentSampled:r.parentSampled,transactionContext:r,...e}),s.sampled&&s.initSpanRecorder(i._experiments&&i._experiments.maxSpans),s}function yI(r,e,t,i,s,n){var o=r.getClient(),a=o&&o.getOptions()||{};let l=new bs(e,r,t,i,s);return l=rh(l,a,{parentSampled:e.parentSampled,transactionContext:e,...n}),l.sampled&&l.initSpanRecorder(a._experiments&&a._experiments.maxSpans),l}function vI(){var r=Hs();!r.__SENTRY__||(r.__SENTRY__.extensions=r.__SENTRY__.extensions||{},r.__SENTRY__.extensions.startTransaction||(r.__SENTRY__.extensions.startTransaction=gI),r.__SENTRY__.extensions.traceHeaders||(r.__SENTRY__.extensions.traceHeaders=_I))}function wI(){var r=Hs();if(!!r.__SENTRY__){var e={mongodb(){var i=_i(jt,"./integrations/node/mongo");return new i.Mongo},mongoose(){var i=_i(jt,"./integrations/node/mongo");return new i.Mongo({mongoose:!0})},mysql(){var i=_i(jt,"./integrations/node/mysql");return new i.Mysql},pg(){var i=_i(jt,"./integrations/node/postgres");return new i.Postgres}},t=Object.keys(e).filter(i=>!!MS(i)).map(i=>{try{return e[i]()}catch{return}}).filter(i=>i);t.length>0&&(r.__SENTRY__.integrations=[...r.__SENTRY__.integrations||[],...t])}}function bI(){vI(),to()&&wI(),uI()}var Sn=W();function SI(){Sn&&Sn.document?Sn.document.addEventListener("visibilitychange",()=>{var r=no();if(Sn.document.hidden&&r){var e="cancelled";(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Transaction: ${e} -> since tab moved to the background, op: ${r.op}`),r.status||r.setStatus(e),r.setTag("visibilitychange","document.hidden"),r.finish()}}):(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("[Tracing] Could not set up background tab detection due to lack of global document")}var Ha=(r,e,t)=>{let i;return s=>{e.value>=0&&(s||t)&&(e.delta=e.value-(i||0),(e.delta||i===void 0)&&(i=e.value,r(e)))}},EI=()=>`v2-${Date.now()}-${Math.floor(Math.random()*(9e12-1))+1e12}`,Wa=(r,e)=>({name:r,value:hi(e,()=>-1),delta:0,entries:[],id:EI()}),Ya=(r,e)=>{try{if(PerformanceObserver.supportedEntryTypes.includes(r)){if(r==="first-input"&&!("PerformanceEventTiming"in self))return;var t=new PerformanceObserver(i=>i.getEntries().map(e));return t.observe({type:r,buffered:!0}),t}}catch{}},co=(r,e)=>{var t=i=>{(i.type==="pagehide"||W().document.visibilityState==="hidden")&&(r(i),e&&(removeEventListener("visibilitychange",t,!0),removeEventListener("pagehide",t,!0)))};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},kI=(r,e)=>{var t=Wa("CLS",0);let i,s=0,n=[];var o=l=>{if(l&&!l.hadRecentInput){var d=n[0],c=n[n.length-1];s&&n.length!==0&&l.startTime-c.startTime<1e3&&l.startTime-d.startTime<5e3?(s+=l.value,n.push(l)):(s=l.value,n=[l]),s>t.value&&(t.value=s,t.entries=n,i&&i())}},a=Ya("layout-shift",o);a&&(i=Ha(r,t,e),co(()=>{a.takeRecords().map(o),i(!0)}))};let Dn=-1;var II=()=>W().document.visibilityState==="hidden"?0:1/0,xI=()=>{co(({timeStamp:r})=>{Dn=r},!0)},Ja=()=>(Dn<0&&(Dn=II(),xI()),{get firstHiddenTime(){return Dn}}),TI=(r,e)=>{var t=Ja(),i=Wa("FID");let s;var n=a=>{s&&a.startTime<t.firstHiddenTime&&(i.value=a.processingStart-a.startTime,i.entries.push(a),s(!0))},o=Ya("first-input",n);o&&(s=Ha(r,i,e),co(()=>{o.takeRecords().map(n),o.disconnect()},!0))},Tl={},RI=(r,e)=>{var t=Ja(),i=Wa("LCP");let s;var n=l=>{var d=l.startTime;d<t.firstHiddenTime&&(i.value=d,i.entries.push(l)),s&&s()},o=Ya("largest-contentful-paint",n);if(o){s=Ha(r,i,e);var a=()=>{Tl[i.id]||(o.takeRecords().map(n),o.disconnect(),Tl[i.id]=!0,s(!0))};["keydown","click"].forEach(l=>{addEventListener(l,a,{once:!0,capture:!0})}),co(a,!0)}};function En(r){return typeof r=="number"&&isFinite(r)}function Ls(r,{startTimestamp:e,...t}){return e&&r.startTimestamp>e&&(r.startTimestamp=e),r.startChild({startTimestamp:e,...t})}var Xi=W();function nh(){return Xi&&Xi.addEventListener&&Xi.performance}let Rl=0,X={},kt,br;function CI(r=!1){var e=nh();e&&Ur&&(e.mark&&Xi.performance.mark("sentry-tracing-init"),MI(),AI(r),NI())}function MI(){kI(r=>{var e=r.entries.pop();!e||((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding CLS"),X.cls={value:r.value,unit:""},br=e)})}function AI(r){RI(e=>{var t=e.entries.pop();if(!!t){var i=Ce(Ur),s=Ce(t.startTime);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding LCP"),X.lcp={value:e.value,unit:"millisecond"},X["mark.lcp"]={value:i+s,unit:"second"},kt=t}},r)}function NI(){TI(r=>{var e=r.entries.pop();if(!!e){var t=Ce(Ur),i=Ce(e.startTime);(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding FID"),X.fid={value:r.value,unit:"millisecond"},X["mark.fid"]={value:t+i,unit:"second"}}})}function DI(r){var e=nh();if(!e||!Xi.performance.getEntries||!Ur)return;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Tracing] Adding & adjusting spans using Performance API");var t=Ce(Ur),i=e.getEntries();let s,n;i.slice(Rl).forEach(o=>{var a=Ce(o.startTime),l=Ce(o.duration);if(!(r.op==="navigation"&&t+a<r.startTimestamp))switch(o.entryType){case"navigation":{UI(r,o,t),s=t+Ce(o.responseStart),n=t+Ce(o.requestStart);break}case"mark":case"paint":case"measure":{var d=VI(r,o,a,l,t),c=Ja(),h=o.startTime<c.firstHiddenTime;o.name==="first-paint"&&h&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding FP"),X.fp={value:o.startTime,unit:"millisecond"},X["mark.fp"]={value:d,unit:"second"}),o.name==="first-contentful-paint"&&h&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding FCP"),X.fcp={value:o.startTime,unit:"millisecond"},X["mark.fcp"]={value:d,unit:"second"});break}case"resource":{var p=o.name.replace(Xi.location.origin,"");OI(r,o,p,a,l,t);break}}}),Rl=Math.max(i.length-1,0),FI(r),r.op==="pageload"&&(typeof s=="number"&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding TTFB"),X.ttfb={value:(s-r.startTimestamp)*1e3,unit:"millisecond"},typeof n=="number"&&n<=s&&(X["ttfb.requestTime"]={value:(s-n)*1e3,unit:"millisecond"})),["fcp","fp","lcp"].forEach(o=>{if(!(!X[o]||t>=r.startTimestamp)){var a=X[o].value,l=t+Ce(a),d=Math.abs((l-r.startTimestamp)*1e3),c=d-a;(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Measurements] Normalized ${o} from ${a} to ${d} (${c})`),X[o].value=d}}),X["mark.fid"]&&X.fid&&Ls(r,{description:"first input delay",endTimestamp:X["mark.fid"].value+Ce(X.fid.value),op:"web.vitals",startTimestamp:X["mark.fid"].value}),"fcp"in X||delete X.cls,Object.keys(X).forEach(o=>{r.setMeasurement(o,X[o].value,X[o].unit)}),LI(r)),kt=void 0,br=void 0,X={}}function VI(r,e,t,i,s){var n=s+t,o=n+i;return Ls(r,{description:e.name,endTimestamp:o,op:e.entryType,startTimestamp:n}),n}function UI(r,e,t){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach(i=>{kn(r,e,i,t)}),kn(r,e,"secureConnection",t,"TLS/SSL","connectEnd"),kn(r,e,"fetch",t,"cache","domainLookupStart"),kn(r,e,"domainLookup",t,"DNS"),PI(r,e,t)}function kn(r,e,t,i,s,n){var o=n?e[n]:e[`${t}End`],a=e[`${t}Start`];!a||!o||Ls(r,{op:"browser",description:hi(s,()=>t),startTimestamp:i+Ce(a),endTimestamp:i+Ce(o)})}function PI(r,e,t){Ls(r,{op:"browser",description:"request",startTimestamp:t+Ce(e.requestStart),endTimestamp:t+Ce(e.responseEnd)}),Ls(r,{op:"browser",description:"response",startTimestamp:t+Ce(e.responseStart),endTimestamp:t+Ce(e.responseEnd)})}function OI(r,e,t,i,s,n){if(!(e.initiatorType==="xmlhttprequest"||e.initiatorType==="fetch")){var o={};"transferSize"in e&&(o["Transfer Size"]=e.transferSize),"encodedBodySize"in e&&(o["Encoded Body Size"]=e.encodedBodySize),"decodedBodySize"in e&&(o["Decoded Body Size"]=e.decodedBodySize);var a=n+i,l=a+s;Ls(r,{description:t,endTimestamp:l,op:e.initiatorType?`resource.${e.initiatorType}`:"resource",startTimestamp:a,data:o})}}function FI(r){var e=Xi.navigator;if(!!e){var t=e.connection;t&&(t.effectiveType&&r.setTag("effectiveConnectionType",t.effectiveType),t.type&&r.setTag("connectionType",t.type),En(t.rtt)&&(X["connection.rtt"]={value:t.rtt,unit:"millisecond"}),En(t.downlink)&&(X["connection.downlink"]={value:t.downlink,unit:""})),En(e.deviceMemory)&&r.setTag("deviceMemory",`${e.deviceMemory} GB`),En(e.hardwareConcurrency)&&r.setTag("hardwareConcurrency",String(e.hardwareConcurrency))}}function LI(r){kt&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding LCP Data"),kt.element&&r.setTag("lcp.element",Ar(kt.element)),kt.id&&r.setTag("lcp.id",kt.id),kt.url&&r.setTag("lcp.url",kt.url.trim().slice(0,200)),r.setTag("lcp.size",kt.size)),br&&br.sources&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log("[Measurements] Adding CLS Data"),br.sources.forEach((e,t)=>r.setTag(`cls.source.${t+1}`,Ar(e.node))))}var BI=["localhost",/^\//],Yn={traceFetch:!0,traceXHR:!0,tracingOrigins:BI};function KI(r){const{traceFetch:e,traceXHR:t,tracingOrigins:i,shouldCreateSpanForRequest:s}={...Yn,...r};var n={},o=d=>{if(n[d])return n[d];var c=i;return n[d]=c.some(h=>Nr(d,h))&&!Nr(d,"sentry_key"),n[d]};let a=o;typeof s=="function"&&(a=d=>o(d)&&s(d));var l={};e&&tt("fetch",d=>{$I(d,a,l)}),t&&tt("xhr",d=>{qI(d,a,l)})}function $I(r,e,t){if(!(!Ga()||!(r.fetchData&&e(r.fetchData.url)))){if(r.endTimestamp){var i=r.fetchData.__span;if(!i)return;var s=t[i];s&&(r.response?s.setHttpStatus(r.response.status):r.error&&s.setStatus("internal_error"),s.finish(),delete t[i]);return}var n=no();if(n){var s=n.startChild({data:{...r.fetchData,type:"fetch"},description:`${r.fetchData.method} ${r.fetchData.url}`,op:"http.client"});r.fetchData.__span=s.spanId,t[s.spanId]=s;var o=r.args[0]=r.args[0],a=r.args[1]=r.args[1]||{};a.headers=jI(o,n.getBaggage(),s,a)}}}function jI(r,e,t,i){let s=i.headers;if(ei(r,Request)&&(s=r.headers),s)if(typeof s.append=="function")s.append("sentry-trace",t.toTraceparent()),s.append(vs,_r(e,s.get(vs)));else if(Array.isArray(s)){const[,n]=s.find(([o,a])=>o===vs);s=[...s,["sentry-trace",t.toTraceparent()],[vs,_r(e,n)]]}else s={...s,"sentry-trace":t.toTraceparent(),baggage:_r(e,s.baggage)};else s={"sentry-trace":t.toTraceparent(),baggage:_r(e)};return s}function qI(r,e,t){if(!(!Ga()||r.xhr&&r.xhr.__sentry_own_request__||!(r.xhr&&r.xhr.__sentry_xhr__&&e(r.xhr.__sentry_xhr__.url)))){var i=r.xhr.__sentry_xhr__;if(r.endTimestamp){var s=r.xhr.__sentry_xhr_span_id__;if(!s)return;var n=t[s];n&&(n.setHttpStatus(i.status_code),n.finish(),delete t[s]);return}var o=no();if(o){var n=o.startChild({data:{...i.data,type:"xhr",method:i.method,url:i.url},description:`${i.method} ${i.url}`,op:"http.client"});if(r.xhr.__sentry_xhr_span_id__=n.spanId,t[r.xhr.__sentry_xhr_span_id__]=n,r.xhr.setRequestHeader)try{r.xhr.setRequestHeader("sentry-trace",n.toTraceparent());var a=r.xhr.getRequestHeader&&r.xhr.getRequestHeader(vs);r.xhr.setRequestHeader(vs,_r(o.getBaggage(),a))}catch{}}}}var lr=W();function zI(r,e=!0,t=!0){if(!lr||!lr.location){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("Could not initialize routing instrumentation due to invalid location");return}let i=lr.location.href,s;e&&(s=r({name:lr.location.pathname,op:"pageload"})),t&&tt("history",({to:n,from:o})=>{if(o===void 0&&i&&i.indexOf(n)!==-1){i=void 0;return}o!==n&&(i=void 0,s&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Finishing current transaction with op: ${s.op}`),s.finish()),s=r({name:lr.location.pathname,op:"navigation"}))})}var GI="BrowserTracing",HI={idleTimeout:ih,finalTimeout:sh,markBackgroundTransactions:!0,routingInstrumentation:zI,startTransactionOnLocationChange:!0,startTransactionOnPageLoad:!0,...Yn};class Xa{__init(){this.name=GI}constructor(e){Xa.prototype.__init.call(this);let t=Yn.tracingOrigins;e&&(e.tracingOrigins&&Array.isArray(e.tracingOrigins)&&e.tracingOrigins.length!==0?t=e.tracingOrigins:(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&(this._emitOptionsWarning=!0)),this.options={...HI,...e,tracingOrigins:t};const{_metricOptions:i}=this.options;CI(i&&i._reportAllChanges)}setupOnce(e,t){this._getCurrentHub=t,this._emitOptionsWarning&&((typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn("[Tracing] You need to define `tracingOrigins` in the options. Set an array of urls or patterns to trace."),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`[Tracing] We added a reasonable default for you: ${Yn.tracingOrigins}`));const{routingInstrumentation:i,startTransactionOnLocationChange:s,startTransactionOnPageLoad:n,markBackgroundTransactions:o,traceFetch:a,traceXHR:l,tracingOrigins:d,shouldCreateSpanForRequest:c}=this.options;i(h=>this._createRouteTransaction(h),n,s),o&&SI(),KI({traceFetch:a,traceXHR:l,tracingOrigins:d,shouldCreateSpanForRequest:c})}_createRouteTransaction(e){if(!this._getCurrentHub){(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.warn(`[Tracing] Did not create ${e.op} transaction because _getCurrentHub is invalid.`);return}const{beforeNavigate:t,idleTimeout:i,finalTimeout:s}=this.options;var n=e.op==="pageload"?WI():void 0,o={...e,...n,trimEnd:!0},a=typeof t=="function"?t(o):o,l=a===void 0?{...o,sampled:!1}:a;l.sampled===!1&&(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Will not send ${l.op} transaction because of beforeNavigate.`),(typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__)&&k.log(`[Tracing] Starting ${l.op} transaction on scope`);var d=this._getCurrentHub();const{location:c}=W();var h=yI(d,l,i,s,!0,{location:c});return h.registerBeforeFinishCallback(p=>{DI(p),p.setTag("sentry_reportAllChanges",Boolean(this.options._metricOptions&&this.options._metricOptions._reportAllChanges))}),h}}function WI(){var r=Cl("sentry-trace"),e=Cl("baggage"),t=r?bE(r):void 0,i=LE(e,r);if(t||i)return{...t&&t,...i&&{metadata:{baggage:i}}}}function Cl(r){var e=W();if(e.document&&e.document.querySelector){var t=e.document.querySelector(`meta[name=${r}]`);return t?t.getAttribute("content"):null}else return null}(typeof __SENTRY_TRACING__>"u"||__SENTRY_TRACING__)&&bI();const YI={downloadSandbox:kS,worker:IS,olm:{wasm:xS,legacyBundle:RS,wasmBundle:TS}},JI="#chatterbox";async function XI(){const e=new URLSearchParams(window.location.search).get("config");if(!e)throw new Error("Root element does not have config specified");return await(await fetch(e)).json()}function QI(){return!!new URLSearchParams(window.location.search).get("minimized")}async function ZI(){i0();const r=document.querySelector(JI);if(!r)throw new Error("No element with id as 'chatterbox' found!");r.className="hydrogen";const e=await XI();e.sentry&&(lI({dsn:e.sentry.dsn,environment:e.sentry.environment,integrations:[new Xa]}),cr("homeserver",e.homeserver),cr("encrypt_room",e.encrypt_room),e.invite_user?cr("mode","invite_user"):e.auto_join_room?cr("mode","auto_join_room"):cr("mode","unknown"));const t=new Py({container:r,assetPaths:YI,config:{themeManifests:[]},options:{development:!1}});t0(t);const i=new ob(e0);t.setNavigation(i);const s=db({navigation:i,history:t.history}),n=QI(),o=new fS(e,{platform:t,navigation:i,urlCreator:s,startMinimized:n});o.start();const a=new ES(o);r.appendChild(a.mount())}function e0(r,e){const{type:t}=e;switch(r?.type){case void 0:return t==="start"||t==="account-setup"||t==="timeline"||t==="minimize";default:return!1}}function t0(r){window.downloadLogs=async()=>{const e=await r.logger.export();confirm(`Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our privacy policy at https://element.io/privacy.

Continue to export logs?`)&&r.saveFileAs(e.asBlob(),"chatterbox-logs.json")}}function i0(){const r=e=>(Ku(e,{tags:{fatalError:!0}}),e.message==="ResizeObserver loop completed with undelivered notifications."||e.message==="ResizeObserver loop limit exceeded"||e.target.tagName==="IMG"?(e.stopImmediatePropagation(),!1):(console.error(e.error??e.reason),window.sendError(),!1));window.addEventListener("error",r,!0),window.addEventListener("unhandledrejection",r,!0)}window.sendViewChangeToParent=function(r){window.parent?.postMessage({action:"resize-iframe",view:r},"*")};window.sendMinimizeToParent=function(){window.parent?.postMessage({action:"minimize"},"*")};window.sendNotificationCount=function(r){window.parent?.postMessage({action:"unread-message",count:r},"*")};window.sendError=function(){window.parent?.postMessage({action:"error"},"*")};ZI()});export default s0();
